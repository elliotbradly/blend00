!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@babylonjs/core/Shaders/outline.fragment"),require("@babylonjs/core/Shaders/outline.vertex"),require("@babylonjs/core/Buffers/buffer"),require("@babylonjs/core/Engines/constants"),require("@babylonjs/core/Materials/clipPlaneMaterialHelper"),require("@babylonjs/core/Materials/drawWrapper"),require("@babylonjs/core/Materials/effect"),require("@babylonjs/core/Materials/effectFallbacks"),require("@babylonjs/core/Materials/materialHelper.functions"),require("@babylonjs/core/Maths/math.vector"),require("@babylonjs/core/scene"),require("@babylonjs/core/sceneComponent"),require("@babylonjs/core/Materials/shaderLanguage"),require("@babylonjs/core/Loading/sceneLoader"),require("@babylonjs/core/Meshes/geometry"),require("@babylonjs/core/Meshes/mesh"),require("@babylonjs/core/Meshes/mesh.vertexData"),require("@babylonjs/core/Misc/tools"),require("@babylonjs/core/Morph/morphTarget"),require("@babylonjs/core/Morph/morphTargetManager"),require("@babylonjs/core/assetContainer"),require("@babylonjs/core/Bones/bone"),require("@babylonjs/core/Bones/skeleton"),require("@babylonjs/core/Culling/boundingInfo"),require("@babylonjs/core/Misc/logger"),require("@babylonjs/core/Materials/material"),require("@babylonjs/core/Maths/math.color"),require("@babylonjs/core/Materials/Textures/texture"),require("@babylonjs/core/Misc/observable"),require("@babylonjs/core/Misc/timingTools"),require("@babylonjs/core/Materials/standardMaterial"),require("@babylonjs/core/Materials/materialDefines"),require("@babylonjs/core/Materials/materialPluginBase"),require("@babylonjs/core/Materials/shaderMaterial"),require("@babylonjs/core/Materials/Textures/renderTargetTexture"),require("@babylonjs/core/Materials/multiMaterial"),require("@babylonjs/core/Meshes/subMesh"),require("@babylonjs/core/Misc/fileTools"),require("@babylonjs/core/Animations/animation"),require("@babylonjs/core/Animations/animationGroup"),require("@babylonjs/core/Animations/animationKey"),require("@babylonjs/core/Maths/math.axis"),require("@babylonjs/core/Physics/v1/physicsJoint"),require("@babylonjs/core/Physics/v1/Plugins/ammoJSPlugin"),require("@babylonjs/core/Physics/joinedPhysicsEngineComponent"),require("@babylonjs/core/Physics/v1/physicsEngineComponent"),require("@babylonjs/core/Meshes/abstractMesh"),require("@babylonjs/core/Physics/v1/physicsImpostor"),require("@babylonjs/core/Physics/v2/physicsEngineComponent"),require("@babylonjs/core/Meshes/transformNode"),require("@babylonjs/core/Physics/v2/IPhysicsEnginePlugin"),require("@babylonjs/core/Physics/v2/physicsBody"),require("@babylonjs/core/Physics/v2/physicsConstraint"),require("@babylonjs/core/Physics/v2/physicsShape"),require("@babylonjs/core/Cameras/camera")):"function"==typeof define&&define.amd?define("babylon-mmd",["@babylonjs/core/Shaders/outline.fragment","@babylonjs/core/Shaders/outline.vertex","@babylonjs/core/Buffers/buffer","@babylonjs/core/Engines/constants","@babylonjs/core/Materials/clipPlaneMaterialHelper","@babylonjs/core/Materials/drawWrapper","@babylonjs/core/Materials/effect","@babylonjs/core/Materials/effectFallbacks","@babylonjs/core/Materials/materialHelper.functions","@babylonjs/core/Maths/math.vector","@babylonjs/core/scene","@babylonjs/core/sceneComponent","@babylonjs/core/Materials/shaderLanguage","@babylonjs/core/Loading/sceneLoader","@babylonjs/core/Meshes/geometry","@babylonjs/core/Meshes/mesh","@babylonjs/core/Meshes/mesh.vertexData","@babylonjs/core/Misc/tools","@babylonjs/core/Morph/morphTarget","@babylonjs/core/Morph/morphTargetManager","@babylonjs/core/assetContainer","@babylonjs/core/Bones/bone","@babylonjs/core/Bones/skeleton","@babylonjs/core/Culling/boundingInfo","@babylonjs/core/Misc/logger","@babylonjs/core/Materials/material","@babylonjs/core/Maths/math.color","@babylonjs/core/Materials/Textures/texture","@babylonjs/core/Misc/observable","@babylonjs/core/Misc/timingTools","@babylonjs/core/Materials/standardMaterial","@babylonjs/core/Materials/materialDefines","@babylonjs/core/Materials/materialPluginBase","@babylonjs/core/Materials/shaderMaterial","@babylonjs/core/Materials/Textures/renderTargetTexture","@babylonjs/core/Materials/multiMaterial","@babylonjs/core/Meshes/subMesh","@babylonjs/core/Misc/fileTools","@babylonjs/core/Animations/animation","@babylonjs/core/Animations/animationGroup","@babylonjs/core/Animations/animationKey","@babylonjs/core/Maths/math.axis","@babylonjs/core/Physics/v1/physicsJoint","@babylonjs/core/Physics/v1/Plugins/ammoJSPlugin","@babylonjs/core/Physics/joinedPhysicsEngineComponent","@babylonjs/core/Physics/v1/physicsEngineComponent","@babylonjs/core/Meshes/abstractMesh","@babylonjs/core/Physics/v1/physicsImpostor","@babylonjs/core/Physics/v2/physicsEngineComponent","@babylonjs/core/Meshes/transformNode","@babylonjs/core/Physics/v2/IPhysicsEnginePlugin","@babylonjs/core/Physics/v2/physicsBody","@babylonjs/core/Physics/v2/physicsConstraint","@babylonjs/core/Physics/v2/physicsShape","@babylonjs/core/Cameras/camera"],t):"object"==typeof exports?exports["babylon-mmd"]=t(require("@babylonjs/core/Shaders/outline.fragment"),require("@babylonjs/core/Shaders/outline.vertex"),require("@babylonjs/core/Buffers/buffer"),require("@babylonjs/core/Engines/constants"),require("@babylonjs/core/Materials/clipPlaneMaterialHelper"),require("@babylonjs/core/Materials/drawWrapper"),require("@babylonjs/core/Materials/effect"),require("@babylonjs/core/Materials/effectFallbacks"),require("@babylonjs/core/Materials/materialHelper.functions"),require("@babylonjs/core/Maths/math.vector"),require("@babylonjs/core/scene"),require("@babylonjs/core/sceneComponent"),require("@babylonjs/core/Materials/shaderLanguage"),require("@babylonjs/core/Loading/sceneLoader"),require("@babylonjs/core/Meshes/geometry"),require("@babylonjs/core/Meshes/mesh"),require("@babylonjs/core/Meshes/mesh.vertexData"),require("@babylonjs/core/Misc/tools"),require("@babylonjs/core/Morph/morphTarget"),require("@babylonjs/core/Morph/morphTargetManager"),require("@babylonjs/core/assetContainer"),require("@babylonjs/core/Bones/bone"),require("@babylonjs/core/Bones/skeleton"),require("@babylonjs/core/Culling/boundingInfo"),require("@babylonjs/core/Misc/logger"),require("@babylonjs/core/Materials/material"),require("@babylonjs/core/Maths/math.color"),require("@babylonjs/core/Materials/Textures/texture"),require("@babylonjs/core/Misc/observable"),require("@babylonjs/core/Misc/timingTools"),require("@babylonjs/core/Materials/standardMaterial"),require("@babylonjs/core/Materials/materialDefines"),require("@babylonjs/core/Materials/materialPluginBase"),require("@babylonjs/core/Materials/shaderMaterial"),require("@babylonjs/core/Materials/Textures/renderTargetTexture"),require("@babylonjs/core/Materials/multiMaterial"),require("@babylonjs/core/Meshes/subMesh"),require("@babylonjs/core/Misc/fileTools"),require("@babylonjs/core/Animations/animation"),require("@babylonjs/core/Animations/animationGroup"),require("@babylonjs/core/Animations/animationKey"),require("@babylonjs/core/Maths/math.axis"),require("@babylonjs/core/Physics/v1/physicsJoint"),require("@babylonjs/core/Physics/v1/Plugins/ammoJSPlugin"),require("@babylonjs/core/Physics/joinedPhysicsEngineComponent"),require("@babylonjs/core/Physics/v1/physicsEngineComponent"),require("@babylonjs/core/Meshes/abstractMesh"),require("@babylonjs/core/Physics/v1/physicsImpostor"),require("@babylonjs/core/Physics/v2/physicsEngineComponent"),require("@babylonjs/core/Meshes/transformNode"),require("@babylonjs/core/Physics/v2/IPhysicsEnginePlugin"),require("@babylonjs/core/Physics/v2/physicsBody"),require("@babylonjs/core/Physics/v2/physicsConstraint"),require("@babylonjs/core/Physics/v2/physicsShape"),require("@babylonjs/core/Cameras/camera")):e.BABYLONMMD=t(e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON)}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this,((e,t,n,i,o,r,a,s,l,h,d,c,m,u,p,g,f,_,b,y,A,M,T,w,x,v,I,B,P,R,C,O,F,S,E,k,N,D,L,U,V,W,z,K,j,Q,Y,q,H,G,$,X,J,Z,ee)=>(()=>{"use strict";var te={858:(e,t,n)=>{e.exports=n.p+"5dd17222f46109441022.wasm"},2524:(e,t,n)=>{e.exports=n.p+"87930dc726653707acc8.wasm"},7236:(e,t,n)=>{e.exports=n.p+"3debd244b0ab29361f66.wasm"},8754:(e,t,n)=>{e.exports=n.p+"64b4c4ffedd018183ce5.wasm"},4268:e=>{e.exports=L},1259:e=>{e.exports=U},6871:e=>{e.exports=V},6320:e=>{e.exports=M},6429:e=>{e.exports=T},3376:e=>{e.exports=n},1068:e=>{e.exports=ee},8619:e=>{e.exports=w},3843:e=>{e.exports=i},6532:e=>{e.exports=u},5918:e=>{e.exports=E},5197:e=>{e.exports=B},3272:e=>{e.exports=o},1308:e=>{e.exports=r},2388:e=>{e.exports=a},9127:e=>{e.exports=s},1860:e=>{e.exports=v},9430:e=>{e.exports=O},7203:e=>{e.exports=l},9190:e=>{e.exports=F},5527:e=>{e.exports=k},9866:e=>{e.exports=m},6837:e=>{e.exports=S},4229:e=>{e.exports=C},4619:e=>{e.exports=W},5501:e=>{e.exports=I},6377:e=>{e.exports=h},4439:e=>{e.exports=Y},3898:e=>{e.exports=p},3929:e=>{e.exports=g},6867:e=>{e.exports=f},3807:e=>{e.exports=N},4044:e=>{e.exports=G},4232:e=>{e.exports=D},4751:e=>{e.exports=x},7508:e=>{e.exports=P},7116:e=>{e.exports=R},7466:e=>{e.exports=_},8698:e=>{e.exports=b},1755:e=>{e.exports=y},5031:e=>{e.exports=j},2273:e=>{e.exports=K},9106:e=>{e.exports=Q},4398:e=>{e.exports=q},5905:e=>{e.exports=z},6970:e=>{e.exports=$},3466:e=>{e.exports=X},3301:e=>{e.exports=J},6247:e=>{e.exports=H},5755:e=>{e.exports=Z},7185:t=>{t.exports=e},3263:e=>{e.exports=t},9125:e=>{e.exports=A},7396:e=>{e.exports=d},2929:e=>{e.exports=c}},ne={};function ie(e){var t=ne[e];if(void 0!==t)return t.exports;var n=ne[e]={exports:{}};return te[e](n,n.exports,ie),n.exports}ie.m=te,ie.d=(e,t)=>{for(var n in t)ie.o(t,n)&&!ie.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},ie.u=e=>e+".babylon.mmd.min.js",ie.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),ie.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),ie.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;ie.g.importScripts&&(e=ie.g.location+"");var t=ie.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");if(n.length)for(var i=n.length-1;i>-1&&(!e||!/^http(s?):/.test(e));)e=n[i--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),ie.p=e})(),ie.b=document.baseURI||self.location.href;var oe={};return(()=>{ie.r(oe),ie.d(oe,{AnimationRetargeter:()=>Ct,BpmxConverter:()=>Tt,BpmxLoader:()=>xe,BpmxObject:()=>ye,BpmxReader:()=>we,BvmdConverter:()=>wt,BvmdLoader:()=>xt,ConsoleLogger:()=>w,DisplayTimeFormat:()=>yo,HumanoidMmd:()=>Oo,MixamoMmdHumanoidBoneMap:()=>Ot,MmdAmmoJSPlugin:()=>co,MmdAmmoPhysics:()=>bo,MmdAmmoPhysicsModel:()=>_o,MmdAnimation:()=>bt,MmdAnimationBase:()=>Oe,MmdAnimationSpan:()=>ve,MmdAnimationTrack:()=>it,MmdAsyncTextureLoader:()=>q,MmdBoneAnimationTrack:()=>ot,MmdCamera:()=>ko,MmdCameraAnimationGroup:()=>Ve,MmdCameraAnimationGroupBezierBuilder:()=>Ke,MmdCameraAnimationGroupHermiteBuilder:()=>We,MmdCameraAnimationGroupSampleBuilder:()=>ze,MmdCameraAnimationTrack:()=>st,MmdCompositeAnimation:()=>Ie,MmdCompositeRuntimeCameraAnimation:()=>Be,MmdCompositeRuntimeModelAnimation:()=>Ce,MmdHumanoidMapper:()=>St,MmdMesh:()=>yt,MmdModel:()=>zo,MmdModelAnimationGroup:()=>Xe,MmdModelAnimationGroupBezierBuilder:()=>tt,MmdModelAnimationGroupHermiteBuilder:()=>Ze,MmdModelAnimationGroupSampleBuilder:()=>et,MmdModelMetadata:()=>At,MmdMorphAnimationTrack:()=>at,MmdMorphController:()=>Vo,MmdMorphControllerBase:()=>Xi,MmdMovableBoneAnimationTrack:()=>rt,MmdPhysics:()=>Po,MmdPhysicsModel:()=>Bo,MmdPlayerControl:()=>Fo,MmdPropertyAnimationTrack:()=>lt,MmdRuntime:()=>Ko,MmdRuntimeAnimation:()=>Se,MmdRuntimeCameraAnimation:()=>Ee,MmdRuntimeCameraAnimationGroup:()=>Qe,MmdRuntimeModelAnimation:()=>qe,MmdRuntimeModelAnimationGroup:()=>nt,MmdStandardMaterial:()=>ee,MmdStandardMaterialBuilder:()=>he,MmdStandardMaterialProxy:()=>Zi,MmdStandardMaterialRenderMethod:()=>re,MmdWasmAnimation:()=>gt,MmdWasmAnimationTrack:()=>dt,MmdWasmBoneAnimationTrack:()=>ct,MmdWasmInstanceTypeMD:()=>wn,MmdWasmInstanceTypeMR:()=>ei,MmdWasmInstanceTypeSD:()=>Ri,MmdWasmInstanceTypeSR:()=>Yi,MmdWasmModel:()=>so,MmdWasmMorphAnimationTrack:()=>ut,MmdWasmMorphController:()=>Ji,MmdWasmMovableBoneAnimationTrack:()=>mt,MmdWasmPropertyAnimationTrack:()=>pt,MmdWasmRuntime:()=>io,MmdWasmRuntimeAnimationEvaluationType:()=>no,MmdWasmRuntimeBone:()=>ao,MmdWasmRuntimeModelAnimation:()=>ft,OiComputeTransformInjector:()=>So,PmdLoader:()=>ge,PmdReader:()=>v,PmxLoader:()=>be,PmxObject:()=>M,PmxReader:()=>_e,ReferenceFileResolver:()=>te,SdefInjector:()=>b,SharedToonTextures:()=>z,StreamAudioPlayer:()=>Nt,TextureAlphaChecker:()=>le,TransparencyMode:()=>ne,VmdData:()=>vt,VmdLoader:()=>Et,VmdObject:()=>It,VpdLoader:()=>kt,VpdReader:()=>Bt,VrmMmdHumanoidBoneMap:()=>Ft,getMmdWasmInstance:()=>$i});var e={};ie.r(e),ie.d(e,{AnimationPool:()=>mn,MmdRuntime:()=>pn,createAnimationPool:()=>en,createMmdRuntime:()=>Zt,default:()=>Tn,init:()=>Jt,initSync:()=>An,initThreadPool:()=>hn,wbg_rayon_PoolBuilder:()=>fn,wbg_rayon_start_worker:()=>dn});var t={};ie.r(t),ie.d(t,{AnimationPool:()=>Kn,MmdRuntime:()=>Qn,createAnimationPool:()=>Nn,createMmdRuntime:()=>kn,default:()=>Zn,init:()=>En,initSync:()=>Xn,initThreadPool:()=>Vn,wbg_rayon_PoolBuilder:()=>qn,wbg_rayon_start_worker:()=>Wn});var n={};ie.r(n),ie.d(n,{AnimationPool:()=>Mi,MmdRuntime:()=>wi,createAnimationPool:()=>mi,createMmdRuntime:()=>ci,default:()=>Pi,init:()=>di,initSync:()=>Ii});var i={};ie.r(i),ie.d(i,{AnimationPool:()=>Li,MmdRuntime:()=>Vi,createAnimationPool:()=>Ni,createMmdRuntime:()=>ki,default:()=>Qi,init:()=>Ei,initSync:()=>Ki}),ie(7185),ie(3263);var o=ie(3376),r=ie(3843),a=ie(3272),s=ie(1308),l=ie(2388),h=ie(9127),d=ie(7203),c=ie(6377),m=ie(7396),u=ie(2929);class p{static AdditionalUV1Kind="additionalUv1";static AdditionalUV2Kind="additionalUv2";static AdditionalUV3Kind="additionalUv3";static AdditionalUV4Kind="additionalUv4";static MatricesSdefCKind="matricesSdefC";static MatricesSdefR0Kind="matricesSdefR0";static MatricesSdefR1Kind="matricesSdefR1";static EdgeScaleKind="edgeScale"}var g=ie(9866);const f="\n#ifndef SDEFDECLARATION\n#define SDEFDECLARATION\n#if NUM_BONE_INFLUENCERS>0 && defined(SDEF)\nattribute vec3 matricesSdefC;attribute vec3 matricesSdefR0;attribute vec3 matricesSdefR1;vec4 rotationMatrixToQuaternion(mat3 matrix) {float trace=matrix[0][0]+matrix[1][1]+matrix[2][2];float s;float sqrtParam;if (trace>0.0) {sqrtParam=trace+1.0;} else if (matrix[0][0]>matrix[1][1] && matrix[0][0]>matrix[2][2]) {sqrtParam=1.0+matrix[0][0]-matrix[1][1]-matrix[2][2];} else if (matrix[1][1]>matrix[2][2]) {sqrtParam=1.0+matrix[1][1]-matrix[0][0]-matrix[2][2];} else {sqrtParam=1.0+matrix[2][2]-matrix[0][0]-matrix[1][1];}\nfloat sqrtValue=sqrt(sqrtParam);if (trace>0.0) {s=0.5/sqrtValue;return vec4(\n(matrix[1][2]-matrix[2][1])*s,\n(matrix[2][0]-matrix[0][2])*s,\n(matrix[0][1]-matrix[1][0])*s,\n0.25/s\n);} else if (matrix[0][0]>matrix[1][1] && matrix[0][0]>matrix[2][2]) {s=2.0*sqrtValue;return vec4(\n0.25*s,\n(matrix[0][1]+matrix[1][0])/s,\n(matrix[2][0]+matrix[0][2])/s,\n(matrix[1][2]-matrix[2][1])/s\n);} else if (matrix[1][1]>matrix[2][2]) {s=2.0*sqrtValue;return vec4(\n(matrix[0][1]+matrix[1][0])/s,\n0.25*s,\n(matrix[1][2]+matrix[2][1])/s,\n(matrix[2][0]-matrix[0][2])/s\n);} else {s=2.0*sqrtValue;return vec4(\n(matrix[2][0]+matrix[0][2])/s,\n(matrix[1][2]+matrix[2][1])/s,\n0.25*s,\n(matrix[0][1]-matrix[1][0])/s\n);}}\nmat3 quaternionToRotationMatrix(vec4 q) {float xx=q.x*q.x;float yy=q.y*q.y;float zz=q.z*q.z;float xy=q.x*q.y;float zw=q.z*q.w;float zx=q.z*q.x;float yw=q.y*q.w;float yz=q.y*q.z;float xw=q.x*q.w;return mat3(\n1.0-2.0*(yy+zz),2.0*(xy+zw),2.0*(zx-yw),\n2.0*(xy-zw),1.0-2.0*(zz+xx),2.0*(yz+xw),\n2.0*(zx+yw),2.0*(yz-xw),1.0-2.0*(yy+xx)\n);}\nvec4 slerp(vec4 q0,vec4 q1,float t) {float cosTheta=dot(q0,q1);q1=mix(-q1,q1,step(0.0,cosTheta));cosTheta=abs(cosTheta);if (cosTheta>0.999999) {return normalize(mix(q0,q1,t));}\nfloat theta=acos(cosTheta);float sinTheta=sin(theta);float w0=sin((1.0-t)*theta)/sinTheta;float w1=sin(t*theta)/sinTheta;return q0*w0+q1*w1;}\n#endif\n#endif\n",_="\n#ifndef SDEFVERTEX\n#define SDEFVERTEX\n#if !defined(BAKED_VERTEX_ANIMATION_TEXTURE) && defined(SDEF)\n#if NUM_BONE_INFLUENCERS>0\n{float weight0=matricesWeights[0];float weight1=matricesWeights[1];\n#ifdef BONETEXTURE\nmat4 transformMatrix0=readMatrixFromRawSampler(boneSampler,matricesIndices[0]);mat4 transformMatrix1=readMatrixFromRawSampler(boneSampler,matricesIndices[1]);\n#else\nmat4 transformMatrix0=mBones[int(matricesIndices[0])];mat4 transformMatrix1=mBones[int(matricesIndices[1])];\n#endif\nmat3 slerpedRotationMatrix=quaternionToRotationMatrix(slerp(\nrotationMatrixToQuaternion(mat3(transformMatrix0)),\nrotationMatrixToQuaternion(mat3(transformMatrix1)),\nweight1\n));mat4 sdefInflunce=mat4(\nvec4(1.0,0.0,0.0,0.0),\nvec4(0.0,1.0,0.0,0.0),\nvec4(0.0,0.0,1.0,0.0),\nvec4(-matricesSdefC,1.0)\n);mat4 rotationMatrix=mat4(\nvec4(slerpedRotationMatrix[0],0.0),\nvec4(slerpedRotationMatrix[1],0.0),\nvec4(slerpedRotationMatrix[2],0.0),\nvec4(0.0,0.0,0.0,1.0)\n);sdefInflunce=rotationMatrix*sdefInflunce;vec3 positionOffset =\nvec3(transformMatrix0*vec4(matricesSdefR0,1))*weight0 +\nvec3(transformMatrix1*vec4(matricesSdefR1,1))*weight1;sdefInflunce[3]+=vec4(positionOffset,0.0);float useLinearDeform=step(0.0,-abs(matricesSdefR0.x));influence=mat4(\nmix(sdefInflunce[0],influence[0],useLinearDeform),\nmix(sdefInflunce[1],influence[1],useLinearDeform),\nmix(sdefInflunce[2],influence[2],useLinearDeform),\nmix(sdefInflunce[3],influence[3],useLinearDeform)\n);}\n#endif\n#endif\n#endif\n";class b{static OverrideEngineCreateEffect(e){const t=e.createEffect.bind(e);e.createEffect=function(e,n,i,o,r,a,s,l,h,d=g.ShaderLanguage.GLSL){let c;if(c=n.attributes?n:{attributes:n,uniformsNames:i,uniformBuffersNames:[],samplers:o??[],defines:r??"",fallbacks:a??null,onCompiled:s??null,onError:l??null,indexParameters:h??null,shaderLanguage:d},(c.shaderLanguage===g.ShaderLanguage.GLSL||void 0===c.shaderLanguage)&&(c.uniformsNames.includes("mBones")||c.samplers.includes("boneSampler"))&&-1===c.defines.indexOf("#define SDEF")){c.attributes.push(p.MatricesSdefCKind),c.attributes.push(p.MatricesSdefR0Kind),c.attributes.push(p.MatricesSdefR1Kind),c.defines+="\n#define SDEF";const e=c.processCodeAfterIncludes;c.processCodeAfterIncludes=e?function(t,n){return n=e(t,n),b.ProcessSdefCode(t,n)}:b.ProcessSdefCode}return t(e,c,this)}}static ProcessSdefCode(e,t){if("vertex"!==e)return t;const n="#define CUSTOM_VERTEX_DEFINITIONS";if(t.includes(n))t=t.replace(n,`${n}\n${f}`);else{const e="void main() {";t=t.replace(e,`${f}\nvoid main() {`)}const i=new RegExp("finalWorld=finalWorld\\*influence;","g");return t.replace(i,`${_}\nfinalWorld=finalWorld*influence;`)}}l.Effect.RegisterShader("mmdOutline","\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nuniform vec4 color;\n#ifdef ALPHATEST\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#include<logDepthFragment>\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n","\nattribute vec3 position;attribute vec3 normal;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\nuniform float offset;\n#include<instancesDeclaration>\nuniform vec2 viewport;uniform mat3 view;uniform mat4 viewProjection;\n#ifdef WORLDPOS_REQUIRED\nuniform mat4 inverseViewProjection;\n#endif\n#ifdef ALPHATEST\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;vec3 normalUpdated=normal;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec3 viewNormal=view*(mat3(finalWorld)*normalUpdated);vec4 projectedPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vec2 screenNormal=normalize(vec2(viewNormal));projectedPosition.xy+=screenNormal/(viewport*0.25/*0.5 */)*offset*projectedPosition.w;gl_Position=projectedPosition;\n#ifdef WORLDPOS_REQUIRED\nvec4 worldPos=inverseViewProjection*projectedPosition;\n#endif\n#ifdef ALPHATEST\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n}\n"),m.Scene.prototype.getMmdOutlineRenderer=function(){return this._mmdOutlineRenderer||(this._mmdOutlineRenderer=new y(this)),this._mmdOutlineRenderer};class y{name="MmdOutline";scene;_engine;_passIdForDrawWrapper;constructor(e){this.scene=e,this._engine=e.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=this._engine.createRenderPassId("Mmd Outline Renderer")}register(){this.scene._afterRenderingMeshStage.registerStep(u.SceneComponentConstants.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)}rebuild(){}dispose(){this._engine.releaseRenderPassId(this._passIdForDrawWrapper)}static _ViewMatrix=new Float32Array(9);static _InverseViewProjectionMatrix=new c.Matrix;render(e,t,n){n=n??this._passIdForDrawWrapper;const i=this.scene,o=i.getEngine(),r=o.getCaps().instancedArrays&&(null!==t.visibleInstances[e._id]&&void 0!==t.visibleInstances[e._id]||e.getRenderingMesh().hasThinInstances);if(!this.isReady(e,r,n))return;const l=e.getMesh(),h=l._internalAbstractMeshDataInfo._actAsRegularMesh?l:null,c=e.getRenderingMesh(),m=h||c,u=e.getMaterial();if(!u||!i.activeCamera)return;const p=e._getDrawWrapper(n),g=s.DrawWrapper.GetEffect(p);o.enableEffect(p),u.useLogarithmicDepth&&g.setFloat("logarithmicDepthConstant",2/(Math.log(i.activeCamera.maxZ+1)/Math.LN2)),g.setFloat("offset",u.outlineWidth),g.setColor4("color",u.outlineColor,u.outlineAlpha);const f=o.getRenderHeight(),_=o.getRenderWidth();g.setFloat2("viewport",_,f);const b=y._ViewMatrix;{const e=i.getViewMatrix().m;b[0]=e[0],b[1]=e[1],b[2]=e[2],b[3]=e[4],b[4]=e[5],b[5]=e[6],b[6]=e[8],b[7]=e[9],b[8]=e[10]}if(g.setMatrix3x3("view",b),g.setMatrix("viewProjection",i.getTransformMatrix()),g.setMatrix("world",m.getWorldMatrix()),(0,d.BindBonesParameters)(m,g),c.morphTargetManager&&c.morphTargetManager.isUsingTextureForTargets&&c.morphTargetManager._bind(g),(0,d.BindMorphTargetParameters)(c,g),r||c._bind(e,g,u.fillMode),u&&u.needAlphaTesting()){const e=u.getAlphaTestTexture();e&&(g.setTexture("diffuseSampler",e),g.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,a.bindClipPlane)(g,u,i),g.defines.includes("WORLDPOS_REQUIRED")&&g.setMatrix("inverseViewProjection",i.getTransformMatrix().invertToRef(y._InverseViewProjectionMatrix)),c._processRendering(m,e,g,u.fillMode,t,r,((e,t)=>{g.setMatrix("world",t)}))}isReady(e,t,n){n=n??this._passIdForDrawWrapper;const i=[],r=[o.VertexBuffer.PositionKind,o.VertexBuffer.NormalKind],s=e.getMesh(),l=e.getMaterial();if(!l)return!1;const c=s.getScene();l.needAlphaTesting()&&(i.push("#define ALPHATEST"),s.isVerticesDataPresent(o.VertexBuffer.UVKind)&&(r.push(o.VertexBuffer.UVKind),i.push("#define UV1")),s.isVerticesDataPresent(o.VertexBuffer.UV2Kind)&&(r.push(o.VertexBuffer.UV2Kind),i.push("#define UV2"))),l.useLogarithmicDepth&&i.push("#define LOGARITHMICDEPTH"),(0,a.prepareStringDefinesForClipPlanes)(l,c,i);let m=!1;for(let e=0;e<i.length;++e)if(i[e].includes("CLIPPLANE")){m=!0;break}m&&i.push("#define WORLDPOS_REQUIRED");const u=new h.EffectFallbacks;if(s.useBones&&s.computeBonesUsingShaders&&s.skeleton){r.push(o.VertexBuffer.MatricesIndicesKind),r.push(o.VertexBuffer.MatricesWeightsKind),s.numBoneInfluencers>4&&(r.push(o.VertexBuffer.MatricesIndicesExtraKind),r.push(o.VertexBuffer.MatricesWeightsExtraKind)),s.isVerticesDataPresent(p.MatricesSdefCKind)&&(r.push(p.MatricesSdefCKind),r.push(p.MatricesSdefR0Kind),r.push(p.MatricesSdefR1Kind),i.push("#define SDEF"));const e=s.skeleton;i.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),s.numBoneInfluencers>0&&u.addCPUSkinningFallback(0,s),e.isUsingTextureForMatrices?i.push("#define BONETEXTURE"):i.push("#define BonesPerMesh "+(e.bones.length+1))}else i.push("#define NUM_BONE_INFLUENCERS 0");const g=s.morphTargetManager;let f=0;g&&(f=g.numMaxInfluencers||g.numInfluencers,f>0&&(i.push("#define MORPHTARGETS"),i.push("#define NUM_MORPH_INFLUENCERS "+f),g.isUsingTextureForTargets&&i.push("#define MORPHTARGETS_TEXTURE"),(0,d.PrepareAttributesForMorphTargetsInfluencers)(r,s,f))),t&&(i.push("#define INSTANCES"),(0,d.PushAttributesForInstances)(r),e.getRenderingMesh().hasThinInstances&&i.push("#define THIN_INSTANCES"));const _=e._getDrawWrapper(n,!0),y=_.defines,A=i.join("\n");if(y!==A){const e=["world","mBones","viewport","view","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","boneTextureWidth","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices"],t=["diffuseSampler","boneSampler","morphTargets"];(0,a.addClipPlaneUniforms)(e),m&&e.push("inverseViewProjection"),_.setEffect(this.scene.getEngine().createEffect("mmdOutline",{attributes:r,uniformsNames:e,samplers:t,defines:A,indexParameters:{maxSimultaneousMorphTargets:f},processCodeAfterIncludes:b.ProcessSdefCode},this.scene.getEngine()),A)}return _.effect.isReady()}_afterRenderingMesh(e,t,n){const i=t.getMaterial();if(null!==i&&i.renderOutline){const e=this._engine,i=e.getDepthWrite(),o=e.getAlphaMode();e.setDepthWrite(!0),e.setAlphaMode(r.Constants.ALPHA_COMBINE,!0),e.setState(!0,void 0,void 0,void 0,!!this.scene._mirroredCameraPosition),this.render(t,n,this._passIdForDrawWrapper),e.setAlphaMode(o,!0),e.setDepthWrite(i)}}}var A,M,T=ie(6532);class w{log(e){console.log(e)}warn(e){console.warn(e)}error(e){console.error(e)}}class x{isDeviceLittleEndian;_dataView;_decoder;_offset;constructor(e){this.isDeviceLittleEndian=this._getIsDeviceLittleEndian(),this._dataView=new DataView(e),this._decoder=null,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}_getIsDeviceLittleEndian(){const e=new Int16Array([256]);return 1===new Int8Array(e.buffer)[1]}swap16Array(e){for(let t=0;t<e.length;++t){const n=e[t];e[t]=(255&n)<<8|n>>8&255}}swap32Array(e){for(let t=0;t<e.length;++t){const n=e[t];e[t]=(255&n)<<24|(65280&n)<<8|n>>8&65280|n>>24&255}}getUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}getInt8(){const e=this._dataView.getInt8(this._offset);return this._offset+=1,e}getUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);e.set(t),this._offset+=e.byteLength}getUint16(){const e=this._dataView.getUint16(this._offset,!0);return this._offset+=2,e}getUint16Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap16Array(e)}getInt16(){const e=this._dataView.getInt16(this._offset,!0);return this._offset+=2,e}getUint32(){const e=this._dataView.getUint32(this._offset,!0);return this._offset+=4,e}getUint32Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap32Array(e)}getInt32(){const e=this._dataView.getInt32(this._offset,!0);return this._offset+=4,e}getInt32Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap32Array(e)}getFloat32(){const e=this._dataView.getFloat32(this._offset,!0);return this._offset+=4,e}getFloat32Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap32Array(e)}getFloat32Tuple(e){const t=new Array(e);for(let n=0;n<e;++n)t[n]=this._dataView.getFloat32(this._offset,!0),this._offset+=4;return t}initializeTextDecoder(e){this._decoder=new TextDecoder(e)}getDecoderString(e,t){if(null===this._decoder)throw new Error("TextDecoder is not initialized.");let n=new Uint8Array(this._dataView.buffer,this._offset,e);if(this._offset+=e,t)for(let e=0;e<n.length;++e)if(0===n[e]){n=n.subarray(0,e);break}return this._decoder.decode(n)}getSignatureString(e){const t=new TextDecoder("utf-8"),n=new Uint8Array(this._dataView.buffer,this._offset,e);return this._offset+=e,t.decode(n)}getPaddedArrayOffset(e,t){this._offset+=this._offset%e==0?0:e-this._offset%e;const n=this._offset;return this._offset+=e*t,n}get bytesAvailable(){return this._dataView.byteLength-this._offset}}!function(e){let t;!function(e){let t;!function(e){e[e.Rotate=0]="Rotate",e[e.RotateMove=1]="RotateMove",e[e.Ik=2]="Ik",e[e.Unknown=3]="Unknown",e[e.IkLink=4]="IkLink",e[e.RotateEffect=5]="RotateEffect",e[e.IkTo=6]="IkTo",e[e.Invisible=7]="Invisible",e[e.Twist=8]="Twist",e[e.RotateRatio=9]="RotateRatio"}(t=e.Type||(e.Type={}))}(t=e.Bone||(e.Bone={}))}(A||(A={})),function(e){let t,n,i,o,r,a,s,l,h;!function(e){let t;!function(e){e[e.Utf16le=0]="Utf16le",e[e.Utf8=1]="Utf8",e[e.ShiftJis=2]="ShiftJis"}(t=e.Encoding||(e.Encoding={}))}(t=e.Header||(e.Header={})),function(e){let t;!function(e){e[e.Bdef1=0]="Bdef1",e[e.Bdef2=1]="Bdef2",e[e.Bdef4=2]="Bdef4",e[e.Sdef=3]="Sdef",e[e.Qdef=4]="Qdef"}(t=e.BoneWeightType||(e.BoneWeightType={}))}(n=e.Vertex||(e.Vertex={})),function(e){let t,n;!function(e){e[e.IsDoubleSided=1]="IsDoubleSided",e[e.EnabledGroundShadow=2]="EnabledGroundShadow",e[e.EnabledDrawShadow=4]="EnabledDrawShadow",e[e.EnabledReceiveShadow=8]="EnabledReceiveShadow",e[e.EnabledToonEdge=16]="EnabledToonEdge",e[e.EnabledVertexColor=32]="EnabledVertexColor",e[e.EnabledPointDraw=64]="EnabledPointDraw",e[e.EnabledLineDraw=128]="EnabledLineDraw"}(t=e.Flag||(e.Flag={})),function(e){e[e.Off=0]="Off",e[e.Multiply=1]="Multiply",e[e.Add=2]="Add",e[e.SubTexture=3]="SubTexture"}(n=e.SphereTextureMode||(e.SphereTextureMode={}))}(i=e.Material||(e.Material={})),function(e){let t;!function(e){e[e.UseBoneIndexAsTailPosition=1]="UseBoneIndexAsTailPosition",e[e.IsRotatable=2]="IsRotatable",e[e.IsMovable=4]="IsMovable",e[e.IsVisible=8]="IsVisible",e[e.IsControllable=16]="IsControllable",e[e.IsIkEnabled=32]="IsIkEnabled",e[e.LocalAppendTransform=128]="LocalAppendTransform",e[e.HasAppendRotate=256]="HasAppendRotate",e[e.HasAppendMove=512]="HasAppendMove",e[e.HasAxisLimit=1024]="HasAxisLimit",e[e.HasLocalVector=2048]="HasLocalVector",e[e.TransformAfterPhysics=4096]="TransformAfterPhysics",e[e.IsExternalParentTransformed=8192]="IsExternalParentTransformed"}(t=e.Flag||(e.Flag={}))}(o=e.Bone||(e.Bone={})),function(e){let t,n,i;!function(e){e[e.System=0]="System",e[e.Eyebrow=1]="Eyebrow",e[e.Eye=2]="Eye",e[e.Lip=3]="Lip",e[e.Other=4]="Other"}(t=e.Category||(e.Category={})),function(e){e[e.GroupMorph=0]="GroupMorph",e[e.VertexMorph=1]="VertexMorph",e[e.BoneMorph=2]="BoneMorph",e[e.UvMorph=3]="UvMorph",e[e.AdditionalUvMorph1=4]="AdditionalUvMorph1",e[e.AdditionalUvMorph2=5]="AdditionalUvMorph2",e[e.AdditionalUvMorph3=6]="AdditionalUvMorph3",e[e.AdditionalUvMorph4=7]="AdditionalUvMorph4",e[e.MaterialMorph=8]="MaterialMorph",e[e.FlipMorph=9]="FlipMorph",e[e.ImpulseMorph=10]="ImpulseMorph"}(n=e.Type||(e.Type={})),function(e){let t;!function(e){e[e.Multiply=0]="Multiply",e[e.Add=1]="Add"}(t=e.Type||(e.Type={}))}(i=e.MaterialMorph||(e.MaterialMorph={}))}(r=e.Morph||(e.Morph={})),function(e){let t;!function(e){let t;!function(e){e[e.Bone=0]="Bone",e[e.Morph=1]="Morph"}(t=e.FrameType||(e.FrameType={}))}(t=e.FrameData||(e.FrameData={}))}(a=e.DisplayFrame||(e.DisplayFrame={})),function(e){let t,n;!function(e){e[e.Sphere=0]="Sphere",e[e.Box=1]="Box",e[e.Capsule=2]="Capsule"}(t=e.ShapeType||(e.ShapeType={})),function(e){e[e.FollowBone=0]="FollowBone",e[e.Physics=1]="Physics",e[e.PhysicsWithBone=2]="PhysicsWithBone"}(n=e.PhysicsMode||(e.PhysicsMode={}))}(s=e.RigidBody||(e.RigidBody={})),function(e){let t;!function(e){e[e.Spring6dof=0]="Spring6dof",e[e.Sixdof=1]="Sixdof",e[e.P2p=2]="P2p",e[e.ConeTwist=3]="ConeTwist",e[e.Slider=4]="Slider",e[e.Hinge=5]="Hinge"}(t=e.Type||(e.Type={}))}(l=e.Joint||(e.Joint={})),function(e){let t,n,i;!function(e){e[e.TriMesh=0]="TriMesh",e[e.Rope=1]="Rope"}(t=e.Type||(e.Type={})),function(e){e[e.Blink=1]="Blink",e[e.ClusterCreation=2]="ClusterCreation",e[e.LinkCrossing=4]="LinkCrossing"}(n=e.Flag||(e.Flag={})),function(e){e[e.VertexPoint=0]="VertexPoint",e[e.VertexTwoSided=1]="VertexTwoSided",e[e.VertexOneSided=2]="VertexOneSided",e[e.FaceTwoSided=3]="FaceTwoSided",e[e.FaceOneSided=4]="FaceOneSided"}(i=e.AeroDynamicModel||(e.AeroDynamicModel={}))}(h=e.SoftBody||(e.SoftBody={}))}(M||(M={}));class v{constructor(){}static async ParseAsync(e,t=new w){const n=new x(e);n.initializeTextDecoder("shift-jis");const i=this._ParseHeader(n),o=await this._ParseVerticesAsync(n),r=this._ParseIndices(n),a=this._ParseMaterials(n),s=this._ParseBones(n),l=this._ParseIks(n),h=this._ParseMorphs(n),[d,c]=this._ParseDisplayFrames(n,h);if(0===n.bytesAvailable){const e=[];return{header:i,vertices:o,indices:r,textures:e,materials:this._ConvertMaterials(a,e),bones:this._ConvertBones(s,l,o,d),morphs:h,displayFrames:d,rigidBodies:[],joints:[],softBodies:[]}}0!==n.getUint8()&&this._ParseEnglishNames(n,i,s,h,d,c);const m=this._ParseToonTextures(n),u=this._ConvertMaterials(a,m);if(0===n.bytesAvailable)return{header:i,vertices:o,indices:r,textures:m,materials:u,bones:this._ConvertBones(s,l,o,d),morphs:h,displayFrames:d,rigidBodies:[],joints:[],softBodies:[]};const p=this._ParseRigidBodies(n),g=this._ConvertBones(s,l,o,d,p);this._NormalizeRigidBodyPositions(p,g);const f=this._ParseJoints(n);return n.bytesAvailable>0&&t.warn(`There are ${n.bytesAvailable} bytes left after parsing`),{header:i,vertices:o,indices:r,textures:m,materials:u,bones:g,morphs:h,displayFrames:d,rigidBodies:p,joints:f,softBodies:[]}}static _ParseHeader(e){if(e.bytesAvailable<7)throw new Error("is not pmd file");const t=e.getSignatureString(3);if("Pmd"!==t)throw new Error("is not pmd file");const n=e.getFloat32(),i=e.getDecoderString(20,!0),o=e.getDecoderString(256,!0);return{signature:t,version:n,encoding:M.Header.Encoding.ShiftJis,additionalVec4Count:0,vertexIndexSize:2,textureIndexSize:4,materialIndexSize:4,boneIndexSize:2,morphIndexSize:2,rigidBodyIndexSize:4,modelName:i,englishModelName:"",comment:o,englishComment:""}}static async _ParseVerticesAsync(e){const t=e.getUint32(),n=[];let i=performance.now();for(let o=0;o<t;++o){const t=e.getFloat32Tuple(3),r=e.getFloat32Tuple(3),a=e.getFloat32Tuple(2),s=M.Vertex.BoneWeightType.Bdef2,l={boneIndices:[e.getUint16(),e.getUint16()],boneWeights:e.getUint8()/100},h=0!==e.getUint8();n.push({position:t,normal:r,uv:a,additionalVec4:[],weightType:s,boneWeight:l,edgeScale:h?1:0}),o%1e4==0&&100<performance.now()-i&&(await new Promise((e=>setTimeout(e,0))),i=performance.now())}return n}static _ParseIndices(e){const t=e.getUint32(),n=new Uint16Array(t);return e.getUint16Array(n),n}static _ParseMaterials(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getFloat32Tuple(4),i=e.getFloat32(),o=e.getFloat32Tuple(3),r=e.getFloat32Tuple(3),a=e.getInt8(),s=e.getUint8(),l=e.getUint32(),h=e.getDecoderString(20,!0);let d=0;0!==s&&(d|=M.Material.Flag.EnabledToonEdge|M.Material.Flag.EnabledGroundShadow),.98!==t[3]&&(d|=M.Material.Flag.EnabledDrawShadow|M.Material.Flag.EnabledReceiveShadow),t[3]<1&&(d|=M.Material.Flag.IsDoubleSided);let c=M.Material.SphereTextureMode.Off,m="",u="";{const e=h.split("*");for(let t=0;t<e.length;++t){const n=e[t];let i=M.Material.SphereTextureMode.Off;if(""!==n){const e=n.lastIndexOf("."),t=-1!==e?n.substring(e).toLowerCase():"";".sph"===t?i=M.Material.SphereTextureMode.Multiply:".spa"===t&&(i=M.Material.SphereTextureMode.Add)}i!==M.Material.SphereTextureMode.Off?(c=i,u=n):m=n}}const p={name:h,englishName:"",diffuse:t,specular:o,shininess:i,ambient:r,flag:d,edgeColor:[0,0,0,1],edgeSize:1,textureIndex:m,sphereTextureIndex:u,sphereTextureMode:c,isSharedToonTexture:!1,toonTextureIndex:a,comment:"",indexCount:l};n.push(p)}return n}static _ParseBones(e){const t=e.getUint16(),n=[];for(let i=0;i<t;++i){const t={name:e.getDecoderString(20,!0),englishName:"",parentBoneIndex:e.getInt16(),tailIndex:e.getInt16(),type:e.getUint8(),ikIndex:e.getInt16(),position:e.getFloat32Tuple(3)};n.push(t)}return n}static _ParseIks(e){const t=e.getUint16(),n=[];for(let i=0;i<t;++i){const t=e.getUint16(),i=e.getUint16(),o=e.getUint8(),r=e.getUint16(),a=e.getFloat32(),s=[];for(let t=0;t<o;++t)s.push(e.getUint16());const l={boneIndex:t,targetIndex:i,iteration:r,rotationConstraint:a,links:s};n.push(l)}return n}static _ParseMorphs(e){const t=e.getUint16();if(0===t)return[];const n=[];for(let i=0;i<t;++i){const t=e.getDecoderString(20,!0),i=e.getUint32();let o={name:t,englishName:"",category:e.getUint8(),type:M.Morph.Type.VertexMorph};const r=new Int32Array(i),a=new Float32Array(3*i);for(let t=0;t<i;++t)r[t]=e.getUint32(),a[3*t+0]=e.getFloat32(),a[3*t+1]=e.getFloat32(),a[3*t+2]=e.getFloat32();o={...o,indices:r,positions:a},n.push(o)}const i=n.shift().indices;for(let e=0;e<n.length;++e){const t=n[e].indices;for(let e=0;e<t.length;++e){const n=t[e];0<=n&&n<i.length?t[e]=i[n]:t[e]=0}}return n}static _ParseDisplayFrames(e,t){const n=[],i=e.getUint8();for(let o=0;o<i;++o){const i={type:M.DisplayFrame.FrameData.FrameType.Morph,index:e.getUint16()},o={name:t[i.index]?.name??"",englishName:"",isSpecialFrame:!0,frames:[i]};n.push(o)}const o=n.length,r=e.getUint8();for(let t=0;t<r;++t){const t={name:e.getDecoderString(50,!0),englishName:"",isSpecialFrame:!1,frames:void 0};n.push(t)}const a=e.getUint32();for(let t=0;t<a;++t){const t=e.getUint16(),i=n[o+e.getUint8()-1];if(void 0!==i){const e={type:M.DisplayFrame.FrameData.FrameType.Bone,index:t};void 0===i.frames?i.frames=[e]:i.frames.push(e)}}for(let e=o;e<n.length;++e){const t=n[e];void 0===t.frames&&(t.frames=[])}return[n,o]}static _ParseEnglishNames(e,t,n,i,o,r){t.englishModelName=e.getDecoderString(20,!0),t.englishComment=e.getDecoderString(256,!0);for(let t=0;t<n.length;++t)n[t].englishName=e.getDecoderString(20,!0);for(let t=0;t<i.length;++t)i[t].englishName=e.getDecoderString(20,!0);for(let t=r;t<o.length;++t)o[t].englishName=e.getDecoderString(50,!0)}static _ParseToonTextures(e){const t=[];for(let n=0;n<10;++n)t.push(e.getDecoderString(100,!0));return t}static _PathNormalize(e){const t=(e=e.replace(/\\/g,"/")).split("/"),n=[];for(let e=0;e<t.length;++e){const i=t[e];"."!==i&&(".."===i?n.pop():n.push(i))}return n.join("/").toLowerCase()}static _ConvertMaterials(e,t){const n=new Array(t.length);for(let e=0;e<t.length;++e)n[e]=this._PathNormalize(t[e]);for(let i=0;i<e.length;++i){const o=e[i];if(0<=o.toonTextureIndex&&o.toonTextureIndex<t.length){const e=n[o.toonTextureIndex];if(/toon(10|0[0-9])\.bmp/.test(e)){o.isSharedToonTexture=!0;let t=e.substring(e.length-6,e.length-4);"n"===t[0]&&(t=t[1]),o.toonTextureIndex=parseInt(t,10)-1}}}const i=new Map;for(let e=0;e<t.length;++e)i.set(this._PathNormalize(t[e]),e);for(let n=0;n<e.length;++n){const o=e[n];if(""!==o.textureIndex){const e=this._PathNormalize(o.textureIndex);let n=i.get(e);void 0===n&&(n=i.size,i.set(e,n),t.push(o.textureIndex)),o.textureIndex=n}else o.textureIndex=-1;if(""!==o.sphereTextureIndex){const e=this._PathNormalize(o.sphereTextureIndex);let n=i.get(e);void 0===n&&(n=i.size,i.set(e,n),t.push(o.sphereTextureIndex)),o.sphereTextureIndex=n}else o.sphereTextureIndex=-1}return e}static _IkAngleLimitTable=new Map(Object.entries({左ひざ:[-180,-.5,0,0,0,0],右ひざ:[-180,-.5,0,0,0,0]}));static _ConvertBones(e,t,n,i,o){const r=new Map;for(let n=0;n<t.length;++n){const i=t[n].boneIndex;0<=i&&i<e.length&&!r.has(i)&&r.set(i,n)}const a=[];for(let t=0;t<e.length;++t){const n=e[t],i={name:n.name,englishName:n.englishName,position:n.position,parentBoneIndex:n.parentBoneIndex,transformOrder:0,flag:M.Bone.Flag.UseBoneIndexAsTailPosition,tailPosition:n.tailIndex<=0?-1:n.tailIndex,appendTransform:void 0,axisLimit:void 0,localVector:void 0,externalParentTransform:void 0,ik:void 0};let o=r.has(t);switch(i.flag|=M.Bone.Flag.IsRotatable|M.Bone.Flag.IsVisible|M.Bone.Flag.IsControllable,i.flag&=~M.Bone.Flag.IsMovable&~M.Bone.Flag.IsIkEnabled&~M.Bone.Flag.HasAppendRotate&~M.Bone.Flag.HasAxisLimit,n.type){case A.Bone.Type.RotateMove:i.flag|=M.Bone.Flag.IsMovable;break;case A.Bone.Type.Ik:o=!0;break;case A.Bone.Type.RotateEffect:i.flag|=M.Bone.Flag.HasAppendRotate,i.flag&=~M.Bone.Flag.UseBoneIndexAsTailPosition&~M.Bone.Flag.IsVisible,i.appendTransform={parentIndex:n.tailIndex,ratio:.01*n.ikIndex}}o&&(i.flag|=M.Bone.Flag.IsMovable|M.Bone.Flag.IsIkEnabled,i.transformOrder=1),a.push(i)}let s=Math.min(a.length,e.length);for(let t=0;t<s;++t){const n=e[t],i=a[t];if(n.type===A.Bone.Type.Twist){let t=e[n.tailIndex];void 0===t&&(t=e[0]);const o=t.position,r=n.position;i.axisLimit=[o[0]-r[0],o[1]-r[1],o[2]-r[2]];const a=i.axisLimit,s=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=s,a[1]/=s,a[2]/=s,i.flag&=~M.Bone.Flag.UseBoneIndexAsTailPosition}}const l=[];for(let n=0;n<s;++n){const i=a[n];if(0==(i.flag&M.Bone.Flag.IsIkEnabled))continue;let o=0;for(let r=0;r<t.length;++r){const s=t[r];if(s.boneIndex!==n)continue;let h;0===o?(h=i,o+=1):(h={name:i.name+"+",englishName:i.englishName,position:[...i.position],parentBoneIndex:n,transformOrder:i.transformOrder,flag:i.flag&~M.Bone.Flag.IsVisible&~M.Bone.Flag.UseBoneIndexAsTailPosition,tailPosition:[0,0,0],appendTransform:void 0!==i.appendTransform?{...i.appendTransform}:void 0,axisLimit:void 0!==i.axisLimit?[...i.axisLimit]:void 0,localVector:void 0!==i.localVector?{x:[...i.localVector.x],z:[...i.localVector.z]}:void 0,externalParentTransform:i.externalParentTransform,ik:void 0},l.push(h),o+=1),void 0===h.ik&&(h.ik={target:0,iteration:0,rotationConstraint:0,links:[]});{const t=h.ik;t.target=s.targetIndex,t.iteration=s.iteration,t.rotationConstraint=4*s.rotationConstraint;const n=s.links;for(let i=0;i<n.length;++i){const o=n[i];if(0<=o&&o<a.length){const n={target:o,limitation:void 0};if(0<=o&&o<e.length){const t=e[o].name,i=this._IkAngleLimitTable.get(t);void 0!==i&&(n.limitation={minimumAngle:[i[0],i[2],i[4]],maximumAngle:[i[1],i[3],i[5]]})}t.links.push(n)}}}}}a.push(...l),s=Math.min(a.length,e.length);const h=[];for(let e=0;e<s;++e)if(0!=(a[e].flag&M.Bone.Flag.IsIkEnabled))for(let n=0;n<t.length;++n)if(t[n].boneIndex===e){h.push([e,n]);break}let d=!0;for(let e=0;e<h.length-1;++e)if(h[e][1]>h[e+1][1]){d=!1;break}if(!d){h.sort(((e,t)=>e[1]-t[1]));const e=new Array(h.length);for(let t=1;t<h.length;++t){let n=!0;(h[t-1][0]>h[t][0]||void 0!==e[t-1])&&(n=!1),n||(e[t]=a[h[t-1][0]])}const t=new Map;for(let n=0;n<e.length;++n){const i=e[n];void 0===i||t.has(i)||t.set(i,n)}const r=new Array(h.length);for(let e=0;e<h.length;++e)r[e]=a[h[e][0]];const s=a.slice();for(let n=0;0<t.size;++n){for(let n=1;n<h.length;++n)if(void 0!==e[n]&&void 0!==r[n]&&!t.has(r[n])){const i=r[n],o=a.indexOf(i);a.splice(o,1);const s=a.indexOf(e[n])+1;a.splice(s,0,i),t.delete(i)}if(h.length<n)break}const l=new Map;for(let e=0;e<a.length;++e){const t=a[e];l.set(t,e)}for(let e=0;e<n.length;++e){const t=n[e].boneWeight;if("number"==typeof t.boneIndices)t.boneIndices=l.get(s[t.boneIndices]);else{const e=t.boneIndices;for(let t=0;t<e.length;++t)e[t]=l.get(s[e[t]])}}for(let e=0;e<a.length;++e){const t=a[e];if(t.parentBoneIndex=l.get(s[t.parentBoneIndex]),"number"==typeof t.tailPosition&&(t.tailPosition=l.get(s[t.tailPosition])),t.appendTransform&&(t.appendTransform.parentIndex=l.get(s[t.appendTransform.parentIndex])),t.ik){t.ik.target=l.get(s[t.ik.target]);const e=t.ik.links;for(let t=0;t<e.length;++t)e[t].target=l.get(s[e[t].target])}}for(let e=0;e<i.length;++e){const t=i[e].frames;if(void 0!==t)for(let e=0;e<t.length;++e){const n=t[e];n.type===M.DisplayFrame.FrameData.FrameType.Bone&&(n.index=l.get(s[n.index]))}}if(void 0!==o)for(let e=0;e<o.length;++e){const t=o[e];t.boneIndex=l.get(s[t.boneIndex])}}let c=!1;for(let e=0;e<a.length;++e){let t=a[e];for(let n=0;n<a.length;++n){const i=a[n].parentBoneIndex;if(i===e){c=!0;break}if(t=a[i],void 0===t)break}if(c)break}if(c)for(let e=0;e<a.length;++e){let e=!1;for(let t=0;t<a.length;++t){const n=a[t];let i=n,o=n.transformOrder;for(;;){const t=a[i.parentBoneIndex];if(void 0===t)break;o<t.transformOrder&&(o=t.transformOrder,e=!0),i=t}n.transformOrder=o}if(!e)break}for(let e=0;e<a.length;++e){const t=a[e];0!=(t.flag&M.Bone.Flag.UseBoneIndexAsTailPosition)?"number"!=typeof t.tailPosition&&(t.tailPosition=-1):"number"==typeof t.tailPosition&&(t.tailPosition=[0,0,0])}return a}static _ParseRigidBodies(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t={name:e.getDecoderString(20,!0),englishName:"",boneIndex:e.getInt16(),collisionGroup:e.getUint8(),collisionMask:e.getUint16(),shapeType:e.getUint8(),shapeSize:e.getFloat32Tuple(3),shapePosition:e.getFloat32Tuple(3),shapeRotation:e.getFloat32Tuple(3),mass:e.getFloat32(),linearDamping:e.getFloat32(),angularDamping:e.getFloat32(),repulsion:e.getFloat32(),friction:e.getFloat32(),physicsMode:e.getUint8()};n.push(t)}return n}static _NormalizeRigidBodyPositions(e,t){for(let n=0;n<e.length;++n){const i=e[n],o=t[i.boneIndex<0?0:i.boneIndex].position,r=i.shapePosition;r[0]+=o[0],r[1]+=o[1],r[2]+=o[2]}}static _ParseJoints(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getDecoderString(20,!0),i=e.getInt32(),o=e.getInt32(),r=e.getFloat32Tuple(3),a=e.getFloat32Tuple(3),s=e.getFloat32Tuple(3),l=e.getFloat32Tuple(3),h=e.getFloat32Tuple(3),d=e.getFloat32Tuple(3),c=e.getFloat32Tuple(3),m=e.getFloat32Tuple(3),u={name:t,englishName:"",type:M.Joint.Type.Spring6dof,rigidbodyIndexA:i,rigidbodyIndexB:o,position:r,rotation:a,positionMin:s,positionMax:l,rotationMin:h,rotationMax:d,springPosition:c,springRotation:m};n.push(u)}return n}}var I=ie(3898),B=ie(3929),P=ie(6867),R=ie(7466),C=ie(8698),O=ie(1755),F=ie(9125),S=ie(6320),E=ie(6429),k=ie(8619),N=ie(4751),D=ie(1860),L=ie(5501),U=ie(5197),V=ie(7508),W=ie(7116);class z{static Data=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII="]}function K(e){const t=(e=e.replace(/\\/g,"/")).split("/"),n=[];for(let e=0;e<t.length;++e){const i=t[e];"."!==i&&(".."===i?n.pop():n.push(i))}return n.join("/")}class j{uniqueId;leftLoadCount;isRequesting;errorTextureDatas;constructor(e){this.uniqueId=e,this.leftLoadCount=0,this.isRequesting=!0,this.errorTextureDatas=[]}}class Q{observable;hasLoadError;constructor(){this.observable=new V.Observable,this.hasLoadError=!1}}class Y{cacheKey;_scene;_assetContainer;_options;_onLoad;_onError;_texture;constructor(e,t,n,i,o,r,a,s){this.cacheKey=e,this._scene=t,this._assetContainer=n,this._options=r,this._onLoad=a,this._onError=s,this._texture=null,o||t._loadFile(i,(i=>{this._createTexture(t,n,e,i,r,a,((e,t)=>{s?.(e,t)}))}),void 0,!0,!0,((e,t)=>{s?.(e?e.status+" "+e.statusText:"",t)}))}loadFromArrayBuffer(e){this._createTexture(this._scene,this._assetContainer,this.cacheKey,e,this._options,this._onLoad,((e,t)=>{this._onError?.(e,t)}))}_onDisposeCallback=null;registerOnDisposeCallback(e){this._onDisposeCallback=e,this._texture.onDisposeObservable.addOnce(e)}unregisterOnDisposeCallback(){const e=this._onDisposeCallback;return null===e?null:(this._onDisposeCallback=null,this._texture.onDisposeObservable.removeCallback(e),e)}_createTexture(e,t,n,i,o,r,a){e._blockEntityCollection=!!t;const s={noMipmap:o.noMipmap,invertY:o.invertY,samplingMode:o.samplingMode,onLoad:()=>{null===this._texture?null!==r&&W.TimingTools.SetImmediate(r):r?.()},onError:a,buffer:i,deleteBuffer:o.deleteBuffer,format:o.format,mimeType:o.mimeType},l=this._texture=new U.Texture("data:"+n,e,s);l._parentContainer=t,e._blockEntityCollection=!1,t?.textures.push(l),l.name=n}get texture(){return this._texture}}class q{onModelTextureLoadedObservable=new Map;textureCache=new Map;_textureLoadInfoMap=new Map;_loadingModels=new Map;_errorTexturesReferenceCount=new Map;_incrementLeftLoadCount(e){let t=this._loadingModels.get(e);void 0===t&&(t=new j(e),this._loadingModels.set(e,t)),t.leftLoadCount+=1;let n=this.onModelTextureLoadedObservable.get(e);return void 0===n&&(n=new V.Observable,this.onModelTextureLoadedObservable.set(e,n)),t}_decrementLeftLoadCount(e){if(e.leftLoadCount-=1,!e.isRequesting&&0===e.leftLoadCount){this._removeErrorTexturesReferenceCount(e.uniqueId),this._loadingModels.delete(e.uniqueId);const t=this.onModelTextureLoadedObservable.get(e.uniqueId);t?.notifyObservers(),t?.clear(),this.onModelTextureLoadedObservable.delete(e.uniqueId)}}loadModelTexturesEnd(e){const t=this._loadingModels.get(e);if(void 0!==t&&(t.isRequesting=!1,0===t.leftLoadCount)){this._removeErrorTexturesReferenceCount(e),this._loadingModels.delete(e);const t=this.onModelTextureLoadedObservable.get(e);t?.notifyObservers(),t?.clear(),this.onModelTextureLoadedObservable.delete(e)}}_addErrorTextureReferenceCount(e,t){this._loadingModels.get(e).errorTextureDatas.push(t),this._errorTexturesReferenceCount.set(t,(this._errorTexturesReferenceCount.get(t)??0)+1)}_removeErrorTexturesReferenceCount(e){const t=this._loadingModels.get(e);for(let e=0;e<t.errorTextureDatas.length;++e){const n=t.errorTextureDatas[e],i=this._errorTexturesReferenceCount.get(n)-1;0===i?null!==n.texture?n.texture.dispose():(this._textureLoadInfoMap.delete(n.cacheKey),this.textureCache.delete(n.cacheKey),this._errorTexturesReferenceCount.delete(n)):this._errorTexturesReferenceCount.set(n,i)}}_handleTextureOnDispose(e){e.registerOnDisposeCallback((()=>{this._textureLoadInfoMap.delete(e.cacheKey),this.textureCache.delete(e.cacheKey),this._errorTexturesReferenceCount.delete(e)}))}_createTextureCacheKey(e,t){const n=e.lastIndexOf(".");let i="";return-1!==n&&(i=e.substring(n),e=e.substring(0,n)),e+ +(t.noMipmap??!1)+ +(t.invertY??!0)+(t.samplingMode??U.Texture.TRILINEAR_SAMPLINGMODE)+(t.format??r.Constants.TEXTUREFORMAT_RGBA)+i}async _loadTextureAsyncInternal(e,t,n,i,o,r,a){const s=this._incrementLeftLoadCount(e),l=this._createTextureCacheKey(t,a);let h=this._textureLoadInfoMap.get(l);void 0===h&&(h=new Q,this._textureLoadInfoMap.set(l,h));let d=this.textureCache.get(l);if(void 0===d&&!h.hasLoadError){const s=null!==i?z.Data[i]:t;d=new Y(l,o,r,s,null!==n,a,(()=>{this._handleTextureOnDispose(d),h.hasLoadError=!1,h.observable.notifyObservers(!1),h.observable.clear()}),((t,n)=>{null!==d.texture&&this._handleTextureOnDispose(d),this._addErrorTextureReferenceCount(e,d),h.hasLoadError=!0,h.observable.notifyObservers(!0),h.observable.clear()})),this.textureCache.set(l,d);const c=n instanceof Blob?await n.arrayBuffer():n;null!==c&&d.loadFromArrayBuffer(c)}return null!==d.texture&&d.texture.isReady()?(this._decrementLeftLoadCount(s),h.hasLoadError?null:d.texture):new Promise((e=>{h.observable.addOnce((t=>{this._decrementLeftLoadCount(s),e(t?null:d.texture)}))}))}async loadTextureAsync(e,t,n,i,o,r){let a;"number"==typeof n?((n<-1||9<n)&&(n=-1),n+=1,a=!0):a=!1;const s=a?a?"file:shared_toon_texture_"+n:n:K(t+n);return await this._loadTextureAsyncInternal(e,s,null,a?n:null,i,o,r)}async loadTextureFromBufferAsync(e,t,n,i,o,r,a=!0){return a&&(t=K(t)),await this._loadTextureAsyncInternal(e,t,n,null,i,o,r)}}var H,G=ie(4229),$=ie(9430),X=ie(9190);class J extends $.MaterialDefines{SPHERE_TEXTURE=!1;SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=!1;SPHERE_TEXTURE_BLEND_MODE_ADD=!1;TOON_TEXTURE=!1;IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=!1;APPLY_AMBIENT_COLOR_TO_DIFFUSE=!1;TEXTURE_COLOR=!1;SPHERE_TEXTURE_COLOR=!1;TOON_TEXTURE_COLOR=!1;SDEF=!1}!function(e){e[e.Multiply=1]="Multiply",e[e.Add=2]="Add",e[e.SubTexture=3]="SubTexture"}(H||(H={}));class Z extends X.MaterialPluginBase{_sphereTexture=null;_sphereTextureBlendMode=H.Add;_toonTexture=null;_ignoreDiffuseWhenToonTextureIsNull=!1;textureMultiplicativeColor=new L.Color4(1,1,1,1);textureAdditiveColor=new L.Color4(0,0,0,0);sphereTextureMultiplicativeColor=new L.Color4(1,1,1,1);sphereTextureAdditiveColor=new L.Color4(0,0,0,0);toonTextureMultiplicativeColor=new L.Color4(1,1,1,1);toonTextureAdditiveColor=new L.Color4(0,0,0,0);_applyAmbientColorToDiffuse=!0;_useTextureColor=!1;_useSphereTextureColor=!1;_useToonTextureColor=!1;_isEnabled=!1;get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this.markAllDefinesAsDirty(),this._enable(e))}get sphereTexture(){return this._sphereTexture}set sphereTexture(e){this._sphereTexture!==e&&(this._sphereTexture=e,this.markAllSubMeshesAsTexturesDirty())}get sphereTextureBlendMode(){return this._sphereTextureBlendMode}set sphereTextureBlendMode(e){this._sphereTextureBlendMode!==e&&(this._sphereTextureBlendMode=e,this.markAllDefinesAsDirty())}get toonTexture(){return this._toonTexture}set toonTexture(e){this._toonTexture!==e&&(this._toonTexture=e,this.markAllSubMeshesAsTexturesDirty())}get ignoreDiffuseWhenToonTextureIsNull(){return this._ignoreDiffuseWhenToonTextureIsNull}set ignoreDiffuseWhenToonTextureIsNull(e){this._ignoreDiffuseWhenToonTextureIsNull!==e&&(this._ignoreDiffuseWhenToonTextureIsNull=e,this.markAllDefinesAsDirty())}get applyAmbientColorToDiffuse(){return this._applyAmbientColorToDiffuse}set applyAmbientColorToDiffuse(e){this._applyAmbientColorToDiffuse!==e&&(this._applyAmbientColorToDiffuse=e,this.markAllDefinesAsDirty())}get useTextureColor(){return this._useTextureColor}set useTextureColor(e){this._useTextureColor!==e&&(this._useTextureColor=e,this.markAllDefinesAsDirty())}get useSphereTextureColor(){return this._useSphereTextureColor}set useSphereTextureColor(e){this._useSphereTextureColor!==e&&(this._useSphereTextureColor=e,this.markAllDefinesAsDirty())}get useToonTextureColor(){return this._useToonTextureColor}set useToonTextureColor(e){this._useToonTextureColor!==e&&(this._useToonTextureColor=e,this.markAllDefinesAsDirty())}_internalMarkAllSubMeshesAsTexturesDirty;markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"MmdMaterial",100,new J,t),this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[r.Constants.MATERIAL_TextureDirtyFlag]}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&this._sphereTexture&&!this._sphereTexture.isReadyOrNotBlocking())}bindForSubMesh(e,t,n,i){if(!this._isEnabled)return;const o=i.materialDefines,r=this._material.isFrozen;e.useUbo&&r&&e.isSync||(o.DIFFUSE&&o.TEXTURE_COLOR&&(e.updateDirectColor4("textureMultiplicativeColor",this.textureMultiplicativeColor),e.updateDirectColor4("textureAdditiveColor",this.textureAdditiveColor)),o.NORMAL&&o.SPHERE_TEXTURE&&o.SPHERE_TEXTURE_COLOR&&(e.updateDirectColor4("sphereTextureMultiplicativeColor",this.sphereTextureMultiplicativeColor),e.updateDirectColor4("sphereTextureAdditiveColor",this.sphereTextureAdditiveColor)),o.TOON_TEXTURE&&o.TOON_TEXTURE_COLOR&&(e.updateDirectColor4("toonTextureMultiplicativeColor",this.toonTextureMultiplicativeColor),e.updateDirectColor4("toonTextureAdditiveColor",this.toonTextureAdditiveColor)),o.SPHERE_TEXTURE&&null!==i.effect&&this._material.bindView(i.effect)),t.texturesEnabled&&(o.NORMAL&&this._sphereTexture&&e.setTexture("sphereSampler",this._sphereTexture),this._toonTexture&&e.setTexture("toonSampler",this._toonTexture))}dispose(e){e&&(this._sphereTexture?.dispose(),this._toonTexture?.dispose())}getCustomCode(e){if("vertex"===e){const e={};return e.CUSTOM_VERTEX_DEFINITIONS=f,e[`!${this._escapeRegExp("finalWorld=finalWorld*influence;")}`]=`\n${_}\nfinalWorld=(finalWorld*influence);\n`,e}if("fragment"===e){const e={CUSTOM_FRAGMENT_DEFINITIONS:"\n#if defined(SPHERE_TEXTURE) && defined(NORMAL)\nuniform sampler2D sphereSampler;\n#endif\n#ifdef TOON_TEXTURE\nuniform sampler2D toonSampler;\n#endif\n",CUSTOM_FRAGMENT_MAIN_BEGIN:"\n#ifdef TOON_TEXTURE\nvec3 toonNdl;\n#endif\n"};e[`!${this._escapeRegExp("#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif")}`]="\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#elif defined(NORMAL) && defined(SPHERE_TEXTURE)\nuniform mat4 view;\n#endif\n",e[`!${this._escapeRegExp("vec3 diffuseColor=vDiffuseColor.rgb;")}`]="\n#ifdef APPLY_AMBIENT_COLOR_TO_DIFFUSE\nvec3 diffuseColor=clamp(vDiffuseColor.rgb+vAmbientColor,0.0,1.0);\n#else\nvec3 diffuseColor=(vDiffuseColor.rgb);\n#endif\n",e[`!${this._escapeRegExp("baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);")}`]="\n#if defined(DIFFUSE) && defined(TEXTURE_COLOR)\nbaseColor=texture2D(diffuseSampler,(vDiffuseUV+uvOffset));baseColor.rgb=mix(\nvec3(1.0),\nbaseColor.rgb*textureMultiplicativeColor.rgb,\ntextureMultiplicativeColor.a\n);baseColor.rgb=clamp(\nbaseColor.rgb+(baseColor.rgb-vec3(1.0))*textureAdditiveColor.a,\n0.0,\n1.0\n)+textureAdditiveColor.rgb;\n#else\nbaseColor=texture2D(diffuseSampler,(vDiffuseUV+uvOffset));\n#endif\n",e[`!${this._escapeRegExp("struct lightingInfo\n{")}`]="\nstruct lightingInfo {\n#ifdef TOON_TEXTURE\n#if !defined(NDOTL)\nfloat ndl;\n#endif\nfloat isToon;\n#endif\n",e[`!${this._escapeRegExp("result.diffuse=ndl*diffuseColor*attenuation;")}`]="\n#ifdef TOON_TEXTURE\nresult.diffuse=diffuseColor*attenuation;result.ndl=ndl;result.isToon=1.0;\n#elif defined(IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED) \nresult.diffuse=diffuseColor*attenuation;\n#else\nresult.diffuse=(ndl*diffuseColor*attenuation);\n#endif\n",e[`!${this._escapeRegExp("diffuseBase+=info.diffuse*shadow;")}`]="\n#ifdef TOON_TEXTURE\ntoonNdl=vec3(clamp(info.ndl*shadow,0.02,0.98));toonNdl.r=texture2D(toonSampler,vec2(0.5,toonNdl.r)).r;toonNdl.g=texture2D(toonSampler,vec2(0.5,toonNdl.g)).g;toonNdl.b=texture2D(toonSampler,vec2(0.5,toonNdl.b)).b;\n#ifdef TOON_TEXTURE_COLOR\ntoonNdl=mix(\nvec3(1.0),\ntoonNdl*toonTextureMultiplicativeColor.rgb,\ntoonTextureMultiplicativeColor.a\n);toonNdl=clamp(\ntoonNdl+(toonNdl-vec3(1.0))*toonTextureAdditiveColor.a,\n0.0,\n1.0\n)+toonTextureAdditiveColor.rgb;\n#endif\ndiffuseBase+=mix(info.diffuse*shadow,toonNdl*info.diffuse,info.isToon);\n#elif defined(IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED)\ndiffuseBase+=info.diffuse;\n#else\ndiffuseBase+=(info.diffuse*shadow);\n#endif\n";const t="\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n";return e[`!${this._escapeRegExp(t)}`]=`\n#ifdef APPLY_AMBIENT_COLOR_TO_DIFFUSE\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n#else\n${t.replace("diffuseBase","(diffuseBase)")}#endif\n`,e.CUSTOM_FRAGMENT_BEFORE_FOG="\n#if defined(NORMAL) && defined(SPHERE_TEXTURE)\nvec3 viewSpaceNormal=normalize(mat3(view)*vNormalW);vec2 sphereUV=viewSpaceNormal.xy*0.5+0.5;vec4 sphereReflectionColor=texture2D(sphereSampler,sphereUV);\n#ifdef SPHERE_TEXTURE_COLOR\nsphereReflectionColor.rgb=mix(\nvec3(1.0),\nsphereReflectionColor.rgb*sphereTextureMultiplicativeColor.rgb,\nsphereTextureMultiplicativeColor.a\n);sphereReflectionColor.rgb=clamp(\nsphereReflectionColor.rgb+(sphereReflectionColor.rgb-vec3(1.0))*sphereTextureAdditiveColor.a,\n0.0,\n1.0\n)+sphereTextureAdditiveColor.rgb;\n#endif\nsphereReflectionColor.rgb*=diffuseBase;\n#ifdef SPHERE_TEXTURE_BLEND_MODE_MULTIPLY\ncolor*=sphereReflectionColor;\n#elif defined(SPHERE_TEXTURE_BLEND_MODE_ADD)\ncolor=vec4(color.rgb+sphereReflectionColor.rgb,color.a);\n#endif\n#endif\n",e}return null}prepareDefines(e,t,n){if(this._isEnabled){const i=t.texturesEnabled;e.SPHERE_TEXTURE=null!==this._sphereTexture&&i,e.SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=this._sphereTextureBlendMode===H.Multiply,e.SPHERE_TEXTURE_BLEND_MODE_ADD=this._sphereTextureBlendMode===H.Add,e.TOON_TEXTURE=null!==this._toonTexture&&i,e.IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=this._ignoreDiffuseWhenToonTextureIsNull,e.APPLY_AMBIENT_COLOR_TO_DIFFUSE=this._applyAmbientColorToDiffuse,e.TEXTURE_COLOR=this._useTextureColor,e.SPHERE_TEXTURE_COLOR=this._useSphereTextureColor,e.TOON_TEXTURE_COLOR=this._useToonTextureColor,e.SDEF=n.useBones&&n.computeBonesUsingShaders&&!!n.skeleton&&n.isVerticesDataPresent(p.MatricesSdefCKind)}else e.SPHERE_TEXTURE=!1,e.SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=!1,e.SPHERE_TEXTURE_BLEND_MODE_ADD=!1,e.TOON_TEXTURE=!1,e.IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=!1,e.APPLY_AMBIENT_COLOR_TO_DIFFUSE=!1,e.TEXTURE_COLOR=!1,e.SPHERE_TEXTURE_COLOR=!1,e.TOON_TEXTURE_COLOR=!1,e.SDEF=!1}hasTexture(e){return this._sphereTexture===e||this._toonTexture===e}getActiveTextures(e){this._sphereTexture&&e.push(this._sphereTexture),this._toonTexture&&e.push(this._toonTexture)}getAnimatables(e){this._sphereTexture&&this._sphereTexture.animations&&0<this._sphereTexture.animations.length&&e.push(this._sphereTexture),this._toonTexture&&this._toonTexture.animations&&0<this._toonTexture.animations.length&&e.push(this._toonTexture)}getSamplers(e){e.push("sphereSampler","toonSampler")}getAttributes(e,t,n){this._isEnabled&&n.useBones&&n.computeBonesUsingShaders&&n.skeleton&&n.isVerticesDataPresent(p.MatricesSdefCKind)&&(e.push(p.MatricesSdefCKind),e.push(p.MatricesSdefR0Kind),e.push(p.MatricesSdefR1Kind))}getUniforms(){return{ubo:[{name:"textureMultiplicativeColor",size:4,type:"vec4"},{name:"textureAdditiveColor",size:4,type:"vec4"},{name:"sphereTextureMultiplicativeColor",size:4,type:"vec4"},{name:"sphereTextureAdditiveColor",size:4,type:"vec4"},{name:"toonTextureMultiplicativeColor",size:4,type:"vec4"},{name:"toonTextureAdditiveColor",size:4,type:"vec4"}],fragment:"\n#if defined(DIFFUSE) && defined(TEXTURE_COLOR)\nuniform vec4 textureMultiplicativeColor;uniform vec4 textureAdditiveColor;\n#endif\n#if defined(SPHERE_TEXTURE) && defined(SPHERE_TEXTURE_COLOR)\nuniform vec4 sphereTextureMultiplicativeColor;uniform vec4 sphereTextureAdditiveColor;\n#endif\n#if defined(TOON_TEXTURE) && defined(TOON_TEXTURE_COLOR)\nuniform vec4 toonTextureMultiplicativeColor;uniform vec4 toonTextureAdditiveColor;\n#endif\n"}}getClassName(){return"MmdPluginMaterial"}_escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}}class ee extends G.StandardMaterial{_pluginMaterial;_renderOutline=!1;outlineWidth=.01;outlineColor=new L.Color3(0,0,0);outlineAlpha=1;constructor(e,t){super(e,t),this.specularColor=new L.Color3(0,0,0);const n=this._pluginMaterial=new Z(this);n.isEnabled=!0,n.ignoreDiffuseWhenToonTextureIsNull=!0}get sphereTexture(){return this._pluginMaterial.sphereTexture}set sphereTexture(e){this._pluginMaterial.sphereTexture=e}get sphereTextureBlendMode(){return this._pluginMaterial.sphereTextureBlendMode}set sphereTextureBlendMode(e){this._pluginMaterial.sphereTextureBlendMode=e}get toonTexture(){return this._pluginMaterial.toonTexture}set toonTexture(e){this._pluginMaterial.toonTexture=e}get ignoreDiffuseWhenToonTextureIsNull(){return this._pluginMaterial.ignoreDiffuseWhenToonTextureIsNull}set ignoreDiffuseWhenToonTextureIsNull(e){this._pluginMaterial.ignoreDiffuseWhenToonTextureIsNull=e}get applyAmbientColorToDiffuse(){return this._pluginMaterial.applyAmbientColorToDiffuse}set applyAmbientColorToDiffuse(e){this._pluginMaterial.applyAmbientColorToDiffuse=e}get textureMultiplicativeColor(){return this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureMultiplicativeColor}set textureMultiplicativeColor(e){this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureMultiplicativeColor=e}get textureAdditiveColor(){return this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureAdditiveColor}set textureAdditiveColor(e){this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureAdditiveColor=e}get sphereTextureMultiplicativeColor(){return this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureMultiplicativeColor}set sphereTextureMultiplicativeColor(e){this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureMultiplicativeColor=e}get sphereTextureAdditiveColor(){return this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureAdditiveColor}set sphereTextureAdditiveColor(e){this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureAdditiveColor=e}get toonTextureMultiplicativeColor(){return this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureMultiplicativeColor}set toonTextureMultiplicativeColor(e){this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureMultiplicativeColor=e}get toonTextureAdditiveColor(){return this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureAdditiveColor}set toonTextureAdditiveColor(e){this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureAdditiveColor=e}get renderOutline(){return this._renderOutline}set renderOutline(e){e&&this.getScene().getMmdOutlineRenderer?.(),this._renderOutline=e}needAlphaBlending(){return!this._disableAlphaBlending&&(super.needAlphaBlending()||null!==this._pluginMaterial.sphereTexture&&this._pluginMaterial.sphereTextureBlendMode===H.Multiply)}}class te{files;_fileRootId;_fileMap=new Map;constructor(e,t,n){if(t=K(t),this.files=e,this._fileRootId=n,0!==e.length)if(e[0]instanceof File)for(const i of e){const e=K(i.webkitRelativePath);if(!e.startsWith(t))continue;const o=n+K(e.slice(t.length));this._fileMap.set(K(o).toUpperCase(),i)}else for(const t of e){const e=n+K(t.relativePath);this._fileMap.set(K(e).toUpperCase(),t)}}createFullPath(e){return this._fileRootId+K(e)}resolve(e){const t=K(e);return this._fileMap.get(t.toUpperCase())}}var ne,re,ae=ie(6837),se=ie(5918);!function(e){e[e.Opaque=D.Material.MATERIAL_OPAQUE]="Opaque",e[e.AlphaTest=D.Material.MATERIAL_ALPHATEST]="AlphaTest",e[e.AlphaBlend=D.Material.MATERIAL_ALPHABLEND]="AlphaBlend"}(ne||(ne={}));class le{_scene;_renderTargetTexture;_resultPixelsBuffer;constructor(e,t=512){this._scene=e;const n=e.getEngine(),i=this._renderTargetTexture=new se.RenderTargetTexture("texture_alpha_checker",t,e,{generateDepthBuffer:!1,generateStencilBuffer:!1,generateMipMaps:!1,type:r.Constants.TEXTURETYPE_UNSIGNED_BYTE,format:n.isWebGPU||n.version>1?r.Constants.TEXTUREFORMAT_RED:r.Constants.TEXTUREFORMAT_RGBA,doNotChangeAspectRatio:!0});i.noPrePassRenderer=!0,i.anisotropicFilteringLevel=1,i.renderParticles=!1,i.optimizeUVAllocation=!0,i.ignoreCameraViewport=!0,i.clearColor=new L.Color4(0,0,0,1),this._resultPixelsBuffer=new Uint8Array(t*t*4)}async _renderTexture(e,t,n){const i=le._GetShader(this._scene);i.setTexture("textureSampler",e);let o=null;null!==n&&(o=t.subMeshes,t.subMeshes=[t.subMeshes[n]]);const r=this._renderTargetTexture;r.renderList=[t],r.setMaterialForRendering(t,i);const a=t._internalAbstractMeshDataInfo._currentLODIsUpToDate,s=t._internalAbstractMeshDataInfo._currentLOD;t._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,t._internalAbstractMeshDataInfo._currentLOD=t;const l=t._nodeDataStorage._isEnabled,h=t._nodeDataStorage._isParentEnabled;t._nodeDataStorage._isEnabled=!0,t._nodeDataStorage._isParentEnabled=!0,r.render(!1,!1),t._nodeDataStorage._isParentEnabled=h,t._nodeDataStorage._isEnabled=l,t._internalAbstractMeshDataInfo._currentLOD=s,t._internalAbstractMeshDataInfo._currentLODIsUpToDate=a;const d=i.getEffect();t.geometry._releaseVertexArrayObject(d);const c=t.subMeshes;for(let e=0,t=c.length;e<t;++e)c[e]._removeDrawWrapper(r.renderPassId,!0);null!==o&&(t.subMeshes=o);const m=this._resultPixelsBuffer;return await r.readPixels(void 0,void 0,m),m}_blockRendering=!1;_taskQueue=[];async hasTranslucentFragmentsOnGeometry(e,t,n,i,o){if(!e.isReady())throw new Error("Texture is not ready");this._blockRendering&&await new Promise((e=>{this._taskQueue.push(e)})),this._blockRendering=!0;const r=await this._renderTexture(e,t,n);let a=0,s=0,l=0;for(let e=0;e<r.length;e+=4){const t=r[e];a=Math.max(a,t),0<t&&t<255&&(s+=t,l+=1)}0!==l&&(s/=l),this._blockRendering=!1;const h=this._taskQueue.shift();return void 0!==h&&h(),a<i?ne.Opaque:s+o<a?ne.AlphaTest:ne.AlphaBlend}async hasFragmentsOnlyOpaqueOnGeometry(e,t,n){if(!e.isReady())throw new Error("Texture is not ready");this._blockRendering&&await new Promise((e=>{this._taskQueue.push(e)})),this._blockRendering=!0;const i=await this._renderTexture(e,t,n);for(let e=0;e<i.length;e+=4)if(0!==i[e]){this._blockRendering=!1;const e=this._taskQueue.shift();return void 0!==e&&e(),!1}this._blockRendering=!1;const o=this._taskQueue.shift();return void 0!==o&&o(),!0}dispose(){this._renderTargetTexture.dispose()}static _GetShader(e){if(!e._textureAlphaCheckerShader){const t=new ae.ShaderMaterial("textureAlphaCheckerShader",e,{vertexSource:"\nprecision highp float;attribute vec2 uv;varying vec2 vUv;void main() {vUv=uv;gl_Position=vec4(mod(uv,1.0)*2.0-1.0,0.0,1.0);}\n",fragmentSource:"\nprecision highp float;uniform sampler2D textureSampler;varying vec2 vUv;void main() {gl_FragColor=vec4(vec3(1.0)-vec3(texture2D(textureSampler,vUv).a),1.0);}\n"},{needAlphaBlending:!1,needAlphaTesting:!1,attributes:["uv"],uniforms:[],samplers:["textureSampler"],shaderLanguage:g.ShaderLanguage.GLSL});t.backFaceCulling=!1,t.alphaMode=r.Constants.ALPHA_DISABLE,e.onDisposeObservable.add((()=>{e._textureAlphaCheckerShader?.dispose(),e._textureAlphaCheckerShader=null})),e._textureAlphaCheckerShader=t}return e._textureAlphaCheckerShader}static DisposeShader(e){e._textureAlphaCheckerShader?.dispose(),e._textureAlphaCheckerShader=null}}!function(e){e[e.DepthWriteAlphaBlendingWithEvaluation=0]="DepthWriteAlphaBlendingWithEvaluation",e[e.DepthWriteAlphaBlending=1]="DepthWriteAlphaBlending",e[e.AlphaEvaluation=2]="AlphaEvaluation"}(re||(re={}));class he{renderMethod=re.DepthWriteAlphaBlendingWithEvaluation;forceDisableAlphaEvaluation=!1;alphaThreshold=195;alphaBlendThreshold=100;alphaEvaluationResolution=512;deleteTextureBufferAfterLoad=!0;_textureLoader=new q;nextStartingAlphaIndex=65536;alphaIndexIncrementsPerModel=1024;_setMeshesAlphaIndex(e){let t=this.nextStartingAlphaIndex;for(let n=0;n<e.length;++n)e[n].alphaIndex=t,t+=1;this.nextStartingAlphaIndex+=this.alphaIndexIncrementsPerModel}buildMaterials(e,t,n,i,o,r,a,s,l,h,d,c,m,u,p){this.renderMethod!==re.DepthWriteAlphaBlendingWithEvaluation&&this.renderMethod!==re.DepthWriteAlphaBlending||this._setMeshesAlphaIndex(l);const g=h.blockMaterialDirtyMechanism;h._forceBlockMaterialDirtyMechanism(!0);let f=null;const _=()=>null!==f?f:this.forceDisableAlphaEvaluation?null:f=new le(h,this.alphaEvaluationResolution),b=new te(a,o,r),y=[],A={lengthComputable:!0,loaded:0,total:3*t.length},M=()=>{A.loaded+=1,u?.(A)},T=[];for(let r=0;r<t.length;++r){const a=t[r];h._blockEntityCollection=!!d;const l=new ee(a.name,h);l._parentContainer=d,h._blockEntityCollection=!1,d?.materials.push(l);{const t=[],c=this.loadGeneralScalarProperties(l,a,s[r]);void 0!==c&&t.push(c);const u=this.loadDiffuseTexture(e,l,a,i,n[a.textureIndex]??null,h,d,o,b,m,M),p=()=>this.setAlphaBlendMode(l,a,s[r],m,_);if(void 0!==u){const e=u.then(p);t.push(e)}else{const e=p();void 0!==e&&t.push(e)}const g=this.loadSphereTexture(e,l,a,i,n[a.sphereTextureIndex]??null,h,d,o,b,m,M);void 0!==g&&t.push(g);const f=this.loadToonTexture(e,l,a,i,n[a.toonTextureIndex]??null,h,d,o,b,m,M);void 0!==f&&t.push(f);const A=this.loadOutlineRenderingProperties(l,a,m);void 0!==A&&t.push(A),y.push(...t),Promise.all(t).then((()=>{this.afterBuildSingleMaterial(l,r,a,i,n,h,o)}))}T.push(l)}this._textureLoader.loadModelTexturesEnd(e);const w=this._textureLoader.onModelTextureLoadedObservable.get(e);return void 0!==w?w.addOnce((()=>{Promise.all(y).then((()=>{f?.dispose(),h._forceBlockMaterialDirtyMechanism(g),null!==c&&this._buildTextureNameMap(t,T,i,n,c),p?.()}))})):Promise.all(y).then((()=>{f?.dispose(),h._forceBlockMaterialDirtyMechanism(g),null!==c&&this._buildTextureNameMap(t,T,i,n,c),p?.()})),T}_buildTextureNameMap(e,t,n,i,o){for(let r=0;r<e.length;++r){const a=e[r],s=t[r],l=n[i[a.textureIndex]?.imagePathIndex];if(void 0!==l){const e=s.diffuseTexture;null!==e&&o.set(e,l)}const h=n[i[a.sphereTextureIndex]?.imagePathIndex];if(void 0!==h){const e=s.sphereTexture;null!==e&&o.set(e,h)}const d=n[i[a.toonTextureIndex]?.imagePathIndex];if(void 0!==d){const e=s.toonTexture;null!==e&&o.set(e,d)}}}loadGeneralScalarProperties=(e,t,n)=>{const i=t.diffuse;e.diffuseColor=new L.Color3(i[0],i[1],i[2]);const o=t.specular;e.specularColor=new L.Color3(o[0],o[1],o[2]);const r=t.ambient;e.ambientColor=new L.Color3(r[0],r[1],r[2]);const a=t.diffuse[3];if(e.alpha=a,0===a)for(let e=0;e<n.length;++e){const t=n[e];void 0!==t.isVisible&&(t.isVisible=!1)}e.specularPower=t.shininess};loadDiffuseTexture=async(e,t,n,i,o,a,s,l,h,d,c)=>{t.backFaceCulling=!(n.flag&M.Material.Flag.IsDoubleSided);const m=i[o?.imagePathIndex??-1];if(void 0!==m){const n=h.createFullPath(m);let i;const u=h.resolve(n);i=void 0!==u?await this._textureLoader.loadTextureFromBufferAsync(e,n,u instanceof File?u:u.data,a,s,{...o,deleteBuffer:this.deleteTextureBufferAfterLoad,format:r.Constants.TEXTUREFORMAT_RGBA,mimeType:u instanceof File?u.type:u.mimeType}):await this._textureLoader.loadTextureAsync(e,l,m,a,s,{...o,deleteBuffer:this.deleteTextureBufferAfterLoad,format:r.Constants.TEXTUREFORMAT_RGBA});const p=i;null!==p?t.diffuseTexture=p:d.error(`Failed to load diffuse texture: ${n}`),c?.()}else c?.()};async _evaluateDiffuseTextureTransparencyMode(e,t,n,i,o){let r=Number.MIN_SAFE_INTEGER;if(this.renderMethod===re.DepthWriteAlphaBlendingWithEvaluation){let i=t>>4&3;if(0==(3^i)&&(i=-1),-1===i){r=D.Material.MATERIAL_OPAQUE;const t=o();if(null!==t)for(let i=0;i<n.length;++i){const o=n[i];if(!await t.hasFragmentsOnlyOpaqueOnGeometry(e,o?.mesh??o,void 0!==o?.subMeshIndex?o.subMeshIndex:null)){r=D.Material.MATERIAL_ALPHABLEND;break}}}else r=0===i?D.Material.MATERIAL_OPAQUE:D.Material.MATERIAL_ALPHABLEND}else if(this.renderMethod===re.AlphaEvaluation){let i=15&t;if(0==(15^i)&&(i=-1),-1!==i)r=i;else{const t=o();if(null!==t)for(let i=0;i<n.length;++i){const o=n[i],a=await t.hasTranslucentFragmentsOnGeometry(e,o?.mesh??o,void 0!==o?.subMeshIndex?o.subMeshIndex:null,this.alphaThreshold,this.alphaBlendThreshold);r<a&&(r=a)}}}else i.warn(`Unknown shading method for evaluating transparency mode: ${this.renderMethod}`);return r!==Number.MIN_SAFE_INTEGER?r:null}setAlphaBlendMode=async(e,t,n,i,o)=>{if(this.renderMethod===re.DepthWriteAlphaBlending)return e.diffuseTexture&&(e.diffuseTexture.hasAlpha=!0,e.useAlphaFromDiffuseTexture=!0),e.transparencyMode=D.Material.MATERIAL_ALPHABLEND,void(e.forceDepthWrite=!0);if(this.renderMethod===re.DepthWriteAlphaBlendingWithEvaluation&&e.alpha<1)return e.diffuseTexture&&(e.diffuseTexture.hasAlpha=!0,e.useAlphaFromDiffuseTexture=!0),e.transparencyMode=D.Material.MATERIAL_ALPHABLEND,void(e.forceDepthWrite=!0);const r=e.diffuseTexture,a=t.evaluatedTransparency??-1;if(null!==r){const t=await this._evaluateDiffuseTextureTransparencyMode(r,a,n,i,o);if(null!==t){const n=t!==D.Material.MATERIAL_OPAQUE;n&&(r.hasAlpha=!0),e.useAlphaFromDiffuseTexture=n,e.transparencyMode=t,this.renderMethod===re.DepthWriteAlphaBlendingWithEvaluation&&(e.forceDepthWrite=n)}}else if(this.renderMethod===re.DepthWriteAlphaBlendingWithEvaluation){let t=a>>4&3;0==(3^t)&&(t=0),e.transparencyMode=0===t?D.Material.MATERIAL_OPAQUE:D.Material.MATERIAL_ALPHABLEND}else{let t=15&a;0==(15^t)&&(t=0),e.transparencyMode=D.Material.MATERIAL_OPAQUE}};loadSphereTexture=async(e,t,n,i,o,a,s,l,h,d,c)=>{if(n.sphereTextureMode!==M.Material.SphereTextureMode.Off){const m=i[o?.imagePathIndex??-1];if(void 0!==m){const i=a.getEngine().isWebGPU||n.sphereTextureMode===M.Material.SphereTextureMode.Multiply?r.Constants.TEXTUREFORMAT_RGBA:r.Constants.TEXTUREFORMAT_RGB,u=h.createFullPath(m);let p;const g=h.resolve(u);p=void 0!==g?await this._textureLoader.loadTextureFromBufferAsync(e,u,g instanceof File?g:g.data,a,s,{...o,deleteBuffer:this.deleteTextureBufferAfterLoad,format:i,mimeType:g instanceof File?g.type:g.mimeType}):await this._textureLoader.loadTextureAsync(e,l,m,a,s,{...o,deleteBuffer:this.deleteTextureBufferAfterLoad,format:i}),null!==p?(t.sphereTexture=p,t.sphereTextureBlendMode=n.sphereTextureMode):d.error(`Failed to load sphere texture: ${u}`),c?.()}else c?.()}else c?.()};loadToonTexture=async(e,t,n,i,o,a,s,l,h,d,c)=>{let m;if(m=n.isSharedToonTexture?n.toonTextureIndex:i[o?.imagePathIndex??-1],void 0!==m){const n=h.createFullPath(m.toString());let i;const u="string"==typeof m?h.resolve(n):void 0;i=void 0!==u?await this._textureLoader.loadTextureFromBufferAsync(e,n,u instanceof File?u:u.data,a,s,{...o,deleteBuffer:this.deleteTextureBufferAfterLoad,format:a.getEngine().isWebGPU?r.Constants.TEXTUREFORMAT_RGBA:r.Constants.TEXTUREFORMAT_RGB,mimeType:u instanceof File?u.type:u.mimeType}):await this._textureLoader.loadTextureAsync(e,l,m,a,s,{...o,deleteBuffer:this.deleteTextureBufferAfterLoad,format:a.getEngine().isWebGPU?r.Constants.TEXTUREFORMAT_RGBA:r.Constants.TEXTUREFORMAT_RGB}),null!==i?t.toonTexture=i:d.error(`Failed to load toon texture: ${n}`),c?.()}else c?.()};loadOutlineRenderingProperties=(e,t,n)=>{if(t.flag&M.Material.Flag.EnabledToonEdge){void 0===m.Scene.prototype.getMmdOutlineRenderer&&n.warn('MMD Outline Renderer is not available. Please import "babylon-mmd/esm/Loader/mmdOutlineRenderer".'),e.renderOutline=!0,e.outlineWidth=t.edgeSize;const i=t.edgeColor;e.outlineColor=new L.Color3(i[0],i[1],i[2]),e.outlineAlpha=i[3]}};afterBuildSingleMaterial=()=>{}}class de{lengthComputable;total;_onProgress;_unprocessedTasks;_processingTasks;_endedTaskNames;_endedTasksTotal;constructor(e,t,n){this.lengthComputable=e;let i=0;for(let e=0;e<t.length;++e)i+=t[e].cost;this.total=i,this._onProgress=n;const o=this._unprocessedTasks=new Map;for(let e=0;e<t.length;++e){if(o.has(t[e].name))throw new Error(`Duplicated task name: ${t[e].name}`);o.set(t[e].name,t[e])}this._processingTasks=new Map,this._endedTaskNames=new Set,this._endedTasksTotal=0}_getTaskState(e){let t=this._processingTasks.get(e);if(void 0===t){const n=this._unprocessedTasks.get(e);if(void 0===n){if(this._endedTaskNames.has(e))return null;throw new Error(`Task not found: ${e}`)}t={name:n.name,cost:n.cost,progress:0},this._processingTasks.set(e,t),this._unprocessedTasks.delete(e)}return t}processTask(e,t){const n=this._getTaskState(e);null!==n&&(n.progress+=t,n.progress>=n.cost&&(this._processingTasks.delete(e),this._endedTaskNames.add(e),this._endedTasksTotal+=n.cost))}setTaskProgress(e,t){const n=this._getTaskState(e);return null!==n&&(n.progress=t,n.progress>=n.cost&&(this._processingTasks.delete(e),this._endedTaskNames.add(e),this._endedTasksTotal+=n.cost),!0)}setTaskProgressRatio(e,t,n){const i=this._getTaskState(e);return null!==i&&(i.progress=n?Math.floor(i.cost*t):i.cost*t,i.progress>=i.cost&&(this._processingTasks.delete(e),this._endedTaskNames.add(e),this._endedTasksTotal+=i.cost),!0)}endTask(e){const t=this._getTaskState(e);null!==t&&(this._processingTasks.delete(e),this._endedTaskNames.add(e),this._endedTasksTotal+=t.cost)}invokeProgressEvent(){null!==this._onProgress&&this._onProgress({lengthComputable:this.lengthComputable,loaded:this.loaded,total:this.total})}get loaded(){let e=this._endedTasksTotal;for(const[t,n]of this._processingTasks)e+=n.progress;return e}}class ce{name;extensions;materialBuilder;useSdef;buildSkeleton;buildMorph;boundingBoxMargin;preserveSerializationData;_loggingEnabled;log;warn;error;static _SharedStandardMaterialBuilder=new he;constructor(e,t){this.name=e,this.extensions=t,this.materialBuilder=ce._SharedStandardMaterialBuilder,this.useSdef=!0,this.buildSkeleton=!0,this.buildMorph=!0,this.boundingBoxMargin=10,this.preserveSerializationData=!1,this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled}importMeshAsync(e,t,n,i,o,r){return this._loadAsyncInternal(t,null,n,i,o)}loadAsync(e,t,n,i,o){return this._loadAsyncInternal(e,null,t,n,i).then((()=>{}))}loadAssetContainerAsync(e,t,n,i,o){const r=new F.AssetContainer(e);return this._loadAsyncInternal(e,r,t,n,i).then((()=>r))}async _loadAsyncInternal(e,t,n,i,o){const r=await this._parseFileAsync(n.arrayBuffer),a=new de(!0,this._getProgressTaskCosts(n,r),o??null);a.endTask("Parse"),a.invokeProgressEvent(),e._blockEntityCollection=!!t;const s=new B.Mesh(r.header.modelName,e);s._parentContainer=t,e._blockEntityCollection=!1,s.setEnabled(!1);const l=await this._buildGeometryAsync(n,r,s,e,t,a),h=n.preserveSerializationData?new Map:null,{materials:d,multiMaterials:c,textureLoadPromise:m}=await this._buildMaterialAsync(n,r,s,l.meshes,h,e,t,i,a),u=[];let p=null;n.buildSkeleton?p=await this._buildSkeletonAsync(n,r,l.meshes,e,t,u,a):a.endTask("Build Skeleton");const g=[];let f=null;if(n.buildMorph&&(f=await this._buildMorphAsync(n,r,l,e,t,g,a)),0!==n.boundingBoxMargin&&this._applyBoundingBoxMargin(l.meshes,n.boundingBoxMargin),s.metadata={isMmdModel:!0,header:{modelName:r.header.modelName,englishModelName:r.header.englishModelName,comment:r.header.comment,englishComment:r.header.englishComment},bones:u,morphs:g,rigidBodies:r.rigidBodies,joints:r.joints,meshes:l.meshes,materials:d,skeleton:p},n.preserveSerializationData){const e=[],t=r.materials;for(let n=0;n<t.length;++n){const i=t[n];e.push({englishName:i.englishName,comment:i.comment})}s.metadata={...s.metadata,containsSerializationData:!0,textureNameMap:h,materialsMetadata:e,displayFrames:r.displayFrames}}return a.invokeProgressEvent(),await m,a.endTask("Texture Load"),a.invokeProgressEvent(),s.setEnabled(!0),null!==t&&(t.rootNodes.push(s),t.meshes.push(s,...l.meshes),t.geometries.push(...l.geometries),t.materials.push(...d),t.multiMaterials.push(...c),null!==p&&t.skeletons.push(p),null!==f&&t.morphTargetManagers.push(...f)),{meshes:[s,...l.meshes],particleSystems:[],skeletons:null!==p?[p]:[],animationGroups:[],transformNodes:[],geometries:l.geometries,lights:[],spriteManagers:[]}}_getProgressTaskCosts(e,t){return[{name:"Parse",cost:Math.floor(e.arrayBuffer.byteLength/100)},{name:"Build Material",cost:100*t.materials.length},{name:"Build Skeleton",cost:e.buildSkeleton?100*t.bones.length:0},{name:"Texture Load",cost:3e4*t.textures.length}]}async _buildSkeletonAsync(e,t,n,i,o,r,a){const s=e.preserveSerializationData;i._blockEntityCollection=!!o;const l=new E.Skeleton(t.header.modelName,t.header.modelName+"_skeleton",i);l._parentContainer=o,i._blockEntityCollection=!1;{const e=t.bones,n=[],i=[];for(let t=0;t<e.length;++t){const o=e[t];let a=!1;if(0<=o.parentBoneIndex&&o.parentBoneIndex<e.length){let n=o.parentBoneIndex;for(;-1!==n;){if(n===t){a=!0,this.warn(`Bone loop detected. Ignore Parenting. Bone index: ${t}`);break}n=e[n].parentBoneIndex}t<=o.parentBoneIndex&&this.warn(`Parent bone index is greater equal than child bone index. Bone index: ${t} Parent bone index: ${o.parentBoneIndex}`)}else-1!==o.parentBoneIndex&&this.error(`Parent bone index is out of range. Bone index: ${t} Parent bone index: ${o.parentBoneIndex}`);const h=o.position,d=new c.Vector3(h[0],h[1],h[2]);if(0<=o.parentBoneIndex&&o.parentBoneIndex<e.length&&!a){const t=e[o.parentBoneIndex];d.x-=t.position[0],d.y-=t.position[1],d.z-=t.position[2]}const m=c.Matrix.Identity().setTranslation(d),u=new S.Bone(o.name,l,void 0,m,void 0,void 0,t);n.push(u),i.push(a);const p={name:o.name,englishName:o.englishName,parentBoneIndex:o.parentBoneIndex,transformOrder:o.transformOrder,flag:o.flag,appendTransform:o.appendTransform,ik:o.ik,...s?{tailPosition:o.tailPosition,axisLimit:o.axisLimit,localVector:o.localVector,externalParentTransform:o.externalParentTransform}:void 0};r.push(p)}for(let t=0;t<n.length;++t){const o=e[t],r=n[t];0<=o.parentBoneIndex&&o.parentBoneIndex<n.length&&!i[t]&&r.setParent(n[o.parentBoneIndex],!1)}for(let e=0;e<n.length;++e){const t=n[e];null===t.getParent()&&t._updateAbsoluteBindMatrices()}}a.endTask("Build Skeleton"),a.invokeProgressEvent();for(let e=0;e<n.length;++e)n[e].skeleton=l;return l}_applyBoundingBoxMargin(e,t){for(let n=0;n<e.length;++n){const i=e[n];if(void 0===i.subMeshes)continue;const o=i.subMeshes;for(let e=0;e<o.length;++e){const n=o[e],i=n.getBoundingInfo();n.setBoundingInfo(new k.BoundingInfo((new c.Vector3).setAll(-t).addInPlace(i.minimum),(new c.Vector3).setAll(t).addInPlace(i.maximum)))}const r=i.getBoundingInfo();i.setBoundingInfo(new k.BoundingInfo((new c.Vector3).setAll(-t).addInPlace(r.minimum),(new c.Vector3).setAll(t).addInPlace(r.maximum))),i._updateBoundingInfo()}}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){N.Logger.Log(e)}_logDisabled(){}_warnEnabled(e){N.Logger.Warn(e)}_warnDisabled(){}_errorEnabled(e){N.Logger.Error(e)}_errorDisabled(){}}class me{static _IdMap=new WeakMap;static _NextId=0;constructor(){}static GetId(e){let t=this._IdMap.get(e);return void 0===t&&(t=this._NextId,this._NextId+=1,this._IdMap.set(e,t)),t}}class ue extends B.Mesh{applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId===this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(o.VertexBuffer.PositionKind))return this;if(!this.isVerticesDataPresent(o.VertexBuffer.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(o.VertexBuffer.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(o.VertexBuffer.NormalKind),n=this._internalMeshDataInfo;if(!n._sourcePositions){const e=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=e}t&&!n._sourceNormals&&this.setNormalsForCPUSkinning();let i=this.getVerticesData(o.VertexBuffer.PositionKind);if(!i)return this;i instanceof Float32Array||(i=new Float32Array(i));let r=this.getVerticesData(o.VertexBuffer.NormalKind);if(t){if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r))}const a=this.isVerticesDataPresent(p.MatricesSdefCKind);let s=null,l=null,h=null;a&&(s=this.getVerticesData(p.MatricesSdefCKind),l=this.getVerticesData(p.MatricesSdefR0Kind),h=this.getVerticesData(p.MatricesSdefR1Kind));const d=this.getVerticesData(o.VertexBuffer.MatricesIndicesKind),m=this.getVerticesData(o.VertexBuffer.MatricesWeightsKind);if(!m||!d)return this;const u=this.numBoneInfluencers>4,g=u?this.getVerticesData(o.VertexBuffer.MatricesIndicesExtraKind):null,f=u?this.getVerticesData(o.VertexBuffer.MatricesWeightsExtraKind):null,_=e.getTransformMatrices(this),b=c.Vector3.Zero(),y=new c.Matrix,A=new c.Matrix,M=new c.Matrix,T=new c.Matrix,w=new c.Quaternion,x=new c.Quaternion,v=new c.Vector3,I=n._sourcePositions,B=n._sourceNormals;let P,R=0;for(let e=0;e<i.length;e+=3,R+=4){let n=0;if(a&&(n=l[e]),0===n){let n;for(P=0;P<4;P++)n=m[R+P],n>0&&(c.Matrix.FromFloat32ArrayToRefScaled(_,Math.floor(16*d[R+P]),n,A),y.addToSelf(A));if(u)for(P=0;P<4;P++)n=f[R+P],n>0&&(c.Matrix.FromFloat32ArrayToRefScaled(_,Math.floor(16*g[R+P]),n,A),y.addToSelf(A));c.Vector3.TransformCoordinatesFromFloatsToRef(I[e],I[e+1],I[e+2],y,b),b.toArray(i,e),t&&(c.Vector3.TransformNormalFromFloatsToRef(B[e],B[e+1],B[e+2],y,b),b.toArray(r,e)),y.reset()}else{const n=m[R+0],o=m[R+1];c.Matrix.FromArrayToRef(_,Math.floor(16*d[R+0]),M),c.Matrix.FromArrayToRef(_,Math.floor(16*d[R+1]),T),c.Quaternion.FromRotationMatrixToRef(M,w),c.Quaternion.FromRotationMatrixToRef(T,x),c.Matrix.FromQuaternionToRef(c.Quaternion.SlerpToRef(w,x,o,w),A),c.Vector3.TransformCoordinatesFromFloatsToRef(I[e]-s[e],I[e+1]-s[e+1],I[e+2]-s[e+2],A,v),c.Vector3.TransformCoordinatesFromFloatsToRef(l[e],l[e+1],l[e+2],M,b).scaleAndAddToRef(n,v),c.Vector3.TransformCoordinatesFromFloatsToRef(h[e],h[e+1],h[e+2],T,b).scaleAndAddToRef(o,v),v.toArray(i,e),t&&(c.Vector3.TransformNormalFromFloatsToRef(B[e],B[e+1],B[e+2],A,v),v.toArray(r,e))}}return this.updateVerticesData(o.VertexBuffer.PositionKind,i),t&&this.updateVerticesData(o.VertexBuffer.NormalKind,r),this}}class pe extends ce{referenceFiles;constructor(e,t){super(e,t),this.referenceFiles=[]}loadFile(e,t,n,i,o,r,a){const s=this.materialBuilder,l=this.useSdef,h=this.buildSkeleton,d=this.buildMorph,c=this.boundingBoxMargin,m=this.referenceFiles,u=this.preserveSerializationData;return e._loadFile(t,((e,n)=>{const o={arrayBuffer:e,pmFileId:t instanceof File?me.GetId(t).toString():t,materialBuilder:s,useSdef:l,buildSkeleton:h,buildMorph:d,boundingBoxMargin:c,referenceFiles:m,preserveSerializationData:u};i(o,n)}),o,!0,r,a)}_getProgressTaskCosts(e,t){const n=super._getProgressTaskCosts(e,t);if(n.push({name:"Build Geometry",cost:t.indices.length}),e.buildMorph){let e=0;const i=t.morphs;for(let t=0;t<i.length;++t){const n=i[t];n.type!==M.Morph.Type.VertexMorph&&n.type!==M.Morph.Type.UvMorph&&n.type!==M.Morph.Type.AdditionalUvMorph1&&n.type!==M.Morph.Type.AdditionalUvMorph2&&n.type!==M.Morph.Type.AdditionalUvMorph3&&n.type!==M.Morph.Type.AdditionalUvMorph4||(e+=n.indices.length)}n.push({name:"Build Morph",cost:e})}return n}async _buildGeometryAsync(e,t,n,i,o,r){const a=[],s=[];let l;const h=[];{l=t.indices instanceof Uint8Array||t.indices instanceof Uint16Array?new Uint16Array(t.indices.length):new Uint32Array(t.indices.length);{const e=t.indices;for(let t=0;t<l.length;t+=3)l[t+0]=e[t+0],l[t+1]=e[t+2],l[t+2]=e[t+1]}const d=t.materials;let c=0;for(let m=0;m<d.length;++m){const u=d[m],g=new Uint8Array(t.vertices.length);let f=0;{const e=u.indexCount;for(let t=0;t<e;++t){const e=l[c+t];0===g[e]&&(g[e]=1,f+=1)}g.fill(0)}const _=new P.VertexData,b=[];if(e.preserveSerializationData)for(let e=0;e<t.header.additionalVec4Count;++e)b.push(new Float32Array(4*f));let y=null,A=null,T=null;e.buildSkeleton&&e.useSdef&&(y=new Float32Array(3*f),A=new Float32Array(3*f),T=new Float32Array(3*f));let w=!1,x=null;e.preserveSerializationData&&(x=new Float32Array(f));const v=new t.indices.constructor(t.vertices.length);{const n=new Float32Array(3*f),i=new Float32Array(3*f),o=new Float32Array(2*f),a=new l.constructor(u.indexCount);let s=null,h=null;e.buildSkeleton&&(s=new Float32Array(4*f),h=new Float32Array(4*f));let d=performance.now(),m=0,p=0;const I=u.indexCount;for(let u=0;u<I;++u){const f=l[c+u];if(0===g[f]){g[f]=1;const r=t.vertices[f];n[3*m+0]=r.position[0],n[3*m+1]=r.position[1],n[3*m+2]=r.position[2],i[3*m+0]=r.normal[0],i[3*m+1]=r.normal[1],i[3*m+2]=r.normal[2],o[2*m+0]=r.uv[0],o[2*m+1]=1-r.uv[1];const l=r.additionalVec4;for(let e=0;e<b.length;++e)b[e][4*m+0]=l[e][0],b[e][4*m+1]=l[e][1],b[e][4*m+2]=l[e][2],b[e][4*m+3]=l[e][3];if(e.buildSkeleton)switch(r.weightType){case M.Vertex.BoneWeightType.Bdef1:{const e=r.boneWeight;s[4*m+0]=e.boneIndices,s[4*m+1]=0,s[4*m+2]=0,s[4*m+3]=0,h[4*m+0]=1,h[4*m+1]=0,h[4*m+2]=0,h[4*m+3]=0}break;case M.Vertex.BoneWeightType.Bdef2:{const e=r.boneWeight;s[4*m+0]=e.boneIndices[0],s[4*m+1]=e.boneIndices[1],s[4*m+2]=0,s[4*m+3]=0,h[4*m+0]=e.boneWeights,h[4*m+1]=1-e.boneWeights,h[4*m+2]=0,h[4*m+3]=0}break;case M.Vertex.BoneWeightType.Bdef4:case M.Vertex.BoneWeightType.Qdef:{const e=r.boneWeight;s[4*m+0]=e.boneIndices[0],s[4*m+1]=e.boneIndices[1],s[4*m+2]=e.boneIndices[2],s[4*m+3]=e.boneIndices[3],h[4*m+0]=e.boneWeights[0],h[4*m+1]=e.boneWeights[1],h[4*m+2]=e.boneWeights[2],h[4*m+3]=e.boneWeights[3]}break;case M.Vertex.BoneWeightType.Sdef:{const t=r.boneWeight;s[4*m+0]=t.boneIndices[0],s[4*m+1]=t.boneIndices[1],s[4*m+2]=0,s[4*m+3]=0;const n=t.boneWeights,i=n.boneWeight0,o=1-i;if(h[4*m+0]=i,h[4*m+1]=o,h[4*m+2]=0,h[4*m+3]=0,e.useSdef){const e=n.c[0],t=n.c[1],r=n.c[2];let a=n.r0[0],s=n.r0[1],l=n.r0[2],h=n.r1[0],d=n.r1[1],c=n.r1[2];const u=a*i+h*o,p=s*i+d*o,g=l*i+c*o;a=e+a-u,s=t+s-p,l=r+l-g,h=e+h-u,d=t+d-p,c=r+c-g;const f=.5*(e+a),_=.5*(t+s),b=.5*(r+l),M=.5*(e+h),x=.5*(t+d),v=.5*(r+c);y[3*m+0]=e,y[3*m+1]=t,y[3*m+2]=r,A[3*m+0]=f,A[3*m+1]=_,A[3*m+2]=b,T[3*m+0]=M,T[3*m+1]=x,T[3*m+2]=v,w=!0}}}e.preserveSerializationData&&(x[m]=r.edgeScale),a[p]=m,v[f]=m,p+=1,m+=1}else a[p]=v[f],p+=1;(c+u)%1e4==0&&100<performance.now()-d&&(r.setTaskProgress("Build Geometry",c+u),r.invokeProgressEvent(),await R.Tools.DelayAsync(0),d=performance.now())}_.positions=n,_.normals=i,_.uvs=o,_.indices=a,_.matricesIndices=s,_.matricesWeights=h}i._blockEntityCollection=!!o;const C=new(e.useSdef&&w?ue:B.Mesh)(u.name,i);C._parentContainer=o,i._blockEntityCollection=!1,C.setParent(n),a.push(C),i._blockEntityCollection=!!o;const O=new I.Geometry(t.header.modelName,i,_,!1);O._parentContainer=o,i._blockEntityCollection=!1,e.preserveSerializationData&&(1<=b.length&&O.setVerticesData(p.AdditionalUV1Kind,b[0],!1,4),2<=b.length&&O.setVerticesData(p.AdditionalUV2Kind,b[1],!1,4),3<=b.length&&O.setVerticesData(p.AdditionalUV3Kind,b[2],!1,4),4<=b.length&&O.setVerticesData(p.AdditionalUV4Kind,b[3],!1,4)),e.useSdef&&w&&(O.setVerticesData(p.MatricesSdefCKind,y,!1,3),O.setVerticesData(p.MatricesSdefR0Kind,A,!1,3),O.setVerticesData(p.MatricesSdefR1Kind,T,!1,3)),e.preserveSerializationData&&O.setVerticesData(p.EdgeScaleKind,x,!1,1),O.applyToMesh(C),s.push(O),h.push({map:v,isReferencedVertex:g}),c+=u.indexCount}}return r.endTask("Build Geometry"),r.invokeProgressEvent(),{meshes:a,geometries:s,indices:l,indexToSubmehIndexMaps:h}}async _buildMaterialAsync(e,t,n,i,o,r,a,s,l){let h;const d=new Array(t.textures.length);for(let e=0;e<d.length;++e)d[e]={noMipmap:!1,invertY:!0,samplingMode:void 0,imagePathIndex:e};const c=[];for(let e=0;e<i.length;++e)c.push([i[e]]);const m=new Promise((m=>{h=e.materialBuilder.buildMaterials(n.uniqueId,t.materials,d,t.textures,s,"file:"+e.pmFileId+"_",e.referenceFiles,c,i,r,a,o,this,(e=>{e.lengthComputable&&(l.setTaskProgressRatio("Texture Load",e.loaded/e.total,!0),l.invokeProgressEvent())}),(()=>m()))})),u=Array.isArray(h)?h:await h;for(let e=0;e<u.length;++e)i[e].material=u[e];return l.endTask("Build Material"),l.invokeProgressEvent(),{materials:u,multiMaterials:[],textureLoadPromise:m}}async _buildMorphAsync(e,t,n,i,r,a,s){const l=e.preserveSerializationData,h=new Int32Array(t.vertices.length).fill(-1),d=new Map,c=n.indices;{const e=t.materials;let n=0;for(let t=0;t<e.length;++t){const i=e[t].indexCount;for(let e=0;e<i;++e){const i=c[n+e];if(-1===h[i])h[i]=t;else if(-2===h[i]){const e=d.get(i);e.includes(t)||e.push(t)}else h[i]!==t&&(d.set(i,[h[i],t]),h[i]=-2)}n+=i}}const m=n.indexToSubmehIndexMaps,u=t.morphs,p=n.geometries,g=new Array(p.length);for(let e=0;e<g.length;++e)g[e]=[];let f=0,_=performance.now();for(let e=0;e<u.length;++e){const t=u[e],n=[],r=[];switch(t.type){case M.Morph.Type.GroupMorph:case M.Morph.Type.BoneMorph:case M.Morph.Type.MaterialMorph:a.push(t);break;case M.Morph.Type.VertexMorph:case M.Morph.Type.UvMorph:case M.Morph.Type.AdditionalUvMorph1:case M.Morph.Type.AdditionalUvMorph2:case M.Morph.Type.AdditionalUvMorph3:case M.Morph.Type.AdditionalUvMorph4:a.push({name:t.name,englishName:t.englishName,category:t.category,type:t.type,morphTargets:n,...l?{elements:r}:void 0});break;default:this.warn(`Unsupported morph type: ${t.type}`)}if(t.type!==M.Morph.Type.VertexMorph&&t.type!==M.Morph.Type.UvMorph&&t.type!==M.Morph.Type.AdditionalUvMorph1&&t.type!==M.Morph.Type.AdditionalUvMorph2&&t.type!==M.Morph.Type.AdditionalUvMorph3&&t.type!==M.Morph.Type.AdditionalUvMorph4)continue;const c=[];{const e=t.indices;for(let t=0;t<e.length;++t){const n=e[t],i=h[n];if(-1!==i)if(-2===i){const e=d.get(n);for(let t=0;t<e.length;++t){const n=e[t];c.includes(n)||c.push(n)}}else c.includes(i)||c.push(i)}if(t.type!==M.Morph.Type.AdditionalUvMorph1&&t.type!==M.Morph.Type.AdditionalUvMorph2&&t.type!==M.Morph.Type.AdditionalUvMorph3&&t.type!==M.Morph.Type.AdditionalUvMorph4)for(let e=0;e<c.length;++e){const o=new C.MorphTarget(t.name,0,i);n.push(o),g[c[e]].push(o)}}if(t.type===M.Morph.Type.VertexMorph)for(let e=0;e<c.length;++e){const i=c[e],a=p[i],s=new Float32Array(a.getVerticesData(o.VertexBuffer.PositionKind)),h=t.indices,d=t.positions,u=m[i].map,g=m[i].isReferencedVertex;if(l){let e=0;for(let t=0;t<h.length;++t){if(0===g[h[t]])continue;const n=u[h[t]];s[3*n+0]+=d[3*t+0],s[3*n+1]+=d[3*t+1],s[3*n+2]+=d[3*t+2],e+=1}const t=new Int32Array(e),n=new Float32Array(3*e);for(let e=0,i=0;e<h.length;++e){if(0===g[h[e]])continue;const o=u[h[e]];t[i]=o,n[3*i+0]=d[3*e+0],n[3*i+1]=d[3*e+1],n[3*i+2]=d[3*e+2],i+=1}r.push({meshIndex:i,indices:t,offsets:n})}else for(let e=0;e<h.length;++e){if(0===g[h[e]])continue;const t=u[h[e]];s[3*t+0]+=d[3*e+0],s[3*t+1]+=d[3*e+1],s[3*t+2]+=d[3*e+2]}n[e].setPositions(s)}else if(t.type===M.Morph.Type.UvMorph)for(let e=0;e<c.length;++e){const i=c[e],a=p[i],s=new Float32Array(a.getVerticesData(o.VertexBuffer.UVKind)),h=t.indices,d=t.offsets,u=m[i].map,g=m[i].isReferencedVertex;if(l){let e=0;for(let t=0;t<h.length;++t){if(0===g[h[t]])continue;const n=u[h[t]];s[2*n+0]+=d[4*t+0],s[2*n+1]-=d[4*t+1],e+=1}const t=new Int32Array(e),n=new Float32Array(4*e);for(let e=0,i=0;e<h.length;++e){if(0===g[h[e]])continue;const o=u[h[e]];t[i]=o,n[4*i+0]=d[4*e+0],n[4*i+1]=-d[4*e+1],n[4*i+2]=d[4*e+2],n[4*i+3]=d[4*e+3],i+=1}r.push({meshIndex:i,indices:t,offsets:n})}else for(let e=0;e<h.length;++e){if(0===g[h[e]])continue;const t=u[h[e]];s[2*t+0]+=d[4*e+0],s[2*t+1]-=d[4*e+1]}const f=n[e];f.setPositions(a.getVerticesData(o.VertexBuffer.PositionKind)),f.setUVs(s)}else if(l)for(let e=0;e<c.length;++e){const n=c[e],i=m[n].map,o=m[n].isReferencedVertex,a=t.indices,s=t.offsets;let l=0;for(let e=0;e<a.length;++e)0!==o[a[e]]&&(l+=1);const h=new Int32Array(l),d=new Float32Array(4*l);for(let e=0,t=0;e<a.length;++e){if(0===o[a[e]])continue;const n=i[a[e]];h[t]=n,d[4*t+0]=s[4*e+0],d[4*t+1]=s[4*e+1],d[4*t+2]=s[4*e+2],d[4*t+3]=s[4*e+3],t+=1}r.push({meshIndex:n,indices:h,offsets:d})}f+=t.indices.length,100<performance.now()-_&&(s.setTaskProgress("Build Morph",f),s.invokeProgressEvent(),await R.Tools.DelayAsync(0),_=performance.now())}s.endTask("Build Morph");const b=[],y=n.meshes;for(let e=0;e<g.length;++e){const t=g[e];if(0===t.length)continue;i._blockEntityCollection=!!r;const n=new O.MorphTargetManager(i);n._parentContainer=r,i._blockEntityCollection=!1,n.enableNormalMorphing=!1,n.enableTangentMorphing=!1,n.enableUVMorphing=!1,n.areUpdatesFrozen=!0;for(let e=0;e<t.length;++e){const i=t[e];n.addTarget(i),i.hasUVs&&(n.enableUVMorphing=!0)}if(n.enableUVMorphing){const n=p[e].getVerticesData(o.VertexBuffer.UVKind);for(let e=0;e<t.length;++e){const i=t[e];i.hasUVs||i.setUVs(n)}}n.areUpdatesFrozen=!1,b.push(n),y[e].morphTargetManager=n}return b}}class ge extends pe{constructor(){super("pmd",{".pmd":{isBinary:!0}})}async _parseFileAsync(e){return await v.ParseAsync(e,this).catch((e=>Promise.reject(e)))}}T.SceneLoader&&T.SceneLoader.RegisterPlugin(new ge);class fe{_vertexIndexSize;_textureIndexSize;_materialIndexSize;_boneIndexSize;_morphIndexSize;_rigidBodyIndexSize;constructor(e,t,n,i,o,r){this._vertexIndexSize=e,this._textureIndexSize=t,this._materialIndexSize=n,this._boneIndexSize=i,this._morphIndexSize=o,this._rigidBodyIndexSize=r}getVertexIndex(e){switch(this._vertexIndexSize){case 1:return e.getUint8();case 2:return e.getUint16();case 4:return e.getInt32();default:throw new Error(`Invalid vertexIndexSize: ${this._vertexIndexSize}`)}}_getNonVertexIndex(e,t){switch(t){case 1:return e.getInt8();case 2:return e.getInt16();case 4:return e.getInt32();default:throw new Error(`Invalid indexSize: ${t}`)}}getTextureIndex(e){return this._getNonVertexIndex(e,this._textureIndexSize)}getMaterialIndex(e){return this._getNonVertexIndex(e,this._materialIndexSize)}getBoneIndex(e){return this._getNonVertexIndex(e,this._boneIndexSize)}getMorphIndex(e){return this._getNonVertexIndex(e,this._morphIndexSize)}getRigidBodyIndex(e){return this._getNonVertexIndex(e,this._rigidBodyIndexSize)}}class _e{constructor(){}static async ParseAsync(e,t=new w){const n=new x(e),i=this._ParseHeader(n,t),o=new fe(i.vertexIndexSize,i.textureIndexSize,i.materialIndexSize,i.boneIndexSize,i.morphIndexSize,i.rigidBodyIndexSize),r=await this._ParseVerticesAsync(n,o,i),a=this._ParseIndices(n,o,i),s=this._ParseTextures(n),l=this._ParseMaterials(n,o),h=this._ParseBones(n,o),d=this._ParseMorphs(n,o),c=this._ParseDisplayFrames(n,o),m=this._ParseRigidBodies(n,o),u=this._ParseJoints(n,o),p=i.version<=2?[]:this._ParseSoftBodies(n,o,i);return n.bytesAvailable>0&&t.warn(`There are ${n.bytesAvailable} bytes left after parsing`),{header:i,vertices:r,indices:a,textures:s,materials:l,bones:h,morphs:d,displayFrames:c,rigidBodies:m,joints:u,softBodies:p}}static _ParseHeader(e,t){if(e.bytesAvailable<17)throw new RangeError("is not pmx file");const n=e.getSignatureString(3);if("PMX"!==n)throw new RangeError("is not pmx file");e.getInt8();const i=e.getFloat32(),o=e.getUint8(),r=e.getUint8();e.initializeTextDecoder(r===M.Header.Encoding.Utf8?"utf-8":"utf-16le");const a=e.getUint8(),s=e.getUint8(),l=e.getUint8(),h=e.getUint8(),d=e.getUint8(),c=e.getUint8(),m=e.getUint8();if(o<8)throw new Error(`Invalid globalsCount: ${o}`);if(8<o){t.warn(`globalsCount is greater than 8: ${o} files may be corrupted or higher version`);for(let t=8;t<o;++t)e.getUint8()}return{signature:n,version:i,encoding:r,additionalVec4Count:a,vertexIndexSize:s,textureIndexSize:l,materialIndexSize:h,boneIndexSize:d,morphIndexSize:c,rigidBodyIndexSize:m,modelName:e.getDecoderString(e.getInt32(),!1),englishModelName:e.getDecoderString(e.getInt32(),!1),comment:e.getDecoderString(e.getInt32(),!1),englishComment:e.getDecoderString(e.getInt32(),!1)}}static async _ParseVerticesAsync(e,t,n){const i=e.getInt32(),o=[];let r=performance.now();for(let a=0;a<i;++a){const i=e.getFloat32Tuple(3),s=e.getFloat32Tuple(3),l=e.getFloat32Tuple(2),h=[];for(let t=0;t<n.additionalVec4Count;++t)h.push(e.getFloat32Tuple(4));const d=e.getUint8();let c;switch(d){case M.Vertex.BoneWeightType.Bdef1:c={boneIndices:t.getBoneIndex(e),boneWeights:null};break;case M.Vertex.BoneWeightType.Bdef2:c={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:e.getFloat32()};break;case M.Vertex.BoneWeightType.Bdef4:c={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:[e.getFloat32(),e.getFloat32(),e.getFloat32(),e.getFloat32()]};break;case M.Vertex.BoneWeightType.Sdef:c={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:{boneWeight0:e.getFloat32(),c:e.getFloat32Tuple(3),r0:e.getFloat32Tuple(3),r1:e.getFloat32Tuple(3)}};break;case M.Vertex.BoneWeightType.Qdef:c={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:[e.getFloat32(),e.getFloat32(),e.getFloat32(),e.getFloat32()]};break;default:throw new Error(`Invalid weightType: ${d}`)}const m=e.getFloat32();o.push({position:i,normal:s,uv:l,additionalVec4:h,weightType:d,boneWeight:c,edgeScale:m}),a%1e4==0&&100<performance.now()-r&&(await new Promise((e=>setTimeout(e,0))),r=performance.now())}return o}static _ParseIndices(e,t,n){const i=e.getInt32(),o=new ArrayBuffer(i*n.vertexIndexSize);let r;switch(n.vertexIndexSize){case 1:r=new Uint8Array(o);break;case 2:r=new Uint16Array(o);break;case 4:r=new Int32Array(o);break;default:throw new Error(`Invalid vertexIndexSize: ${n.vertexIndexSize}`)}for(let n=0;n<i;++n)r[n]=t.getVertexIndex(e);return r}static _ParseTextures(e){const t=e.getInt32(),n=[];for(let i=0;i<t;++i){const t=e.getDecoderString(e.getInt32(),!1);n.push(t)}return n}static _ParseMaterials(e,t){const n=e.getInt32(),i=[];for(let o=0;o<n;++o){const n=e.getDecoderString(e.getInt32(),!1),o=e.getDecoderString(e.getInt32(),!1),r=e.getFloat32Tuple(4),a=e.getFloat32Tuple(3),s=e.getFloat32(),l=e.getFloat32Tuple(3),h=e.getUint8(),d=e.getFloat32Tuple(4),c=e.getFloat32(),m=t.getTextureIndex(e),u=t.getTextureIndex(e),p=e.getUint8(),g=1===e.getUint8(),f={name:n,englishName:o,diffuse:r,specular:a,shininess:s,ambient:l,flag:h,edgeColor:d,edgeSize:c,textureIndex:m,sphereTextureIndex:u,sphereTextureMode:p,isSharedToonTexture:g,toonTextureIndex:g?e.getUint8():t.getTextureIndex(e),comment:e.getDecoderString(e.getInt32(),!1),indexCount:e.getInt32()};i.push(f)}return i}static _ParseBones(e,t){const n=e.getInt32(),i=[];for(let o=0;o<n;++o){const n=e.getDecoderString(e.getInt32(),!1),o=e.getDecoderString(e.getInt32(),!1),r=e.getFloat32Tuple(3),a=t.getBoneIndex(e),s=e.getInt32(),l=e.getUint16();let h,d,c,m,u,p;if(h=l&M.Bone.Flag.UseBoneIndexAsTailPosition?t.getBoneIndex(e):e.getFloat32Tuple(3),(l&M.Bone.Flag.HasAppendMove||l&M.Bone.Flag.HasAppendRotate)&&(d={parentIndex:t.getBoneIndex(e),ratio:e.getFloat32()}),l&M.Bone.Flag.HasAxisLimit&&(c=e.getFloat32Tuple(3)),l&M.Bone.Flag.HasLocalVector&&(m={x:e.getFloat32Tuple(3),z:e.getFloat32Tuple(3)}),l&M.Bone.Flag.IsExternalParentTransformed&&(u=e.getInt32()),l&M.Bone.Flag.IsIkEnabled){const n=t.getBoneIndex(e),i=e.getInt32(),o=e.getFloat32(),r=[],a=e.getInt32();for(let n=0;n<a;++n){const n={target:t.getBoneIndex(e),limitation:1===e.getUint8()?{minimumAngle:e.getFloat32Tuple(3),maximumAngle:e.getFloat32Tuple(3)}:void 0};r.push(n)}p={target:n,iteration:i,rotationConstraint:o,links:r}}const g={name:n,englishName:o,position:r,parentBoneIndex:a,transformOrder:s,flag:l,tailPosition:h,appendTransform:d,axisLimit:c,localVector:m,externalParentTransform:u,ik:p};i.push(g)}return i}static _ParseMorphs(e,t){const n=e.getInt32(),i=[];for(let o=0;o<n;++o){const n=e.getDecoderString(e.getInt32(),!1),o=e.getDecoderString(e.getInt32(),!1),r=e.getInt8(),a=e.getInt8();let s={name:n,englishName:o,category:r,type:a};const l=e.getInt32();switch(a){case M.Morph.Type.GroupMorph:{const n=new Int32Array(l),i=new Float32Array(l);for(let o=0;o<l;++o)n[o]=t.getMorphIndex(e),i[o]=e.getFloat32();s={...s,indices:n,ratios:i}}break;case M.Morph.Type.VertexMorph:{const n=new Int32Array(l),i=new Float32Array(3*l);for(let o=0;o<l;++o)n[o]=t.getVertexIndex(e),i[3*o+0]=e.getFloat32(),i[3*o+1]=e.getFloat32(),i[3*o+2]=e.getFloat32();s={...s,indices:n,positions:i}}break;case M.Morph.Type.BoneMorph:{const n=new Int32Array(l),i=new Float32Array(3*l),o=new Float32Array(4*l);for(let r=0;r<l;++r)n[r]=t.getBoneIndex(e),i[3*r+0]=e.getFloat32(),i[3*r+1]=e.getFloat32(),i[3*r+2]=e.getFloat32(),o[4*r+0]=e.getFloat32(),o[4*r+1]=e.getFloat32(),o[4*r+2]=e.getFloat32(),o[4*r+3]=e.getFloat32();s={...s,indices:n,positions:i,rotations:o}}break;case M.Morph.Type.UvMorph:case M.Morph.Type.AdditionalUvMorph1:case M.Morph.Type.AdditionalUvMorph2:case M.Morph.Type.AdditionalUvMorph3:case M.Morph.Type.AdditionalUvMorph4:{const n=new Int32Array(l),i=new Float32Array(4*l);for(let o=0;o<l;++o)n[o]=t.getVertexIndex(e),i[4*o+0]=e.getFloat32(),i[4*o+1]=e.getFloat32(),i[4*o+2]=e.getFloat32(),i[4*o+3]=e.getFloat32();s={...s,indices:n,offsets:i}}break;case M.Morph.Type.MaterialMorph:{const n=[];for(let i=0;i<l;++i){const i={index:t.getMaterialIndex(e),type:e.getUint8(),diffuse:e.getFloat32Tuple(4),specular:e.getFloat32Tuple(3),shininess:e.getFloat32(),ambient:e.getFloat32Tuple(3),edgeColor:e.getFloat32Tuple(4),edgeSize:e.getFloat32(),textureColor:e.getFloat32Tuple(4),sphereTextureColor:e.getFloat32Tuple(4),toonTextureColor:e.getFloat32Tuple(4)};n.push(i)}s={...s,elements:n}}break;case M.Morph.Type.FlipMorph:{const n=new Int32Array(l),i=new Float32Array(l);for(let o=0;o<l;++o)n[o]=t.getMorphIndex(e),i[o]=e.getFloat32();s={...s,indices:n,ratios:i}}break;case M.Morph.Type.ImpulseMorph:{const n=new Int32Array(l),i=new Array(l),o=new Float32Array(3*l),r=new Float32Array(3*l);for(let a=0;a<l;++a)n[a]=t.getRigidBodyIndex(e),i[a]=1===e.getUint8(),o[3*a+0]=e.getFloat32(),o[3*a+1]=e.getFloat32(),o[3*a+2]=e.getFloat32(),r[3*a+0]=e.getFloat32(),r[3*a+1]=e.getFloat32(),r[3*a+2]=e.getFloat32();s={...s,indices:n,isLocals:i,velocities:o,torques:r}}break;default:throw new Error(`Unknown morph type: ${a}`)}i.push(s)}return i}static _ParseDisplayFrames(e,t){const n=e.getInt32(),i=[];for(let o=0;o<n;++o){const n=e.getDecoderString(e.getInt32(),!1),o=e.getDecoderString(e.getInt32(),!1),r=1===e.getUint8(),a=e.getInt32(),s=[];for(let n=0;n<a;++n){const n=e.getUint8(),i={type:n,index:n===M.DisplayFrame.FrameData.FrameType.Bone?t.getBoneIndex(e):t.getMorphIndex(e)};s.push(i)}const l={name:n,englishName:o,isSpecialFrame:r,frames:s};i.push(l)}return i}static _ParseRigidBodies(e,t){const n=e.getInt32(),i=[];for(let o=0;o<n;++o){const n={name:e.getDecoderString(e.getInt32(),!1),englishName:e.getDecoderString(e.getInt32(),!1),boneIndex:t.getBoneIndex(e),collisionGroup:e.getUint8(),collisionMask:e.getUint16(),shapeType:e.getUint8(),shapeSize:e.getFloat32Tuple(3),shapePosition:e.getFloat32Tuple(3),shapeRotation:e.getFloat32Tuple(3),mass:e.getFloat32(),linearDamping:e.getFloat32(),angularDamping:e.getFloat32(),repulsion:e.getFloat32(),friction:e.getFloat32(),physicsMode:e.getUint8()};i.push(n)}return i}static _ParseJoints(e,t){const n=e.getInt32(),i=[];for(let o=0;o<n;++o){const n={name:e.getDecoderString(e.getInt32(),!1),englishName:e.getDecoderString(e.getInt32(),!1),type:e.getUint8(),rigidbodyIndexA:t.getRigidBodyIndex(e),rigidbodyIndexB:t.getRigidBodyIndex(e),position:e.getFloat32Tuple(3),rotation:e.getFloat32Tuple(3),positionMin:e.getFloat32Tuple(3),positionMax:e.getFloat32Tuple(3),rotationMin:e.getFloat32Tuple(3),rotationMax:e.getFloat32Tuple(3),springPosition:e.getFloat32Tuple(3),springRotation:e.getFloat32Tuple(3)};i.push(n)}return i}static _ParseSoftBodies(e,t,n){const i=e.getInt32(),o=[];for(let r=0;r<i;++r){const i=e.getDecoderString(e.getInt32(),!1),r=e.getDecoderString(e.getInt32(),!1),a=e.getUint8(),s=t.getMaterialIndex(e),l=e.getUint8(),h=e.getUint16(),d=e.getUint8(),c=e.getInt32(),m=e.getInt32(),u=e.getFloat32(),p=e.getFloat32(),g=e.getInt32(),f={vcf:e.getFloat32(),dp:e.getFloat32(),dg:e.getFloat32(),lf:e.getFloat32(),pr:e.getFloat32(),vc:e.getFloat32(),df:e.getFloat32(),mt:e.getFloat32(),chr:e.getFloat32(),khr:e.getFloat32(),shr:e.getFloat32(),ahr:e.getFloat32()},_={srhrCl:e.getFloat32(),skhrCl:e.getFloat32(),sshrCl:e.getFloat32(),srSpltCl:e.getFloat32(),skSpltCl:e.getFloat32(),ssSpltCl:e.getFloat32()},b={vIt:e.getInt32(),pIt:e.getInt32(),dIt:e.getInt32(),cIt:e.getInt32()},y={lst:e.getInt32(),ast:e.getInt32(),vst:e.getInt32()},A=e.getInt32(),M=[];for(let n=0;n<A;++n){const n={rigidbodyIndex:t.getRigidBodyIndex(e),vertexIndex:t.getVertexIndex(e),isNearMode:0!==e.getUint8()};M.push(n)}const T=e.getInt32(),w=new ArrayBuffer(T*n.vertexIndexSize);let x;switch(n.vertexIndexSize){case 1:x=new Uint8Array(w);break;case 2:x=new Uint16Array(w);break;case 4:x=new Int32Array(w);break;default:throw new Error(`Invalid vertexIndexSize: ${n.vertexIndexSize}`)}for(let n=0;n<T;++n)x[n]=t.getVertexIndex(e);const v={name:i,englishName:r,type:a,materialIndex:s,collisionGroup:l,collisionMask:h,flags:d,bLinkDistance:c,clusterCount:m,totalMass:u,collisionMargin:p,aeroModel:g,config:f,cluster:_,iteration:b,material:y,anchors:M,vertexPins:x};o.push(v)}return o}}class be extends pe{constructor(){super("pmx",{".pmx":{isBinary:!0}})}async _parseFileAsync(e){return await _e.ParseAsync(e,this).catch((e=>Promise.reject(e)))}}T.SceneLoader&&T.SceneLoader.RegisterPlugin(new be);var ye,Ae=ie(5527),Me=ie(3807);!function(e){let t,n,i;!function(e){let t,n,i;!function(e){e[e.IsSkinnedMesh=1]="IsSkinnedMesh"}(t=e.MeshType||(e.MeshType={})),function(e){e[e.HasSdef=1]="HasSdef",e[e.IsIndexed=2]="IsIndexed",e[e.HasEdgeScale=4]="HasEdgeScale"}(n=e.GeometryType||(e.GeometryType={})),function(e){e[e.Int32=0]="Int32",e[e.Uint32=1]="Uint32",e[e.Uint16=2]="Uint16"}(i=e.IndexElementType||(e.IndexElementType={}))}(t=e.Geometry||(e.Geometry={})),function(e){let t;!function(e){e[e.HasMimeType=1]="HasMimeType"}(t=e.Flag||(e.Flag={}))}(n=e.Image||(e.Image={})),function(e){let t;!function(e){e[e.NoMipmap=1]="NoMipmap",e[e.InvertY=2]="InvertY"}(t=e.Flag||(e.Flag={}))}(i=e.Texture||(e.Texture={}))}(ye||(ye={}));var Te=ie(4232);class we{constructor(){}static async ParseAsync(e,t=new w){const n=new x(e);n.initializeTextDecoder("utf-8");const i=this._ParseHeader(n),o=1===n.getUint8(),r=await this._ParseGeometriesAsync(n,o),a=await this._ParseImagesAsync(n),s=this._ParseTexturesAsync(n),l=this._ParseMaterials(n,i.version),h=o?this._ParseBones(n):[],d=this._ParseMorphs(n),c=this._ParseDisplayFrames(n),m=this._ParseRigidBodies(n),u=this._ParseJoints(n);return n.bytesAvailable>0&&t.warn(`There are ${n.bytesAvailable} bytes left after parsing`),{header:i,geometries:r,images:a,textures:s,materials:l,bones:h,morphs:d,displayFrames:c,rigidBodies:m,joints:u}}static _ParseHeader(e){if(e.bytesAvailable<7)throw new RangeError("is not bpmx file");const t=e.getDecoderString(4,!1);if("BPMX"!==t)throw new RangeError("is not bpmx file");const n=[e.getInt8(),e.getInt8(),e.getInt8()];if(2!==n[0]||0!==n[1]&&1!==n[1]||0!==n[2])throw new Te.LoadFileError(`BPMX version ${n[0]}.${n[1]}.${n[2]} is not supported.`);return{signature:t,version:n,modelName:e.getDecoderString(e.getUint32(),!1),englishModelName:e.getDecoderString(e.getUint32(),!1),comment:e.getDecoderString(e.getUint32(),!1),englishComment:e.getDecoderString(e.getUint32(),!1)}}static async _ParseGeometriesAsync(e,t){let n=performance.now();const i=[],o=e.getUint32();for(let r=0;r<o;++r){const o=e.getDecoderString(e.getUint32(),!1);let r=e.getInt32();if(-2===r){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getInt32(),i=e.getUint32(),o=e.getUint32(),r=e.getUint32(),a=e.getUint32();n.push({materialIndex:t,verticesStart:i,verticesCount:o,indexStart:r,indexCount:a})}r=n}const a=e.getUint32(),s=new Float32Array(3*a);e.getFloat32Array(s),100<performance.now()-n&&(await new Promise((e=>setTimeout(e,0))),n=performance.now());const l=new Float32Array(3*a);e.getFloat32Array(l),100<performance.now()-n&&(await new Promise((e=>setTimeout(e,0))),n=performance.now());const h=new Float32Array(2*a);e.getFloat32Array(h);const d=[],c=e.getUint8();for(let t=0;t<c;++t){const t=new Float32Array(4*a);e.getFloat32Array(t),d.push(t)}100<performance.now()-n&&(await new Promise((e=>setTimeout(e,0))),n=performance.now());const m=e.getUint8();let u,p,g;if(0!=(m&ye.Geometry.GeometryType.IsIndexed)){const t=e.getUint8(),i=e.getUint32();t===ye.Geometry.IndexElementType.Int32?(u=new Int32Array(i),e.getInt32Array(u)):t===ye.Geometry.IndexElementType.Uint32?(u=new Uint32Array(i),e.getUint32Array(u)):(u=new Uint16Array(i),e.getUint16Array(u)),100<performance.now()-n&&(await new Promise((e=>setTimeout(e,0))),n=performance.now())}if(t){const t=new Float32Array(4*a);e.getFloat32Array(t);const i=new Float32Array(4*a);let o;if(e.getFloat32Array(i),100<performance.now()-n&&(await new Promise((e=>setTimeout(e,0))),n=performance.now()),0!=(m&ye.Geometry.GeometryType.HasSdef)){const t=new Float32Array(3*a),i=new Float32Array(3*a),r=new Float32Array(3*a);e.getFloat32Array(t),e.getFloat32Array(i),e.getFloat32Array(r),o={c:t,r0:i,r1:r},100<performance.now()-n&&(await new Promise((e=>setTimeout(e,0))),n=performance.now())}p={matricesIndices:t,matricesWeights:i,sdef:o}}0!=(m&ye.Geometry.GeometryType.HasEdgeScale)&&(g=new Float32Array(a),e.getFloat32Array(g));const f={name:o,materialIndex:r,positions:s,normals:l,uvs:h,additionalUvs:d,indices:u,skinning:p,edgeScale:g};i.push(f)}return i}static async _ParseImagesAsync(e){const t=e.getUint32();let n=performance.now();const i=[];for(let o=0;o<t;++o){const t=e.getDecoderString(e.getUint32(),!1),o=0!=(e.getUint8()&ye.Image.Flag.HasMimeType)?e.getDecoderString(e.getUint32(),!1):void 0,r=e.getUint32(),a=new ArrayBuffer(r);e.getUint8Array(new Uint8Array(a)),i.push({relativePath:t,mimeType:o,data:a}),100<performance.now()-n&&(await new Promise((e=>setTimeout(e,0))),n=performance.now())}return i}static _ParseTexturesAsync(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getUint8(),i=e.getUint8(),o=e.getInt32();n.push({flag:t,samplingMode:i,imageIndex:o})}return n}static _ParseMaterials(e,t){const n=e.getUint32(),i=[];for(let o=0;o<n;++o){const n={name:e.getDecoderString(e.getUint32(),!1),englishName:e.getDecoderString(e.getUint32(),!1),diffuse:e.getFloat32Tuple(4),specular:e.getFloat32Tuple(3),shininess:e.getFloat32(),ambient:e.getFloat32Tuple(3),evaluatedTransparency:2===t[0]&&0===t[1]?240|e.getUint8():e.getUint8(),flag:e.getUint8(),edgeColor:e.getFloat32Tuple(4),edgeSize:e.getFloat32(),textureIndex:e.getInt32(),sphereTextureIndex:e.getInt32(),sphereTextureMode:e.getUint8(),isSharedToonTexture:1===e.getUint8(),toonTextureIndex:e.getInt32(),comment:e.getDecoderString(e.getUint32(),!1)};i.push(n)}return i}static _ParseBones(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getDecoderString(e.getUint32(),!1),i=e.getDecoderString(e.getUint32(),!1),o=e.getFloat32Tuple(3),r=e.getInt32(),a=e.getInt32(),s=e.getUint16();let l,h,d,c,m,u;if(l=s&M.Bone.Flag.UseBoneIndexAsTailPosition?e.getInt32():e.getFloat32Tuple(3),(s&M.Bone.Flag.HasAppendMove||s&M.Bone.Flag.HasAppendRotate)&&(h={parentIndex:e.getInt32(),ratio:e.getFloat32()}),s&M.Bone.Flag.HasAxisLimit&&(d=e.getFloat32Tuple(3)),s&M.Bone.Flag.HasLocalVector&&(c={x:e.getFloat32Tuple(3),z:e.getFloat32Tuple(3)}),s&M.Bone.Flag.IsExternalParentTransformed&&(m=e.getInt32()),s&M.Bone.Flag.IsIkEnabled){const t=e.getInt32(),n=e.getInt32(),i=e.getFloat32(),o=[],r=e.getInt32();for(let t=0;t<r;++t){const t={target:e.getInt32(),limitation:1===e.getUint8()?{minimumAngle:e.getFloat32Tuple(3),maximumAngle:e.getFloat32Tuple(3)}:void 0};o.push(t)}u={target:t,iteration:n,rotationConstraint:i,links:o}}const p={name:t,englishName:i,position:o,parentBoneIndex:r,transformOrder:a,flag:s,tailPosition:l,appendTransform:h,axisLimit:d,localVector:c,externalParentTransform:m,ik:u};n.push(p)}return n}static _ParseMorphs(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getDecoderString(e.getUint32(),!1),i=e.getDecoderString(e.getUint32(),!1),o=e.getUint8(),r=e.getUint8();let a={name:t,englishName:i,category:o,type:r};switch(r){case M.Morph.Type.GroupMorph:{const t=e.getUint32(),n=new Int32Array(t);e.getInt32Array(n);const i=new Float32Array(t);e.getFloat32Array(i),a={...a,indices:n,ratios:i}}break;case M.Morph.Type.VertexMorph:{const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getUint32(),i=e.getUint32(),o=new Int32Array(i);e.getInt32Array(o);const r=new Float32Array(3*i);e.getFloat32Array(r);const a={meshIndex:t,indices:o,offsets:r};n.push(a)}a={...a,elements:n}}break;case M.Morph.Type.BoneMorph:{const t=e.getUint32(),n=new Int32Array(t);e.getInt32Array(n);const i=new Float32Array(3*t);e.getFloat32Array(i);const o=new Float32Array(4*t);e.getFloat32Array(o),a={...a,indices:n,positions:i,rotations:o}}break;case M.Morph.Type.UvMorph:case M.Morph.Type.AdditionalUvMorph1:case M.Morph.Type.AdditionalUvMorph2:case M.Morph.Type.AdditionalUvMorph3:case M.Morph.Type.AdditionalUvMorph4:{const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getUint32(),i=e.getUint32(),o=new Int32Array(i);e.getInt32Array(o);const r=new Float32Array(4*i);e.getFloat32Array(r);const a={meshIndex:t,indices:o,offsets:r};n.push(a)}a={...a,elements:n}}break;case M.Morph.Type.MaterialMorph:{const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t={index:e.getInt32(),type:e.getUint8(),diffuse:e.getFloat32Tuple(4),specular:e.getFloat32Tuple(3),shininess:e.getFloat32(),ambient:e.getFloat32Tuple(3),edgeColor:e.getFloat32Tuple(4),edgeSize:e.getFloat32(),textureColor:e.getFloat32Tuple(4),sphereTextureColor:e.getFloat32Tuple(4),toonTextureColor:e.getFloat32Tuple(4)};n.push(t)}a={...a,elements:n}}break;default:throw new Error(`Unknown morph type: ${r}`)}n.push(a)}return n}static _ParseDisplayFrames(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getDecoderString(e.getUint32(),!1),i=e.getDecoderString(e.getUint32(),!1),o=1===e.getUint8(),r=e.getUint32(),a=[];for(let t=0;t<r;++t){const t={type:e.getUint8(),index:e.getInt32()};a.push(t)}const s={name:t,englishName:i,isSpecialFrame:o,frames:a};n.push(s)}return n}static _ParseRigidBodies(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t={name:e.getDecoderString(e.getUint32(),!1),englishName:e.getDecoderString(e.getUint32(),!1),boneIndex:e.getInt32(),collisionGroup:e.getUint8(),collisionMask:e.getUint16(),shapeType:e.getUint8(),shapeSize:e.getFloat32Tuple(3),shapePosition:e.getFloat32Tuple(3),shapeRotation:e.getFloat32Tuple(3),mass:e.getFloat32(),linearDamping:e.getFloat32(),angularDamping:e.getFloat32(),repulsion:e.getFloat32(),friction:e.getFloat32(),physicsMode:e.getUint8()};n.push(t)}return n}static _ParseJoints(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t={name:e.getDecoderString(e.getUint32(),!1),englishName:e.getDecoderString(e.getUint32(),!1),type:e.getUint8(),rigidbodyIndexA:e.getInt32(),rigidbodyIndexB:e.getInt32(),position:e.getFloat32Tuple(3),rotation:e.getFloat32Tuple(3),positionMin:e.getFloat32Tuple(3),positionMax:e.getFloat32Tuple(3),rotationMin:e.getFloat32Tuple(3),rotationMax:e.getFloat32Tuple(3),springPosition:e.getFloat32Tuple(3),springRotation:e.getFloat32Tuple(3)};n.push(t)}return n}}class xe extends ce{constructor(){super("bpmx",{".bpmx":{isBinary:!0}})}loadFile(e,t,n,i,o,r,a){const s=this.materialBuilder,l=this.useSdef,h=this.buildSkeleton,d=this.buildMorph,c=this.boundingBoxMargin,m=this.preserveSerializationData;return e._loadFile(t,((e,n)=>{const o={arrayBuffer:e,pmFileId:t instanceof File?me.GetId(t).toString():t,materialBuilder:s,useSdef:l,buildSkeleton:h,buildMorph:d,boundingBoxMargin:c,preserveSerializationData:m};i(o,n)}),o,!0,r,a)}async _parseFileAsync(e){return await we.ParseAsync(e,this).catch((e=>Promise.reject(e)))}_getProgressTaskCosts(e,t){const n=super._getProgressTaskCosts(e,t);let i=0;for(let e=0;e<t.geometries.length;++e)i+=t.geometries[e].positions.length;if(n.push({name:"Build Geometry",cost:i}),e.buildMorph){let e=0;const i=t.morphs;for(let t=0;t<i.length;++t){const n=i[t];if(n.type!==M.Morph.Type.VertexMorph&&n.type!==M.Morph.Type.UvMorph)continue;const o=n.elements;for(let t=0;t<o.length;++t)e+=o[t].indices.length}n.push({name:"Build Morph",cost:e})}return n}async _buildGeometryAsync(e,t,n,i,o,r){const a=[],s=[];let l=performance.now(),h=0;const d=t.geometries;for(let c=0;c<d.length;++c){const m=d[c],u=m.skinning,g=new P.VertexData;g.positions=m.positions,g.normals=m.normals,g.uvs=m.uvs,void 0!==m.indices&&(g.indices=m.indices),e.buildSkeleton&&void 0!==u&&(g.matricesIndices=u.matricesIndices,g.matricesWeights=u.matricesWeights);let f=null,_=null,b=null;if(e.buildSkeleton&&e.useSdef&&void 0!==u?.sdef){const e=m.positions.length/3,t=u.matricesWeights;f=u.sdef.c,_=u.sdef.r0,b=u.sdef.r1;for(let n=0;n<e;++n){const e=t[4*n+0],i=t[4*n+1],o=f[3*n+0],r=f[3*n+1],a=f[3*n+2];let s=_[3*n+0],l=_[3*n+1],h=_[3*n+2],d=b[3*n+0],c=b[3*n+1],m=b[3*n+2];const u=s*e+d*i,p=l*e+c*i,g=h*e+m*i;s=o+s-u,l=r+l-p,h=a+h-g,d=o+d-u,c=r+c-p,m=a+m-g;const y=.5*(o+s),A=.5*(r+l),M=.5*(a+h),T=.5*(o+d),w=.5*(r+c),x=.5*(a+m);f[3*n+0]=o,f[3*n+1]=r,f[3*n+2]=a,_[3*n+0]=y,_[3*n+1]=A,_[3*n+2]=M,b[3*n+0]=T,b[3*n+1]=w,b[3*n+2]=x}}i._blockEntityCollection=!!o;const y=new(null!==f?ue:B.Mesh)(m.name,i);y._parentContainer=o,i._blockEntityCollection=!1,void 0===m.indices&&(y.isUnIndexed=!0),y.setParent(n),a.push(y),i._blockEntityCollection=!!o;const A=new I.Geometry(t.header.modelName,i,g,!1);if(A._parentContainer=o,i._blockEntityCollection=!1,e.preserveSerializationData&&void 0!==m.additionalUvs){const e=[p.AdditionalUV1Kind,p.AdditionalUV2Kind,p.AdditionalUV3Kind,p.AdditionalUV4Kind];for(let t=0;t<m.additionalUvs.length;++t)A.setVerticesData(e[t],m.additionalUvs[t],!1,4)}null!==f&&(A.setVerticesData(p.MatricesSdefCKind,f,!1,3),A.setVerticesData(p.MatricesSdefR0Kind,_,!1,3),A.setVerticesData(p.MatricesSdefR1Kind,b,!1,3)),e.preserveSerializationData&&void 0!==m.edgeScale&&A.setVerticesData(p.EdgeScaleKind,m.edgeScale,!1,1),A.applyToMesh(y),s.push(A),h+=m.positions.length,h%1e4==0&&100<performance.now()-l&&(r.setTaskProgress("Build Geometry",h),r.invokeProgressEvent(),await R.Tools.DelayAsync(0),l=performance.now())}return r.endTask("Build Geometry"),r.invokeProgressEvent(),{meshes:a,geometries:s}}async _buildMaterialAsync(e,t,n,i,o,r,a,s,l){let h;const d=new Array(t.images.length);for(let e=0;e<t.images.length;++e)d[e]=t.images[e].relativePath;const c=new Array(t.textures.length);for(let e=0;e<t.textures.length;++e){const n=t.textures[e];c[e]={noMipmap:0!=(n.flag&ye.Texture.Flag.NoMipmap),invertY:0!=(n.flag&ye.Texture.Flag.InvertY),samplingMode:n.samplingMode,imagePathIndex:n.imageIndex}}const m=new Array(t.materials.length);for(let e=0;e<m.length;++e)m[e]=[];const u=t.geometries;for(let e=0;e<i.length;++e){const t=u[e].materialIndex;if(-1!==t)if("object"==typeof t){const n=t;for(let t=0;t<n.length;++t)m[n[t].materialIndex].push({mesh:i[e],subMeshIndex:t})}else m[t].push(i[e])}const p=new Promise((u=>{h=e.materialBuilder.buildMaterials(n.uniqueId,t.materials,c,d,s,"file:"+e.pmFileId+"_",t.images,m,i,r,a,o,this,(e=>{e.lengthComputable&&(l.setTaskProgressRatio("Texture Load",e.loaded/e.total,!0),l.invokeProgressEvent())}),(()=>u()))})),g=Array.isArray(h)?h:await h,f=[];for(let e=0;e<i.length;++e){const t=i[e],n=u[e].materialIndex;if(-1!==n)if("object"==typeof n){const e=n;if(t.subMeshes.length=0,0===e.length)t.material=null;else if(1===e.length){const n=e[0];new Me.SubMesh(0,n.verticesStart,n.verticesCount,n.indexStart,n.indexCount,t),t.material=g[e[0].materialIndex]}else{r._blockEntityCollection=!!a;const n=new Ae.MultiMaterial(t.name,r);n._parentContainer=a,r._blockEntityCollection=!1;const i=n.subMaterials;f.push(n);for(let n=0;n<e.length;++n){const o=e[n];new Me.SubMesh(n,o.verticesStart,o.verticesCount,o.indexStart,o.indexCount,t),i.push(g[o.materialIndex])}t.material=n}}else{const e=g[n];t.material=e}}return l.endTask("Build Material"),l.invokeProgressEvent(),{materials:g,multiMaterials:f,textureLoadPromise:p}}_buildSkeletonAsync(e,t,n,i,o,r,a){return 0===t.bones.length?(a.endTask("Build Skeleton"),Promise.resolve(null)):super._buildSkeletonAsync(e,t,n,i,o,r,a)}async _buildMorphAsync(e,t,n,i,r,a,s){const l=e.preserveSerializationData,h=t.morphs,d=new Array(t.geometries.length);for(let e=0;e<d.length;++e)d[e]=[];let c=0,m=performance.now();for(let e=0;e<h.length;++e){const n=h[e],o=[];switch(n.type){case M.Morph.Type.GroupMorph:case M.Morph.Type.BoneMorph:case M.Morph.Type.MaterialMorph:a.push(n);break;case M.Morph.Type.VertexMorph:case M.Morph.Type.UvMorph:case M.Morph.Type.AdditionalUvMorph1:case M.Morph.Type.AdditionalUvMorph2:case M.Morph.Type.AdditionalUvMorph3:case M.Morph.Type.AdditionalUvMorph4:a.push({name:n.name,englishName:n.englishName,category:n.category,type:n.type,morphTargets:o,...l?{elements:n.elements}:void 0})}if(n.type===M.Morph.Type.VertexMorph||n.type===M.Morph.Type.UvMorph||n.type===M.Morph.Type.AdditionalUvMorph1||n.type===M.Morph.Type.AdditionalUvMorph2||n.type===M.Morph.Type.AdditionalUvMorph3||n.type===M.Morph.Type.AdditionalUvMorph4){if(n.type!==M.Morph.Type.AdditionalUvMorph1&&n.type!==M.Morph.Type.AdditionalUvMorph2&&n.type!==M.Morph.Type.AdditionalUvMorph3&&n.type!==M.Morph.Type.AdditionalUvMorph4){const e=n.elements;for(let t=0;t<e.length;++t){const r=new C.MorphTarget(n.name,0,i);o.push(r),d[e[t].meshIndex].push(r),c+=e[t].indices.length}const r=t.geometries;if(n.type===M.Morph.Type.VertexMorph)for(let t=0;t<e.length;++t){const n=e[t],i=r[n.meshIndex],a=new Float32Array(i.positions.length);a.set(i.positions);const s=n.indices,l=n.offsets;for(let e=0;e<s.length;++e){const t=s[e];a[3*t+0]+=l[3*e+0],a[3*t+1]+=l[3*e+1],a[3*t+2]+=l[3*e+2]}o[t].setPositions(a)}else for(let t=0;t<e.length;++t){const n=e[t],i=r[n.meshIndex],a=new Float32Array(i.uvs.length);a.set(i.uvs);const s=n.indices,l=n.offsets;for(let e=0;e<s.length;++e){const t=s[e];a[2*t+0]+=l[4*e+0],a[2*t+1]+=l[4*e+1]}const h=o[t];h.setPositions(i.positions),h.setUVs(a)}}100<performance.now()-m&&(s.setTaskProgress("Build Morph",c),s.invokeProgressEvent(),await R.Tools.DelayAsync(0),m=performance.now())}}s.endTask("Build Morph");const u=[],p=n.meshes;for(let e=0;e<d.length;++e){const t=d[e];if(0===t.length)continue;i._blockEntityCollection=!!r;const a=new O.MorphTargetManager(i);a._parentContainer=r,i._blockEntityCollection=!1,a.enableNormalMorphing=!1,a.enableTangentMorphing=!1,a.enableUVMorphing=!1,a.areUpdatesFrozen=!0;for(let e=0;e<t.length;++e){const n=t[e];a.addTarget(n),n.hasUVs&&(a.enableUVMorphing=!0)}if(a.enableUVMorphing){const i=n.geometries[e].getVerticesData(o.VertexBuffer.UVKind);for(let e=0;e<t.length;++e){const n=t[e];n.hasUVs||n.setUVs(i)}}a.areUpdatesFrozen=!1,u.push(a),p[e].morphTargetManager=a}return u}}T.SceneLoader&&T.SceneLoader.RegisterPlugin(new xe);class ve{animation;startFrame;endFrame;offset;weight;easingFunction;easeInFrameTime;easeOutFrameTime;constructor(e,t,n,i,o){this.animation=e,this.startFrame=t??e.startFrame,this.endFrame=n??e.endFrame,this.offset=i??0,this.weight=o??1,this.easingFunction=null,this.easeInFrameTime=0,this.easeOutFrameTime=0}get name(){return this.animation.name}isInSpan(e){return this.startFrame+this.offset<=e&&e<=this.endFrame+this.offset}getFrameTime(e){return e-this.offset}getEasedWeight(e){const t=this.startFrame,n=this.endFrame,i=this.easeInFrameTime,o=this.easeOutFrameTime;if(Math.abs(e-t)<Math.abs(e-n)){if(t+i<=e)return this.weight;if(e<=t)return 0;{const n=e-t;return this.weight*(this.easingFunction?.ease(n/i)??n/i)}}if(e<=n-o)return this.weight;if(n<=e)return 0;{const t=e-n+o;return this.weight*(1-(this.easingFunction?.ease(t/o)??t/o))}}}class Ie{onSpanAddedObservable;onSpanRemovedObservable;name;_startFrame;_endFrame;_spans;constructor(e){this.onSpanAddedObservable=new V.Observable,this.onSpanRemovedObservable=new V.Observable,this.name=e,this._startFrame=0,this._endFrame=0,this._spans=[]}addSpan(e){this._startFrame=0===this._spans.length?e.startFrame+e.offset:Math.min(this.startFrame,e.startFrame+e.offset),this._endFrame=Math.max(this.endFrame,e.endFrame+e.offset),this._spans.push(e),this.onSpanAddedObservable.notifyObservers(e)}removeSpan(e){const t=this._spans.indexOf(e);this.removeSpanFromIndex(t)}removeSpanFromIndex(e){const t=this._spans;if(!(e<0||t.length<=e)){if(t.splice(e,1),0===t.length)this._startFrame=0,this._endFrame=0;else{let e=t[0].startFrame+t[0].offset,n=t[0].endFrame+t[0].offset;for(let i=1;i<t.length;i++){const o=t[i];e=Math.min(e,o.startFrame+o.offset),n=Math.max(n,o.endFrame+o.offset)}this._startFrame=e,this._endFrame=n}this.onSpanRemovedObservable.notifyObservers(e)}}get startFrame(){return this._startFrame}get endFrame(){return this._endFrame}get spans(){return this._spans}}class Be{animation;_camera;_runtimeAnimations;_onSpanAdded;_onSpanRemoved;constructor(e,t,n,i,o){this.animation=e,this._camera=t,this._runtimeAnimations=n,this._onSpanAdded=i,this._onSpanRemoved=o,e.onSpanAddedObservable.add(i),e.onSpanRemovedObservable.add(o)}static _ActiveAnimationSpans=[];static _ActiveRuntimeAnimations=[];static _CameraPosition=new c.Vector3;static _CameraRotation=new c.Vector3;animate(e){e=Math.max(this.animation.startFrame,Math.min(this.animation.endFrame,e));const t=this.animation.spans,n=this._runtimeAnimations,i=Be._ActiveAnimationSpans,o=Be._ActiveRuntimeAnimations;for(let r=0;r<t.length;++r){const a=t[r],s=n[r];null!==s&&0<a.weight&&a.isInSpan(e)&&(i.push(a),o.push(s))}let r=0;for(let t=0;t<i.length;++t)r+=i[t].getEasedWeight(i[t].getFrameTime(e));const a=this._camera;if(0===r)return i.length=0,void(o.length=0);if(1===r&&1===i.length){const t=i[0];return o[0].animate(t.getFrameTime(e)),i.length=0,void(o.length=0)}const s=r<1?1:1/r,l=Be._CameraPosition.setAll(0),h=Be._CameraRotation.setAll(0);let d=0,c=0;for(let t=0;t<i.length;++t){const n=i[t],r=o[t],m=n.getFrameTime(e);r.animate(m);const u=n.getEasedWeight(m)*s;a.position.scaleAndAddToRef(u,l),a.rotation.scaleAndAddToRef(u,h),d+=a.distance*u,c+=a.fov*u}a.position.copyFrom(l),a.rotation.copyFrom(h),a.distance=d,a.fov=c,i.length=0,o.length=0}dispose(){null!==this._onSpanAdded&&(this.animation.onSpanAddedObservable.removeCallback(this._onSpanAdded),this.animation.onSpanRemovedObservable.removeCallback(this._onSpanRemoved),this._onSpanAdded=null,this._onSpanRemoved=null)}static Create(e,t){const n=new Array(e.spans.length).fill(null),i=e.spans;for(let e=0;e<i.length;++e){const o=i[e].animation;if(void 0!==o.createRuntimeCameraAnimation){const i=o.createRuntimeCameraAnimation(t);n[e]=i}else if(void 0===o.createRuntimeModelAnimation)throw new Error(`animation ${o.name} is not bindable. are you missing import "babylon-mmd/esm/Runtime/Animation/mmdRuntimeCameraAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeCameraAnimationGroup"?`)}return new Be(e,t,n,(e=>{const i=e.animation;if(void 0!==i.createRuntimeCameraAnimation){const e=i.createRuntimeCameraAnimation(t);n.push(e)}else{if(void 0===i.createRuntimeModelAnimation)throw new Error(`animation ${i.name} is not bindable. are you missing import "babylon-mmd/esm/Runtime/Animation/mmdRuntimeCameraAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeCameraAnimationGroup"?`);n.push(null)}}),(e=>{n.splice(e,1)}))}}function Pe(e,t,n,i){let o=!1,r=!1,a=!1;const s=new Set,l=t=>{const n=t.materialElements;for(let t=0;t<n.length;++t){const i=n[t];if(null!==i.textureColor&&!o){const t=i.index;if(-1===i.index){for(let t=0;t<e.length;++t)e[t].textureMultiplicativeColor;o=!0}else e[t].textureMultiplicativeColor,s.add(t.toString())}if(null!==i.sphereTextureColor&&!r){const t=i.index;if(-1===i.index){for(let t=0;t<e.length;++t)e[t].sphereTextureMultiplicativeColor;r=!0}else e[t].sphereTextureMultiplicativeColor,s.add(t.toString())}if(null!==i.toonTextureColor&&!a){const t=i.index;if(-1===i.index){for(let t=0;t<e.length;++t)e[t].toonTextureMultiplicativeColor;a=!0}else e[t].toonTextureMultiplicativeColor,s.add(t.toString())}}},h=new Uint8Array(t.morphs.length);for(let e=0;e<n.length;++e){const i=n[e];if(null!==i){for(let e=0;e<i.length;++e){const n=i[e];if(1===h[n])continue;h[n]=1;const o=t.morphs[n];switch(o.type){case M.Morph.Type.GroupMorph:{const e=o.elements;for(let n=0;n<e.length;++n){const i=e[n];if(1===h[i])continue;h[i]=1;const o=t.morphs[i];void 0!==o&&o.type===M.Morph.Type.MaterialMorph&&l(o)}}break;case M.Morph.Type.MaterialMorph:l(o)}}if(o&&r&&a)break}}o||r||a?i?.log("All materials could be recompiled for morph animation"):0<s.size&&i?.log(`Materials ${Array.from(s).join(", ")} could be recompiled for morph animation`)}function Re(e,t){const n=e.morphTargetManagers,i=new Array(n.length),o=new Array(n.length);for(let e=0;e<n.length;++e){const t=i[e]=new Set,r=o[e]=new Set,a=n[e],s=a.numTargets;for(let e=0;e<s;++e){const n=a.getTarget(e);t.add(n),0!==n.influence&&r.add(n)}}{const t=e.morphs;for(let e=0;e<t.length;++e){const n=t[e];switch(n.type){case M.Morph.Type.VertexMorph:case M.Morph.Type.UvMorph:{const e=n.elements;for(let t=0;t<e.length;++t){const n=e[t];for(let e=0;e<o.length;++e)o[e].delete(n)}}}}}const r=e=>{const t=e.elements;for(let e=0;e<t.length;++e){const r=t[e];for(let e=0;e<n.length;++e)i[e].has(r)&&o[e].add(r)}},a=new Uint8Array(e.morphs.length);for(let n=0;n<t.length;++n){const i=t[n];if(null!==i)for(let t=0;t<i.length;++t){const n=i[t];if(1===a[n])continue;a[n]=1;const o=e.morphs[n];switch(o.type){case M.Morph.Type.GroupMorph:{const t=o.elements;for(let n=0;n<t.length;++n){const i=t[n];if(1===a[i])continue;a[i]=1;const o=e.morphs[i];if(void 0!==o)switch(o.type){case M.Morph.Type.VertexMorph:case M.Morph.Type.UvMorph:r(o)}}}break;case M.Morph.Type.VertexMorph:case M.Morph.Type.UvMorph:r(o)}}}for(let e=0;e<n.length;++e)n[e].numMaxInfluencers=o[e].size}Ie.prototype.createRuntimeCameraAnimation=function(e){return Be.Create(this,e)};class Ce{animation;_ikSolverStates;_morphController;_meshes;_runtimeAnimations;_onSpanAdded;_onSpanRemoved;constructor(e,t,n,i,o,r,a){this.animation=e,this._ikSolverStates=t,this._morphController=n,this._meshes=i,this._runtimeAnimations=o,this._onSpanAdded=r,this._onSpanRemoved=a,e.onSpanAddedObservable.add(r),e.onSpanRemovedObservable.add(a)}static _RuntimeAnimationIdMap=new WeakMap;static _RuntimeAnimationIdCounter=0;static _GetRuntimeAnimationId(e){let t=Ce._RuntimeAnimationIdMap.get(e);return void 0===t&&(t=Ce._RuntimeAnimationIdCounter+=1,Ce._RuntimeAnimationIdMap.set(e,t)),t}_boneResultMap=new Map;_movableBoneResultMap=new Map;_morphResultMap=new Map;_ikSolverResultMap=new Map;_activeAnimationSpans=[];_activeRuntimeAnimations=[];_activeRuntimeAnimationIds=[];_lastActiveRuntimeAnimationIds=[];_boneRestPosition=new c.Vector3;static _IdentityQuaternion=c.Quaternion.Identity();animate(e){e=Math.max(this.animation.startFrame,Math.min(this.animation.endFrame,e));const t=this.animation.spans,n=this._runtimeAnimations,i=this._activeAnimationSpans,o=this._activeRuntimeAnimations,r=this._morphController;for(let r=0;r<t.length;++r){const a=t[r],s=n[r];null!==s&&0<a.weight&&a.isInSpan(e)&&(i.push(a),o.push(s))}let a=0;for(let t=0;t<i.length;++t)a+=i[t].getEasedWeight(i[t].getFrameTime(e));const s=this._meshes,l=this._ikSolverStates,h=this._boneResultMap,d=this._movableBoneResultMap,m=this._morphResultMap,u=this._ikSolverResultMap;let p=!0;const g=this._activeRuntimeAnimationIds,f=this._lastActiveRuntimeAnimationIds;if(f.length!==o.length){p=!1;for(let e=0;e<o.length;++e)g.push(Ce._GetRuntimeAnimationId(o[e]))}else for(let e=0;e<o.length;++e){const t=Ce._GetRuntimeAnimationId(o[e]);g.push(t),f[e]!==t&&(p=!1)}if(this._lastActiveRuntimeAnimationIds=g,this._activeRuntimeAnimationIds=f,f.length=0,p)if(0===a){for(const[e,t]of h)e.rotationQuaternion.copyFromFloats(0,0,0,1),t[1]=0,t[2]=0;for(const[e,t]of d)e.rotationQuaternion.copyFromFloats(0,0,0,1),e.getRestMatrix().getTranslationToRef(this._boneRestPosition),t[0].copyFromFloats(0,0,0),t[2]=0,t[3]=0;for(const[e,t]of m)r.setMorphWeightFromIndex(e,0),m.set(e,0);for(let e=0;e<s.length;++e)s[e].visibility=1;for(const[e,t]of u)l[e]=0,u.set(e,!0)}else{for(const[e,t]of h)t[1]=0,t[2]=0;for(const[e,t]of d)t[0].copyFromFloats(0,0,0),t[2]=0,t[3]=0;for(const[e,t]of m)m.set(e,0);for(const[e,t]of u)u.set(e,!0)}else{for(const[e,t]of h)e.rotationQuaternion.copyFromFloats(0,0,0,1);for(const[e,t]of d)e.rotationQuaternion.copyFromFloats(0,0,0,1),e.getRestMatrix().getTranslationToRef(this._boneRestPosition);for(const[e,t]of m)r.setMorphWeightFromIndex(e,0);for(let e=0;e<s.length;++e)s[e].visibility=1;for(const[e,t]of u)l[e]=1;h.clear(),d.clear(),m.clear(),u.clear()}if(0===a)return i.length=0,void(o.length=0);if(1===a&&1===i.length){const t=i[0],n=o[0];n.animate(t.getFrameTime(e));const r=n.boneBindIndexMap;for(let e=0;e<r.length;++e){const t=r[e];null!==t&&void 0===h.get(t)&&h.set(t,[new c.Quaternion,0,0])}const a=n.movableBoneBindIndexMap;for(let e=0;e<a.length;++e){const t=a[e];null!==t&&void 0===d.get(t)&&d.set(t,[new c.Vector3,new c.Quaternion,0,0])}const s=n.morphBindIndexMap;for(let e=0;e<s.length;++e){const t=s[e];if(null!==t)for(let e=0;e<t.length;++e){const n=t[e];void 0===m.get(n)&&m.set(n,0)}}const l=n.ikSolverBindIndexMap;for(let e=0;e<l.length;++e){const t=l[e];null!==t&&void 0===u.get(t)&&u.set(t,!0)}return i.length=0,void(o.length=0)}let _,b;a<1?(_=1,b=1-a):(_=1/a,b=0);for(let t=0;t<i.length;++t){const n=i[t],a=o[t];0!==s.length&&(s[0].visibility=1);const p=n.getFrameTime(e);a.animate(p);const g=n.getEasedWeight(p)*_,f=a.boneBindIndexMap;for(let e=0;e<f.length;++e){const t=f[e];if(null!==t){const e=h.get(t);void 0===e?h.set(t,[t.rotationQuaternion.clone(),g,1]):(0===e[2]?(e[0].copyFrom(t.rotationQuaternion),e[1]=g):(c.Quaternion.SlerpToRef(e[0],t.rotationQuaternion,g/(e[1]+g),e[0]),e[1]+=g),e[2]+=1)}}const y=a.movableBoneBindIndexMap;for(let e=0;e<y.length;++e){const t=y[e];if(null!==t){const e=t.getRestMatrix().getTranslationToRef(this._boneRestPosition),n=d.get(t);void 0===n?d.set(t,[t.position.clone().subtractInPlace(e).scaleInPlace(g),t.rotationQuaternion.clone(),g,1]):(t.position.subtractInPlace(e).scaleAndAddToRef(g,n[0]),0===n[3]?(n[1].copyFrom(t.rotationQuaternion),n[2]=g):(c.Quaternion.SlerpToRef(n[1],t.rotationQuaternion,g/(n[2]+g),n[1]),n[2]+=g),n[3]+=1)}}const A=a.morphBindIndexMap;for(let e=0;e<A.length;++e){const t=A[e];if(null!==t)for(let e=0;e<t.length;++e){const n=t[e],i=m.get(n);void 0===i?m.set(n,r.getMorphWeightFromIndex(n)*g):m.set(n,i+r.getMorphWeightFromIndex(n)*g)}}const M=a.ikSolverBindIndexMap;for(let e=0;e<M.length;++e){const t=M[e];if(-1!==t){const e=u.get(t);void 0===e?u.set(t,0!==l[t]):u.set(t,e&&0!==l[t])}}0!==s.length&&(b+=s[0].visibility*g)}for(const[e,t]of h)a<1?c.Quaternion.SlerpToRef(Ce._IdentityQuaternion,t[0],t[1],e.rotationQuaternion):e.rotationQuaternion.copyFrom(t[0]);for(const[e,t]of d)e.getRestMatrix().getTranslationToRef(e.position).addInPlace(t[0]),a<1?c.Quaternion.SlerpToRef(Ce._IdentityQuaternion,t[1],t[2],e.rotationQuaternion):e.rotationQuaternion.copyFrom(t[1]);for(const[e,t]of m)r.setMorphWeightFromIndex(e,t);if(Math.abs(b-1)<1e-6)for(let e=0;e<s.length;++e)s[e].visibility=1;else for(let e=0;e<s.length;++e)s[e].visibility=b;for(const[e,t]of u)l[e]=t?1:0;i.length=0,o.length=0}induceMaterialRecompile(e,t){const n=this._runtimeAnimations;for(let e=0;e<n.length;++e)n[e]?.induceMaterialRecompile(!1,t);if(e){const e=[];for(let t=0;t<n.length;++t){const i=n[t];if(null!==i){const t=i.morphBindIndexMap;e.push(...t)}}Re(this._morphController,e)}}dispose(){null!==this._onSpanAdded&&(this.animation.onSpanAddedObservable.removeCallback(this._onSpanAdded),this.animation.onSpanRemovedObservable.removeCallback(this._onSpanRemoved),this._onSpanAdded=null,this._onSpanRemoved=null)}static Create(e,t,n,i){const o=new Array(e.spans.length).fill(null),r=e.spans;for(let e=0;e<r.length;++e){const a=r[e].animation;if(void 0!==a.createRuntimeModelAnimation){const r=a.createRuntimeModelAnimation(t,n,i);o[e]=r}else if(void 0===a.createRuntimeModelAnimation)throw new Error(`animation ${a.name} is not bindable. are you missing import "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimationGroup"?`)}return new Ce(e,t.ikSolverStates,t.morph,t.mesh.metadata.meshes,o,(e=>{const r=e.animation;if(void 0!==r.createRuntimeModelAnimation){const e=r.createRuntimeModelAnimation(t,n,i);o.push(e)}else{if(void 0===r.createRuntimeModelAnimation)throw new Error(`animation ${r.name} is not bindable. are you missing import "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimationGroup"?`);o.push(null)}}),(e=>{o.splice(e,1)}))}}Ie.prototype.createRuntimeModelAnimation=function(e,t,n){return Ce.Create(this,e,t,n)};class Oe{name;boneTracks;movableBoneTracks;morphTracks;propertyTrack;cameraTrack;startFrame;endFrame;constructor(e,t,n,i,o,r){this.name=e,this.boneTracks=t,this.movableBoneTracks=n,this.morphTracks=i,this.propertyTrack=o,this.cameraTrack=r;let a=Number.MAX_SAFE_INTEGER,s=Number.MIN_SAFE_INTEGER;for(let e=0;e<t.length;++e){const n=t[e];a=Math.min(a,n.startFrame),s=Math.max(s,n.endFrame)}for(let e=0;e<n.length;++e){const t=n[e];a=Math.min(a,t.startFrame),s=Math.max(s,t.endFrame)}for(let e=0;e<i.length;++e){const t=i[e];a=Math.min(a,t.startFrame),s=Math.max(s,t.endFrame)}a=Math.min(a,o.startFrame),s=Math.max(s,o.endFrame),a=Math.min(a,r.startFrame),s=Math.max(s,r.endFrame),this.startFrame=a,this.endFrame=s}}class Fe{static Interpolate(e,t,n,i,o){let r=.5,a=r,s=1-a;const l=Math;let h,d,c;for(let n=0;n<15;++n){h=3*s*s*a,d=3*s*a*a,c=a*a*a;const n=h*e+d*t+c-o;if(l.abs(n)<1e-5)break;r*=.5,a+=n<0?r:-r,s=1-a}return h*n+d*i+c}}class Se{_lastResults=new Map;_upperBoundFrameIndex(e,t){const n=t.frameNumbers;let i=this._lastResults.get(t);void 0===i&&(i=[Number.NEGATIVE_INFINITY,0],this._lastResults.set(t,i));const o=e-i[0];if(Math.abs(o)<6){let t=i[1];for(;0<t&&e<n[t-1];)t-=1;for(;t<n.length&&n[t]<=e;)t+=1;return i[0]=e,i[1]=t,t}{let t=0,o=n.length;for(;t<o;){const i=t+(o-t>>1);e<n[i]?o=i:t=i+1}return i[0]=e,i[1]=t,t}}}class Ee extends Se{animation;_camera;constructor(e,t){super(),this.animation=e.cameraTrack,this._camera=t}static _CameraPositionA=new c.Vector3;static _CameraPositionB=new c.Vector3;static _CameraRotationA=new c.Vector3;static _CameraRotationB=new c.Vector3;static _DegToRad=Math.PI/180;animate(e){const t=this.animation;if(0===t.frameNumbers.length)return;const n=this._camera,i=Math.max(t.startFrame,Math.min(t.endFrame,e)),o=this._upperBoundFrameIndex(i,t),r=o-1,a=t.frameNumbers[r],s=t.frameNumbers[o];if(void 0===s||a+1===s){const e=t.positions;n.position.set(e[3*r],e[3*r+1],e[3*r+2]);const i=t.rotations;n.rotation.set(i[3*r],i[3*r+1],i[3*r+2]),n.distance=t.distances[r],n.fov=t.fovs[r]*Ee._DegToRad}else{const e=(i-a)/(s-a),l=t.positions,h=t.positionInterpolations,d=Ee._CameraPositionA.set(l[3*r],l[3*r+1],l[3*r+2]),c=Ee._CameraPositionB.set(l[3*o],l[3*o+1],l[3*o+2]),m=Fe.Interpolate(h[12*o]/127,h[12*o+1]/127,h[12*o+2]/127,h[12*o+3]/127,e),u=Fe.Interpolate(h[12*o+4]/127,h[12*o+5]/127,h[12*o+6]/127,h[12*o+7]/127,e),p=Fe.Interpolate(h[12*o+8]/127,h[12*o+9]/127,h[12*o+10]/127,h[12*o+11]/127,e);n.position.set(d.x+(c.x-d.x)*m,d.y+(c.y-d.y)*u,d.z+(c.z-d.z)*p);const g=t.rotations,f=t.rotationInterpolations,_=Ee._CameraRotationA.set(g[3*r],g[3*r+1],g[3*r+2]),b=Ee._CameraRotationB.set(g[3*o],g[3*o+1],g[3*o+2]),y=Fe.Interpolate(f[4*o]/127,f[4*o+1]/127,f[4*o+2]/127,f[4*o+3]/127,e),A=1-y;n.rotation.set(_.x*A+b.x*y,_.y*A+b.y*y,_.z*A+b.z*y);const M=t.distances[r],T=t.distances[o],w=Fe.Interpolate(t.distanceInterpolations[4*o]/127,t.distanceInterpolations[4*o+1]/127,t.distanceInterpolations[4*o+2]/127,t.distanceInterpolations[4*o+3]/127,e);n.distance=M+(T-M)*w;const x=t.fovs[r],v=t.fovs[o],I=Fe.Interpolate(t.fovInterpolations[4*o]/127,t.fovInterpolations[4*o+1]/127,t.fovInterpolations[4*o+2]/127,t.fovInterpolations[4*o+3]/127,e);n.fov=(x+(v-x)*I)*Ee._DegToRad}}static Create(e,t){return new Ee(e,t)}}Oe.prototype.createRuntimeCameraAnimation=function(e){return Ee.Create(this,e)};var ke=ie(4268),Ne=ie(1259),De=ie(6871);class Le extends ke.Animation{static ANIMATIONTYPE_SLERP_TANGENT_QUATERNION=8;_interpolate(e,t,n=!1){if(t.loopMode===ke.Animation.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;const i=this._keys,o=i.length;let r=t.key;for(;r>=0&&e<i[r].frame;)r-=1;for(;r+1<=o-1&&e>=i[r+1].frame;)r+=1;if(t.key=r,r<0)return n?void 0:this._getKeyValue(i[0].value);if(r+1>o-1)return n?void 0:this._getKeyValue(i[o-1].value);const a=i[r],s=i[r+1];if(n&&(e===a.frame||e===s.frame))return;const l=this._getKeyValue(a.value),h=this._getKeyValue(s.value);if(a.interpolation===De.AnimationKeyInterpolation.STEP)return s.frame>e?l:h;const d=void 0!==a.outTangent&&void 0!==s.inTangent,c=s.frame-a.frame;let m=(e-a.frame)/c;const u=a.easingFunction||this.getEasingFunction();if(null!==u&&(m=u.ease(m)),a.interpolation===De.AnimationKeyInterpolation.NONE)switch(this.dataType){case ke.Animation.ANIMATIONTYPE_FLOAT:{const e=d?this.floatInterpolateFunctionWithTangents(l,a.outTangent*c,h,s.inTangent*c,m):this.floatInterpolateFunction(l,h,m);switch(t.loopMode){case ke.Animation.ANIMATIONLOOPMODE_CYCLE:case ke.Animation.ANIMATIONLOOPMODE_CONSTANT:case ke.Animation.ANIMATIONLOOPMODE_YOYO:return e;case ke.Animation.ANIMATIONLOOPMODE_RELATIVE:case ke.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return(t.offsetValue??0)*t.repeatCount+e}break}case ke.Animation.ANIMATIONTYPE_QUATERNION:{const e=d?this.quaternionInterpolateFunctionWithTangents(l,a.outTangent.scale(c),h,s.inTangent.scale(c),m):this.quaternionInterpolateFunction(l,h,m);switch(t.loopMode){case ke.Animation.ANIMATIONLOOPMODE_CYCLE:case ke.Animation.ANIMATIONLOOPMODE_CONSTANT:case ke.Animation.ANIMATIONLOOPMODE_YOYO:return e;case ke.Animation.ANIMATIONLOOPMODE_RELATIVE:case ke.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.addInPlace((t.offsetValue||ke._staticOffsetValueQuaternion).scale(t.repeatCount))}return e}case ke.Animation.ANIMATIONTYPE_VECTOR3:{const e=d?this.vector3InterpolateFunctionWithTangents(l,a.outTangent.scale(c),h,s.inTangent.scale(c),m):this.vector3InterpolateFunction(l,h,m);switch(t.loopMode){case ke.Animation.ANIMATIONLOOPMODE_CYCLE:case ke.Animation.ANIMATIONLOOPMODE_CONSTANT:case ke.Animation.ANIMATIONLOOPMODE_YOYO:return e;case ke.Animation.ANIMATIONLOOPMODE_RELATIVE:case ke.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||ke._staticOffsetValueVector3).scale(t.repeatCount))}break}case ke.Animation.ANIMATIONTYPE_VECTOR2:{const e=d?this.vector2InterpolateFunctionWithTangents(l,a.outTangent.scale(c),h,s.inTangent.scale(c),m):this.vector2InterpolateFunction(l,h,m);switch(t.loopMode){case ke.Animation.ANIMATIONLOOPMODE_CYCLE:case ke.Animation.ANIMATIONLOOPMODE_CONSTANT:case ke.Animation.ANIMATIONLOOPMODE_YOYO:return e;case ke.Animation.ANIMATIONLOOPMODE_RELATIVE:case ke.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||ke._staticOffsetValueVector2).scale(t.repeatCount))}break}case ke.Animation.ANIMATIONTYPE_SIZE:switch(t.loopMode){case ke.Animation.ANIMATIONLOOPMODE_CYCLE:case ke.Animation.ANIMATIONLOOPMODE_CONSTANT:case ke.Animation.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(l,h,m);case ke.Animation.ANIMATIONLOOPMODE_RELATIVE:case ke.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return this.sizeInterpolateFunction(l,h,m).add((t.offsetValue||ke._staticOffsetValueSize).scale(t.repeatCount))}break;case ke.Animation.ANIMATIONTYPE_COLOR3:{const e=d?this.color3InterpolateFunctionWithTangents(l,a.outTangent.scale(c),h,s.inTangent.scale(c),m):this.color3InterpolateFunction(l,h,m);switch(t.loopMode){case ke.Animation.ANIMATIONLOOPMODE_CYCLE:case ke.Animation.ANIMATIONLOOPMODE_CONSTANT:case ke.Animation.ANIMATIONLOOPMODE_YOYO:return e;case ke.Animation.ANIMATIONLOOPMODE_RELATIVE:case ke.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||ke._staticOffsetValueColor3).scale(t.repeatCount))}break}case ke.Animation.ANIMATIONTYPE_COLOR4:{const e=d?this.color4InterpolateFunctionWithTangents(l,a.outTangent.scale(c),h,s.inTangent.scale(c),m):this.color4InterpolateFunction(l,h,m);switch(t.loopMode){case ke.Animation.ANIMATIONLOOPMODE_CYCLE:case ke.Animation.ANIMATIONLOOPMODE_CONSTANT:case ke.Animation.ANIMATIONLOOPMODE_YOYO:return e;case ke.Animation.ANIMATIONLOOPMODE_RELATIVE:case ke.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||ke._staticOffsetValueColor4).scale(t.repeatCount))}break}case ke.Animation.ANIMATIONTYPE_MATRIX:switch(t.loopMode){case ke.Animation.ANIMATIONLOOPMODE_CYCLE:case ke.Animation.ANIMATIONLOOPMODE_CONSTANT:case ke.Animation.ANIMATIONLOOPMODE_YOYO:return ke.Animation.AllowMatricesInterpolation?this.matrixInterpolateFunction(l,h,m,t.workValue):l;case ke.Animation.ANIMATIONLOOPMODE_RELATIVE:case ke.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return l}}else switch(this.dataType){case ke.Animation.ANIMATIONTYPE_FLOAT:{const e=d?this.floatInterpolateFunctionWithControlPoints(l,a.outTangent,h,s.inTangent,m):this.floatInterpolateFunction(l,h,m);switch(t.loopMode){case ke.Animation.ANIMATIONLOOPMODE_CYCLE:case ke.Animation.ANIMATIONLOOPMODE_CONSTANT:case ke.Animation.ANIMATIONLOOPMODE_YOYO:return e;case ke.Animation.ANIMATIONLOOPMODE_RELATIVE:case ke.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return(t.offsetValue??0)*t.repeatCount+e}break}case ke.Animation.ANIMATIONTYPE_QUATERNION:{const e=d?this.quaternionInterpolateFunctionWithControlPoints(l,a.outTangent,h,s.inTangent,m):this.quaternionInterpolateFunction(l,h,m);switch(t.loopMode){case ke.Animation.ANIMATIONLOOPMODE_CYCLE:case ke.Animation.ANIMATIONLOOPMODE_CONSTANT:case ke.Animation.ANIMATIONLOOPMODE_YOYO:return e;case ke.Animation.ANIMATIONLOOPMODE_RELATIVE:case ke.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.addInPlace((t.offsetValue||ke._staticOffsetValueQuaternion).scale(t.repeatCount))}return e}case Le.ANIMATIONTYPE_SLERP_TANGENT_QUATERNION:{const e=d?this.quaternionInterpolateFunctionWithSlerpControlPoints(l,a.outTangent,h,s.inTangent,m):this.quaternionInterpolateFunction(l,h,m);switch(t.loopMode){case ke.Animation.ANIMATIONLOOPMODE_CYCLE:case ke.Animation.ANIMATIONLOOPMODE_CONSTANT:case ke.Animation.ANIMATIONLOOPMODE_YOYO:return e;case ke.Animation.ANIMATIONLOOPMODE_RELATIVE:case ke.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.addInPlace((t.offsetValue||ke._staticOffsetValueQuaternion).scale(t.repeatCount))}return e}case ke.Animation.ANIMATIONTYPE_VECTOR3:{const e=d?this.vector3InterpolateFunctionWithControlPoints(l,a.outTangent,h,s.inTangent,m):this.vector3InterpolateFunction(l,h,m);switch(t.loopMode){case ke.Animation.ANIMATIONLOOPMODE_CYCLE:case ke.Animation.ANIMATIONLOOPMODE_CONSTANT:case ke.Animation.ANIMATIONLOOPMODE_YOYO:return e;case ke.Animation.ANIMATIONLOOPMODE_RELATIVE:case ke.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||ke._staticOffsetValueVector3).scale(t.repeatCount))}break}case ke.Animation.ANIMATIONTYPE_VECTOR2:{const e=d?this.vector2InterpolateFunctionWithControlPoints(l,a.outTangent,h,s.inTangent,m):this.vector2InterpolateFunction(l,h,m);switch(t.loopMode){case ke.Animation.ANIMATIONLOOPMODE_CYCLE:case ke.Animation.ANIMATIONLOOPMODE_CONSTANT:case ke.Animation.ANIMATIONLOOPMODE_YOYO:return e;case ke.Animation.ANIMATIONLOOPMODE_RELATIVE:case ke.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||ke._staticOffsetValueVector2).scale(t.repeatCount))}break}case ke.Animation.ANIMATIONTYPE_SIZE:switch(t.loopMode){case ke.Animation.ANIMATIONLOOPMODE_CYCLE:case ke.Animation.ANIMATIONLOOPMODE_CONSTANT:case ke.Animation.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(l,h,m);case ke.Animation.ANIMATIONLOOPMODE_RELATIVE:case ke.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return this.sizeInterpolateFunction(l,h,m).add((t.offsetValue||ke._staticOffsetValueSize).scale(t.repeatCount))}break;case ke.Animation.ANIMATIONTYPE_COLOR3:{const e=d?this.color3InterpolateFunctionWithControlPoints(l,a.outTangent,h,s.inTangent,m):this.color3InterpolateFunction(l,h,m);switch(t.loopMode){case ke.Animation.ANIMATIONLOOPMODE_CYCLE:case ke.Animation.ANIMATIONLOOPMODE_CONSTANT:case ke.Animation.ANIMATIONLOOPMODE_YOYO:return e;case ke.Animation.ANIMATIONLOOPMODE_RELATIVE:case ke.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||ke._staticOffsetValueColor3).scale(t.repeatCount))}break}case ke.Animation.ANIMATIONTYPE_COLOR4:{const e=d?this.color4InterpolateFunctionWithControlPoints(l,a.outTangent,h,s.inTangent,m):this.color4InterpolateFunction(l,h,m);switch(t.loopMode){case ke.Animation.ANIMATIONLOOPMODE_CYCLE:case ke.Animation.ANIMATIONLOOPMODE_CONSTANT:case ke.Animation.ANIMATIONLOOPMODE_YOYO:return e;case ke.Animation.ANIMATIONLOOPMODE_RELATIVE:case ke.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||ke._staticOffsetValueColor4).scale(t.repeatCount))}break}case ke.Animation.ANIMATIONTYPE_MATRIX:switch(t.loopMode){case ke.Animation.ANIMATIONLOOPMODE_CYCLE:case ke.Animation.ANIMATIONLOOPMODE_CONSTANT:case ke.Animation.ANIMATIONLOOPMODE_YOYO:return ke.Animation.AllowMatricesInterpolation?this.matrixInterpolateFunction(l,h,m,t.workValue):l;case ke.Animation.ANIMATIONLOOPMODE_RELATIVE:case ke.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return l}}return 0}floatInterpolateFunctionWithControlPoints(e,t,n,i,o){const r=Fe.Interpolate(t.x,i.x,t.y,i.y,o);return e*(1-r)+n*r}quaternionInterpolateFunctionWithControlPoints(e,t,n,i,o){const r=Fe.Interpolate(t[0].x,i[0].x,t[0].y,i[0].y,o),a=Fe.Interpolate(t[1].x,i[1].x,t[1].y,i[1].y,o),s=Fe.Interpolate(t[2].x,i[2].x,t[2].y,i[2].y,o),l=Fe.Interpolate(t[3].x,i[3].x,t[3].y,i[3].y,o);return new c.Quaternion(e.x*(1-r)+n.x*r,e.y*(1-a)+n.y*a,e.z*(1-s)+n.z*s,e.w*(1-l)+n.w*l)}quaternionInterpolateFunctionWithSlerpControlPoints(e,t,n,i,o){const r=Fe.Interpolate(t.x,i.x,t.y,i.y,o);return c.Quaternion.Slerp(e,n,r)}vector3InterpolateFunctionWithControlPoints(e,t,n,i,o){const r=Fe.Interpolate(t[0].x,i[0].x,t[0].y,i[0].y,o),a=Fe.Interpolate(t[1].x,i[1].x,t[1].y,i[1].y,o),s=Fe.Interpolate(t[2].x,i[2].x,t[2].y,i[2].y,o);return new c.Vector3(e.x*(1-r)+n.x*r,e.y*(1-a)+n.y*a,e.z*(1-s)+n.z*s)}vector2InterpolateFunctionWithControlPoints(e,t,n,i,o){const r=Fe.Interpolate(t[0].x,i[0].x,t[0].y,i[0].y,o),a=Fe.Interpolate(t[1].x,i[1].x,t[1].y,i[1].y,o);return new c.Vector2(e.x*(1-r)+n.x*r,e.y*(1-a)+n.y*a)}color3InterpolateFunctionWithControlPoints(e,t,n,i,o){const r=Fe.Interpolate(t[0].x,i[0].x,t[0].y,i[0].y,o),a=Fe.Interpolate(t[1].x,i[1].x,t[1].y,i[1].y,o),s=Fe.Interpolate(t[2].x,i[2].x,t[2].y,i[2].y,o);return new L.Color3(e.r*(1-r)+n.r*r,e.g*(1-a)+n.g*a,e.b*(1-s)+n.b*s)}color4InterpolateFunctionWithControlPoints(e,t,n,i,o){const r=Fe.Interpolate(t.r,i.r,t.g,i.g,o),a=Fe.Interpolate(t.b,i.b,t.g,i.g,o),s=Fe.Interpolate(t.b,i.b,t.g,i.g,o),l=Fe.Interpolate(t.a,i.a,t.g,i.g,o);return new L.Color4(e.r*(1-r)+n.r*r,e.g*(1-a)+n.g*a,e.b*(1-s)+n.b*s,e.a*(1-l)+n.a*l)}}function Ue(e,t,n,i){let o;o=0===i?0:0===n?i<0?-1/0:1/0:0===e&&0===t?i/n:0===e?i<0?-1/0:1/0:0===t?0:t*i/(e*n);const r=3*Math.abs(i)/n;return Math.max(-r,Math.min(r,o))}class Ve{name;positionAnimation;rotationAnimation;distanceAnimation;fovAnimation;startFrame;endFrame;constructor(e,t){const n=this.name=e.name;this.positionAnimation=t.createPositionAnimation(n,e.cameraTrack),this.rotationAnimation=t.createRotationAnimation(n,e.cameraTrack),this.distanceAnimation=t.createDistanceAnimation(n,e.cameraTrack),this.fovAnimation=t.createFovAnimation(n,e.cameraTrack),this.startFrame=e.startFrame,this.endFrame=e.endFrame}createAnimationGroup(e){const t=new Ne.AnimationGroup(this.name,e.getScene());return t.addTargetedAnimation(this.positionAnimation,e),t.addTargetedAnimation(this.rotationAnimation,e),t.addTargetedAnimation(this.distanceAnimation,e),t.addTargetedAnimation(this.fovAnimation,e),t}}class We{createPositionAnimation(e,t){const n=new ke.Animation(e+"_camera_position","position",30,ke.Animation.ANIMATIONTYPE_VECTOR3,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.positions,r=t.positionInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0,l=t-(0<e?i[e-1]:-30),h=s-t,d=h<1.0001?De.AnimationKeyInterpolation.STEP:De.AnimationKeyInterpolation.NONE;a[e]={frame:t,value:new c.Vector3(o[3*e],o[3*e+1],o[3*e+2]),inTangent:n?new c.Vector3(Ue(1-r[12*e+1]/127,1-r[12*e+3]/127,l,o[3*e]-o[3*(e-1)]),Ue(1-r[12*e+5]/127,1-r[12*e+7]/127,l,o[3*e+1]-o[3*(e-1)+1]),Ue(1-r[12*e+9]/127,1-r[12*e+11]/127,l,o[3*e+2]-o[3*(e-1)+2])):void 0,outTangent:s<1/0?new c.Vector3(Ue(r[12*(e+1)+0]/127,r[12*(e+1)+2]/127,h,o[3*(e+1)]-o[3*e]),Ue(r[12*(e+1)+4]/127,r[12*(e+1)+6]/127,h,o[3*(e+1)+1]-o[3*e+1]),Ue(r[12*(e+1)+8]/127,r[12*(e+1)+10]/127,h,o[3*(e+1)+2]-o[3*e+2])):void 0,interpolation:d,lockedTangent:!1}}return n.setKeys(a),n}createRotationAnimation(e,t){const n=new ke.Animation(e+"_camera_rotation","rotation",30,ke.Animation.ANIMATIONTYPE_VECTOR3,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.rotations,r=t.rotationInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0,l=t-(0<e?i[e-1]:-30),h=s-t,d=h<1.0001?De.AnimationKeyInterpolation.STEP:De.AnimationKeyInterpolation.NONE;a[e]={frame:t,value:new c.Vector3(o[3*e],o[3*e+1],o[3*e+2]),inTangent:n?new c.Vector3(Ue(1-r[4*e+1]/127,1-r[4*e+3]/127,l,o[3*e]-o[3*(e-1)]),Ue(1-r[4*e+1]/127,1-r[4*e+3]/127,l,o[3*e+1]-o[3*(e-1)+1]),Ue(1-r[4*e+1]/127,1-r[4*e+3]/127,l,o[3*e+2]-o[3*(e-1)+2])):void 0,outTangent:s<1/0?new c.Vector3(Ue(r[4*(e+1)+0]/127,r[4*(e+1)+2]/127,h,o[3*(e+1)]-o[3*e]),Ue(r[4*(e+1)+0]/127,r[4*(e+1)+2]/127,h,o[3*(e+1)+1]-o[3*e+1]),Ue(r[4*(e+1)+0]/127,r[4*(e+1)+2]/127,h,o[3*(e+1)+2]-o[3*e+2])):void 0,interpolation:d,lockedTangent:!1}}return n.setKeys(a),n}createDistanceAnimation(e,t){const n=new ke.Animation(e+"_camera_distance","distance",30,ke.Animation.ANIMATIONTYPE_FLOAT,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.distances,r=t.distanceInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0,l=t-(0<e?i[e-1]:-30),h=s-t,d=h<1.0001?De.AnimationKeyInterpolation.STEP:De.AnimationKeyInterpolation.NONE;a[e]={frame:t,value:o[e],inTangent:n?Ue(1-r[4*e+1]/127,1-r[4*e+3]/127,l,o[e]-o[e-1]):void 0,outTangent:s<1/0?Ue(r[4*(e+1)+0]/127,r[4*(e+1)+2]/127,h,o[e+1]-o[e]):void 0,interpolation:d,lockedTangent:!1}}return n.setKeys(a),n}createFovAnimation(e,t){const n=new ke.Animation(e+"_camera_fov","fov",30,ke.Animation.ANIMATIONTYPE_FLOAT,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.fovs,r=t.fovInterpolations,a=Math.PI/180,s=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,l=e+1<i.length?i[e+1]:1/0,h=t-(0<e?i[e-1]:-30),d=l-t,c=d<1.0001?De.AnimationKeyInterpolation.STEP:De.AnimationKeyInterpolation.NONE;s[e]={frame:t,value:o[e]*a,inTangent:n?Ue(1-r[4*e+1]/127,1-r[4*e+3]/127,h,o[e]*a-o[e-1]*a):void 0,outTangent:l<1/0?Ue(r[4*(e+1)+0]/127,r[4*(e+1)+2]/127,d,o[e+1]*a-o[e]*a):void 0,interpolation:c,lockedTangent:!1}}return n.setKeys(s),n}}class ze{createPositionAnimation(e,t){const n=new ke.Animation(e+"_camera_position","position",30,ke.Animation.ANIMATIONTYPE_VECTOR3,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.positions,r=t.positionInterpolations,a=new Array(t.endFrame);let s=0;const l=new c.Vector3(o[0],o[1],o[2]);for(let e=0;e<i.length;++e){const t=i[e];a[t]={frame:t,value:new c.Vector3(o[3*e],o[3*e+1],o[3*e+2]),interpolation:t+1===i[e+1]?De.AnimationKeyInterpolation.STEP:De.AnimationKeyInterpolation.NONE};const n=r[12*e+0]/127,h=r[12*e+1]/127,d=r[12*e+2]/127,m=r[12*e+3]/127,u=r[12*e+4]/127,p=r[12*e+5]/127,g=r[12*e+6]/127,f=r[12*e+7]/127,_=r[12*e+8]/127,b=r[12*e+9]/127,y=r[12*e+10]/127,A=r[12*e+11]/127;for(let i=s+1;i<t;++i){const r=(i-s)/(t-s),M=Fe.Interpolate(n,h,d,m,r),T=Fe.Interpolate(u,p,g,f,r),w=Fe.Interpolate(_,b,y,A,r);a[i]={frame:i,value:new c.Vector3(l.x+(o[3*e]-l.x)*M,l.y+(o[3*e+1]-l.y)*T,l.z+(o[3*e+2]-l.z)*w),interpolation:De.AnimationKeyInterpolation.NONE}}s=t,l.set(o[3*e],o[3*e+1],o[3*e+2])}return n.setKeys(a),n}createRotationAnimation(e,t){const n=new ke.Animation(e+"_camera_rotation","rotation",30,ke.Animation.ANIMATIONTYPE_VECTOR3,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.rotations,r=t.rotationInterpolations,a=new Array(t.endFrame);let s=0;const l=new c.Vector3(o[0],o[1],o[2]);for(let e=0;e<i.length;++e){const t=i[e];a[t]={frame:t,value:new c.Vector3(o[3*e],o[3*e+1],o[3*e+2]),interpolation:t+1===i[e+1]?De.AnimationKeyInterpolation.STEP:De.AnimationKeyInterpolation.NONE};const n=r[4*e+0]/127,h=r[4*e+1]/127,d=r[4*e+2]/127,m=r[4*e+3]/127;for(let i=s+1;i<t;++i){const r=(i-s)/(t-s),u=Fe.Interpolate(n,h,d,m,r);a[i]={frame:i,value:new c.Vector3(l.x+(o[3*e]-l.x)*u,l.y+(o[3*e+1]-l.y)*u,l.z+(o[3*e+2]-l.z)*u),interpolation:De.AnimationKeyInterpolation.NONE}}s=t,l.set(o[3*e],o[3*e+1],o[3*e+2])}return n.setKeys(a),n}createDistanceAnimation(e,t){const n=new ke.Animation(e+"_camera_distance","distance",30,ke.Animation.ANIMATIONTYPE_FLOAT,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.distances,r=t.distanceInterpolations,a=new Array(t.endFrame);let s=0,l=o[0];for(let e=0;e<i.length;++e){const t=i[e];a[t]={frame:t,value:o[e],interpolation:t+1===i[e+1]?De.AnimationKeyInterpolation.STEP:De.AnimationKeyInterpolation.NONE};const n=r[4*e+0]/127,h=r[4*e+1]/127,d=r[4*e+2]/127,c=r[4*e+3]/127;for(let i=s+1;i<t;++i){const r=(i-s)/(t-s),m=Fe.Interpolate(n,h,d,c,r);a[i]={frame:i,value:l+(o[e]-l)*m,interpolation:De.AnimationKeyInterpolation.NONE}}s=t,l=o[e]}return n.setKeys(a),n}createFovAnimation(e,t){const n=new ke.Animation(e+"_camera_fov","fov",30,ke.Animation.ANIMATIONTYPE_FLOAT,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.fovs,r=t.fovInterpolations,a=Math.PI/180,s=new Array(t.endFrame);let l=0,h=o[0]*a;for(let e=0;e<i.length;++e){const t=i[e];s[t]={frame:t,value:o[e]*a,interpolation:t+1===i[e+1]?De.AnimationKeyInterpolation.STEP:De.AnimationKeyInterpolation.NONE};const n=r[4*e+0]/127,d=r[4*e+1]/127,c=r[4*e+2]/127,m=r[4*e+3]/127;for(let i=l+1;i<t;++i){const r=(i-l)/(t-l),u=Fe.Interpolate(n,d,c,m,r);s[i]={frame:i,value:h+(o[e]*a-h)*u,interpolation:De.AnimationKeyInterpolation.NONE}}l=t,h=o[e]*a}return n.setKeys(s),n}}class Ke{createPositionAnimation(e,t){const n=new Le(e+"_camera_position","position",30,ke.Animation.ANIMATIONTYPE_VECTOR3,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.positions,r=t.positionInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0,l=s-t<1.0001?De.AnimationKeyInterpolation.STEP:2;a[e]={frame:t,value:new c.Vector3(o[3*e],o[3*e+1],o[3*e+2]),inTangent:n?[new c.Vector2(r[12*e+1]/127,r[12*e+3]/127),new c.Vector2(r[12*e+5]/127,r[12*e+7]/127),new c.Vector2(r[12*e+9]/127,r[12*e+11]/127)]:void 0,outTangent:s<1/0?[new c.Vector2(r[12*(e+1)+0]/127,r[12*(e+1)+2]/127),new c.Vector2(r[12*(e+1)+4]/127,r[12*(e+1)+6]/127),new c.Vector2(r[12*(e+1)+8]/127,r[12*(e+1)+10]/127)]:void 0,interpolation:l,lockedTangent:!1}}return n.setKeys(a),n}createRotationAnimation(e,t){const n=new Le(e+"_camera_rotation","rotation",30,ke.Animation.ANIMATIONTYPE_VECTOR3,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.rotations,r=t.rotationInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0,l=s-t<1.0001?De.AnimationKeyInterpolation.STEP:2;a[e]={frame:t,value:new c.Vector3(o[3*e],o[3*e+1],o[3*e+2]),inTangent:n?[new c.Vector2(r[4*e+1]/127,r[4*e+3]/127),new c.Vector2(r[4*e+1]/127,r[4*e+3]/127),new c.Vector2(r[4*e+1]/127,r[4*e+3]/127)]:void 0,outTangent:s<1/0?[new c.Vector2(r[4*(e+1)+0]/127,r[4*(e+1)+2]/127),new c.Vector2(r[4*(e+1)+0]/127,r[4*(e+1)+2]/127),new c.Vector2(r[4*(e+1)+0]/127,r[4*(e+1)+2]/127)]:void 0,interpolation:l,lockedTangent:!1}}return n.setKeys(a),n}createDistanceAnimation(e,t){const n=new Le(e+"_camera_distance","distance",30,ke.Animation.ANIMATIONTYPE_FLOAT,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.distances,r=t.distanceInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0,l=s-t<1.0001?De.AnimationKeyInterpolation.STEP:2;a[e]={frame:t,value:o[e],inTangent:n?new c.Vector2(r[4*e+1]/127,r[4*e+3]/127):void 0,outTangent:s<1/0?new c.Vector2(r[4*(e+1)+0]/127,r[4*(e+1)+2]/127):void 0,interpolation:l,lockedTangent:!1}}return n.setKeys(a),n}createFovAnimation(e,t){const n=new Le(e+"_camera_fov","fov",30,ke.Animation.ANIMATIONTYPE_FLOAT,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.fovs,r=t.fovInterpolations,a=Math.PI/180,s=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,l=e+1<i.length?i[e+1]:1/0,h=l-t<1.0001?De.AnimationKeyInterpolation.STEP:2;s[e]={frame:t,value:o[e]*a,inTangent:n?new c.Vector2(r[4*e+1]/127,r[4*e+3]/127):void 0,outTangent:l<1/0?new c.Vector2(r[4*(e+1)+0]/127,r[4*(e+1)+2]/127):void 0,interpolation:h,lockedTangent:!1}}return n.setKeys(s),n}}function je(){return{key:0,repeatCount:0,loopMode:ke.Animation.ANIMATIONLOOPMODE_CONSTANT}}class Qe{animation;_positionAnimationState;_rotationAnimationState;_distanceAnimationState;_fovAnimationState;_camera;constructor(e,t){this.animation=e,this._positionAnimationState=je(),this._rotationAnimationState=je(),this._distanceAnimationState=je(),this._fovAnimationState=je(),this._camera=t}animate(e){const t=this.animation,n=this._camera;n.position.copyFrom(t.positionAnimation._interpolate(e,this._positionAnimationState)),n.rotation.copyFrom(t.rotationAnimation._interpolate(e,this._rotationAnimationState)),n.distance=t.distanceAnimation._interpolate(e,this._distanceAnimationState),n.fov=t.fovAnimation._interpolate(e,this._fovAnimationState)}static Create(e,t){return new Qe(e,t)}}Ve.prototype.createRuntimeCameraAnimation=function(e){return Qe.Create(this,e)};var Ye=ie(4619);class qe extends Se{animation;boneBindIndexMap;movableBoneBindIndexMap;_morphController;morphBindIndexMap;_meshes;ikSolverBindIndexMap;_ikSolverStates;_materialRecompileInduceInfo;constructor(e,t,n,i,o,r,a,s,l){super(),this.animation=e,this.boneBindIndexMap=t,this.movableBoneBindIndexMap=n,this._morphController=i,this.morphBindIndexMap=o,this._meshes=r,this.ikSolverBindIndexMap=a,this._ikSolverStates=s,this._materialRecompileInduceInfo=l}static _BonePositionA=new c.Vector3;static _BonePositionB=new c.Vector3;static _BonePosition=new c.Vector3;static _BoneRotationA=new c.Quaternion;static _BoneRotationB=new c.Quaternion;animate(e){const t=this.animation,n=t.boneTracks;if(0<n.length){const t=this.boneBindIndexMap;for(let i=0;i<n.length;++i){const o=t[i];if(null===o)continue;const r=n[i],a=Math.max(r.startFrame,Math.min(r.endFrame,e)),s=this._upperBoundFrameIndex(a,r),l=s-1,h=r.frameNumbers[s];if(void 0===h){const e=r.rotations;o.setRotationQuaternion(qe._BoneRotationB.set(e[4*l],e[4*l+1],e[4*l+2],e[4*l+3]),Ye.Space.LOCAL)}else{const e=r.frameNumbers[l],t=(a-e)/(h-e),n=r.rotations,i=r.rotationInterpolations,d=qe._BoneRotationA.set(n[4*l],n[4*l+1],n[4*l+2],n[4*l+3]),m=qe._BoneRotationB.set(n[4*s],n[4*s+1],n[4*s+2],n[4*s+3]),u=Fe.Interpolate(i[4*s]/127,i[4*s+1]/127,i[4*s+2]/127,i[4*s+3]/127,t);c.Quaternion.SlerpToRef(d,m,u,d),o.setRotationQuaternion(d,Ye.Space.LOCAL)}}}const i=t.movableBoneTracks;if(0<i.length){const t=this.movableBoneBindIndexMap;for(let n=0;n<i.length;++n){const o=t[n];if(null===o)continue;const r=i[n],a=Math.max(r.startFrame,Math.min(r.endFrame,e)),s=this._upperBoundFrameIndex(a,r),l=s-1,h=r.frameNumbers[s];if(void 0===h){const e=r.positions;o.getRestMatrix().getTranslationToRef(qe._BonePosition),o.position=qe._BonePosition.addInPlaceFromFloats(e[3*l],e[3*l+1],e[3*l+2]);const t=r.rotations;o.setRotationQuaternion(qe._BoneRotationB.set(t[4*l],t[4*l+1],t[4*l+2],t[4*l+3]),Ye.Space.LOCAL)}else{const e=r.frameNumbers[l],t=(a-e)/(h-e),n=r.positions,i=r.positionInterpolations,d=qe._BonePositionA.set(n[3*l],n[3*l+1],n[3*l+2]),m=qe._BonePositionB.set(n[3*s],n[3*s+1],n[3*s+2]),u=Fe.Interpolate(i[12*s]/127,i[12*s+1]/127,i[12*s+2]/127,i[12*s+3]/127,t),p=Fe.Interpolate(i[12*s+4]/127,i[12*s+5]/127,i[12*s+6]/127,i[12*s+7]/127,t),g=Fe.Interpolate(i[12*s+8]/127,i[12*s+9]/127,i[12*s+10]/127,i[12*s+11]/127,t);d.x+=(m.x-d.x)*u,d.y+=(m.y-d.y)*p,d.z+=(m.z-d.z)*g,o.getRestMatrix().getTranslationToRef(qe._BonePosition),o.position=qe._BonePosition.addInPlace(d);const f=r.rotations,_=r.rotationInterpolations,b=qe._BoneRotationA.set(f[4*l],f[4*l+1],f[4*l+2],f[4*l+3]),y=qe._BoneRotationB.set(f[4*s],f[4*s+1],f[4*s+2],f[4*s+3]),A=Fe.Interpolate(_[4*s]/127,_[4*s+1]/127,_[4*s+2]/127,_[4*s+3]/127,t);c.Quaternion.SlerpToRef(b,y,A,b),o.setRotationQuaternion(b,Ye.Space.LOCAL)}}}const o=t.morphTracks;if(0<o.length){const t=this._morphController,n=this.morphBindIndexMap;for(let i=0;i<o.length;++i){const r=n[i];if(null===r)continue;const a=o[i],s=Math.max(a.startFrame,Math.min(a.endFrame,e)),l=this._upperBoundFrameIndex(s,a),h=l-1,d=a.frameNumbers[l];if(void 0===d){const e=a.weights[h];for(let n=0;n<r.length;++n)t.setMorphWeightFromIndex(r[n],e)}else{const e=a.frameNumbers[h],n=(s-e)/(d-e),i=a.weights[h],o=i+(a.weights[l]-i)*n;for(let e=0;e<r.length;++e)t.setMorphWeightFromIndex(r[e],o)}}}if(0<t.propertyTrack.frameNumbers.length){const n=t.propertyTrack,i=Math.max(n.startFrame,Math.min(n.endFrame,e)),o=this._upperBoundFrameIndex(i,n)-1,r=n.visibles[o],a=this._meshes;for(let e=0;e<a.length;++e)a[e].visibility=r;const s=this._ikSolverStates.ikSolverStates,l=this.ikSolverBindIndexMap;for(let e=0;e<l.length;++e){const t=l[e];if(-1===t)continue;const i=n.getIkState(e);s[t]=i[o]}}}induceMaterialRecompile(e,t){null!==this._materialRecompileInduceInfo&&(qe.InduceMaterialRecompile(this._materialRecompileInduceInfo,this._morphController,this.morphBindIndexMap,t),e&&Re(this._morphController,this.morphBindIndexMap),this._materialRecompileInduceInfo=null)}static Create(e,t,n,i){const o=t.skeleton.bones,r=new Map;if(void 0===n)for(let e=0;e<o.length;++e)r.set(o[e].name,e);else for(let e=0;e<o.length;++e)r.set(n[o[e].name]??o[e].name,e);const a=new Array(e.boneTracks.length),s=e.boneTracks;for(let e=0;e<s.length;++e){const t=s[e],n=r.get(t.name);void 0===n?(i?.warn(`Binding failed: bone ${t.name} not found`),a[e]=null):a[e]=o[n]}const l=new Array(e.movableBoneTracks.length),h=e.movableBoneTracks;for(let e=0;e<h.length;++e){const t=h[e],n=r.get(t.name);void 0===n?(i?.warn(`Binding failed: bone ${t.name} not found`),l[e]=null):l[e]=o[n]}const d=t.morph,c=new Array(e.morphTracks.length),m=e.morphTracks;for(let e=0;e<m.length;++e){const t=m[e],o=n?.[t.name]??t.name,r=d.getMorphIndices(o);void 0===r?(i?.warn(`Binding failed: morph ${o} not found`),c[e]=null):c[e]=r}const u=t.runtimeBones,p=new Int32Array(e.propertyTrack.ikBoneNames.length),g=e.propertyTrack.ikBoneNames;for(let e=0;e<g.length;++e){const t=g[e],n=r.get(t);if(void 0===n)i?.warn(`Binding failed: IK bone ${t} not found`),p[e]=-1;else{const o=u[n].ikSolverIndex;-1===o?(i?.warn(`Binding failed: IK solver for bone ${t} not found`),p[e]=-1):p[e]=o}}return new qe(e,a,l,d,c,t.mesh.metadata.meshes,p,t,t.mesh.metadata.materials)}static InduceMaterialRecompile=Pe}Oe.prototype.createRuntimeModelAnimation=function(e,t,n){return qe.Create(this,e,t,n)};class He{_morphController;_morphIndices;constructor(e,t){this._morphController=e,this._morphIndices=t}get influence(){return this._morphController.getMorphWeightFromIndex(this._morphIndices[0])}set influence(e){for(let t=0;t<this._morphIndices.length;++t)this._morphController.setMorphWeightFromIndex(this._morphIndices[t],e)}}class Ge{_enabled;_ikSolverState;constructor(e,t){this._enabled=e[t],this._ikSolverState=new Uint8Array(e.buffer,e.byteOffset+t,1)}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this._ikSolverState[0]=.5<e?1:0}}class $e{_meshes;constructor(e){this._meshes=e}get visibility(){return this._meshes[0].visibility}set visibility(e){for(let t=0;t<this._meshes.length;++t)this._meshes[t].visibility=e}}class Xe{name;bonePositionAnimations;bonePositionAnimationBindMap;boneRotationAnimations;boneRotationAnimationBindMap;morphAnimations;morphAnimationBindMap;propertyAnimations;visibilityAnimation;propertyAnimationBindMap;startFrame;endFrame;constructor(e,t){const n=this.name=e.name,i=e.movableBoneTracks,o=this.bonePositionAnimations=new Array(i.length),r=this.bonePositionAnimationBindMap=new Array(i.length);for(let e=0;e<i.length;++e)o[e]=t.createBonePositionAnimation(n,i[e]),r[e]=i[e].name;const a=e.boneTracks,s=this.boneRotationAnimations=new Array(a.length+i.length),l=this.boneRotationAnimationBindMap=new Array(a.length+i.length);for(let e=0;e<a.length;++e)s[e]=t.createBoneRotationAnimation(n,a[e]),l[e]=a[e].name;for(let e=0;e<i.length;++e)s[a.length+e]=t.createBoneRotationAnimation(n,i[e]),l[a.length+e]=i[e].name;const h=e.morphTracks,d=this.morphAnimations=new Array(h.length),c=this.morphAnimationBindMap=new Array(h.length);for(let e=0;e<h.length;++e)d[e]=t.createMorphAnimation(n,h[e]),c[e]=h[e].name;this.visibilityAnimation=t.createVisibilityAnimation(n,e.propertyTrack),this.propertyAnimations=t.createPropertyAnimation(n,e.propertyTrack),this.propertyAnimationBindMap=e.propertyTrack.ikBoneNames,this.startFrame=e.startFrame,this.endFrame=e.endFrame}createAnimationGroup(e){const t=new Ne.AnimationGroup(this.name,e.mesh.getScene(),1);t.isAdditive=!0;const n=new Map,i=e.skeleton.bones;for(let e=0;e<i.length;++e)n.set(i[e].name,e);const o=this.bonePositionAnimations,r=this.bonePositionAnimationBindMap;for(let e=0;e<o.length;++e){const a=n.get(r[e]);void 0!==a&&t.addTargetedAnimation(o[e],i[a])}const a=this.boneRotationAnimations,s=this.boneRotationAnimationBindMap;for(let e=0;e<a.length;++e){const o=n.get(s[e]);void 0!==o&&t.addTargetedAnimation(a[e],i[o])}const l=this.morphAnimations,h=this.morphAnimationBindMap,d=e.morph;for(let e=0;e<l.length;++e){const n=d.getMorphIndices(h[e]);void 0!==n&&t.addTargetedAnimation(l[e],new He(d,n))}const c=e.runtimeBones,m=this.propertyAnimations,u=this.propertyAnimationBindMap,p=e.ikSolverStates;for(let e=0;e<m.length;++e){const i=n.get(u[e]);if(void 0!==i){const n=c[i].ikSolverIndex;-1!==n&&t.addTargetedAnimation(m[e],new Ge(p,n))}}const g=this.visibilityAnimation;return null!==g&&0!==e.mesh.metadata.meshes.length&&t.addTargetedAnimation(g,new $e(e.mesh.metadata.meshes)),t}}class Je{createMorphAnimation(e,t){const n=new ke.Animation(e+"_morph_"+t.name,"influence",30,ke.Animation.ANIMATIONTYPE_FLOAT,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.weights,r=new Array(i.length);for(let e=0;e<i.length;++e)r[e]={frame:i[e],value:o[e],interpolation:De.AnimationKeyInterpolation.NONE};return n.setKeys(r),n}createVisibilityAnimation(e,t){const n=new ke.Animation(e+"_visibility","visibility",30,ke.Animation.ANIMATIONTYPE_FLOAT,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.visibles,r=new Array(i.length);for(let e=0;e<i.length;++e)r[e]={frame:i[e],value:o[e]-1,interpolation:De.AnimationKeyInterpolation.STEP};return n.setKeys(r),0===i.length||1===i.length&&1===o[0]?null:n}createPropertyAnimation(e,t){const n=new Array(t.ikBoneNames.length),i=t.ikBoneNames;for(let o=0;o<i.length;++o){const r=n[o]=new ke.Animation(e+"_ik_"+i[o],"enabled",30,ke.Animation.ANIMATIONTYPE_FLOAT,ke.Animation.ANIMATIONLOOPMODE_CYCLE),a=t.frameNumbers,s=t.getIkState(o),l=new Array(a.length);for(let e=0;e<a.length;++e)l[e]={frame:a[e],value:s[e]-1,interpolation:De.AnimationKeyInterpolation.STEP};r.setKeys(l)}return n}}class Ze extends Je{createBonePositionAnimation(e,t){const n=new ke.Animation(e+"_bone_position_"+t.name,"position",30,ke.Animation.ANIMATIONTYPE_VECTOR3,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.positions,r=t.positionInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0,l=t-(0<e?i[e-1]:-30),h=s-t;a[e]={frame:t,value:new c.Vector3(o[3*e],o[3*e+1],o[3*e+2]),inTangent:n?new c.Vector3(Ue(1-r[12*e+1]/127,1-r[12*e+3]/127,l,o[3*e]-o[3*(e-1)]),Ue(1-r[12*e+5]/127,1-r[12*e+7]/127,l,o[3*e+1]-o[3*(e-1)+1]),Ue(1-r[12*e+9]/127,1-r[12*e+11]/127,l,o[3*e+2]-o[3*(e-1)+2])):void 0,outTangent:s<1/0?new c.Vector3(Ue(r[12*(e+1)+0]/127,r[12*(e+1)+2]/127,h,o[3*(e+1)]-o[3*e]),Ue(r[12*(e+1)+4]/127,r[12*(e+1)+6]/127,h,o[3*(e+1)+1]-o[3*e+1]),Ue(r[12*(e+1)+8]/127,r[12*(e+1)+10]/127,h,o[3*(e+1)+2]-o[3*e+2])):void 0,interpolation:De.AnimationKeyInterpolation.NONE,lockedTangent:!1}}return n.setKeys(a),n}_minimizeRotationDifference(e,t){c.Quaternion.Dot(e,t)<0&&(e.x=-e.x,e.y=-e.y,e.z=-e.z,e.w=-e.w)}createBoneRotationAnimation(e,t){const n=new ke.Animation(e+"_bone_rotation_"+t.name,"rotationQuaternion",30,ke.Animation.ANIMATIONTYPE_QUATERNION,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.rotations,r=t.rotationInterpolations;let a=new c.Quaternion(0,0,0,0);const s=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,l=e+1<i.length?i[e+1]:1/0,h=t-(0<e?i[e-1]:-30),d=l-t,m=new c.Quaternion(o[4*e],o[4*e+1],o[4*e+2],o[4*e+3]);this._minimizeRotationDifference(m,a);const u=new c.Quaternion(o[4*(e+1)],o[4*(e+1)+1],o[4*(e+1)+2],o[4*(e+1)+3]);this._minimizeRotationDifference(u,m),s[e]={frame:t,value:m,inTangent:n?new c.Quaternion(Ue(1-r[4*e+1]/127,1-r[4*e+3]/127,h,m.x-a.x),Ue(1-r[4*e+1]/127,1-r[4*e+3]/127,h,m.y-a.y),Ue(1-r[4*e+1]/127,1-r[4*e+3]/127,h,m.z-a.z),Ue(1-r[4*e+1]/127,1-r[4*e+3]/127,h,m.w-a.w)):void 0,outTangent:l<1/0?new c.Quaternion(Ue(r[4*(e+1)+0]/127,r[4*(e+1)+2]/127,d,u.x-m.x),Ue(r[4*(e+1)+0]/127,r[4*(e+1)+2]/127,d,u.y-m.y),Ue(r[4*(e+1)+0]/127,r[4*(e+1)+2]/127,d,u.z-m.z),Ue(r[4*(e+1)+0]/127,r[4*(e+1)+2]/127,d,u.w-m.w)):void 0,interpolation:De.AnimationKeyInterpolation.NONE,lockedTangent:!1},a=m}return n.setKeys(s),n}}class et extends Je{createBonePositionAnimation(e,t){const n=new ke.Animation(e+"_bone_position_"+t.name,"position",30,ke.Animation.ANIMATIONTYPE_VECTOR3,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.positions,r=t.positionInterpolations,a=new Array(t.endFrame);let s=0;const l=new c.Vector3(o[0],o[1],o[2]);for(let e=0;e<i.length;++e){const t=i[e];a[t]={frame:t,value:new c.Vector3(o[3*e],o[3*e+1],o[3*e+2])};const n=r[12*e+0]/127,h=r[12*e+1]/127,d=r[12*e+2]/127,m=r[12*e+3]/127,u=r[12*e+4]/127,p=r[12*e+5]/127,g=r[12*e+6]/127,f=r[12*e+7]/127,_=r[12*e+8]/127,b=r[12*e+9]/127,y=r[12*e+10]/127,A=r[12*e+11]/127;for(let i=s+1;i<t;++i){const r=(i-s)/(t-s),M=Fe.Interpolate(n,h,d,m,r),T=Fe.Interpolate(u,p,g,f,r),w=Fe.Interpolate(_,b,y,A,r);a[i]={frame:i,value:new c.Vector3(l.x+(o[3*e]-l.x)*M,l.y+(o[3*e+1]-l.y)*T,l.z+(o[3*e+2]-l.z)*w)}}s=t,l.set(o[3*e],o[3*e+1],o[3*e+2])}return n.setKeys(a),n}createBoneRotationAnimation(e,t){const n=new ke.Animation(e+"_bone_rotation_"+t.name,"rotationQuaternion",30,ke.Animation.ANIMATIONTYPE_QUATERNION,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.rotations,r=t.rotationInterpolations,a=new Array(t.endFrame);let s=0;const l=new c.Quaternion(o[0],o[1],o[2],o[3]);for(let e=0;e<i.length;++e){const t=i[e];a[t]={frame:t,value:new c.Quaternion(o[4*e],o[4*e+1],o[4*e+2],o[4*e+3])};const n=r[4*e+0]/127,h=r[4*e+1]/127,d=r[4*e+2]/127,m=r[4*e+3]/127;for(let i=s+1;i<t;++i){const r=(i-s)/(t-s),u=Fe.Interpolate(n,h,d,m,r),p=new c.Quaternion(o[4*e],o[4*e+1],o[4*e+2],o[4*e+3]);a[i]={frame:i,value:c.Quaternion.SlerpToRef(l,p,u,p)}}s=t,l.set(o[4*e],o[4*e+1],o[4*e+2],o[4*e+3])}return n.setKeys(a),n}}class tt extends Je{createBonePositionAnimation(e,t){const n=new Le(e+"_bone_position_"+t.name,"position",30,ke.Animation.ANIMATIONTYPE_VECTOR3,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.positions,r=t.positionInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0;a[e]={frame:t,value:new c.Vector3(o[3*e],o[3*e+1],o[3*e+2]),inTangent:n?[new c.Vector2(r[12*e+1]/127,r[12*e+3]/127),new c.Vector2(r[12*e+5]/127,r[12*e+7]/127),new c.Vector2(r[12*e+9]/127,r[12*e+11]/127)]:void 0,outTangent:s<1/0?[new c.Vector2(r[12*(e+1)+0]/127,r[12*(e+1)+2]/127),new c.Vector2(r[12*(e+1)+4]/127,r[12*(e+1)+6]/127),new c.Vector2(r[12*(e+1)+8]/127,r[12*(e+1)+10]/127)]:void 0,interpolation:2,lockedTangent:!1}}return n.setKeys(a),n}createBoneRotationAnimation(e,t){const n=new Le(e+"_bone_rotation_"+t.name,"rotationQuaternion",30,Le.ANIMATIONTYPE_SLERP_TANGENT_QUATERNION,ke.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,o=t.rotations,r=t.rotationInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0;a[e]={frame:t,value:new c.Quaternion(o[4*e],o[4*e+1],o[4*e+2],o[4*e+3]),inTangent:n?new c.Vector2(r[4*e+1]/127,r[4*e+3]/127):void 0,outTangent:s<1/0?new c.Vector2(r[4*(e+1)+0]/127,r[4*(e+1)+2]/127):void 0,interpolation:2,lockedTangent:!1}}return n.setKeys(a),n}}class nt{animation;boneBindIndexMap;movableBoneBindIndexMap;_morphController;morphBindIndexMap;_meshes;ikSolverBindIndexMap;_ikSolverStates;_materialRecompileInduceInfo;_bonePositionAnimationStates;_boneRotationAnimationStates;_morphAnimationStates;_propertyAnimationStates;_visibilityAnimationState;constructor(e,t,n,i,o,r,a,s,l){this.animation=e,this.boneBindIndexMap=t,this.movableBoneBindIndexMap=n,this._morphController=i,this.morphBindIndexMap=o,this._meshes=r,this.ikSolverBindIndexMap=a,this._ikSolverStates=s,this._materialRecompileInduceInfo=l;const h=this._bonePositionAnimationStates=new Array(e.bonePositionAnimations.length);for(let e=0;e<h.length;++e)h[e]=je();const d=this._boneRotationAnimationStates=new Array(e.boneRotationAnimations.length);for(let e=0;e<d.length;++e)d[e]=je();const c=this._morphAnimationStates=new Array(e.morphAnimations.length);for(let e=0;e<c.length;++e)c[e]=je();const m=this._propertyAnimationStates=new Array(e.propertyAnimations.length);for(let e=0;e<m.length;++e)m[e]=je();this._visibilityAnimationState=je()}static _BonePosition=new c.Vector3;animate(e){const t=this.animation,n=t.boneRotationAnimations,i=this.boneBindIndexMap;for(let t=0;t<n.length;++t){const o=n[t],r=i[t];null!==r&&r.setRotationQuaternion(o._interpolate(e,this._boneRotationAnimationStates[t]),Ye.Space.LOCAL)}const o=t.bonePositionAnimations,r=this.movableBoneBindIndexMap;for(let t=0;t<o.length;++t){const n=o[t],i=r[t];null!==i&&(i.getRestMatrix().getTranslationToRef(nt._BonePosition),i.position=nt._BonePosition.addInPlace(n._interpolate(e,this._bonePositionAnimationStates[t])))}const a=t.morphAnimations,s=this.morphBindIndexMap,l=this._morphController;for(let t=0;t<a.length;++t){const n=a[t],i=s[t];if(null===i)continue;const o=n._interpolate(e,this._morphAnimationStates[t]);for(let e=0;e<i.length;++e)l.setMorphWeightFromIndex(i[e],o)}if(null!==t.visibilityAnimation){const n=this._meshes,i=1+t.visibilityAnimation._interpolate(e,this._visibilityAnimationState);for(let e=0;e<n.length;++e)n[e].visibility=i}const h=t.propertyAnimations,d=this.ikSolverBindIndexMap,c=this._ikSolverStates.ikSolverStates;for(let t=0;t<h.length;++t){const n=h[t],i=d[t];-1!==i&&(c[i]=0<1+n._interpolate(e,this._propertyAnimationStates[t])?1:0)}}induceMaterialRecompile(e,t){null!==this._materialRecompileInduceInfo&&(nt.InduceMaterialRecompile(this._materialRecompileInduceInfo,this._morphController,this.morphBindIndexMap,t),e&&Re(this._morphController,this.morphBindIndexMap),this._materialRecompileInduceInfo=null)}static Create(e,t,n,i){const o=t.skeleton.bones,r=new Map;if(void 0===n)for(let e=0;e<o.length;++e)r.set(o[e].name,e);else for(let e=0;e<o.length;++e)r.set(n[o[e].name]??o[e].name,e);const a=new Array(e.boneRotationAnimations.length),s=e.boneRotationAnimationBindMap;for(let e=0;e<s.length;++e){const t=r.get(s[e]);void 0===t?(i?.warn(`Binding failed: bone ${s[e]} not found`),a[e]=null):a[e]=o[t]}const l=new Array(e.bonePositionAnimations.length),h=e.bonePositionAnimationBindMap;for(let e=0;e<h.length;++e){const t=r.get(h[e]);void 0===t?(i?.warn(`Binding failed: bone ${h[e]} not found`),l[e]=null):l[e]=o[t]}const d=t.morph,c=new Array(e.morphAnimations.length),m=e.morphAnimationBindMap;for(let e=0;e<m.length;++e){const t=m[e],o=n?.[t]??t,r=d.getMorphIndices(o);void 0===r?(i?.warn(`Binding failed: morph ${o} not found`),c[e]=null):c[e]=r}const u=t.runtimeBones,p=new Int32Array(e.propertyAnimations.length),g=e.propertyAnimationBindMap;for(let e=0;e<g.length;++e){const t=g[e],n=r.get(t);if(void 0===n)i?.warn(`Binding failed: IK bone ${t} not found`),p[e]=-1;else{const o=u[n].ikSolverIndex;-1===o?(i?.warn(`Binding failed: IK solver for bone ${t} not found`),p[e]=-1):p[e]=o}}return new nt(e,a,l,d,c,t.mesh.metadata.meshes,p,t,t.mesh.metadata.materials)}static InduceMaterialRecompile=Pe}Xe.prototype.createRuntimeModelAnimation=function(e,t,n){return nt.Create(this,e,t,n)};class it{trackType;name;frameNumbers;constructor(e,t,n,i,o){this.trackType=e,this.name=t,this.frameNumbers=void 0===i?new Uint32Array(n):new Uint32Array(i,o,n)}validate(){for(let e=1;e<this.frameNumbers.length;++e)if(this.frameNumbers[e-1]>=this.frameNumbers[e])return!1;return!0}get startFrame(){return 0===this.frameNumbers.length?0:this.frameNumbers[0]}get endFrame(){return 0===this.frameNumbers.length?0:this.frameNumbers[this.frameNumbers.length-1]}}class ot extends it{rotations;rotationInterpolations;constructor(e,t,n,i,o,r){super("bone",e,t,n,i),void 0===n?(this.rotations=new Float32Array(4*t),this.rotationInterpolations=new Uint8Array(4*t)):(this.rotations=new Float32Array(n,o,4*t),this.rotationInterpolations=new Uint8Array(n,r,4*t))}}class rt extends it{positions;positionInterpolations;rotations;rotationInterpolations;constructor(e,t,n,i,o,r,a,s){super("movableBone",e,t,n,i),void 0===n?(this.positions=new Float32Array(3*t),this.positionInterpolations=new Uint8Array(12*t),this.rotations=new Float32Array(4*t),this.rotationInterpolations=new Uint8Array(4*t)):(this.positions=new Float32Array(n,o,3*t),this.positionInterpolations=new Uint8Array(n,r,12*t),this.rotations=new Float32Array(n,a,4*t),this.rotationInterpolations=new Uint8Array(n,s,4*t))}}class at extends it{weights;constructor(e,t,n,i,o){super("morph",e,t,n,i),this.weights=void 0===n?new Float32Array(t):new Float32Array(n,o,t)}}class st extends it{positions;positionInterpolations;rotations;rotationInterpolations;distances;distanceInterpolations;fovs;fovInterpolations;constructor(e,t,n,i,o,r,a,s,l,h,d){super("camera","cameraTrack",e,t,n),void 0===t?(this.positions=new Float32Array(3*e),this.positionInterpolations=new Uint8Array(12*e),this.rotations=new Float32Array(3*e),this.rotationInterpolations=new Uint8Array(4*e),this.distances=new Float32Array(e),this.distanceInterpolations=new Uint8Array(4*e),this.fovs=new Float32Array(e),this.fovInterpolations=new Uint8Array(4*e)):(this.positions=new Float32Array(t,i,3*e),this.positionInterpolations=new Uint8Array(t,o,12*e),this.rotations=new Float32Array(t,r,3*e),this.rotationInterpolations=new Uint8Array(t,a,4*e),this.distances=new Float32Array(t,s,e),this.distanceInterpolations=new Uint8Array(t,l,4*e),this.fovs=new Float32Array(t,h,e),this.fovInterpolations=new Uint8Array(t,d,4*e))}}class lt extends it{visibles;ikBoneNames;_ikStates;constructor(e,t,n,i,o,r){if(super("property","propertyTrack",e,n,i),void 0===n){this.visibles=new Uint8Array(e),this.ikBoneNames=t,this._ikStates=new Array(t.length);for(let n=0;n<t.length;++n)this._ikStates[n]=new Uint8Array(e)}else{this.visibles=new Uint8Array(n,o,e),this.ikBoneNames=t,this._ikStates=new Array(t.length),void 0===r&&(r=new Array(t.length));for(let i=0;i<t.length;++i)this._ikStates[i]=new Uint8Array(n,r[i],e)}}getIkState(e){return this._ikStates[e]}}class ht{static _Map=new Map;instance;pool;_referenceCount;constructor(e,t){this.instance=e,this.pool=t,this._referenceCount=0}addReference(){this._referenceCount+=1}removeReference(){this._referenceCount-=1,0===this._referenceCount&&(this.pool.free(),ht._Map.delete(this.instance))}static Get(e){let t=this._Map.get(e);if(!t){const n=e.createAnimationPool();t=new ht(e,n),this._Map.set(e,t)}return t}}class dt{trackType;name;_frameNumbers;get frameNumbers(){return this._frameNumbers.array}constructor(e,t,n,i,o){this.trackType=e,this.name=t,this._frameNumbers=i.createTypedArray(Uint32Array,o,n)}get startFrame(){const e=this._frameNumbers.array;return 0===e.length?0:e[0]}get endFrame(){const e=this._frameNumbers.array;return 0===e.length?0:e[e.length-1]}}class ct extends dt{_rotations;get rotations(){return this._rotations.array}_rotationInterpolations;get rotationInterpolations(){return this._rotationInterpolations.array}constructor(e,t,n,i,o,r){super("bone",e,t,n,i),this._rotations=n.createTypedArray(Float32Array,o,4*t),this._rotationInterpolations=n.createTypedArray(Uint8Array,r,4*t)}}class mt extends dt{_positions;get positions(){return this._positions.array}_positionInterpolations;get positionInterpolations(){return this._positionInterpolations.array}_rotations;get rotations(){return this._rotations.array}_rotationInterpolations;get rotationInterpolations(){return this._rotationInterpolations.array}constructor(e,t,n,i,o,r,a,s){super("movableBone",e,t,n,i),this._positions=n.createTypedArray(Float32Array,o,3*t),this._positionInterpolations=n.createTypedArray(Uint8Array,r,12*t),this._rotations=n.createTypedArray(Float32Array,a,4*t),this._rotationInterpolations=n.createTypedArray(Uint8Array,s,4*t)}}class ut extends dt{_weights;get weights(){return this._weights.array}constructor(e,t,n,i,o){super("morph",e,t,n,i),this._weights=n.createTypedArray(Float32Array,o,t)}}class pt extends dt{visibles;ikBoneNames;_ikStates;constructor(e,t,n,i,o,r){if(super("property","propertyTrack",e,n,i),o.length!==e)throw new Error("visibles.length !== frameCount");this.visibles=o,this.ikBoneNames=t,this._ikStates=new Array(t.length),void 0===r&&(r=new Array(t.length));for(let i=0;i<t.length;++i)this._ikStates[i]=n.createTypedArray(Uint8Array,r[i],e)}getIkState(e){return this._ikStates[e].array}}class gt extends Oe{ptr;_poolWrapper;_disposed;_bindedDispose;_disposeObservableObject;constructor(e,t,n){const i=ht.Get(t);i.addReference();const o=i.pool,r=e.boneTracks,a=o.allocateLengthsBuffer(r.length),s=t.createTypedArray(Uint32Array,a,r.length).array;for(let e=0;e<r.length;++e)s[e]=r[e].frameNumbers.length;const l=o.createBoneTracks(a,s.length);o.deallocateLengthsBuffer(a,s.length);const h=new Array(r.length);for(let e=0;e<r.length;++e){const n=r[e],i=o.getBoneTrackFrameNumbers(l,e),a=o.getBoneTrackRotations(l,e),s=o.getBoneTrackRotationInterpolations(l,e),d=new ct(n.name,n.frameNumbers.length,t,i,a,s);d.frameNumbers.set(n.frameNumbers),d.rotations.set(n.rotations),d.rotationInterpolations.set(n.rotationInterpolations),h[e]=d}const d=e.movableBoneTracks,c=o.allocateLengthsBuffer(d.length),m=t.createTypedArray(Uint32Array,c,d.length).array;for(let e=0;e<d.length;++e)m[e]=d[e].frameNumbers.length;const u=o.createMovableBoneTracks(c,m.length);o.deallocateLengthsBuffer(c,m.length);const p=new Array(d.length);for(let e=0;e<d.length;++e){const n=d[e],i=o.getMovableBoneTrackFrameNumbers(u,e),r=o.getMovableBoneTrackPositions(u,e),a=o.getMovableBoneTrackPositionInterpolations(u,e),s=o.getMovableBoneTrackRotations(u,e),l=o.getMovableBoneTrackRotationInterpolations(u,e),h=new mt(n.name,n.frameNumbers.length,t,i,r,a,s,l);h.frameNumbers.set(n.frameNumbers),h.positions.set(n.positions),h.positionInterpolations.set(n.positionInterpolations),h.rotations.set(n.rotations),h.rotationInterpolations.set(n.rotationInterpolations),p[e]=h}const g=e.morphTracks,f=o.allocateLengthsBuffer(g.length),_=t.createTypedArray(Uint32Array,f,g.length).array;for(let e=0;e<g.length;++e)_[e]=g[e].frameNumbers.length;const b=o.createMorphTracks(f,_.length);o.deallocateLengthsBuffer(f,_.length);const y=new Array(g.length);for(let e=0;e<g.length;++e){const n=g[e],i=o.getMorphTrackFrameNumbers(b,e),r=o.getMorphTrackWeights(b,e),a=new ut(n.name,n.frameNumbers.length,t,i,r);a.frameNumbers.set(n.frameNumbers),a.weights.set(n.weights),y[e]=a}const A=e.propertyTrack,M=o.createAnimation(l,h.length,u,p.length,b,y.length,A.frameNumbers.length,A.ikBoneNames.length),T=o.getPropertyTrackFrameNumbers(M);let w;A.visibles.buffer.byteLength-A.visibles.byteLength<A.visibles.byteLength?w=A.visibles:(w=new Uint8Array(A.visibles.length),w.set(A.visibles));const x=[];for(let e=0;e<A.ikBoneNames.length;++e){const t=o.getPropertyTrackIkStates(M,e);x.push(t)}const v=new pt(A.frameNumbers.length,A.ikBoneNames,t,T,w,x);v.frameNumbers.set(A.frameNumbers);for(let e=0;e<A.ikBoneNames.length;++e){const t=A.getIkState(e);v.getIkState(e).set(t)}const I=e.cameraTrack,B=I.frameNumbers.byteLength+I.positions.byteLength+I.positionInterpolations.byteLength+I.rotations.byteLength+I.rotationInterpolations.byteLength+I.distances.byteLength+I.distanceInterpolations.byteLength+I.fovs.byteLength+I.fovInterpolations.byteLength;let P;I.frameNumbers.buffer.byteLength-B<B?P=I:(P=new st(I.frameNumbers.length),P.frameNumbers.set(I.frameNumbers),P.positions.set(I.positions),P.positionInterpolations.set(I.positionInterpolations),P.rotations.set(I.rotations),P.rotationInterpolations.set(I.rotationInterpolations),P.distances.set(I.distances),P.distanceInterpolations.set(I.distanceInterpolations),P.fovs.set(I.fovs),P.fovInterpolations.set(I.fovInterpolations)),super(e.name,h,p,y,v,P),this.ptr=M,this._poolWrapper=i,this._disposed=!1,this._bindedDispose=this.dispose.bind(this),this._disposeObservableObject=n,null!==this._disposeObservableObject&&this._disposeObservableObject.onDisposeObservable.add(this._bindedDispose)}dispose(){this._disposed||(this._disposed=!0,this._poolWrapper.pool.destroyAnimation(this.ptr),this._poolWrapper.removeReference(),this._poolWrapper=null,this.boneTracks.length=0,this.movableBoneTracks.length=0,this.morphTracks.length=0,this.propertyTrack=new lt(0,[]),this.cameraTrack=new st(0),null!==this._disposeObservableObject&&this._disposeObservableObject.onDisposeObservable.removeCallback(this._bindedDispose))}get isDisposed(){return this._disposed}}class ft extends Se{ptr;_modelPtr;_onDispose;animation;_boneBindIndexMap;get boneBindIndexMap(){return this._boneBindIndexMap.array}_movableBoneBindIndexMap;get movableBoneBindIndexMap(){return this._movableBoneBindIndexMap.array}_morphController;morphBindIndexMap;_meshes;_ikSolverBindIndexMap;get ikSolverBindIndexMap(){return this._ikSolverBindIndexMap.array}_materialRecompileInduceInfo;constructor(e,t,n,i,o,r,a,s,l,h,d){super(),this.ptr=e,this._modelPtr=t,this._onDispose=d,this.animation=n,this._boneBindIndexMap=i,this._movableBoneBindIndexMap=o,this._morphController=r,this.morphBindIndexMap=a,this._meshes=s,this._ikSolverBindIndexMap=l,this._materialRecompileInduceInfo=h}dispose(e=!1){if(null!==this._onDispose){if(!e){const e=this.animation._runtimeModelAnimations;if(void 0!==e){const t=e.indexOf(this);-1!==t&&e.splice(t,1)}}this._onDispose(),this._onDispose=null,this.animation._poolWrapper.pool.destroyRuntimeAnimation(this.ptr)}}wasmAnimate(e){this.animation._poolWrapper.pool.animateMmdModel(this.ptr,this._modelPtr,e)}animate(e){const t=this.animation,n=t.morphTracks;if(0<n.length){const t=this._morphController,i=this.morphBindIndexMap;for(let o=0;o<n.length;++o){const r=i[o];if(null===r)continue;const a=n[o],s=Math.max(a.startFrame,Math.min(a.endFrame,e)),l=this._upperBoundFrameIndex(s,a),h=l-1,d=a.frameNumbers[l];if(void 0===d){const e=a.weights[h];for(let n=0;n<r.length;++n)t.setMorphWeightFromIndex(r[n],e,!1)}else{const e=a.frameNumbers[h],n=(s-e)/(d-e),i=a.weights[h],o=i+(a.weights[l]-i)*n;for(let e=0;e<r.length;++e)t.setMorphWeightFromIndex(r[e],o,!1)}}}if(0<t.propertyTrack.frameNumbers.length){const n=t.propertyTrack,i=Math.max(n.startFrame,Math.min(n.endFrame,e)),o=this._upperBoundFrameIndex(i,n)-1,r=n.visibles[o],a=this._meshes;for(let e=0;e<a.length;++e)a[e].visibility=r}}induceMaterialRecompile(e,t){null!==this._materialRecompileInduceInfo&&(ft.InduceMaterialRecompile(this._materialRecompileInduceInfo,this._morphController,this.morphBindIndexMap,t),e&&Re(this._morphController,this.morphBindIndexMap),this._materialRecompileInduceInfo=null)}static Create(e,t,n,i,o){const r=e._poolWrapper.instance,a=e._poolWrapper.pool,s=t.skeleton.bones,l=new Map;if(void 0===i)for(let e=0;e<s.length;++e)l.set(s[e].name,e);else for(let e=0;e<s.length;++e)l.set(i[s[e].name]??s[e].name,e);const h=a.createBoneBindIndexMap(e.ptr),d=r.createTypedArray(Int32Array,h,e.boneTracks.length);{const t=e.boneTracks,n=d.array;for(let e=0;e<t.length;++e){const i=t[e],r=l.get(i.name);void 0===r?(o?.warn(`Binding failed: bone ${i.name} not found`),n[e]=-1):n[e]=r}}const c=a.createMovableBoneBindIndexMap(e.ptr),m=r.createTypedArray(Int32Array,c,e.movableBoneTracks.length);{const t=m.array,n=e.movableBoneTracks;for(let e=0;e<n.length;++e){const i=n[e],r=l.get(i.name);void 0===r?(o?.warn(`Binding failed: bone ${i.name} not found`),t[e]=-1):t[e]=r}}const u=new Array(e.morphTracks.length),p=t.morph,g=e.morphTracks;for(let e=0;e<g.length;++e){const t=g[e],n=i?.[t.name]??t.name,r=p.getMorphIndices(n);void 0===r?(o?.warn(`Binding failed: morph ${n} not found`),u[e]=null):u[e]=r}const f=a.allocateLengthsBuffer(g.length),_=r.createTypedArray(Uint32Array,f,g.length);{const e=_.array,t=p.wasmMorphIndexMap;for(let n=0;n<g.length;++n){let i=0;const o=u[n];if(null!==o)for(let e=0;e<o.length;++e){const n=t[o[e]];void 0!==n&&-1!==n&&(i+=1)}e[n]=i}}const b=a.createMorphBindIndexMap(e.ptr,f);{const e=p.wasmMorphIndexMap;for(let t=0;t<g.length;++t){const n=a.getNthMorphBindIndexMap(b,t),i=r.createTypedArray(Int32Array,n,_.array[t]).array;let o=0;const s=u[t];if(null!==s)for(let t=0;t<s.length;++t){const n=e[s[t]];void 0!==n&&-1!==n&&(i[o]=n,o+=1)}}}a.deallocateLengthsBuffer(f,g.length);const y=a.createIkSolverBindIndexMap(e.ptr),A=r.createTypedArray(Int32Array,y,e.propertyTrack.ikBoneNames.length);{const n=A.array,i=t.runtimeBones,r=e.propertyTrack.ikBoneNames;for(let e=0;e<r.length;++e){const t=r[e],a=l.get(t);if(void 0===a)o?.warn(`Binding failed: IK bone ${t} not found`),n[e]=-1;else{const r=i[a].ikSolverIndex;-1===r?(o?.warn(`Binding failed: IK solver for bone ${t} not found`),n[e]=-1):n[e]=r}}}const M=a.createRuntimeAnimation(e.ptr,h,c,b,y);return new ft(M,t.ptr,e,d,m,p,u,t.mesh.metadata.meshes,A,t.mesh.metadata.materials,n)}static InduceMaterialRecompile=Pe}gt.prototype.createWasmRuntimeModelAnimation=function(e,t,n,i){void 0===this._runtimeModelAnimations&&(this._runtimeModelAnimations=[]);const o=ft.Create(this,e,t,n,i);return this._runtimeModelAnimations.push(o),o};const _t=gt.prototype.dispose;gt.prototype.dispose=function(){if(this.isDisposed)return;const e=this._runtimeModelAnimations;if(void 0!==e){for(let t=0;t<e.length;++t)e[t].dispose(!0);this._runtimeModelAnimations=void 0}_t.call(this)};class bt extends Oe{constructor(e,t,n,i,o,r){super(e,t,n,i,o,r)}validate(){const e=this.boneTracks;for(let t=0;t<e.length;++t)if(!e[t].validate())return!1;const t=this.movableBoneTracks;for(let e=0;e<t.length;++e)if(!t[e].validate())return!1;const n=this.morphTracks;for(let e=0;e<n.length;++e)if(!n[e].validate())return!1;return this.propertyTrack.validate()&&this.cameraTrack.validate()}}var yt,At;!function(e){e.isMmdMesh=function(e){return!(null===e.metadata||!e.metadata.isMmdModel)},e.isMmdSkinnedMesh=function(e){return!(null===e.metadata||!e.metadata.isMmdModel)&&null!==e.metadata.skeleton}}(yt||(yt={})),function(e){e.isSerializationMetadata=function(e){return!0===e.containsSerializationData}}(At||(At={}));class Mt{_dataView;_encoder;_offset;constructor(e){this._dataView=new DataView(e),this._encoder=new TextEncoder,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}setUint8(e){this._dataView.setUint8(this._offset,e),this._offset+=1}setUint8Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setUint8(this._offset,e[n]),this._offset+=1}setInt8(e){this._dataView.setInt8(this._offset,e),this._offset+=1}setInt8Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setInt8(this._offset,e[n]),this._offset+=1}setUint16(e){this._dataView.setUint16(this._offset,e,!0),this._offset+=2}setUint16Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setUint16(this._offset,e[n],!0),this._offset+=2}setUint32(e){this._dataView.setUint32(this._offset,e,!0),this._offset+=4}setUint32Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setUint32(this._offset,e[n],!0),this._offset+=4}setInt32(e){this._dataView.setInt32(this._offset,e,!0),this._offset+=4}setInt32Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setInt32(this._offset,e[n],!0),this._offset+=4}setFloat32(e){this._dataView.setFloat32(this._offset,e,!0),this._offset+=4}setFloat32Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setFloat32(this._offset,e[n],!0),this._offset+=4}setString(e){const t=this._dataView,n=this._encoder.encode(e);t.setUint32(this._offset,n.length,!0),this._offset+=4;for(let e=0;e<n.length;++e)t.setUint8(this._offset,n[e]),this._offset+=1}get bytesAvailable(){return this._dataView.byteLength-this._offset}static Padding(e,t){return e%t==0?0:t-e%t}}class Tt{_loggingEnabled;log;warn;error;constructor(){this._loggingEnabled=!0,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled}convert(e,t={}){if(!yt.isMmdMesh(e))throw new Error(`${e.name} is not MmdMesh`);const{includeSkinningData:n=!0,includeMorphData:i=!0,translucentMaterials:r=[],alphaEvaluateResults:a=[]}=t,s=e.metadata,l=At.isSerializationMetadata(s);n&&null===s.skeleton&&this.log("MmdMesh has no skeleton. Skinning data will not be included");const h=[],d=new Int32Array(s.bones.length).fill(-1);let c=-1;const m=s.skeleton?.bones??[];for(let e=0;e<m.length;++e)c=Math.max(c,m[e].getIndex());const u=new Int32Array(c+1).fill(-1);if(n&&null!==s.skeleton){const e=s.bones,t=new Map;{const n=new Map;for(let e=0;e<m.length;++e){const t=m[e];n.has(t.name)||n.set(t.name,t)}for(let i=0;i<e.length;++i){const o=e[i],r=n.get(o.name);void 0!==r&&t.set(o,r)}}const n=new Map;{const t=new Map;for(let n=0;n<e.length;++n){const i=e[n];t.has(i.name)||t.set(i.name,i)}for(let e=0;e<m.length;++e){const i=m[e],o=t.get(i.name);void 0!==o&&n.set(i,o)}}const i=new Map;for(let t=0;t<e.length;++t){const n=e[t];let o=i.get(e[n.parentBoneIndex]);void 0===o&&0<=n.parentBoneIndex&&n.parentBoneIndex<e.length&&(o=[],i.set(e[n.parentBoneIndex],o)),o?.push(n)}const o=new Map;for(let e=0;e<m.length;++e){if(null!==m[e].getParent())continue;const t=[m[e]];for(o.set(m[e],m[e].getRestMatrix());t.length>0;){const e=t.pop(),n=o.get(e),i=e.children;for(let e=0;e<i.length;++e){const r=i[e];o.set(r,r.getRestMatrix().multiply(n)),t.push(r)}}}const r=new Map;for(let a=0;a<e.length;++a){const s=e[a];let l=t.get(s);const c=[],m=e=>{const t=e.children;for(let i=0;i<t.length;++i){const o=t[i],a=n.get(o);void 0===a?(c.push(e),m(o)):r.has(a)||r.set(a,h.length+c.length)}};if(void 0!==l)m(l);else{const e=i.get(s);if(void 0!==e)for(let t=0;t<e.length;++t){const n=e[t];r.set(n,h.length+c.length)}}const p=e=>{const n=i.get(e);if(void 0!==n)for(let e=0;e<n.length;++e){const i=n[e];let o=t.get(i);if(void 0!==o)return o;if(o=p(i),void 0!==o)return o}};if(void 0===l&&(l=p(s)),void 0===l){let n=e[s.parentBoneIndex];for(;void 0!==n&&(l=t.get(n),void 0===l);)n=e[n.parentBoneIndex]}const g=s.name,f=s.englishName,_=void 0!==l?o.get(l).getTranslation().asArray():[0,0,0],b=-1,y=s.transformOrder,A=s.tailPosition??-2,T=s.appendTransform,w=s.axisLimit,x=s.localVector,v=s.externalParentTransform,I=s.ik;let B=(s.flag??0)&(Array.isArray(A)?~M.Bone.Flag.UseBoneIndexAsTailPosition:0)&(T?0:~M.Bone.Flag.HasAppendRotate|~M.Bone.Flag.HasAppendMove)&(w?0:~M.Bone.Flag.HasAxisLimit)&(x?0:~M.Bone.Flag.HasLocalVector)&(v?0:~M.Bone.Flag.IsExternalParentTransformed)&(I?0:~M.Bone.Flag.IsIkEnabled);B|=(Array.isArray(A)?0:M.Bone.Flag.UseBoneIndexAsTailPosition)|(T?M.Bone.Flag.HasAppendRotate|M.Bone.Flag.HasAppendMove:0)|(w?M.Bone.Flag.HasAxisLimit:0)|(x?M.Bone.Flag.HasLocalVector:0)|(v?M.Bone.Flag.IsExternalParentTransformed:0)|(I?M.Bone.Flag.IsIkEnabled:0);const P={name:g,englishName:f,position:_,parentBoneIndex:b,transformOrder:y,flag:B,tailPosition:A,appendTransform:T,axisLimit:w,localVector:x,externalParentTransform:v,ik:I},R=d[a]=h.length;void 0!==l&&(u[l.getIndex()]=R),h.push(P);const C=M.Bone.Flag.UseBoneIndexAsTailPosition|M.Bone.Flag.IsRotatable|M.Bone.Flag.IsVisible|M.Bone.Flag.IsControllable;for(let e=0;e<c.length;++e){const t=c[e];u[t.getIndex()]=h.length;let i=-1;const r=t.getParent();null!==r&&(i=n.get(r)===s?R:u[r.getIndex()]),h.push({name:t.name,englishName:"",position:o.get(t).getTranslation().asArray(),parentBoneIndex:i,transformOrder:0,flag:C,tailPosition:i,appendTransform:void 0,axisLimit:void 0,localVector:void 0,externalParentTransform:void 0,ik:void 0})}}for(let t=0;t<e.length;++t){const n=e[t],i=h[d[t]],o=i.parentBoneIndex=r.get(n)??-1;-2===i.tailPosition?i.tailPosition=o:"number"==typeof i.tailPosition&&0<=i.tailPosition&&i.tailPosition<e.length&&(i.tailPosition=d[i.tailPosition]);const a=i.appendTransform;void 0!==a&&(i.appendTransform={parentIndex:d[a.parentIndex]??a.parentIndex,ratio:a.ratio});const s=i.ik;if(void 0!==s){const e=[];i.ik={target:d[s.target]??s.target,iteration:s.iteration,rotationConstraint:s.rotationConstraint,links:e};const t=s.links;for(let n=0;n<t.length;++n){const i=t[n];e.push({target:d[i.target]??i.target,limitation:i.limitation})}}}}const g=[],f=new Map;{const e=s.meshes;for(let t=0;t<e.length;++t){const n=e[t];if(null===n.geometry){this.warn(`mesh ${n.name} has no geometry. skippping`);continue}const i=n.geometry;null!==i.getVerticesData(o.VertexBuffer.PositionKind)?null!==i.getVerticesData(o.VertexBuffer.NormalKind)?null!==i.getVerticesData(o.VertexBuffer.UVKind)?n.isUnIndexed||null!==i.getIndices()?null===s.skeleton||s.skeleton===n.skeleton?(f.set(t,g.length),g.push(n)):this.warn(`mesh ${n.name} has different skeleton. skippping`):this.warn(`mesh ${n.name} has no indices data. skippping`):this.warn(`mesh ${n.name} has no uv data. skippping`):this.warn(`mesh ${n.name} has no normal data. skippping`):this.warn(`mesh ${n.name} has no position data. skippping`)}}const _=[],b=[];{const e=new Set;for(let t=0;t<g.length;++t){const n=g[t].material;if(null===n)continue;const i=n.subMaterials??[n];for(let t=0;t<i.length;++t){const n=i[t];if(null!==n&&(n.diffuseTexture?e.add(n.diffuseTexture):n.albedoTexture&&e.add(n.albedoTexture),n.sphereTexture&&e.add(n.sphereTexture),n.toonTexture)){const t=n.toonTexture.name;t.startsWith("file:shared_toon_texture_")&&t.length<=27&&!isNaN(Number(t.substring(25)))||e.add(n.toonTexture)}}}const t=l?s.textureNameMap:null;null===t&&this.warn("metadata.textureNameMap is not defined. texture names will be fallback to converted string by loader");const n=new Map,i=new Map;for(const o of e){let e=null;const r=o._buffer;r instanceof ArrayBuffer?e=new Uint8Array(r):null==r?this.warn(`texture ${o.name} has no texture buffer. make sure load model with materialBuilder.deleteTextureBufferAfterLoad = false`):r.buffer instanceof ArrayBuffer?e=new Uint8Array(r.buffer,r.byteOffset,r.byteLength):this.warn(`texture ${o.name} has unsupported type of texture buffer. only ArrayBuffer and TypedArray is supported`);const a=(o.noMipmap?ye.Texture.Flag.NoMipmap:0)|(o.invertY?ye.Texture.Flag.InvertY:0);let s;if(null!==e){let r=i.get(e.buffer);void 0===r&&(r=i.size,i.set(e.buffer,r));const a=`${r}_${e.byteOffset}_${e.byteLength}`;if(s=n.get(a),void 0===s){s=_.length,n.set(a,s);let i=t?.get(o);void 0===i&&(this.warn(`texture ${o.name} has no name in textureNameMap. falling back to converted string by loader`),i=o.name),_.push({relativePath:i,mimeType:o.mimeType,buffer:e})}}b.push({flag:a,samplingMode:o.samplingMode,imageIndex:s??-1,texture:o})}}const y=[],A=new Map;{const e=new Map;{const t=s.materials;for(let n=0;n<t.length;++n){const i=t[n];e.set(i,n)}}const t=new Map;{const e=s.materials,n=l?s.materialsMetadata:null;if(null!==n)for(let i=0;i<e.length;++i){const o=e[i],r=n[i];t.has(o)||void 0!==r&&t.set(o,r)}}let n=!1;const i=new Map;for(let o=0;o<g.length;++o){const s=g[o],l=[];{const e=s.material?.subMaterials??[s.material],t=s.subMeshes;for(let n=0;n<t.length;++n){const i=e[t[n].materialIndex];l.push(i)}}for(let o=0;o<l.length;++o){const h=l[o];if(null===h){if(n)this.warn(`mesh ${s.name} has no material. using default material metadata`);else{n=!0,this.warn(`mesh ${s.name} has no material. adding default material metadata`);const e={name:"default",englishName:"default",diffuse:[1,1,1,1],specular:[0,0,0],shininess:0,ambient:[0,0,0],evaluatedTransparency:0,flag:0,edgeColor:[0,0,0,1],edgeSize:0,textureIndex:-1,sphereTextureIndex:-1,sphereTextureMode:M.Material.SphereTextureMode.Off,isSharedToonTexture:!1,toonTextureIndex:-1,comment:"",linkedMaterial:null};y.push(e)}continue}const d=i.get(h),c=e.get(h);if(void 0===c)this.warn(`mesh ${s.name} has material which is not included in model metadata`);else if(void 0!==d)A.set(c,d);else{A.set(c,y.length),i.set(h,y.length);const e=t.get(h);void 0===e&&this.log(`mesh ${s.name} has no additional material metadata`);const n=h.name??"",o=e?.englishName??"",l=h.diffuseColor?.asArray()??[1,1,1,1];l.length=4,l[3]=h.alpha??1;const d=h.specularColor?.asArray()??h.reflectivityColor?.asArray()??[0,0,0];d.length=3;const m=h.specularPower??0,u=h.ambientColor?.asArray()??[0,0,0];u.length=3;const p=(3&+(r[c]??-1))<<4|(15&(a[c]??-1))<<0,g=(!1===h.backFaceCulling?M.Material.Flag.IsDoubleSided:0)|(h.renderOutline?M.Material.Flag.EnabledToonEdge:0),f=h.outlineColor?.asArray()??[0,0,0];f.length=4,f[3]=h.outlineAlpha??0;const _=h.outlineWidth??0,T=h.diffuseTexture??h.albedoTexture,w=T?b.findIndex((e=>e.texture===T)):-1,x=h.sphereTexture,v=x?b.findIndex((e=>e.texture===x)):-1,I=h.sphereTextureBlendMode??M.Material.SphereTextureMode.Off,B=h.toonTexture,P=!!B&&B.name.startsWith("file:shared_toon_texture_")&&B.name.length<=27&&!isNaN(Number(B.name.substring(25)));let R;R=P?Number(B.name.substring(25))-1:B?b.findIndex((e=>e.texture===B)):-1;const C={name:n,englishName:o,diffuse:l,specular:d,shininess:m,ambient:u,evaluatedTransparency:p,flag:g,edgeColor:f,edgeSize:_,textureIndex:w,sphereTextureIndex:v,sphereTextureMode:I,isSharedToonTexture:P,toonTextureIndex:R,comment:e?.comment??"",linkedMaterial:h};y.push(C)}}}}const T=new Array(s.morphs.length).fill(null);for(let e=0;e<T.length;++e)T[e]=[];if(i)if(l){const e=s.morphs;for(let t=0;t<e.length;++t){const n=e[t];switch(n.type){case M.Morph.Type.VertexMorph:case M.Morph.Type.UvMorph:case M.Morph.Type.AdditionalUvMorph1:case M.Morph.Type.AdditionalUvMorph2:case M.Morph.Type.AdditionalUvMorph3:case M.Morph.Type.AdditionalUvMorph4:{const e=[],i=n.elements;for(let t=0;t<i.length;++t){const o=i[t],r=f.get(o.meshIndex);void 0!==r?e.push({meshIndex:r,indices:o.indices,offsets:o.offsets}):this.warn(`morph ${n.name} has invalid mesh. skipping`)}T[t]=e}}}}else{this.warn("metadata.morphsMetadata is not defined. UV morphs will be lossy converted");const e=s.morphs;for(let t=0;t<e.length;++t){const n=e[t];let i=!1;switch(n.type){case M.Morph.Type.VertexMorph:case M.Morph.Type.UvMorph:case M.Morph.Type.AdditionalUvMorph1:case M.Morph.Type.AdditionalUvMorph2:case M.Morph.Type.AdditionalUvMorph3:case M.Morph.Type.AdditionalUvMorph4:i=!0}if(!i)continue;const r=T[t]=[],a=n.morphTargets;for(let e=0;e<a.length;++e){let t=-1;const i=a[e];e:for(let e=0;e<g.length;++e){const n=g[e].morphTargetManager;if(null===n)continue;const o=n.numTargets;for(let r=0;r<o;++r)if(n.getTarget(r)===i){t=e;break e}}if(-1===t){this.warn(`morph ${n.name} has no target mesh. skipping`);continue}let s,l,h=0;if(n.type===M.Morph.Type.VertexMorph){const e=g[t].geometry.getVerticesData(o.VertexBuffer.PositionKind),r=i.getPositions();if(null===r){this.warn(`morph ${n.name} has no positions data. skipping`);continue}if(e.length!==r.length){this.warn(`morph ${n.name} has different number of positions. skipping`);continue}for(let t=0;t<e.length;t+=3)e[t+0]===r[t+0]&&e[t+1]===r[t+1]&&e[t+2]===r[t+2]||(h+=1);s=new Int32Array(h),l=new Float32Array(3*h);const a=e.length/3;for(let t=0,n=0;t<a;++t)e[3*t+0]===r[3*t+0]&&e[3*t+1]===r[3*t+1]&&e[3*t+2]===r[3*t+2]||(s[n]=t,l[3*n+0]=r[3*t+0]-e[3*t+0],l[3*n+1]=r[3*t+1]-e[3*t+1],l[3*n+2]=r[3*t+2]-e[3*t+2],n+=1)}else{const e=g[t].geometry.getVerticesData(o.VertexBuffer.UVKind),r=i.getUVs();if(null===r){this.warn(`morph ${n.name} has no uvs data. skipping`);continue}if(e.length!==r.length){this.warn(`morph ${n.name} has different number of uvs. skipping`);continue}for(let t=0;t<e.length;t+=2)e[t+0]===r[t+0]&&e[t+1]===r[t+1]||(h+=1);s=new Int32Array(h),l=new Float32Array(4*h);const a=e.length/2;for(let t=0,n=0;t<a;++t)e[2*t+0]===r[2*t+0]&&e[2*t+1]===r[2*t+1]||(s[n]=t,l[4*n+0]=r[2*t+0]-e[2*t+0],l[4*n+1]=r[2*t+1]-e[2*t+1],n+=1)}r.push({meshIndex:t,indices:s,offsets:l})}}}const w=new TextEncoder;let x=7;{const e=s.header;x+=4+w.encode(e.modelName).length,x+=4+w.encode(e.englishModelName).length,x+=4+w.encode(e.comment).length,x+=4+w.encode(e.englishComment).length,x+=1,x+=4;for(let e=0;e<g.length;++e){const t=g[e],n=t.geometry;x+=4+w.encode(t.name).length,x+=4;const i=t.material;if(void 0!==i?.subMaterials){const e=i.subMaterials;x+=4;for(let t=0;t<e.length;++t)x+=4,x+=4,x+=4,x+=4,x+=4}x+=4;const r=n.getVerticesData(o.VertexBuffer.PositionKind);x+=4*r.length;const a=r.length/3;if(x+=3*a*4,x+=2*a*4,x+=1,null!==n.getVerticesData(p.AdditionalUV1Kind)&&(x+=4*a*4),null!==n.getVerticesData(p.AdditionalUV2Kind)&&(x+=4*a*4),null!==n.getVerticesData(p.AdditionalUV3Kind)&&(x+=4*a*4),null!==n.getVerticesData(p.AdditionalUV4Kind)&&(x+=4*a*4),x+=1,!t.isUnIndexed){x+=1,x+=4;const e=n.getIndices();x+=Array.isArray(e)?4*e.length:e.byteLength}0!==h.length&&(null===n.getVerticesData(o.VertexBuffer.MatricesIndicesKind)&&this.warn(`mesh ${t.name} has no matricesIndices data. falling back to zero matricesIndices`),x+=4*a*4,null===n.getVerticesData(o.VertexBuffer.MatricesWeightsKind)&&this.warn(`mesh ${t.name} has no matricesWeights data. falling back to zero matricesWeights`),x+=4*a*4);const s=n.getVerticesData(p.MatricesSdefCKind),l=n.getVerticesData(p.MatricesSdefR0Kind),d=n.getVerticesData(p.MatricesSdefR1Kind);null!==s&&null!==l&&null!==d?(x+=3*a*4,x+=3*a*4,x+=3*a*4):null!==s&&null!==l&&null!==d||null===s&&null===l&&null===d||this.warn(`mesh ${t.name} has incomplete sdef data. sdefC, sdefR0, sdefR1 must be all defined or all undefined. falling back to linear blend skinning`),null!==n.getVerticesData(p.EdgeScaleKind)&&(x+=4*a)}x+=4;for(let e=0;e<_.length;++e){const t=_[e];x+=4+w.encode(t.relativePath).length,x+=1,void 0!==t.mimeType&&(x+=4+w.encode(t.mimeType).length),x+=4,x+=t.buffer.byteLength}x+=4;for(let e=0;e<b.length;++e)x+=6;x+=4;for(let e=0;e<y.length;++e){const t=y[e];x+=4+w.encode(t.name).length,x+=4+w.encode(t.englishName).length,x+=16,x+=12,x+=4,x+=12,x+=1,x+=1,x+=16,x+=4,x+=4,x+=4,x+=1,x+=1,x+=4,x+=4+w.encode(t.comment).length}if(0!==h.length){x+=4,l||this.warn("metadata.bones has following missing properties: tailPosition, axisLimit, localVector, externalParentTransform. lossy conversion will be applied");for(let e=0;e<h.length;++e){const t=h[e];if(x+=4+w.encode(t.name).length,x+=4+w.encode(t.englishName).length,x+=12,x+=4,x+=4,x+=2,l?"number"==typeof t.tailPosition?x+=4:x+=12:x+=4,void 0!==t.appendTransform&&(x+=4,x+=4),void 0!==t.axisLimit&&(x+=12),void 0!==t.localVector&&(x+=12,x+=12),void 0!==t.externalParentTransform&&(x+=4),void 0!==t.ik){x+=4,x+=4,x+=4,x+=4;const e=t.ik.links;for(let t=0;t<e.length;++t)x+=4,x+=1,void 0!==e[t].limitation&&(x+=12,x+=12)}}}x+=4;const t=s.morphs;for(let e=0;e<t.length;++e){const n=t[e];switch(x+=4+w.encode(n.name).length,x+=4+w.encode(n.englishName).length,x+=1,x+=1,n.type){case M.Morph.Type.GroupMorph:x+=4+8*n.indices.length;break;case M.Morph.Type.VertexMorph:{x+=4;const t=T[e];for(let e=0;e<t.length;++e){const n=t[e];x+=8+4*n.indices.length+4*n.offsets.length}}break;case M.Morph.Type.BoneMorph:x+=4+32*n.indices.length;break;case M.Morph.Type.UvMorph:case M.Morph.Type.AdditionalUvMorph1:case M.Morph.Type.AdditionalUvMorph2:case M.Morph.Type.AdditionalUvMorph3:case M.Morph.Type.AdditionalUvMorph4:{x+=4;const t=T[e];for(let e=0;e<t.length;++e){const n=t[e];x+=8+4*n.indices.length+4*n.offsets.length}}break;case M.Morph.Type.MaterialMorph:x+=4+117*n.elements.length}}if(x+=4,l&&null!==s.displayFrames){const e=s.displayFrames;for(let t=0;t<e.length;++t){const n=e[t];x+=4+w.encode(n.name).length,x+=4+w.encode(n.englishName).length,x+=1,x+=4,x+=5*n.frames.length}}x+=4;const n=s.rigidBodies;for(let e=0;e<n.length;++e){const t=n[e];x+=4+w.encode(t.name).length,x+=4+w.encode(t.englishName).length,x+=4,x+=1,x+=2,x+=1,x+=12,x+=12,x+=12,x+=4,x+=4,x+=4,x+=4,x+=4,x+=1}x+=4;const i=s.joints;for(let e=0;e<i.length;++e){const t=i[e];x+=4+w.encode(t.name).length,x+=4+w.encode(t.englishName).length,x+=1,x+=4,x+=4,x+=12,x+=12,x+=12,x+=12,x+=12,x+=12,x+=12,x+=12}}const v=new ArrayBuffer(x),I=new Mt(v);I.setUint8Array(w.encode("BPMX")),I.setInt8Array([2,1,0]);{const e=s.header;I.setString(e.modelName),I.setString(e.englishModelName),I.setString(e.comment),I.setString(e.englishComment)}const B=0!==h.length?ye.Geometry.MeshType.IsSkinnedMesh:0;I.setUint8(B),I.setUint32(g.length);for(let e=0;e<g.length;++e){const t=g[e],n=t.geometry;I.setString(t.name);let i=!1;if(1<t.subMeshes.length||0===t.subMeshes.length)i=!0;else{const e=t.subMeshes[0];0===e.materialIndex&&0===e.verticesStart&&e.verticesCount===n.getTotalVertices()&&0===e.indexStart&&e.indexCount===n.getTotalIndices()||(i=!0)}if(i){I.setInt32(-2);const e=t.subMeshes;I.setUint32(e.length);const n=t.material?.subMaterials??[t.material];for(let t=0;t<e.length;++t){const i=e[t],o=n[i.materialIndex]??null,r=y.findIndex((e=>e.linkedMaterial===o));I.setInt32(r),I.setUint32(i.verticesStart),I.setUint32(i.verticesCount),I.setUint32(i.indexStart),I.setUint32(i.indexCount)}}else{const e=t.material,n=y.findIndex((t=>t.linkedMaterial===e));I.setInt32(n)}const r=n.getVerticesData(o.VertexBuffer.PositionKind),a=r.length/3;I.setUint32(a),I.setFloat32Array(r);let s=n.getVerticesData(o.VertexBuffer.NormalKind);if(s.length!==3*a){this.warn(`mesh ${t.name} normals vertex count is different from positions vertex count`);const e=new Float32Array(3*a);e.set(s),s=e}I.setFloat32Array(s);let l=n.getVerticesData(o.VertexBuffer.UVKind);if(l.length!==2*a){this.warn(`mesh ${t.name} uv vertex count is different from positions vertex count`);const e=new Float32Array(2*a);e.set(l),l=e}I.setFloat32Array(l);const d=[];{const e=n.getVerticesData(p.AdditionalUV1Kind);null!==e&&d.push(e);const t=n.getVerticesData(p.AdditionalUV2Kind);null!==t&&d.push(t);const i=n.getVerticesData(p.AdditionalUV3Kind);null!==i&&d.push(i);const o=n.getVerticesData(p.AdditionalUV4Kind);null!==o&&d.push(o)}I.setUint8(d.length);for(let e=0;e<d.length;++e){const n=d[e];if(n.length!==4*a){this.warn(`mesh ${t.name} additional uv vertex count is different from positions vertex count`);const i=new Float32Array(4*a);i.set(n),d[e]=i}I.setFloat32Array(n)}let c=n.getVerticesData(p.MatricesSdefCKind),m=n.getVerticesData(p.MatricesSdefR0Kind),f=n.getVerticesData(p.MatricesSdefR1Kind);const _=null!==c&&null!==m&&null!==f;let b=n.getVerticesData(p.EdgeScaleKind);const A=(_?ye.Geometry.GeometryType.HasSdef:0)|(t.isUnIndexed?0:ye.Geometry.GeometryType.IsIndexed)|(null!==b?ye.Geometry.GeometryType.HasEdgeScale:0);if(I.setUint8(A),!t.isUnIndexed){const e=n.getIndices();I.setUint8(e instanceof Uint32Array?ye.Geometry.IndexElementType.Uint32:e instanceof Uint16Array?ye.Geometry.IndexElementType.Uint16:ye.Geometry.IndexElementType.Int32),I.setUint32(e.length),e instanceof Uint16Array?I.setUint16Array(e):e instanceof Uint32Array?I.setUint32Array(e):I.setInt32Array(e)}if(0!==h.length){const e=new Float32Array(4*a);{const i=n.getVerticesData(o.VertexBuffer.MatricesIndicesKind);if(null!==i&&i.length===4*a||this.warn(`mesh ${t.name} bone indices vertex count is different from positions vertex count`),null!==i)for(let t=0;t<e.length;++t)e[t]=u[i[t]]??i[t]}I.setFloat32Array(e);let i=n.getVerticesData(o.VertexBuffer.MatricesWeightsKind);if(null===i&&(i=new Float32Array(4*a)),i.length!==4*a){this.warn(`mesh ${t.name} bone weights vertex count is different from positions vertex count`);const e=new Float32Array(4*a);e.set(i),i=e}if(I.setFloat32Array(i),_){if(c.length!==3*a){this.warn(`mesh ${t.name} sdefC vertex count is different from positions vertex count`);const e=new Float32Array(3*a);e.set(c),c=e}if(m.length!==3*a){this.warn(`mesh ${t.name} sdefR0 vertex count is different from positions vertex count`);const e=new Float32Array(3*a);e.set(m),m=e}if(f.length!==3*a){this.warn(`mesh ${t.name} sdefR1 vertex count is different from positions vertex count`);const e=new Float32Array(3*a);e.set(f),f=e}I.setFloat32Array(c),I.setFloat32Array(m),I.setFloat32Array(f)}}if(null!==b){if(b.length!==a){this.warn(`mesh ${t.name} edgeScale vertex count is different from positions vertex count`);const e=new Float32Array(a);e.set(b),b=e}I.setFloat32Array(b)}}I.setUint32(_.length);for(let e=0;e<_.length;++e){const t=_[e];I.setString(t.relativePath);const n=void 0!==t.mimeType?ye.Image.Flag.HasMimeType:0;I.setUint8(n),void 0!==t.mimeType&&I.setString(t.mimeType),I.setUint32(t.buffer.byteLength),I.setUint8Array(t.buffer)}I.setUint32(b.length);for(let e=0;e<b.length;++e){const t=b[e];I.setUint8(t.flag),I.setUint8(t.samplingMode),I.setInt32(t.imageIndex)}I.setUint32(y.length);for(let e=0;e<y.length;++e){const t=y[e];I.setString(t.name),I.setString(t.englishName),I.setFloat32Array(t.diffuse),I.setFloat32Array(t.specular),I.setFloat32(t.shininess),I.setFloat32Array(t.ambient),I.setUint8(t.evaluatedTransparency),I.setUint8(t.flag),I.setFloat32Array(t.edgeColor),I.setFloat32(t.edgeSize),I.setInt32(t.textureIndex),I.setInt32(t.sphereTextureIndex),I.setUint8(t.sphereTextureMode),I.setUint8(t.isSharedToonTexture?1:0),I.setInt32(t.toonTextureIndex),I.setString(t.comment)}if(0!==h.length){I.setUint32(h.length);for(let e=0;e<h.length;++e){const t=h[e];if(I.setString(t.name),I.setString(t.englishName),I.setFloat32Array(t.position),I.setInt32(t.parentBoneIndex),I.setInt32(t.transformOrder),I.setUint16(t.flag),"number"==typeof t.tailPosition?I.setInt32(t.tailPosition):I.setFloat32Array(t.tailPosition),void 0!==t.appendTransform&&(I.setInt32(t.appendTransform.parentIndex),I.setFloat32(t.appendTransform.ratio)),void 0!==t.axisLimit&&I.setFloat32Array(t.axisLimit),void 0!==t.localVector&&(I.setFloat32Array(t.localVector.x),I.setFloat32Array(t.localVector.z)),void 0!==t.externalParentTransform&&I.setInt32(t.externalParentTransform),void 0!==t.ik){const e=t.ik;I.setInt32(e.target),I.setInt32(e.iteration),I.setFloat32(e.rotationConstraint);const n=e.links;I.setInt32(n.length);for(let e=0;e<n.length;++e){const t=n[e];I.setInt32(t.target),I.setUint8(void 0!==t.limitation?1:0),void 0!==t.limitation&&(I.setFloat32Array(t.limitation.minimumAngle),I.setFloat32Array(t.limitation.maximumAngle))}}}}I.setUint32(s.morphs.length);const P=s.morphs;for(let e=0;e<P.length;++e){const t=P[e];switch(I.setString(t.name),I.setString(t.englishName),I.setUint8(t.category),I.setUint8(t.type),t.type){case M.Morph.Type.GroupMorph:{I.setUint32(t.indices.length),I.setInt32Array(t.indices);let e=t.ratios;if(e.length!==t.indices.length){this.warn(`morph ${t.name} group morph ratio count is different from indices count`);const n=new Float32Array(t.indices.length);n.set(e),e=n}I.setFloat32Array(e)}break;case M.Morph.Type.VertexMorph:case M.Morph.Type.UvMorph:case M.Morph.Type.AdditionalUvMorph1:case M.Morph.Type.AdditionalUvMorph2:case M.Morph.Type.AdditionalUvMorph3:case M.Morph.Type.AdditionalUvMorph4:{const n=T[e];I.setUint32(n.length);for(let e=0;e<n.length;++e){const i=n[e];I.setUint32(i.meshIndex),I.setUint32(i.indices.length),I.setInt32Array(i.indices);let o=i.offsets;const r=t.type===M.Morph.Type.VertexMorph?3:4;if(o.length!==i.indices.length*r){this.warn(`morph ${t.name} vertex/uv morph offset count is different from indices count`);const e=new Float32Array(i.indices.length*r);e.set(o),o=e}I.setFloat32Array(o)}}break;case M.Morph.Type.BoneMorph:{const e=new Int32Array(t.indices.length);{const n=t.indices;for(let t=0;t<n.length;++t)e[t]=d[n[t]]??n[t]}I.setUint32(e.length),I.setInt32Array(e);let n=t.positions;if(n.length!==3*e.length){this.warn(`morph ${t.name} bone morph position count is different from indices count`);const i=new Float32Array(3*e.length);i.set(n),n=i}I.setFloat32Array(n);let i=t.rotations;if(i.length!==4*e.length){this.warn(`morph ${t.name} bone morph rotation count is different from indices count`);const n=new Float32Array(4*e.length);n.set(i),i=n}I.setFloat32Array(i)}break;case M.Morph.Type.MaterialMorph:{I.setUint32(t.elements.length);const e=t.elements;for(let t=0;t<e.length;++t){const n=e[t],i=A.get(n.index)??n.index;I.setInt32(i),I.setUint8(n.type),I.setFloat32Array(n.diffuse),I.setFloat32Array(n.specular),I.setFloat32(n.shininess),I.setFloat32Array(n.ambient),I.setFloat32Array(n.edgeColor),I.setFloat32(n.edgeSize),I.setFloat32Array(n.textureColor),I.setFloat32Array(n.sphereTextureColor),I.setFloat32Array(n.toonTextureColor)}}break;default:I.setUint32(0)}}if(l&&null!==s.displayFrames){I.setUint32(s.displayFrames.length);const e=s.displayFrames;for(let t=0;t<e.length;++t){const n=e[t];I.setString(n.name),I.setString(n.englishName),I.setUint8(n.isSpecialFrame?1:0),I.setUint32(n.frames.length);const i=n.frames;for(let e=0;e<i.length;++e){const t=i[e];I.setUint8(t.type);const n=t.type===M.DisplayFrame.FrameData.FrameType.Bone?d[t.index]??t.index:t.index;I.setInt32(n)}}}else I.setUint32(0);I.setUint32(s.rigidBodies.length);const R=s.rigidBodies;for(let e=0;e<R.length;++e){const t=R[e];I.setString(t.name),I.setString(t.englishName),I.setInt32(d[t.boneIndex]??t.boneIndex),I.setUint8(t.collisionGroup),I.setUint16(t.collisionMask),I.setUint8(t.shapeType),I.setFloat32Array(t.shapeSize),I.setFloat32Array(t.shapePosition),I.setFloat32Array(t.shapeRotation),I.setFloat32(t.mass),I.setFloat32(t.linearDamping),I.setFloat32(t.angularDamping),I.setFloat32(t.repulsion),I.setFloat32(t.friction),I.setUint8(t.physicsMode)}I.setUint32(s.joints.length);const C=s.joints;for(let e=0;e<C.length;++e){const t=C[e];I.setString(t.name),I.setString(t.englishName),I.setUint8(t.type),I.setInt32(t.rigidbodyIndexA),I.setInt32(t.rigidbodyIndexB),I.setFloat32Array(t.position),I.setFloat32Array(t.rotation),I.setFloat32Array(t.positionMin),I.setFloat32Array(t.positionMax),I.setFloat32Array(t.rotationMin),I.setFloat32Array(t.rotationMax),I.setFloat32Array(t.springPosition),I.setFloat32Array(t.springRotation)}return 0!==I.bytesAvailable&&this.error(`unexpected bytes available: ${I.bytesAvailable}`),v}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){N.Logger.Log(e)}_logDisabled(){}_warnEnabled(e){N.Logger.Warn(e)}_warnDisabled(){}_errorEnabled(e){N.Logger.Error(e)}_errorDisabled(){}}class wt{constructor(){}static Convert(e){const t=new TextEncoder;let n=7;{n+=4;const i=e.boneTracks.length;for(let o=0;o<i;++o){const i=e.boneTracks[o];n+=4+t.encode(i.name).length,n+=4,n+=4*i.frameNumbers.length+Mt.Padding(n,4),n+=16*i.frameNumbers.length+Mt.Padding(n,4),n+=4*i.frameNumbers.length}n+=4;const o=e.movableBoneTracks.length;for(let i=0;i<o;++i){const o=e.movableBoneTracks[i];n+=4+t.encode(o.name).length,n+=4,n+=4*o.frameNumbers.length+Mt.Padding(n,4),n+=12*o.frameNumbers.length+Mt.Padding(n,4),n+=12*o.frameNumbers.length,n+=16*o.frameNumbers.length+Mt.Padding(n,4),n+=4*o.frameNumbers.length}n+=4;const r=e.morphTracks.length;for(let i=0;i<r;++i){const o=e.morphTracks[i];n+=4+t.encode(o.name).length,n+=4,n+=4*o.frameNumbers.length+Mt.Padding(n,4),n+=4*o.frameNumbers.length+Mt.Padding(n,4)}n+=4,n+=4*e.propertyTrack.frameNumbers.length+Mt.Padding(n,4),n+=1*e.propertyTrack.frameNumbers.length+Mt.Padding(n,4),n+=4;const a=e.propertyTrack.ikBoneNames.length;for(let i=0;i<a;++i){const o=e.propertyTrack.ikBoneNames[i];n+=4+t.encode(o).length}n+=1*a*e.propertyTrack.frameNumbers.length,n+=4,n+=4*e.cameraTrack.frameNumbers.length+Mt.Padding(n,4),n+=12*e.cameraTrack.frameNumbers.length+Mt.Padding(n,4),n+=12*e.cameraTrack.frameNumbers.length,n+=12*e.cameraTrack.frameNumbers.length+Mt.Padding(n,4),n+=4*e.cameraTrack.frameNumbers.length,n+=4*e.cameraTrack.frameNumbers.length+Mt.Padding(n,4),n+=4*e.cameraTrack.frameNumbers.length,n+=4*e.cameraTrack.frameNumbers.length+Mt.Padding(n,4),n+=4*e.cameraTrack.frameNumbers.length}const i=new ArrayBuffer(n),o=new Mt(i);o.setUint8Array(t.encode("BVMD")),o.setInt8Array([2,0,0]);const r=e.boneTracks;o.setUint32(r.length);for(let e=0;e<r.length;++e){const t=r[e];o.setString(t.name),o.setUint32(t.frameNumbers.length),o.offset+=Mt.Padding(o.offset,4),o.setUint32Array(t.frameNumbers),o.offset+=Mt.Padding(o.offset,4),o.setFloat32Array(t.rotations),o.setUint8Array(t.rotationInterpolations)}const a=e.movableBoneTracks;o.setUint32(a.length);for(let e=0;e<a.length;++e){const t=a[e];o.setString(t.name),o.setUint32(t.frameNumbers.length),o.offset+=Mt.Padding(o.offset,4),o.setUint32Array(t.frameNumbers),o.offset+=Mt.Padding(o.offset,4),o.setFloat32Array(t.positions),o.setUint8Array(t.positionInterpolations),o.offset+=Mt.Padding(o.offset,4),o.setFloat32Array(t.rotations),o.setUint8Array(t.rotationInterpolations)}const s=e.morphTracks;o.setUint32(s.length);for(let e=0;e<s.length;++e){const t=s[e];o.setString(t.name),o.setUint32(t.frameNumbers.length),o.offset+=Mt.Padding(o.offset,4),o.setUint32Array(t.frameNumbers),o.offset+=Mt.Padding(o.offset,4),o.setFloat32Array(t.weights)}o.setUint32(e.propertyTrack.frameNumbers.length),o.setUint32(e.propertyTrack.ikBoneNames.length),o.offset+=Mt.Padding(o.offset,4),o.setUint32Array(e.propertyTrack.frameNumbers),o.setUint8Array(e.propertyTrack.visibles);const l=e.propertyTrack.ikBoneNames;for(let t=0;t<l.length;++t){const n=l[t];o.setString(n),o.setUint8Array(e.propertyTrack.getIkState(t))}return o.setUint32(e.cameraTrack.frameNumbers.length),o.offset+=Mt.Padding(o.offset,4),o.setUint32Array(e.cameraTrack.frameNumbers),o.offset+=Mt.Padding(o.offset,4),o.setFloat32Array(e.cameraTrack.positions),o.setUint8Array(e.cameraTrack.positionInterpolations),o.offset+=Mt.Padding(o.offset,4),o.setFloat32Array(e.cameraTrack.rotations),o.setUint8Array(e.cameraTrack.rotationInterpolations),o.offset+=Mt.Padding(o.offset,4),o.setFloat32Array(e.cameraTrack.distances),o.setUint8Array(e.cameraTrack.distanceInterpolations),o.offset+=Mt.Padding(o.offset,4),o.setFloat32Array(e.cameraTrack.fovs),o.setUint8Array(e.cameraTrack.fovInterpolations),i}}class xt{_scene;_loggingEnabled;log;warn;error;constructor(e){this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._scene=e}loadFromBuffer(e,t){const n=new x(t);if(n.initializeTextDecoder("utf-8"),"BVMD"!==n.getDecoderString(4,!1))throw new Te.LoadFileError("BVMD signature is not valid.");const i=[n.getInt8(),n.getInt8(),n.getInt8()];if(2!==i[0]||0!==i[1]||0!==i[2])throw new Te.LoadFileError(`BVMD version ${i[0]}.${i[1]}.${i[2]} is not supported.`);const o=n.getUint32(),r=new Array(o);for(let e=0;e<o;++e){const i=n.getDecoderString(n.getUint32(),!0),o=n.getUint32(),a=n.getPaddedArrayOffset(4,o),s=n.getPaddedArrayOffset(4,4*o),l=n.getPaddedArrayOffset(1,4*o),h=r[e]=new ot(i,o,t,a,s,l);n.isDeviceLittleEndian||(n.swap32Array(h.frameNumbers),n.swap32Array(h.rotations))}const a=n.getUint32(),s=new Array(a);for(let e=0;e<a;++e){const i=n.getDecoderString(n.getUint32(),!0),o=n.getUint32(),r=n.getPaddedArrayOffset(4,o),a=n.getPaddedArrayOffset(4,3*o),l=n.getPaddedArrayOffset(1,12*o),h=n.getPaddedArrayOffset(4,4*o),d=n.getPaddedArrayOffset(1,4*o),c=s[e]=new rt(i,o,t,r,a,l,h,d);n.isDeviceLittleEndian||(n.swap32Array(c.frameNumbers),n.swap32Array(c.positions),n.swap32Array(c.rotations))}const l=n.getUint32(),h=new Array(l);for(let e=0;e<l;++e){const i=n.getDecoderString(n.getUint32(),!0),o=n.getUint32(),r=n.getPaddedArrayOffset(4,o),a=n.getPaddedArrayOffset(4,o),s=h[e]=new at(i,o,t,r,a);n.isDeviceLittleEndian||(n.swap32Array(s.frameNumbers),n.swap32Array(s.weights))}const d=n.getUint32(),c=n.getUint32(),m=n.getPaddedArrayOffset(4,d),u=n.getPaddedArrayOffset(1,d),p=new Array(c),g=new Array(c);for(let e=0;e<c;++e)p[e]=n.getDecoderString(n.getUint32(),!0),g[e]=n.getPaddedArrayOffset(1,d);const f=new lt(d,p,t,m,u,g);n.isDeviceLittleEndian||n.swap32Array(f.frameNumbers);const _=n.getUint32(),b=n.getPaddedArrayOffset(4,_),y=n.getPaddedArrayOffset(4,3*_),A=n.getPaddedArrayOffset(1,12*_),M=n.getPaddedArrayOffset(4,3*_),T=n.getPaddedArrayOffset(1,4*_),w=n.getPaddedArrayOffset(4,_),v=n.getPaddedArrayOffset(1,4*_),I=n.getPaddedArrayOffset(4,_),B=n.getPaddedArrayOffset(1,4*_),P=new st(_,t,b,y,A,M,T,w,v,I,B);return n.isDeviceLittleEndian||(n.swap32Array(P.frameNumbers),n.swap32Array(P.positions),n.swap32Array(P.rotations),n.swap32Array(P.distances),n.swap32Array(P.fovs)),new bt(e,r,s,h,f,P)}load(e,t,n,i,o){return this._scene._loadFile(t,((t,i)=>{n(this.loadFromBuffer(e,t))}),i,!0,!0,o)}loadAsync(e,t,n){return new Promise(((i,o)=>{this.load(e,t,i,n,((e,t)=>o({request:e,exception:t})))}))}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){N.Logger.Log(e)}_logDisabled(){}_warnEnabled(e){N.Logger.Warn(e)}_warnDisabled(){}_errorEnabled(e){N.Logger.Error(e)}_errorDisabled(){}}class vt{static _Signature="Vocaloid Motion Data 0002";static SignatureBytes=30;static ModelNameBytes=20;static BoneKeyFrameBytes=111;static MorphKeyFrameBytes=23;static CameraKeyFrameBytes=61;static LightKeyFrameBytes=28;static SelfShadowKeyFrameBytes=9;static PropertyKeyFrameBytes=5;static PropertyKeyFrameIkStateBytes=21;dataDeserializer;boneKeyFrameCount;morphKeyFrameCount;cameraKeyFrameCount;lightKeyFrameCount;selfShadowKeyFrameCount;propertyKeyFrameCount;constructor(e,t,n,i,o,r,a){this.dataDeserializer=e,this.boneKeyFrameCount=t,this.morphKeyFrameCount=n,this.cameraKeyFrameCount=i,this.lightKeyFrameCount=o,this.selfShadowKeyFrameCount=r,this.propertyKeyFrameCount=a}static CheckedCreate(e,t=new w){const n=new x(e);if(n.initializeTextDecoder("shift-jis"),n.bytesAvailable<vt.SignatureBytes+vt.ModelNameBytes)return null;if(n.getSignatureString(this.SignatureBytes).substring(0,this._Signature.length)!==this._Signature)return null;n.offset+=vt.ModelNameBytes;let i=0,o=0,r=0,a=0,s=0,l=0;if(n.bytesAvailable<4)return null;if(i=n.getUint32(),n.bytesAvailable<i*vt.BoneKeyFrameBytes)return null;if(n.offset+=i*vt.BoneKeyFrameBytes,n.bytesAvailable<4)return null;if(o=n.getUint32(),n.bytesAvailable<o*vt.MorphKeyFrameBytes)return null;if(n.offset+=o*vt.MorphKeyFrameBytes,0!==n.bytesAvailable){if(n.bytesAvailable<4)return null;if(r=n.getUint32(),n.bytesAvailable<r*vt.CameraKeyFrameBytes)return null;if(n.offset+=r*vt.CameraKeyFrameBytes,n.bytesAvailable<4)return null;if(a=n.getUint32(),n.bytesAvailable<a*vt.LightKeyFrameBytes)return null;n.offset+=a*vt.LightKeyFrameBytes}if(0!==n.bytesAvailable){if(n.bytesAvailable<4)return null;if(s=n.getUint32(),n.bytesAvailable<s*vt.SelfShadowKeyFrameBytes)return null;n.offset+=s*vt.SelfShadowKeyFrameBytes}if(0!==n.bytesAvailable){if(n.bytesAvailable<4)return null;l=n.getUint32();for(let e=0;e<l;++e){if(n.bytesAvailable<vt.PropertyKeyFrameBytes)return null;if(n.offset+=vt.PropertyKeyFrameBytes,n.bytesAvailable<4)return null;const e=n.getUint32();if(n.bytesAvailable<e*vt.PropertyKeyFrameIkStateBytes)return null;n.offset+=e*vt.PropertyKeyFrameIkStateBytes}}return n.bytesAvailable>0&&t.warn(`There are ${n.bytesAvailable} bytes left after parsing`),n.offset=0,new vt(n,i,o,r,a,s,l)}}class It{propertyKeyFrames;_vmdData;constructor(e,t){this._vmdData=e,this.propertyKeyFrames=t}static Parse(e){const t=e.dataDeserializer,n=[];t.offset=vt.SignatureBytes+vt.ModelNameBytes+4+e.boneKeyFrameCount*vt.BoneKeyFrameBytes+4+e.morphKeyFrameCount*vt.MorphKeyFrameBytes+4+e.cameraKeyFrameCount*vt.CameraKeyFrameBytes+4+e.lightKeyFrameCount*vt.LightKeyFrameBytes+4+e.selfShadowKeyFrameCount*vt.SelfShadowKeyFrameBytes+4;const i=e.propertyKeyFrameCount;for(let e=0;e<i;++e){const e=t.getUint32(),i=0!==t.getUint8(),o=t.getUint32(),r=[];for(let e=0;e<o;++e){const e=t.getDecoderString(20,!0),n=0!==t.getUint8();r.push([e,n])}const a={frameNumber:e,visible:i,ikStates:r};n.push(a)}return new It(e,n)}static ParseFromBuffer(e){const t=vt.CheckedCreate(e);if(null===t)throw new Error("Invalid VMD data");return It.Parse(t)}get boneKeyFrames(){const e=vt.SignatureBytes+vt.ModelNameBytes+4;return new It.BoneKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.boneKeyFrameCount)}get morphKeyFrames(){const e=vt.SignatureBytes+vt.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*vt.BoneKeyFrameBytes+4;return new It.MorphKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.morphKeyFrameCount)}get cameraKeyFrames(){const e=vt.SignatureBytes+vt.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*vt.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*vt.MorphKeyFrameBytes+4;return new It.CameraKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.cameraKeyFrameCount)}get lightKeyFrames(){const e=vt.SignatureBytes+vt.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*vt.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*vt.MorphKeyFrameBytes+4+this._vmdData.cameraKeyFrameCount*vt.CameraKeyFrameBytes+4;return new It.LightKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.lightKeyFrameCount)}get selfShadowKeyFrames(){const e=vt.SignatureBytes+vt.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*vt.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*vt.MorphKeyFrameBytes+4+this._vmdData.cameraKeyFrameCount*vt.CameraKeyFrameBytes+4+this._vmdData.lightKeyFrameCount*vt.LightKeyFrameBytes+4;return new It.SelfShadowKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.selfShadowKeyFrameCount)}}!function(e){class t{_dataDeserializer;_startOffset;_length;constructor(e,t,n){this._dataDeserializer=e,this._startOffset=t,this._length=n}get length(){return this._length}}e.BufferArrayReader=t,e.BoneKeyFrames=class extends t{constructor(e,t,n){super(e,t,n)}get(e){const t=this._startOffset+e*vt.BoneKeyFrameBytes;return new n(this._dataDeserializer,t)}};class n{boneName;frameNumber;position;rotation;interpolation;constructor(e,t){e.offset=t,this.boneName=e.getDecoderString(15,!0),this.frameNumber=e.getUint32(),this.position=e.getFloat32Tuple(3),this.rotation=e.getFloat32Tuple(4),this.interpolation=new Uint8Array(64);for(let t=0;t<64;++t)this.interpolation[t]=e.getUint8()}}e.BoneKeyFrame=n,e.MorphKeyFrames=class extends t{constructor(e,t,n){super(e,t,n)}get(e){const t=this._startOffset+e*vt.MorphKeyFrameBytes;return new i(this._dataDeserializer,t)}};class i{morphName;frameNumber;weight;constructor(e,t){e.offset=t,this.morphName=e.getDecoderString(15,!0),this.frameNumber=e.getUint32(),this.weight=e.getFloat32()}}e.MorphKeyFrame=i,e.CameraKeyFrames=class extends t{constructor(e,t,n){super(e,t,n)}get(e){const t=this._startOffset+e*vt.CameraKeyFrameBytes;return new o(this._dataDeserializer,t)}};class o{frameNumber;distance;position;rotation;interpolation;fov;perspective;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.distance=e.getFloat32(),this.position=e.getFloat32Tuple(3),this.rotation=e.getFloat32Tuple(3),this.interpolation=new Uint8Array(24);for(let t=0;t<24;++t)this.interpolation[t]=e.getUint8();this.fov=e.getUint32(),this.perspective=0!==e.getUint8()}}e.CameraKeyFrame=o,e.LightKeyFrames=class extends t{constructor(e,t,n){super(e,t,n)}get(e){const t=this._startOffset+e*vt.LightKeyFrameBytes;return new r(this._dataDeserializer,t)}};class r{frameNumber;color;direction;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.color=e.getFloat32Tuple(3),this.direction=e.getFloat32Tuple(3)}}e.LightKeyFrame=r,e.SelfShadowKeyFrames=class extends t{constructor(e,t,n){super(e,t,n)}get(e){const t=this._startOffset+e*vt.SelfShadowKeyFrameBytes;return new a(this._dataDeserializer,t)}};class a{frameNumber;mode;distance;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.mode=e.getUint8(),this.distance=e.getFloat32()}}e.SelfShadowKeyFrame=a}(It||(It={}));class Bt{static _Signature="Vocaloid Pose Data file";constructor(){}static Parse(e,t=new w){if(!e.startsWith(Bt._Signature))throw new Error("VPD signature is not valid.");const n=[Bt._Signature.length];Bt._ConsumeStatement(e,n),Bt._ConsumeStatement(e,n);const i={},o={};for(;n[0]<e.length&&(n[0]=Bt._ConsumeEmpty(e,n[0]),!(e.length<=n[0]));){const r=Bt._ConsumeBeforeOpenBracket(e,n);if(r.startsWith("Bone")){const o=Bt._ConsumeBeforeLineEnding(e,n);let r,a;const s=Bt._ConsumeStatement(e,n),l=s.split(",");if(3!==l.length)t.warn(`Position components are not 3: ${s}`);else{const e=Number(l[0]),n=Number(l[1]),i=Number(l[2]);isNaN(e)||isNaN(n)||isNaN(e)?t.warn(`Invalid position: ${s}`):0===e&&0===n&&0===i||(r=[e,n,i])}const h=Bt._ConsumeStatement(e,n),d=h.split(",");if(4!==d.length)t.warn(`Rotation components are not 4: ${h}`);else{const e=Number(d[0]),n=Number(d[1]),i=Number(d[2]),o=Number(d[3]);isNaN(e)||isNaN(n)||isNaN(e)||isNaN(o)?t.warn(`Invalid rotation: ${h}`):a=[e,n,i,o]}void 0!==a&&(void 0!==i[o]&&t.warn(`Duplicate bone: ${o}. Use the last one.`),i[o]={position:r,rotation:a})}else if(r.startsWith("Morph")){const i=Bt._ConsumeBeforeLineEnding(e,n),r=Bt._ConsumeStatement(e,n),a=Number(r);isNaN(a)?t.warn(`Invalid weight: ${r}`):(void 0!==o[i]&&t.warn(`Duplicate morph: ${i}. Use the last one.`),o[i]=a)}else t.warn(`Unknown type: ${r}`);n[0]=Bt._ConsumeWhileCloseBracket(e,n[0])}return{bones:i,morphs:o}}static _ConsumeWhiteSpace(e,t){for(;t<e.length&&(" "===e[t]||"\t"===e[t]||"\r"===e[t]||"\n"===e[t]);)t+=1;return t}static _ConsumeLine(e,t){for(;t<e.length;){if("\r"===e[t]||"\n"===e[t]){t+=1;break}t+=1}return"\r"===e[t-1]&&"\n"===e[t]&&(t+=1),t}static _ConsumeEmpty(e,t){let n=t;for(;t<e.length&&(n=t,"/"===e[t=Bt._ConsumeWhiteSpace(e,t)]&&"/"===e[t+1]&&(t=Bt._ConsumeLine(e,t)),n!==t););return t}static _ConsumeWhileCloseBracket(e,t){for(;t<e.length;){if("}"===e[t]){t+=1;break}t+=1}return t}static _ConsumeStatement(e,t){let n=t[0],i="";for(;;)if(n=Bt._ConsumeWhiteSpace(e,n),"/"!==e[n]||"/"!==e[n+1]){if(e.length<=n)break;if(";"===e[n]){n+=1;break}i+=e[n],n+=1}else n=Bt._ConsumeLine(e,n);return t[0]=n,i}static _ConsumeBeforeLineEnding(e,t){const n=t[0];let i=t[0];for(;i<e.length&&"\r"!==e[i]&&"\n"!==e[i];)i+=1;return t[0]=i,e.substring(n,i)}static _ConsumeBeforeOpenBracket(e,t){let n=t[0],i="";for(;n<e.length;){if("{"===e[n]){n+=1;break}i+=e[n],n+=1}return t[0]=n,i}}function Pt(e,t,n){if(void 0===t[e.targetProperty])return void n?.warn(`Wrong target property ${e.targetProperty} for ${e.name} ${t.name}`);const i="rotationQuaternion"===e.targetProperty?c.Quaternion.FromRotationMatrix(t.getRestMatrix()):"position"===e.targetProperty?t.getRestMatrix().getTranslation():void 0;if(void 0===i)return void n?.warn(`Failed to get rest pose for ${e.name} ${e.targetProperty}`);const o=e.getKeys();switch(e.dataType){case ke.Animation.ANIMATIONTYPE_QUATERNION:{const e=i.clone().invertInPlace();for(let t=0;t<o.length;++t)e.multiplyToRef(o[t].value,o[t].value);break}case ke.Animation.ANIMATIONTYPE_VECTOR3:for(let e=0;e<o.length;++e)o[e].value.subtractInPlace(i);break;default:n?.warn("Animation data type is not supported")}}function Rt(e){const t=new ke.Animation(e.name,e.targetProperty,e.framePerSecond,e.dataType,e.loopMode);t.enableBlending=e.enableBlending,t.blendingSpeed=e.blendingSpeed;const n=e.getKeys();if(void 0!==n){const e=new Array(n.length);for(let t=0;t<n.length;t++){const i=e[t]={...n[t]};void 0!==i.value.clone&&(i.value=i.value.clone()),void 0!==i.inTangent&&void 0!==i.inTangent.clone&&(i.inTangent=i.inTangent.clone()),void 0!==i.outTangent&&void 0!==i.outTangent.clone&&(i.outTangent=i.outTangent.clone())}t.setKeys(e)}if(t._ranges){t._ranges={};for(const n in e._ranges){const i=e._ranges[n];i&&(t._ranges[n]=i.clone())}}return t}class Ct{_boneNameMap;_sourceSkeleton;_targetSkeleton;_sourceSkeletonTransformOffset;_sourceSkeletonAbsoluteMatrices;_targetBoneNameMap;_loggingEnabled;log;warn;error;constructor(){this._boneNameMap=null,this._sourceSkeleton=null,this._targetSkeleton=null,this._sourceSkeletonTransformOffset=null,this._sourceSkeletonAbsoluteMatrices=null,this._targetBoneNameMap=null,this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled}setBoneMap(e){return this._boneNameMap=e,this}setSourceSkeleton(e,t){return this._sourceSkeleton=e,void 0===t?this._sourceSkeletonTransformOffset=null:void 0!==t.getWorldMatrix?this._sourceSkeletonTransformOffset=t.computeWorldMatrix(!0).clone():this._sourceSkeletonTransformOffset=t.clone(),this._sourceSkeletonAbsoluteMatrices=null,this}setTargetSkeleton(e){return this._targetSkeleton=e,this._targetBoneNameMap=null,this}retargetAnimation(e,t={}){if(!this._isSkeletonAnimation(e))return this.warn("Animation is not skeleton animation. animation retargeting is aborted."),null;if(t.cloneAnimation??=!0,t.removeBoneRotationOffset??=!1,null===this._boneNameMap)throw new Error("Bone map is not set");if(null===this._sourceSkeleton)throw new Error("Source skeleton is not set");if(null===this._targetSkeleton)throw new Error("Target skeleton is not set");if(null===this._targetBoneNameMap){const e=this._targetBoneNameMap=new Map;{const t=this._targetSkeleton.bones;for(let n=0;n<t.length;++n){const i=t[n];e.set(i.name,i)}}}t.cloneAnimation&&(e=function(e,t){const n=new Ne.AnimationGroup(t||e.name,e._scene);for(const t of e.targetedAnimations)n.addTargetedAnimation(Rt(t.animation),t.target);return n}(e,e.name+"_retargeted")),this._removeScaleAnimation(e);const n=e.targetedAnimations;for(let e=0;e<n.length;++e)this._flattenAnimationTarget(n[e]);if(e.isAdditive||function(e,t,n){if(e.isAdditive)return void n?.warn("Animation group is already additive");const i=new Map;{const e=t.bones;for(let t=0;t<e.length;++t){const n=e[t],o=n.getTransformNode();null!==o&&i.set(o,n)}}const o=e.targetedAnimations;for(let e=0;e<o.length;++e){const t=o[e].animation,r=o[e].target,a=i.get(r);void 0===a&&o[e].target,void 0!==a?Pt(t,a):n?.warn(`Failed to find rest pose for ${t.name}`)}e.isAdditive=!0}(e,this._sourceSkeleton),void 0!==t.rotationOffsets){const n=new c.Quaternion,i=t.rotationOffsets,o=e.targetedAnimations;for(let e=0;e<o.length;++e){const t=o[e].target,r=o[e].animation.targetPropertyPath;if("rotationQuaternion"===r[r.length-1]){const r=i[t.name];if(void 0!==r){c.Quaternion.FromEulerAnglesToRef(r.x,r.y,r.z,n);const t=o[e].animation.getKeys();for(let e=0;e<t.length;++e){const i=t[e].value;n.multiplyToRef(i,i)}}}}}if(t.removeBoneRotationOffset){const t=new Map,i=new Map;{const e=this._sourceSkeleton.bones;for(let n=0;n<e.length;++n){const o=e[n],r=o.getTransformNode();null!==r&&t.set(r,o),i.set(o,n)}}const o=new Int32Array(n.length);for(let e=0;e<n.length;++e){const r=n[e].target;let a=t.get(r);void 0===a&&(a=r);const s=i.get(a);void 0===s?(o[e]=-1,this.warn(`${a.name} is not found in source skeleton`)):o[e]=s}null===this._sourceSkeletonAbsoluteMatrices&&(this._sourceSkeletonAbsoluteMatrices=this._computeSkeletonAbsoluteMatrices(this._sourceSkeleton,this._sourceSkeletonTransformOffset,i)),this._removeBoneRotationOffset(e,o,this._sourceSkeleton,this._sourceSkeletonAbsoluteMatrices,i)}return this._retargetAnimationInternal(e,this._boneNameMap,this._targetBoneNameMap),e.isAdditive=!0,e.weight=1,e}_isSkeletonAnimation(e){const t=e.targetedAnimations;for(let e=0;e<t.length;++e){const n=t[e].animation,i=n.targetPropertyPath[n.targetPropertyPath.length-1];if("position"!==i&&"rotationQuaternion"!==i&&"scaling"!==i)return!1}return!0}static _Stack=[];_computeSkeletonAbsoluteMatrices(e,t,n){const i=e.bones,o=Ct._Stack;o.length=0;for(let e=0;e<i.length;++e){const t=i[e];null===t.getParent()&&o.push(t)}null===t&&(t=c.Matrix.Identity());const r=new Array(i.length);for(;o.length>0;){const e=o.pop(),i=e.getParent(),a=null===i?t:r[n.get(i)];r[n.get(e)]=e.getRestMatrix().multiply(a);const s=e.getChildren();for(let e=0;e<s.length;++e)o.push(s[e])}return r}_removeScaleAnimation(e){const t=[],n=e.targetedAnimations;for(let e=0;e<n.length;++e){const i=n[e];i.target&&("scaling"===i.animation.targetProperty&&t.push(e))}for(let e=0,i=0;e<n.length;++e)e!==t[i]?n[e-i]=n[e]:i+=1;n.length-=t.length}_getFinalTarget(e,t){if(t.length>1){let n=e[t[0]];for(let e=1;e<t.length-1;e++)n=n[t[e]];return n}return e}_flattenAnimationTarget(e){const t=e.target,n=e.animation.targetPropertyPath,i=this._getFinalTarget(t,n);e.target=i,n[0]=e.animation.targetPropertyPath[e.animation.targetPropertyPath.length-1],n.length=1,e.animation.targetProperty=e.animation.targetPropertyPath[0]}_removeBoneRotationOffset(e,t,n,i,o){const r=e.targetedAnimations,a=new c.Matrix,s=new c.Matrix,l=this._sourceSkeletonTransformOffset;for(let e=0;e<r.length;++e){const h=t[e];if(-1===h)continue;const d=r[e].animation,m=d.targetProperty,u=n.bones[h];if("rotationQuaternion"===m){const e=i[h];e.invertToRef(s);const t=d.getKeys();for(let n=0;n<t.length;++n){const i=t[n].value;s.multiplyToRef(c.Matrix.FromQuaternionToRef(i,a),a),a.multiplyToRef(e,a),c.Quaternion.FromRotationMatrixToRef(a,i)}}else if("position"===m){const e=u.getParent(),t=null!==e?o.get(e):-1,n=-1!==t?i[t]:l;if(null!==n){const e=d.getKeys();for(let t=0;t<e.length;++t){const i=e[t].value;c.Vector3.TransformNormalToRef(i,n,i)}}}else this.warn(`Unsupported target property: ${m}`)}}_retargetAnimationInternal(e,t,n){const i=[],o=e.targetedAnimations;for(let e=0;e<o.length;++e){const r=o[e];if(!r.target){i.push(e),this.warn(`Animation target is null. Animation name: ${r.animation.name}`);continue}const a=t[r.target.name];if(void 0!==a){const t=n.get(a);void 0!==t?r.target=t:(i.push(e),this.warn(`Bone not found. Bone name: ${r.target.name}`))}else i.push(e),this.warn(`Bone not found. Bone name: ${r.target.name}`)}for(let e=0,t=0;e<o.length;++e)e!==i[t]?o[e-t]=o[e]:t+=1;o.length-=i.length}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){N.Logger.Log(e)}_logDisabled(){}_warnEnabled(e){N.Logger.Warn(e)}_warnDisabled(){}_errorEnabled(e){N.Logger.Error(e)}_errorDisabled(){}}const Ot={hips:"mixamorig:Hips",spine:"mixamorig:Spine",chest:"mixamorig:Spine2",neck:"mixamorig:Neck",head:"mixamorig:Head",leftShoulder:"mixamorig:LeftShoulder",leftUpperArm:"mixamorig:LeftArm",leftLowerArm:"mixamorig:LeftForeArm",leftHand:"mixamorig:LeftHand",rightShoulder:"mixamorig:RightShoulder",rightUpperArm:"mixamorig:RightArm",rightLowerArm:"mixamorig:RightForeArm",rightHand:"mixamorig:RightHand",leftUpperLeg:"mixamorig:LeftUpLeg",leftLowerLeg:"mixamorig:LeftLeg",leftFoot:"mixamorig:LeftFoot",leftToes:"mixamorig:LeftToeBase",rightUpperLeg:"mixamorig:RightUpLeg",rightLowerLeg:"mixamorig:RightLeg",rightFoot:"mixamorig:RightFoot",rightToes:"mixamorig:RightToeBase",leftEye:void 0,rightEye:void 0,leftThumbProximal:"mixamorig:LeftHandThumb1",leftThumbIntermediate:"mixamorig:LeftHandThumb2",leftThumbDistal:"mixamorig:LeftHandThumb3",leftIndexProximal:"mixamorig:LeftHandIndex1",leftIndexIntermediate:"mixamorig:LeftHandIndex2",leftIndexDistal:"mixamorig:LeftHandIndex3",leftMiddleProximal:"mixamorig:LeftHandMiddle1",leftMiddleIntermediate:"mixamorig:LeftHandMiddle2",leftMiddleDistal:"mixamorig:LeftHandMiddle3",leftRingProximal:"mixamorig:LeftHandRing1",leftRingIntermediate:"mixamorig:LeftHandRing2",leftRingDistal:"mixamorig:LeftHandRing3",leftLittleProximal:"mixamorig:LeftHandPinky1",leftLittleIntermediate:"mixamorig:LeftHandPinky2",leftLittleDistal:"mixamorig:LeftHandPinky3",rightThumbProximal:"mixamorig:RightHandThumb1",rightThumbIntermediate:"mixamorig:RightHandThumb2",rightThumbDistal:"mixamorig:RightHandThumb3",rightIndexProximal:"mixamorig:RightHandIndex1",rightIndexIntermediate:"mixamorig:RightHandIndex2",rightIndexDistal:"mixamorig:RightHandIndex3",rightMiddleProximal:"mixamorig:RightHandMiddle1",rightMiddleIntermediate:"mixamorig:RightHandMiddle2",rightMiddleDistal:"mixamorig:RightHandMiddle3",rightRingProximal:"mixamorig:RightHandRing1",rightRingIntermediate:"mixamorig:RightHandRing2",rightRingDistal:"mixamorig:RightHandRing3",rightLittleProximal:"mixamorig:RightHandPinky1",rightLittleIntermediate:"mixamorig:RightHandPinky2",rightLittleDistal:"mixamorig:RightHandPinky3"},Ft={hips:"hips",spine:"spine",chest:"chest",neck:"neck",head:"head",leftShoulder:"leftShoulder",leftUpperArm:"leftUpperArm",leftLowerArm:"leftLowerArm",leftHand:"leftHand",rightShoulder:"rightShoulder",rightUpperArm:"rightUpperArm",rightLowerArm:"rightLowerArm",rightHand:"rightHand",leftUpperLeg:"leftUpperLeg",leftLowerLeg:"leftLowerLeg",leftFoot:"leftFoot",leftToes:"leftToes",rightUpperLeg:"rightUpperLeg",rightLowerLeg:"rightLowerLeg",rightFoot:"rightFoot",rightToes:"rightToes",leftEye:"leftEye",rightEye:"rightEye",leftThumbProximal:"leftThumbProximal",leftThumbIntermediate:"leftThumbIntermediate",leftThumbDistal:"leftThumbDistal",leftIndexProximal:"leftIndexProximal",leftIndexIntermediate:"leftIndexIntermediate",leftIndexDistal:"leftIndexDistal",leftMiddleProximal:"leftMiddleProximal",leftMiddleIntermediate:"leftMiddleIntermediate",leftMiddleDistal:"leftMiddleDistal",leftRingProximal:"leftRingProximal",leftRingIntermediate:"leftRingIntermediate",leftRingDistal:"leftRingDistal",leftLittleProximal:"leftLittleProximal",leftLittleIntermediate:"leftLittleIntermediate",leftLittleDistal:"leftLittleDistal",rightThumbProximal:"rightThumbProximal",rightThumbIntermediate:"rightThumbIntermediate",rightThumbDistal:"rightThumbDistal",rightIndexProximal:"rightIndexProximal",rightIndexIntermediate:"rightIndexIntermediate",rightIndexDistal:"rightIndexDistal",rightMiddleProximal:"rightMiddleProximal",rightMiddleIntermediate:"rightMiddleIntermediate",rightMiddleDistal:"rightMiddleDistal",rightRingProximal:"rightRingProximal",rightRingIntermediate:"rightRingIntermediate",rightRingDistal:"rightRingDistal",rightLittleProximal:"rightLittleProximal",rightLittleIntermediate:"rightLittleIntermediate",rightLittleDistal:"rightLittleDistal"};class St{static _PropertyMap={hips:"センター",spine:"上半身",chest:"上半身2",neck:"首",head:"頭",leftShoulder:"左肩",leftUpperArm:"左腕",leftLowerArm:"左ひじ",leftHand:"左手首",rightShoulder:"右肩",rightUpperArm:"右腕",rightLowerArm:"右ひじ",rightHand:"右手首",leftUpperLeg:"左足",leftLowerLeg:"左ひざ",leftFoot:"左足首",leftToes:"左つま先",rightUpperLeg:"右足",rightLowerLeg:"右ひざ",rightFoot:"右足首",rightToes:"右つま先",leftEye:"左目",rightEye:"右目",leftThumbProximal:"左親指０",leftThumbIntermediate:"左親指１",leftThumbDistal:"左親指２",leftIndexProximal:"左人指１",leftIndexIntermediate:"左人指２",leftIndexDistal:"左人指３",leftMiddleProximal:"左中指１",leftMiddleIntermediate:"左中指２",leftMiddleDistal:"左中指３",leftRingProximal:"左薬指１",leftRingIntermediate:"左薬指２",leftRingDistal:"左薬指３",leftLittleProximal:"左小指１",leftLittleIntermediate:"左小指２",leftLittleDistal:"左小指３",rightThumbProximal:"右親指０",rightThumbIntermediate:"右親指１",rightThumbDistal:"右親指２",rightIndexProximal:"右人指１",rightIndexIntermediate:"右人指２",rightIndexDistal:"右人指３",rightMiddleProximal:"右中指１",rightMiddleIntermediate:"右中指２",rightMiddleDistal:"右中指３",rightRingProximal:"右薬指１",rightRingIntermediate:"右薬指２",rightRingDistal:"右薬指３",rightLittleProximal:"右小指１",rightLittleIntermediate:"右小指２",rightLittleDistal:"右小指３"};static _PropertyKeys=Object.keys(St._PropertyMap);boneMap;constructor(e){const t=this.boneMap={},n=St._PropertyMap,i=St._PropertyKeys;for(let o=0,r=i.length;o<r;++o){const r=i[o],a=e[r],s=n[r];void 0!==a&&void 0!==s&&(t[a]=s)}}}class Et{_scene;_loggingEnabled;log;warn;error;constructor(e){this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._scene=e}loadFromVmdObject(e,t,n,i){this.loadFromVmdObjectAsync(e,t,i).then(n)}async loadFromVmdObjectAsync(e,t,n){Array.isArray(t)||(t=[t]);let i=0,o=0,r=0,a=0;for(let e=0;e<t.length;++e){const n=t[e];i+=n.boneKeyFrames.length,o+=n.morphKeyFrames.length,r+=n.propertyKeyFrames.length,a+=n.cameraKeyFrames.length}const s={lengthComputable:!0,loaded:0,total:i+o+r+a};let l=0,h=performance.now();const d=[];{const e=new Map,i=[],o=[],r=[];for(let e=0;e<t.length;++e){const n=t[e].boneKeyFrames,i=n.length;for(let e=0;e<i;++e)r.push(n.get(e))}100<performance.now()-h&&(await R.Tools.DelayAsync(0),h=performance.now());const a=r.length;for(let t=0;t<a;++t){const n=r[t].boneName;let a=e.get(n);void 0===a&&(a=e.size,e.set(n,a),i.push(0),o.push(n)),i[a]+=1}r.sort(((e,t)=>e.frameNumber-t.frameNumber));for(let t=0;t<e.size;++t)d.push(new rt(o[t],i[t]));100<performance.now()-h&&(await R.Tools.DelayAsync(0),h=performance.now());const c=new Uint32Array(e.size);for(let t=0;t<a;++t){const i=r[t],o=e.get(i.boneName),a=d[o],m=c[o],u=i.interpolation;a.frameNumbers[m]=i.frameNumber;const p=a.positions,g=i.position;p[3*m+0]=g[0],p[3*m+1]=g[1],p[3*m+2]=g[2];const f=a.positionInterpolations;f[12*m+0]=u[0],f[12*m+1]=u[8],f[12*m+2]=u[4],f[12*m+3]=u[12],f[12*m+4]=u[16],f[12*m+5]=u[24],f[12*m+6]=u[20],f[12*m+7]=u[28],f[12*m+8]=u[32],f[12*m+9]=u[40],f[12*m+10]=u[36],f[12*m+11]=u[44];const _=a.rotations,b=i.rotation;_[4*m+0]=b[0],_[4*m+1]=b[1],_[4*m+2]=b[2],_[4*m+3]=b[3];const y=a.rotationInterpolations;y[4*m+0]=u[48],y[4*m+1]=u[56],y[4*m+2]=u[52],y[4*m+3]=u[60],c[o]+=1,t%1e3==0&&100<performance.now()-h&&(s.loaded=l+t,n?.({...s}),await R.Tools.DelayAsync(0),h=performance.now())}}const c=[],m=[];for(let e=0;e<d.length;++e){const t=d[e];let n=!0;for(let e=0;e<t.frameNumbers.length;++e){const i=t.positions;if(0!==i[3*e+0]||0!==i[3*e+1]||0!==i[3*e+2]){n=!1;break}const o=t.rotations;if(0!==o[4*e+0]||0!==o[4*e+1]||0!==o[4*e+2]||1!==o[4*e+3]){n=!1;break}}if(n)continue;let i=!1;for(let e=0;e<t.positions.length;++e)if(0!==t.positions[e]){i=!0;break}if(i)m.push(t);else{const e=new ot(t.name,t.frameNumbers.length);e.frameNumbers.set(t.frameNumbers),e.rotations.set(t.rotations),e.rotationInterpolations.set(t.rotationInterpolations),c.push(e)}}if(d.length=0,1<t.length){const e=new Int32Array(c.length).fill(-1);for(let t=0;t<c.length;++t){const n=c[t].frameNumbers;let i=0,o=n[0];for(let e=1;e<=n.length;++e){const t=n[e];o!==t&&(i+=1,o=t)}n.length!==i&&(e[t]=i)}for(let t=0;t<c.length;++t){const n=e[t];if(-1===n)continue;const i=c[t],o=i.frameNumbers,r=i.rotations,a=i.rotationInterpolations,s=new ot(i.name,n);let l=0,h=o[0];for(let e=1;e<=o.length;++e){const t=o[e];if(h!==t){const n=e-1;s.frameNumbers[l]=h;const i=s.rotations;i[4*l+0]=r[4*n+0],i[4*l+1]=r[4*n+1],i[4*l+2]=r[4*n+2],i[4*l+3]=r[4*n+3];const o=s.rotationInterpolations;o[4*l+0]=a[4*n+0],o[4*l+1]=a[4*n+1],o[4*l+2]=a[4*n+2],o[4*l+3]=a[4*n+3],l+=1,h=t}}c[t]=s}const t=new Int32Array(m.length).fill(-1);for(let e=0;e<m.length;++e){const n=m[e].frameNumbers;let i=0,o=n[0];for(let e=1;e<=n.length;++e){const t=n[e];o!==t&&(i+=1,o=t)}n.length!==i&&(t[e]=i)}for(let e=0;e<m.length;++e){const n=t[e];if(-1===n)continue;const i=m[e],o=i.frameNumbers,r=i.positions,a=i.positionInterpolations,s=i.rotations,l=i.rotationInterpolations,h=new rt(i.name,n);let d=0,c=o[0];for(let e=1;e<=o.length;++e){const t=o[e];if(c!==t){const n=e-1;h.frameNumbers[d]=c;const i=h.positions;i[3*d+0]=r[3*n+0],i[3*d+1]=r[3*n+1],i[3*d+2]=r[3*n+2];const o=h.positionInterpolations;o[12*d+0]=a[12*n+0],o[12*d+1]=a[12*n+1],o[12*d+2]=a[12*n+2],o[12*d+3]=a[12*n+3],o[12*d+4]=a[12*n+4],o[12*d+5]=a[12*n+5],o[12*d+6]=a[12*n+6],o[12*d+7]=a[12*n+7],o[12*d+8]=a[12*n+8],o[12*d+9]=a[12*n+9],o[12*d+10]=a[12*n+10],o[12*d+11]=a[12*n+11];const m=h.rotations;m[4*d+0]=s[4*n+0],m[4*d+1]=s[4*n+1],m[4*d+2]=s[4*n+2],m[4*d+3]=s[4*n+3];const u=h.rotationInterpolations;u[4*d+0]=l[4*n+0],u[4*d+1]=l[4*n+1],u[4*d+2]=l[4*n+2],u[4*d+3]=l[4*n+3],d+=1,c=t}}m[e]=h}}s.loaded=l+i,n?.({...s}),l+=i;const u=[];{const e=new Map,i=[],o=[],r=[];for(let e=0;e<t.length;++e){const n=t[e].morphKeyFrames,i=n.length;for(let e=0;e<i;++e)r.push(n.get(e))}100<performance.now()-h&&(await R.Tools.DelayAsync(0),h=performance.now());const a=r.length;for(let t=0;t<a;++t){const n=r[t].morphName;let a=e.get(n);void 0===a&&(a=e.size,e.set(n,a),i.push(0),o.push(n)),i[a]+=1}r.sort(((e,t)=>e.frameNumber-t.frameNumber));for(let t=0;t<e.size;++t)u.push(new at(o[t],i[t]));100<performance.now()-h&&(await R.Tools.DelayAsync(0),h=performance.now());const d=new Uint32Array(e.size);for(let t=0;t<a;++t){const i=r[t],o=e.get(i.morphName),a=u[o],c=d[o];a.frameNumbers[c]=i.frameNumber,a.weights[c]=i.weight,d[o]+=1,t%1e3==0&&100<performance.now()-h&&(s.loaded=l+t,n?.({...s}),await R.Tools.DelayAsync(0),h=performance.now())}}const p=[];for(let e=0;e<u.length;++e){const t=u[e];let n=!0;for(let e=0;e<t.weights.length;++e)if(0!==t.weights[e]){n=!1;break}n||p.push(t)}if(u.length=0,1<t.length){const e=new Int32Array(p.length).fill(-1);for(let t=0;t<p.length;++t){const n=p[t].frameNumbers;let i=0,o=n[0];for(let e=1;e<=n.length;++e){const t=n[e];o!==t&&(i+=1,o=t)}n.length!==i&&(e[t]=i)}for(let t=0;t<p.length;++t){const n=e[t];if(-1===n)continue;const i=p[t],o=i.frameNumbers,r=i.weights,a=new at(i.name,n);let s=0,l=o[0];for(let e=1;e<=o.length;++e){const t=o[e];l!==t&&(a.frameNumbers[s]=l,a.weights[s]=r[e-1],s+=1,l=t)}p[t]=a}}s.loaded=l+o,n?.({...s}),l+=o;const g=[];for(let e=0;e<t.length;++e){const n=t[e].propertyKeyFrames;for(let e=0;e<n.length;++e)g.push(n[e])}let f;if(g.sort(((e,t)=>e.frameNumber-t.frameNumber)),1<t.length)f=g;else{f=[];let e=g[0]?.frameNumber;for(let t=1;t<=g.length;++t){const n=g[t]?.frameNumber;e!==n&&(f.push(g[t-1]),e=n)}}const _=new Set;for(let e=0;e<t.length;++e){const n=t[e].propertyKeyFrames;for(let e=0;e<n.length;++e){const t=n[e];for(let e=0;e<t.ikStates.length;++e)_.add(t.ikStates[e][0])}}const b=new Array(_.size),y=new Map;{let e=0;for(const t of _)y.set(t,e),b[e]=t,e+=1}const A=new lt(f.length,b);{const e=new Uint8Array(_.size);for(let t=0;t<f.length;++t){const n=f[t];A.frameNumbers[t]=n.frameNumber,A.visibles[t]=n.visible?1:0;const i=n.ikStates;e.fill(0);for(let n=0;n<i.length;++n){const o=i[n],r=y.get(o[0]);A.getIkState(r)[t]=o[1]?1:0,e[r]=1}for(let n=0;n<e.length;++n)if(0===e[n]){const e=A.getIkState(n)[t-1];A.getIkState(n)[t]=void 0===e?0:e}}}s.loaded=l+r,n?.({...s}),l+=r;const M=[];for(let e=0;e<t.length;++e){const n=t[e].cameraKeyFrames;for(let e=0;e<n.length;++e)M.push(n.get(e))}let T;if(M.sort(((e,t)=>e.frameNumber-t.frameNumber)),1<t.length)T=M;else{T=[];let e=M[0]?.frameNumber;for(let t=1;t<=M.length;++t){const n=M[t]?.frameNumber;e!==n&&(T.push(M[t-1]),e=n)}}const w=new st(T.length);for(let e=0;e<T.length;++e){const t=T[e],i=t.interpolation;w.frameNumbers[e]=t.frameNumber;const o=w.positions,r=t.position;o[3*e+0]=r[0],o[3*e+1]=r[1],o[3*e+2]=r[2];const a=w.positionInterpolations;a[12*e+0]=i[0],a[12*e+1]=i[1],a[12*e+2]=i[2],a[12*e+3]=i[3],a[12*e+4]=i[4],a[12*e+5]=i[5],a[12*e+6]=i[6],a[12*e+7]=i[7],a[12*e+8]=i[8],a[12*e+9]=i[9],a[12*e+10]=i[10],a[12*e+11]=i[11];const d=w.rotations,c=t.rotation;d[3*e+0]=c[0],d[3*e+1]=c[1],d[3*e+2]=c[2];const m=w.rotationInterpolations;m[4*e+0]=i[12],m[4*e+1]=i[13],m[4*e+2]=i[14],m[4*e+3]=i[15],w.distances[e]=t.distance;const u=w.distanceInterpolations;u[4*e+0]=i[16],u[4*e+1]=i[17],u[4*e+2]=i[18],u[4*e+3]=i[19],w.fovs[e]=t.fov;const p=w.fovInterpolations;p[4*e+0]=i[20],p[4*e+1]=i[21],p[4*e+2]=i[22],p[4*e+3]=i[23],e%1e3==0&&100<performance.now()-h&&(s.loaded=l+e,n?.({...s}),await R.Tools.DelayAsync(0),h=performance.now())}return s.loaded=l+a,n?.({...s}),l+=a,new bt(e,c,m,p,A,w)}loadFromVmdData(e,t,n,i){Array.isArray(t)||(t=[t]);const o=[];for(let e=0;e<t.length;++e)o.push(It.Parse(t[e]));this.loadFromVmdObject(e,o,n,i)}loadFromVmdDataAsync(e,t,n){return new Promise((i=>{this.loadFromVmdData(e,t,i,n)}))}loadFromBuffer(e,t,n,i,o){Array.isArray(t)||(t=[t]);const r=[];for(let e=0;e<t.length;++e){const n=vt.CheckedCreate(t[e]);if(null===n)return void o?.(new Error("VMD data validation failed."));r.push(n)}this.loadFromVmdData(e,r,n,i)}loadFromBufferAsync(e,t,n){return new Promise(((i,o)=>{this.loadFromBuffer(e,t,i,n,o)}))}load(e,t,n,i,o){Array.isArray(t)||(t=[t]);const r=this._scene,a=[],s=[];for(let l=0;l<t.length;++l){const h=t[l];s.push(r._loadFile(h,((r,s)=>{a.push(r),a.length===t.length&&this.loadFromBuffer(e,a,n,i,(e=>{o?.(void 0,e)}))}),i,!0,!0,o))}return 1===t.length?s[0]:s}loadAsync(e,t,n){return new Promise(((i,o)=>{this.load(e,t,i,n,((e,t)=>o({request:e,exception:t})))}))}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){N.Logger.Log(e)}_logDisabled(){}_warnEnabled(e){N.Logger.Warn(e)}_warnDisabled(){}_errorEnabled(e){N.Logger.Error(e)}_errorDisabled(){}}class kt{_scene;_textDecoder;_loggingEnabled;log;warn;error;constructor(e){this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._scene=e,this._textDecoder=new TextDecoder("shift_jis")}loadFromVpdObject(e,t){const n=t.bones,i=Object.keys(n);let o=0;for(let e=0;e<i.length;e++)void 0!==n[i[e]].position&&(o+=1);const r=new Array(i.length-o),a=new Array(o);let s=0,l=0;for(let e=0;e<i.length;e++){const t=i[e],o=n[t];if(void 0===o.position){const e=r[s]=new ot(t,1);e.rotations[0]=o.rotation[0],e.rotations[1]=o.rotation[1],e.rotations[2]=o.rotation[2],e.rotations[3]=o.rotation[3],s+=1}else{const e=a[l]=new rt(t,1);e.positions[0]=o.position[0],e.positions[1]=o.position[1],e.positions[2]=o.position[2],e.rotations[0]=o.rotation[0],e.rotations[1]=o.rotation[1],e.rotations[2]=o.rotation[2],e.rotations[3]=o.rotation[3],l+=1}}const h=t.morphs,d=Object.keys(h),c=new Array(d.length);for(let e=0;e<d.length;e++){const t=d[e];(c[e]=new at(t,1)).weights[0]=h[t]}return new bt(e,r,a,c,new lt(0,[]),new st(0))}loadFromBuffer(e,t){const n=this._textDecoder.decode(t),i=Bt.Parse(n,this);return this.loadFromVpdObject(e,i)}load(e,t,n,i,o){return this._scene._loadFile(t,(t=>n(this.loadFromBuffer(e,t))),i,!0,!0,o)}loadAsync(e,t,n){return new Promise(((i,o)=>{this.load(e,t,i,n,((e,t)=>o({request:e,exception:t})))}))}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){N.Logger.Log(e)}_logDisabled(){}_warnEnabled(e){N.Logger.Warn(e)}_warnDisabled(){}_errorEnabled(e){N.Logger.Error(e)}_errorDisabled(){}}class Nt{onLoadErrorObservable;onDurationChangedObservable;onPlaybackRateChangedObservable;onMuteStateChangedObservable;onPlayObservable;onPauseObservable;onSeekObservable;_audio;_duration;_playbackRate;_isVirtualPlay;_virtualStartTime;_virtualPaused;_virtualPauseCurrentTime;_metadataLoaded;_bindedDispose;_disposeObservableObject;constructor(e){this.onLoadErrorObservable=new V.Observable,this.onDurationChangedObservable=new V.Observable,this.onPlaybackRateChangedObservable=new V.Observable,this.onMuteStateChangedObservable=new V.Observable,this.onPlayObservable=new V.Observable,this.onPauseObservable=new V.Observable,this.onSeekObservable=new V.Observable;const t=this._audio=new Audio;t.loop=!1,t.autoplay=!1,this._duration=0,this._playbackRate=1,this._isVirtualPlay=!1,this._virtualStartTime=0,this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this._metadataLoaded=!1,t.ondurationchange=this._onDurationChanged,t.onerror=this._onLoadError,t.onplaying=this._onPlay,t.onpause=this._onPause,t.onseeked=this._onSeek,this._bindedDispose=this.dispose.bind(this),this._disposeObservableObject=e,null!==this._disposeObservableObject&&this._disposeObservableObject.onDisposeObservable.add(this._bindedDispose)}_onDurationChanged=()=>{this._duration=this._audio.duration,this._isVirtualPlay&&(this._isVirtualPlay=!1,this.onMuteStateChangedObservable.notifyObservers()),this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this._metadataLoaded=!0,this.onDurationChangedObservable.notifyObservers()};_onLoadError=()=>{this._duration=0,this._isVirtualPlay&&(this._isVirtualPlay=!1,this.onMuteStateChangedObservable.notifyObservers()),this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this._metadataLoaded=!1,this.onLoadErrorObservable.notifyObservers(),this.onDurationChangedObservable.notifyObservers()};_onPlay=()=>{this._isVirtualPlay||(this._audio.playbackRate=this._playbackRate),this.onPlayObservable.notifyObservers()};_onPause=()=>{this._isVirtualPlay?this._virtualPaused&&this.onPauseObservable.notifyObservers():this.onPauseObservable.notifyObservers()};_ignoreSeekedEventOnce=!1;_onSeek=()=>{this._ignoreSeekedEventOnce?this._ignoreSeekedEventOnce=!1:this.onSeekObservable.notifyObservers()};get duration(){return this._duration}get currentTime(){if(this._isVirtualPlay){if(this._virtualPaused)return this._virtualPauseCurrentTime;{const e=(performance.now()/1e3-this._virtualStartTime)*this._playbackRate;return e>this._duration?(this._virtualPaused=!0,this._virtualPauseCurrentTime=this._duration,this._onPause(),this._virtualPauseCurrentTime):e}}return this._audio.currentTime}set currentTime(e){this._isVirtualPlay?(this._virtualPaused?this._virtualPauseCurrentTime=e:this._virtualStartTime=performance.now()/1e3-e/this._playbackRate,this._onSeek()):this._audio.currentTime=e}_setCurrentTimeWithoutNotify(e){this._isVirtualPlay?this._virtualPaused?this._virtualPauseCurrentTime=e:this._virtualStartTime=performance.now()/1e3-e/this._playbackRate:(this._ignoreSeekedEventOnce=!0,this._audio.currentTime=e)}get volume(){return this._audio.volume}set volume(e){this._audio.volume=e}get muted(){return this._isVirtualPlay}mute(){this._isVirtualPlay||(this._isVirtualPlay=!0,this._virtualStartTime=performance.now()/1e3-this._audio.currentTime/this._playbackRate,this._virtualPaused=this._audio.paused,this._virtualPauseCurrentTime=this._audio.currentTime,this._audio.pause(),this.onMuteStateChangedObservable.notifyObservers())}async unmute(){if(!this._isVirtualPlay)return!1;let e=!1;if(this._ignoreSeekedEventOnce=!0,this._virtualPaused)this._audio.currentTime=this._virtualPauseCurrentTime;else{this._audio.currentTime=(performance.now()/1e3-this._virtualStartTime)*this._playbackRate;try{await this._audio.play(),this._audio.playbackRate=this._playbackRate}catch(t){if(!(t instanceof DOMException&&"NotAllowedError"===t.name))throw t;e=!0}}return!e&&(this._isVirtualPlay=!1,this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this.onMuteStateChangedObservable.notifyObservers(),!0)}get playbackRate(){return this._playbackRate}set playbackRate(e){this._setPlaybackRateWithoutNotify(e),this.onPlaybackRateChangedObservable.notifyObservers()}_setPlaybackRateWithoutNotify(e){if(this._isVirtualPlay&&!this._virtualPaused){const t=performance.now()/1e3,n=(t-this._virtualStartTime)*this._playbackRate;this._virtualStartTime=t-n/e}this._playbackRate=e,this._audio.playbackRate=e}get preservesPitch(){return this._audio.preservesPitch}set preservesPitch(e){this._audio.preservesPitch=e}get paused(){return this._isVirtualPlay?this._virtualPaused:this._audio.paused}get source(){return this._audio.src}set source(e){e!==this._audio.src&&(this._audio.src=e,this._metadataLoaded=!1,this._isVirtualPlay&&(this._isVirtualPlay=!1,this.onMuteStateChangedObservable.notifyObservers()),this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this._audio.load())}get metadataLoaded(){return this._metadataLoaded}async _virtualPlay(){this._metadataLoaded?(this._virtualPaused&&(this._virtualStartTime=performance.now()/1e3-this._virtualPauseCurrentTime/this._playbackRate,this._virtualPaused=!1),this._isVirtualPlay||(this._isVirtualPlay=!0,this.onMuteStateChangedObservable.notifyObservers()),this._onPlay()):await new Promise(((e,t)=>{const n=()=>{this._virtualPaused&&(this._virtualStartTime=performance.now()/1e3-this._virtualPauseCurrentTime/this._playbackRate,this._virtualPaused=!1),this._isVirtualPlay||(this._isVirtualPlay=!0,this.onMuteStateChangedObservable.notifyObservers()),this._onPlay(),this.onLoadErrorObservable.removeCallback(i),e()},i=()=>{this.onDurationChangedObservable.removeCallback(n),t(new DOMException("The media resource indicated by the src attribute or assigned media provider object was not suitable.","NotSupportedError"))};this.onDurationChangedObservable.addOnce(n),this.onLoadErrorObservable.addOnce(i)}))}_playRequestBlocking=!1;async play(){if(!this._isVirtualPlay||this._virtualPaused)if(this._isVirtualPlay)await this._virtualPlay();else if(!this._playRequestBlocking){this._playRequestBlocking=!0;try{await this._audio.play()}catch(e){if(!(e instanceof DOMException&&"NotAllowedError"===e.name))throw e;await this._virtualPlay()}finally{this._playRequestBlocking=!1}}}pause(){if(this._isVirtualPlay){if(this._virtualPaused)return;this._virtualPaused=!0,this._virtualPauseCurrentTime=(performance.now()/1e3-this._virtualStartTime)*this._playbackRate,this._onPause()}else this._audio.pause()}dispose(){const e=this._audio;e.pause(),e.ondurationchange=null,e.onerror=null,e.onplaying=null,e.onpause=null,e.onseeked=null,this._audio.remove(),this.onLoadErrorObservable.clear(),this.onDurationChangedObservable.clear(),this.onPlaybackRateChangedObservable.clear(),this.onMuteStateChangedObservable.clear(),this.onPlayObservable.clear(),this.onPauseObservable.clear(),this.onSeekObservable.clear(),null!==this._disposeObservableObject&&this._disposeObservableObject.onDisposeObservable.removeCallback(this._bindedDispose)}}let Dt,Lt;const Ut=new Array(128).fill(void 0);function Vt(e){return Ut[e]}Ut.push(void 0,null,!0,!1);let Wt=Ut.length;function zt(e){const t=Vt(e);return function(e){e<132||(Ut[e]=Wt,Wt=e)}(e),t}function Kt(e){Wt===Ut.length&&Ut.push(Ut.length+1);const t=Wt;if(Wt=Ut[t],"number"!=typeof Wt)throw new Error("corrupt heap");return Ut[t]=e,t}function jt(e){if("boolean"!=typeof e)throw new Error("expected a boolean argument, found "+typeof e)}const Qt="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&Qt.decode();let Yt=null;function qt(){return null!==Yt&&Yt.buffer===Lt.memory.buffer||(Yt=new Uint8Array(Lt.memory.buffer)),Yt}function Ht(e,t){return e>>>=0,Qt.decode(qt().slice(e,e+t))}function Gt(e){if("number"!=typeof e)throw new Error("expected a number argument, found "+typeof e)}function $t(e){return null==e}function Xt(e,t){if(!(e instanceof t))throw new Error(`expected instance of ${t.name}`);return e.ptr}function Jt(){Lt.init()}function Zt(){const e=Lt.createMmdRuntime();return pn.__wrap(e)}function en(){const e=Lt.createAnimationPool();return mn.__wrap(e)}function tn(e,t){try{return e.apply(this,t)}catch(e){let t=function(){try{return e instanceof Error?`${e.message}\n\nStack:\n${e.stack}`:e.toString()}catch(e){return"<failed to stringify thrown value>"}}();throw console.error("wasm-bindgen: imported JS function that was not marked as `catch` threw an error:",t),e}}let nn=0;const on="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},rn=function(e,t){const n=on.encode(e);return t.set(n),{read:e.length,written:n.length}};let an=null;function sn(){return null!==an&&an.buffer===Lt.memory.buffer||(an=new Int32Array(Lt.memory.buffer)),an}function ln(e,t){try{return e.apply(this,t)}catch(e){Lt.__wbindgen_exn_store(Kt(e))}}function hn(e){return Gt(e),zt(Lt.initThreadPool(e))}function dn(e){Gt(e),Lt.wbg_rayon_start_worker(e)}const cn="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>Lt.__wbg_animationpool_free(e>>>0)));class mn{constructor(){throw new Error("cannot invoke `new` directly")}static __wrap(e){e>>>=0;const t=Object.create(mn.prototype);return t.__wbg_ptr=e,cn.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,cn.unregister(this),e}free(){const e=this.__destroy_into_raw();Lt.__wbg_animationpool_free(e)}allocateLengthsBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Lt.animationpool_allocateLengthsBuffer(this.__wbg_ptr,e)>>>0}deallocateLengthsBuffer(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_deallocateLengthsBuffer(this.__wbg_ptr,e,t)}createBoneTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_createBoneTracks(this.__wbg_ptr,e,t)>>>0}getBoneTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_getBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_getBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotationInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_getBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMovableBoneTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_createMovableBoneTracks(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_getMovableBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositions(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_getMovableBoneTrackPositions(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositionInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_getMovableBoneTrackPositionInterpolations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_getMovableBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotationInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_getMovableBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMorphTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_createMorphTracks(this.__wbg_ptr,e,t)>>>0}getMorphTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_getMorphTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMorphTrackWeights(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_getMorphTrackWeights(this.__wbg_ptr,e,t)>>>0}createAnimation(e,t,n,i,o,r,a,s){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Gt(n),Gt(i),Gt(o),Gt(r),Gt(a),Gt(s),Lt.animationpool_createAnimation(this.__wbg_ptr,e,t,n,i,o,r,a,s)>>>0}getPropertyTrackFrameNumbers(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Lt.animationpool_getPropertyTrackFrameNumbers(this.__wbg_ptr,e)>>>0}getPropertyTrackIkStates(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_getPropertyTrackIkStates(this.__wbg_ptr,e,t)>>>0}destroyAnimation(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Gt(this.__wbg_ptr),Gt(e),Lt.animationpool_destroyAnimation(this.__wbg_ptr,e)}createBoneBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Lt.animationpool_createBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMovableBoneBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Lt.animationpool_createMovableBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMorphBindIndexMap(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_createMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}getNthMorphBindIndexMap(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_getNthMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}createIkSolverBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Lt.animationpool_createIkSolverBindIndexMap(this.__wbg_ptr,e)>>>0}createRuntimeAnimation(e,t,n,i,o){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Gt(n),Gt(i),Gt(o),Lt.animationpool_createRuntimeAnimation(this.__wbg_ptr,e,t,n,i,o)>>>0}destroyRuntimeAnimation(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Gt(this.__wbg_ptr),Gt(e),Lt.animationpool_destroyRuntimeAnimation(this.__wbg_ptr,e)}animateMmdModel(e,t,n){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.animationpool_animateMmdModel(this.__wbg_ptr,e,t,n)}}const un="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>Lt.__wbg_mmdruntime_free(e>>>0)));class pn{constructor(){throw new Error("cannot invoke `new` directly")}static __wrap(e){e>>>=0;const t=Object.create(pn.prototype);return t.__wbg_ptr=e,un.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,un.unregister(this),e}free(){const e=this.__destroy_into_raw();Lt.__wbg_mmdruntime_free(e)}allocateBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Lt.mmdruntime_allocateBuffer(this.__wbg_ptr,e)>>>0}deallocateBuffer(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.mmdruntime_deallocateBuffer(this.__wbg_ptr,e,t)}createMmdModel(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.mmdruntime_createMmdModel(this.__wbg_ptr,e,t)>>>0}destroyMmdModel(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Gt(this.__wbg_ptr),Gt(e),Lt.mmdruntime_destroyMmdModel(this.__wbg_ptr,e)}getAnimationArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Lt.mmdruntime_getAnimationArena(this.__wbg_ptr,e)>>>0}getAnimationIkSolverStateArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Lt.mmdruntime_getAnimationIkSolverStateArena(this.__wbg_ptr,e)>>>0}getAnimationMorphArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Lt.mmdruntime_getAnimationMorphArena(this.__wbg_ptr,e)>>>0}getBoneWorldMatrixArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Lt.mmdruntime_getBoneWorldMatrixArena(this.__wbg_ptr,e)>>>0}createBoneWorldMatrixBackBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Gt(e),Lt.mmdruntime_createBoneWorldMatrixBackBuffer(this.__wbg_ptr,e)>>>0}setRuntimeAnimation(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Gt(this.__wbg_ptr),Gt(e),Gt(t),Lt.mmdruntime_setRuntimeAnimation(this.__wbg_ptr,e,t)}setExternalPhysics(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Gt(this.__wbg_ptr),Gt(e),jt(t),Lt.mmdruntime_setExternalPhysics(this.__wbg_ptr,e,t)}beforePhysics(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Gt(this.__wbg_ptr),$t(e)||Gt(e),Lt.mmdruntime_beforePhysics(this.__wbg_ptr,!$t(e),$t(e)?0:e)}afterPhysics(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Gt(this.__wbg_ptr),Lt.mmdruntime_afterPhysics(this.__wbg_ptr)}getLockStatePtr(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Lt.mmdruntime_getLockStatePtr(this.__wbg_ptr)>>>0}swapWorldMatrixBuffer(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Gt(this.__wbg_ptr),Lt.mmdruntime_swapWorldMatrixBuffer(this.__wbg_ptr)}static bufferedBeforePhysics(e,t){if(Xt(e,pn),0===e.__wbg_ptr)throw new Error("Attempt to use a moved value");$t(t)||Gt(t),Lt.mmdruntime_bufferedBeforePhysics(e.__wbg_ptr,!$t(t),$t(t)?0:t)}static bufferedUpdate(e,t){if(Xt(e,pn),0===e.__wbg_ptr)throw new Error("Attempt to use a moved value");$t(t)||Gt(t),Lt.mmdruntime_bufferedUpdate(e.__wbg_ptr,!$t(t),$t(t)?0:t)}}const gn="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>Lt.__wbg_wbg_rayon_poolbuilder_free(e>>>0)));class fn{constructor(){throw new Error("cannot invoke `new` directly")}static __wrap(e){e>>>=0;const t=Object.create(fn.prototype);return t.__wbg_ptr=e,gn.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,gn.unregister(this),e}free(){const e=this.__destroy_into_raw();Lt.__wbg_wbg_rayon_poolbuilder_free(e)}numThreads(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Lt.wbg_rayon_poolbuilder_numThreads(this.__wbg_ptr)>>>0}receiver(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Gt(this.__wbg_ptr),Lt.wbg_rayon_poolbuilder_receiver(this.__wbg_ptr)>>>0}build(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Gt(this.__wbg_ptr),Lt.wbg_rayon_poolbuilder_build(this.__wbg_ptr)}}function _n(){const e={wbg:{}};return e.wbg.__wbindgen_object_drop_ref=function(e){zt(e)},e.wbg.__wbg_new_abda76e883ba8a5f=function(){return tn((function(){return Kt(new Error)}),arguments)},e.wbg.__wbg_stack_658279fe44541cf6=function(){return tn((function(e,t){const n=function(e,t,n){if("string"!=typeof e)throw new Error("expected a string argument, found "+typeof e);if(void 0===n){const n=on.encode(e),i=t(n.length,1)>>>0;return qt().subarray(i,i+n.length).set(n),nn=n.length,i}let i=e.length,o=t(i,1)>>>0;const r=qt();let a=0;for(;a<i;a++){const t=e.charCodeAt(a);if(t>127)break;r[o+a]=t}if(a!==i){0!==a&&(e=e.slice(a)),o=n(o,i,i=a+3*e.length,1)>>>0;const t=qt().subarray(o+a,o+i),r=rn(e,t);if(r.read!==e.length)throw new Error("failed to pass whole string");a+=r.written,o=n(o,i,a,1)>>>0}return nn=a,o}(Vt(t).stack,Lt.__wbindgen_malloc,Lt.__wbindgen_realloc),i=nn;sn()[e/4+1]=i,sn()[e/4+0]=n}),arguments)},e.wbg.__wbg_error_f851667af71bcfc6=function(){return tn((function(e,t){let n,i;try{n=e,i=t,console.error(Ht(e,t))}finally{Lt.__wbindgen_free(n,i,1)}}),arguments)},e.wbg.__wbg_instanceof_Window_cee7a886d55e7df5=function(){return tn((function(e){let t;try{t=Vt(e)instanceof Window}catch(e){t=!1}const n=t;return jt(n),n}),arguments)},e.wbg.__wbg_newnoargs_cfecb3965268594c=function(){return tn((function(e,t){return Kt(new Function(Ht(e,t)))}),arguments)},e.wbg.__wbg_call_3f093dd26d5569f8=function(){return ln((function(e,t){return Kt(Vt(e).call(Vt(t)))}),arguments)},e.wbg.__wbindgen_object_clone_ref=function(e){return Kt(Vt(e))},e.wbg.__wbg_self_05040bd9523805b9=function(){return ln((function(){return Kt(self.self)}),arguments)},e.wbg.__wbg_window_adc720039f2cb14f=function(){return ln((function(){return Kt(window.window)}),arguments)},e.wbg.__wbg_globalThis_622105db80c1457d=function(){return ln((function(){return Kt(globalThis.globalThis)}),arguments)},e.wbg.__wbg_global_f56b013ed9bcf359=function(){return ln((function(){return Kt(ie.g.global)}),arguments)},e.wbg.__wbindgen_is_undefined=function(e){const t=void 0===Vt(e);return jt(t),t},e.wbg.__wbindgen_throw=function(e,t){throw new Error(Ht(e,t))},e.wbg.__wbindgen_module=function(){return Kt(Mn.__wbindgen_wasm_module)},e.wbg.__wbindgen_memory=function(){return Kt(Lt.memory)},e.wbg.__wbg_startWorkers_2ee336a9694dda13=function(){return tn((function(e,t,n){return Kt(async function(e,t,n){if(0===n.numThreads())throw new Error("num_threads must be > 0.");const i={module:e,memory:t,receiver:n.receiver()};Dt=await Promise.all(Array.from({length:n.numThreads()},(async()=>{const e=new Worker(new URL(ie.p+ie.u(614),ie.b),{type:void 0});return e.postMessage(i),await new Promise((t=>e.addEventListener("message",t,{once:!0}))),e}))),n.build()}(zt(e),zt(t),fn.__wrap(n)))}),arguments)},e}function bn(e,t){e.wbg.memory=t||new WebAssembly.Memory({initial:19,maximum:16384,shared:!0})}function yn(e,t){return Lt=e.exports,Mn.__wbindgen_wasm_module=t,an=null,Yt=null,Lt.__wbindgen_start(),Lt}function An(e,t){if(void 0!==Lt)return Lt;const n=_n();return bn(n,t),e instanceof WebAssembly.Module||(e=new WebAssembly.Module(e)),yn(new WebAssembly.Instance(e,n),e)}async function Mn(e,t){if(void 0!==Lt)return Lt;void 0===e&&(e=new URL(ie(858),ie.b));const n=_n();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e)),bn(n,t);const{instance:i,module:o}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if("application/wasm"==e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}(await e,n);return yn(i,o)}const Tn=Mn;class wn{getWasmInstanceInner(){return e}}let xn,vn;const In=new Array(128).fill(void 0);function Bn(e){return In[e]}In.push(void 0,null,!0,!1);let Pn=In.length;function Rn(e){const t=Bn(e);return function(e){e<132||(In[e]=Pn,Pn=e)}(e),t}function Cn(e){Pn===In.length&&In.push(In.length+1);const t=Pn;return Pn=In[t],In[t]=e,t}const On="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&On.decode();let Fn=null;function Sn(e,t){return e>>>=0,On.decode((null!==Fn&&Fn.buffer===vn.memory.buffer||(Fn=new Uint8Array(vn.memory.buffer)),Fn).slice(e,e+t))}function En(){vn.init()}function kn(){const e=vn.createMmdRuntime();return Qn.__wrap(e)}function Nn(){const e=vn.createAnimationPool();return Kn.__wrap(e)}function Dn(e){return null==e}function Ln(e,t){if(!(e instanceof t))throw new Error(`expected instance of ${t.name}`);return e.ptr}function Un(e,t){try{return e.apply(this,t)}catch(e){vn.__wbindgen_exn_store(Cn(e))}}function Vn(e){return Rn(vn.initThreadPool(e))}function Wn(e){vn.wbg_rayon_start_worker(e)}const zn="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>vn.__wbg_animationpool_free(e>>>0)));class Kn{static __wrap(e){e>>>=0;const t=Object.create(Kn.prototype);return t.__wbg_ptr=e,zn.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,zn.unregister(this),e}free(){const e=this.__destroy_into_raw();vn.__wbg_animationpool_free(e)}allocateLengthsBuffer(e){return vn.animationpool_allocateLengthsBuffer(this.__wbg_ptr,e)>>>0}deallocateLengthsBuffer(e,t){vn.animationpool_deallocateLengthsBuffer(this.__wbg_ptr,e,t)}createBoneTracks(e,t){return vn.animationpool_createBoneTracks(this.__wbg_ptr,e,t)>>>0}getBoneTrackFrameNumbers(e,t){return vn.animationpool_getBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotations(e,t){return vn.animationpool_getBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotationInterpolations(e,t){return vn.animationpool_getBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMovableBoneTracks(e,t){return vn.animationpool_createMovableBoneTracks(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackFrameNumbers(e,t){return vn.animationpool_getMovableBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositions(e,t){return vn.animationpool_getMovableBoneTrackPositions(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositionInterpolations(e,t){return vn.animationpool_getMovableBoneTrackPositionInterpolations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotations(e,t){return vn.animationpool_getMovableBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotationInterpolations(e,t){return vn.animationpool_getMovableBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMorphTracks(e,t){return vn.animationpool_createMorphTracks(this.__wbg_ptr,e,t)>>>0}getMorphTrackFrameNumbers(e,t){return vn.animationpool_getMorphTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMorphTrackWeights(e,t){return vn.animationpool_getMorphTrackWeights(this.__wbg_ptr,e,t)>>>0}createAnimation(e,t,n,i,o,r,a,s){return vn.animationpool_createAnimation(this.__wbg_ptr,e,t,n,i,o,r,a,s)>>>0}getPropertyTrackFrameNumbers(e){return vn.animationpool_getPropertyTrackFrameNumbers(this.__wbg_ptr,e)>>>0}getPropertyTrackIkStates(e,t){return vn.animationpool_getPropertyTrackIkStates(this.__wbg_ptr,e,t)>>>0}destroyAnimation(e){vn.animationpool_destroyAnimation(this.__wbg_ptr,e)}createBoneBindIndexMap(e){return vn.animationpool_createBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMovableBoneBindIndexMap(e){return vn.animationpool_createMovableBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMorphBindIndexMap(e,t){return vn.animationpool_createMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}getNthMorphBindIndexMap(e,t){return vn.animationpool_getNthMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}createIkSolverBindIndexMap(e){return vn.animationpool_createIkSolverBindIndexMap(this.__wbg_ptr,e)>>>0}createRuntimeAnimation(e,t,n,i,o){return vn.animationpool_createRuntimeAnimation(this.__wbg_ptr,e,t,n,i,o)>>>0}destroyRuntimeAnimation(e){vn.animationpool_destroyRuntimeAnimation(this.__wbg_ptr,e)}animateMmdModel(e,t,n){vn.animationpool_animateMmdModel(this.__wbg_ptr,e,t,n)}}const jn="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>vn.__wbg_mmdruntime_free(e>>>0)));class Qn{static __wrap(e){e>>>=0;const t=Object.create(Qn.prototype);return t.__wbg_ptr=e,jn.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,jn.unregister(this),e}free(){const e=this.__destroy_into_raw();vn.__wbg_mmdruntime_free(e)}allocateBuffer(e){return vn.mmdruntime_allocateBuffer(this.__wbg_ptr,e)>>>0}deallocateBuffer(e,t){vn.mmdruntime_deallocateBuffer(this.__wbg_ptr,e,t)}createMmdModel(e,t){return vn.mmdruntime_createMmdModel(this.__wbg_ptr,e,t)>>>0}destroyMmdModel(e){vn.mmdruntime_destroyMmdModel(this.__wbg_ptr,e)}getAnimationArena(e){return vn.mmdruntime_getAnimationArena(this.__wbg_ptr,e)>>>0}getAnimationIkSolverStateArena(e){return vn.mmdruntime_getAnimationIkSolverStateArena(this.__wbg_ptr,e)>>>0}getAnimationMorphArena(e){return vn.mmdruntime_getAnimationMorphArena(this.__wbg_ptr,e)>>>0}getBoneWorldMatrixArena(e){return vn.mmdruntime_getBoneWorldMatrixArena(this.__wbg_ptr,e)>>>0}createBoneWorldMatrixBackBuffer(e){return vn.mmdruntime_createBoneWorldMatrixBackBuffer(this.__wbg_ptr,e)>>>0}setRuntimeAnimation(e,t){vn.mmdruntime_setRuntimeAnimation(this.__wbg_ptr,e,t)}setExternalPhysics(e,t){vn.mmdruntime_setExternalPhysics(this.__wbg_ptr,e,t)}beforePhysics(e){vn.mmdruntime_beforePhysics(this.__wbg_ptr,!Dn(e),Dn(e)?0:e)}afterPhysics(){vn.mmdruntime_afterPhysics(this.__wbg_ptr)}getLockStatePtr(){return vn.mmdruntime_getLockStatePtr(this.__wbg_ptr)>>>0}swapWorldMatrixBuffer(){vn.mmdruntime_swapWorldMatrixBuffer(this.__wbg_ptr)}static bufferedBeforePhysics(e,t){Ln(e,Qn),vn.mmdruntime_bufferedBeforePhysics(e.__wbg_ptr,!Dn(t),Dn(t)?0:t)}static bufferedUpdate(e,t){Ln(e,Qn),vn.mmdruntime_bufferedUpdate(e.__wbg_ptr,!Dn(t),Dn(t)?0:t)}}const Yn="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>vn.__wbg_wbg_rayon_poolbuilder_free(e>>>0)));class qn{static __wrap(e){e>>>=0;const t=Object.create(qn.prototype);return t.__wbg_ptr=e,Yn.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Yn.unregister(this),e}free(){const e=this.__destroy_into_raw();vn.__wbg_wbg_rayon_poolbuilder_free(e)}numThreads(){return vn.wbg_rayon_poolbuilder_numThreads(this.__wbg_ptr)>>>0}receiver(){return vn.wbg_rayon_poolbuilder_receiver(this.__wbg_ptr)>>>0}build(){vn.wbg_rayon_poolbuilder_build(this.__wbg_ptr)}}function Hn(){const e={wbg:{}};return e.wbg.__wbindgen_object_drop_ref=function(e){Rn(e)},e.wbg.__wbg_instanceof_Window_cee7a886d55e7df5=function(e){let t;try{t=Bn(e)instanceof Window}catch(e){t=!1}return t},e.wbg.__wbg_newnoargs_cfecb3965268594c=function(e,t){return Cn(new Function(Sn(e,t)))},e.wbg.__wbg_call_3f093dd26d5569f8=function(){return Un((function(e,t){return Cn(Bn(e).call(Bn(t)))}),arguments)},e.wbg.__wbindgen_object_clone_ref=function(e){return Cn(Bn(e))},e.wbg.__wbg_self_05040bd9523805b9=function(){return Un((function(){return Cn(self.self)}),arguments)},e.wbg.__wbg_window_adc720039f2cb14f=function(){return Un((function(){return Cn(window.window)}),arguments)},e.wbg.__wbg_globalThis_622105db80c1457d=function(){return Un((function(){return Cn(globalThis.globalThis)}),arguments)},e.wbg.__wbg_global_f56b013ed9bcf359=function(){return Un((function(){return Cn(ie.g.global)}),arguments)},e.wbg.__wbindgen_is_undefined=function(e){return void 0===Bn(e)},e.wbg.__wbindgen_throw=function(e,t){throw new Error(Sn(e,t))},e.wbg.__wbindgen_module=function(){return Cn(Jn.__wbindgen_wasm_module)},e.wbg.__wbindgen_memory=function(){return Cn(vn.memory)},e.wbg.__wbg_startWorkers_2ee336a9694dda13=function(e,t,n){return Cn(async function(e,t,n){if(0===n.numThreads())throw new Error("num_threads must be > 0.");const i={module:e,memory:t,receiver:n.receiver()};xn=await Promise.all(Array.from({length:n.numThreads()},(async()=>{const e=new Worker(new URL(ie.p+ie.u(256),ie.b),{type:void 0});return e.postMessage(i),await new Promise((t=>e.addEventListener("message",t,{once:!0}))),e}))),n.build()}(Rn(e),Rn(t),qn.__wrap(n)))},e}function Gn(e,t){e.wbg.memory=t||new WebAssembly.Memory({initial:18,maximum:16384,shared:!0})}function $n(e,t){return vn=e.exports,Jn.__wbindgen_wasm_module=t,Fn=null,vn.__wbindgen_start(),vn}function Xn(e,t){if(void 0!==vn)return vn;const n=Hn();return Gn(n,t),e instanceof WebAssembly.Module||(e=new WebAssembly.Module(e)),$n(new WebAssembly.Instance(e,n),e)}async function Jn(e,t){if(void 0!==vn)return vn;void 0===e&&(e=new URL(ie(2524),ie.b));const n=Hn();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e)),Gn(n,t);const{instance:i,module:o}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if("application/wasm"==e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}(await e,n);return $n(i,o)}const Zn=Jn;class ei{getWasmInstanceInner(){return t}}let ti;const ni=new Array(128).fill(void 0);function ii(e){return ni[e]}ni.push(void 0,null,!0,!1);let oi=ni.length;const ri="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&ri.decode();let ai=null;function si(){return null!==ai&&0!==ai.byteLength||(ai=new Uint8Array(ti.memory.buffer)),ai}function li(e,t){return e>>>=0,ri.decode(si().subarray(e,e+t))}function hi(e){if("number"!=typeof e)throw new Error("expected a number argument, found "+typeof e)}function di(){ti.init()}function ci(){const e=ti.createMmdRuntime();return wi.__wrap(e)}function mi(){const e=ti.createAnimationPool();return Mi.__wrap(e)}function ui(e){return null==e}function pi(e,t){try{return e.apply(this,t)}catch(e){let t=function(){try{return e instanceof Error?`${e.message}\n\nStack:\n${e.stack}`:e.toString()}catch(e){return"<failed to stringify thrown value>"}}();throw console.error("wasm-bindgen: imported JS function that was not marked as `catch` threw an error:",t),e}}let gi=0;const fi="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},_i="function"==typeof fi.encodeInto?function(e,t){return fi.encodeInto(e,t)}:function(e,t){const n=fi.encode(e);return t.set(n),{read:e.length,written:n.length}};let bi=null;function yi(){return null!==bi&&0!==bi.byteLength||(bi=new Int32Array(ti.memory.buffer)),bi}const Ai="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>ti.__wbg_animationpool_free(e>>>0)));class Mi{constructor(){throw new Error("cannot invoke `new` directly")}static __wrap(e){e>>>=0;const t=Object.create(Mi.prototype);return t.__wbg_ptr=e,Ai.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Ai.unregister(this),e}free(){const e=this.__destroy_into_raw();ti.__wbg_animationpool_free(e)}allocateLengthsBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),ti.animationpool_allocateLengthsBuffer(this.__wbg_ptr,e)>>>0}deallocateLengthsBuffer(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_deallocateLengthsBuffer(this.__wbg_ptr,e,t)}createBoneTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_createBoneTracks(this.__wbg_ptr,e,t)>>>0}getBoneTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_getBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_getBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotationInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_getBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMovableBoneTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_createMovableBoneTracks(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_getMovableBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositions(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_getMovableBoneTrackPositions(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositionInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_getMovableBoneTrackPositionInterpolations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_getMovableBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotationInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_getMovableBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMorphTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_createMorphTracks(this.__wbg_ptr,e,t)>>>0}getMorphTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_getMorphTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMorphTrackWeights(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_getMorphTrackWeights(this.__wbg_ptr,e,t)>>>0}createAnimation(e,t,n,i,o,r,a,s){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),hi(n),hi(i),hi(o),hi(r),hi(a),hi(s),ti.animationpool_createAnimation(this.__wbg_ptr,e,t,n,i,o,r,a,s)>>>0}getPropertyTrackFrameNumbers(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),ti.animationpool_getPropertyTrackFrameNumbers(this.__wbg_ptr,e)>>>0}getPropertyTrackIkStates(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_getPropertyTrackIkStates(this.__wbg_ptr,e,t)>>>0}destroyAnimation(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hi(this.__wbg_ptr),hi(e),ti.animationpool_destroyAnimation(this.__wbg_ptr,e)}createBoneBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),ti.animationpool_createBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMovableBoneBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),ti.animationpool_createMovableBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMorphBindIndexMap(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_createMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}getNthMorphBindIndexMap(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_getNthMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}createIkSolverBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),ti.animationpool_createIkSolverBindIndexMap(this.__wbg_ptr,e)>>>0}createRuntimeAnimation(e,t,n,i,o){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),hi(n),hi(i),hi(o),ti.animationpool_createRuntimeAnimation(this.__wbg_ptr,e,t,n,i,o)>>>0}destroyRuntimeAnimation(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hi(this.__wbg_ptr),hi(e),ti.animationpool_destroyRuntimeAnimation(this.__wbg_ptr,e)}animateMmdModel(e,t,n){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hi(this.__wbg_ptr),hi(e),hi(t),ti.animationpool_animateMmdModel(this.__wbg_ptr,e,t,n)}}const Ti="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>ti.__wbg_mmdruntime_free(e>>>0)));class wi{constructor(){throw new Error("cannot invoke `new` directly")}static __wrap(e){e>>>=0;const t=Object.create(wi.prototype);return t.__wbg_ptr=e,Ti.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Ti.unregister(this),e}free(){const e=this.__destroy_into_raw();ti.__wbg_mmdruntime_free(e)}allocateBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),ti.mmdruntime_allocateBuffer(this.__wbg_ptr,e)>>>0}deallocateBuffer(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hi(this.__wbg_ptr),hi(e),hi(t),ti.mmdruntime_deallocateBuffer(this.__wbg_ptr,e,t)}createMmdModel(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),hi(t),ti.mmdruntime_createMmdModel(this.__wbg_ptr,e,t)>>>0}destroyMmdModel(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hi(this.__wbg_ptr),hi(e),ti.mmdruntime_destroyMmdModel(this.__wbg_ptr,e)}getAnimationArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),ti.mmdruntime_getAnimationArena(this.__wbg_ptr,e)>>>0}getAnimationIkSolverStateArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),ti.mmdruntime_getAnimationIkSolverStateArena(this.__wbg_ptr,e)>>>0}getAnimationMorphArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),ti.mmdruntime_getAnimationMorphArena(this.__wbg_ptr,e)>>>0}getBoneWorldMatrixArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),ti.mmdruntime_getBoneWorldMatrixArena(this.__wbg_ptr,e)>>>0}createBoneWorldMatrixBackBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),hi(e),ti.mmdruntime_createBoneWorldMatrixBackBuffer(this.__wbg_ptr,e)>>>0}setRuntimeAnimation(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hi(this.__wbg_ptr),hi(e),hi(t),ti.mmdruntime_setRuntimeAnimation(this.__wbg_ptr,e,t)}setExternalPhysics(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hi(this.__wbg_ptr),hi(e),function(e){if("boolean"!=typeof e)throw new Error("expected a boolean argument, found "+typeof e)}(t),ti.mmdruntime_setExternalPhysics(this.__wbg_ptr,e,t)}beforePhysics(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hi(this.__wbg_ptr),ui(e)||hi(e),ti.mmdruntime_beforePhysics(this.__wbg_ptr,!ui(e),ui(e)?0:e)}afterPhysics(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hi(this.__wbg_ptr),ti.mmdruntime_afterPhysics(this.__wbg_ptr)}getLockStatePtr(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hi(this.__wbg_ptr),ti.mmdruntime_getLockStatePtr(this.__wbg_ptr)>>>0}swapWorldMatrixBuffer(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hi(this.__wbg_ptr),ti.mmdruntime_swapWorldMatrixBuffer(this.__wbg_ptr)}}function xi(){const e={wbg:{}};return e.wbg.__wbindgen_object_drop_ref=function(e){!function(e){const t=ii(e);(function(e){e<132||(ni[e]=oi,oi=e)})(e)}(e)},e.wbg.__wbg_new_abda76e883ba8a5f=function(){return pi((function(){return function(e){oi===ni.length&&ni.push(ni.length+1);const t=oi;if(oi=ni[t],"number"!=typeof oi)throw new Error("corrupt heap");return ni[t]=e,t}(new Error)}),arguments)},e.wbg.__wbg_stack_658279fe44541cf6=function(){return pi((function(e,t){const n=function(e,t,n){if("string"!=typeof e)throw new Error("expected a string argument, found "+typeof e);if(void 0===n){const n=fi.encode(e),i=t(n.length,1)>>>0;return si().subarray(i,i+n.length).set(n),gi=n.length,i}let i=e.length,o=t(i,1)>>>0;const r=si();let a=0;for(;a<i;a++){const t=e.charCodeAt(a);if(t>127)break;r[o+a]=t}if(a!==i){0!==a&&(e=e.slice(a)),o=n(o,i,i=a+3*e.length,1)>>>0;const t=si().subarray(o+a,o+i),r=_i(e,t);if(r.read!==e.length)throw new Error("failed to pass whole string");a+=r.written,o=n(o,i,a,1)>>>0}return gi=a,o}(ii(t).stack,ti.__wbindgen_malloc,ti.__wbindgen_realloc),i=gi;yi()[e/4+1]=i,yi()[e/4+0]=n}),arguments)},e.wbg.__wbg_error_f851667af71bcfc6=function(){return pi((function(e,t){let n,i;try{n=e,i=t,console.error(li(e,t))}finally{ti.__wbindgen_free(n,i,1)}}),arguments)},e.wbg.__wbindgen_throw=function(e,t){throw new Error(li(e,t))},e}function vi(e,t){return ti=e.exports,Bi.__wbindgen_wasm_module=t,bi=null,ai=null,ti}function Ii(e){if(void 0!==ti)return ti;const t=xi();return e instanceof WebAssembly.Module||(e=new WebAssembly.Module(e)),vi(new WebAssembly.Instance(e,t),e)}async function Bi(e){if(void 0!==ti)return ti;void 0===e&&(e=new URL(ie(7236),ie.b));const t=xi();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:i}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if("application/wasm"==e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}(await e,t);return vi(n,i)}const Pi=Bi;class Ri{getWasmInstanceInner(){return n}}let Ci;const Oi="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&Oi.decode();let Fi=null;function Si(e){return null==e}function Ei(){Ci.init()}function ki(){const e=Ci.createMmdRuntime();return Vi.__wrap(e)}function Ni(){const e=Ci.createAnimationPool();return Li.__wrap(e)}const Di="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>Ci.__wbg_animationpool_free(e>>>0)));class Li{static __wrap(e){e>>>=0;const t=Object.create(Li.prototype);return t.__wbg_ptr=e,Di.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Di.unregister(this),e}free(){const e=this.__destroy_into_raw();Ci.__wbg_animationpool_free(e)}allocateLengthsBuffer(e){return Ci.animationpool_allocateLengthsBuffer(this.__wbg_ptr,e)>>>0}deallocateLengthsBuffer(e,t){Ci.animationpool_deallocateLengthsBuffer(this.__wbg_ptr,e,t)}createBoneTracks(e,t){return Ci.animationpool_createBoneTracks(this.__wbg_ptr,e,t)>>>0}getBoneTrackFrameNumbers(e,t){return Ci.animationpool_getBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotations(e,t){return Ci.animationpool_getBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotationInterpolations(e,t){return Ci.animationpool_getBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMovableBoneTracks(e,t){return Ci.animationpool_createMovableBoneTracks(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackFrameNumbers(e,t){return Ci.animationpool_getMovableBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositions(e,t){return Ci.animationpool_getMovableBoneTrackPositions(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositionInterpolations(e,t){return Ci.animationpool_getMovableBoneTrackPositionInterpolations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotations(e,t){return Ci.animationpool_getMovableBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotationInterpolations(e,t){return Ci.animationpool_getMovableBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMorphTracks(e,t){return Ci.animationpool_createMorphTracks(this.__wbg_ptr,e,t)>>>0}getMorphTrackFrameNumbers(e,t){return Ci.animationpool_getMorphTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMorphTrackWeights(e,t){return Ci.animationpool_getMorphTrackWeights(this.__wbg_ptr,e,t)>>>0}createAnimation(e,t,n,i,o,r,a,s){return Ci.animationpool_createAnimation(this.__wbg_ptr,e,t,n,i,o,r,a,s)>>>0}getPropertyTrackFrameNumbers(e){return Ci.animationpool_getPropertyTrackFrameNumbers(this.__wbg_ptr,e)>>>0}getPropertyTrackIkStates(e,t){return Ci.animationpool_getPropertyTrackIkStates(this.__wbg_ptr,e,t)>>>0}destroyAnimation(e){Ci.animationpool_destroyAnimation(this.__wbg_ptr,e)}createBoneBindIndexMap(e){return Ci.animationpool_createBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMovableBoneBindIndexMap(e){return Ci.animationpool_createMovableBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMorphBindIndexMap(e,t){return Ci.animationpool_createMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}getNthMorphBindIndexMap(e,t){return Ci.animationpool_getNthMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}createIkSolverBindIndexMap(e){return Ci.animationpool_createIkSolverBindIndexMap(this.__wbg_ptr,e)>>>0}createRuntimeAnimation(e,t,n,i,o){return Ci.animationpool_createRuntimeAnimation(this.__wbg_ptr,e,t,n,i,o)>>>0}destroyRuntimeAnimation(e){Ci.animationpool_destroyRuntimeAnimation(this.__wbg_ptr,e)}animateMmdModel(e,t,n){Ci.animationpool_animateMmdModel(this.__wbg_ptr,e,t,n)}}const Ui="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>Ci.__wbg_mmdruntime_free(e>>>0)));class Vi{static __wrap(e){e>>>=0;const t=Object.create(Vi.prototype);return t.__wbg_ptr=e,Ui.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Ui.unregister(this),e}free(){const e=this.__destroy_into_raw();Ci.__wbg_mmdruntime_free(e)}allocateBuffer(e){return Ci.mmdruntime_allocateBuffer(this.__wbg_ptr,e)>>>0}deallocateBuffer(e,t){Ci.mmdruntime_deallocateBuffer(this.__wbg_ptr,e,t)}createMmdModel(e,t){return Ci.mmdruntime_createMmdModel(this.__wbg_ptr,e,t)>>>0}destroyMmdModel(e){Ci.mmdruntime_destroyMmdModel(this.__wbg_ptr,e)}getAnimationArena(e){return Ci.mmdruntime_getAnimationArena(this.__wbg_ptr,e)>>>0}getAnimationIkSolverStateArena(e){return Ci.mmdruntime_getAnimationIkSolverStateArena(this.__wbg_ptr,e)>>>0}getAnimationMorphArena(e){return Ci.mmdruntime_getAnimationMorphArena(this.__wbg_ptr,e)>>>0}getBoneWorldMatrixArena(e){return Ci.mmdruntime_getBoneWorldMatrixArena(this.__wbg_ptr,e)>>>0}createBoneWorldMatrixBackBuffer(e){return Ci.mmdruntime_createBoneWorldMatrixBackBuffer(this.__wbg_ptr,e)>>>0}setRuntimeAnimation(e,t){Ci.mmdruntime_setRuntimeAnimation(this.__wbg_ptr,e,t)}setExternalPhysics(e,t){Ci.mmdruntime_setExternalPhysics(this.__wbg_ptr,e,t)}beforePhysics(e){Ci.mmdruntime_beforePhysics(this.__wbg_ptr,!Si(e),Si(e)?0:e)}afterPhysics(){Ci.mmdruntime_afterPhysics(this.__wbg_ptr)}getLockStatePtr(){return Ci.mmdruntime_getLockStatePtr(this.__wbg_ptr)>>>0}swapWorldMatrixBuffer(){Ci.mmdruntime_swapWorldMatrixBuffer(this.__wbg_ptr)}}function Wi(){const e={wbg:{}};return e.wbg.__wbindgen_throw=function(e,t){throw new Error((n=e,i=t,n>>>=0,Oi.decode((null!==Fi&&0!==Fi.byteLength||(Fi=new Uint8Array(Ci.memory.buffer)),Fi).subarray(n,n+i))));var n,i},e}function zi(e,t){return Ci=e.exports,ji.__wbindgen_wasm_module=t,Fi=null,Ci}function Ki(e){if(void 0!==Ci)return Ci;const t=Wi();return e instanceof WebAssembly.Module||(e=new WebAssembly.Module(e)),zi(new WebAssembly.Instance(e,t),e)}async function ji(e){if(void 0!==Ci)return Ci;void 0===e&&(e=new URL(ie(8754),ie.b));const t=Wi();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:i}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if("application/wasm"==e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}(await e,t);return zi(n,i)}const Qi=ji;class Yi{getWasmInstanceInner(){return i}}class qi{array;constructor(e,t,n,i){this.array=new e(t.buffer,n,i)}}class Hi{_memory;_byteOffset;_length;_array;constructor(e,t,n,i){this._memory=t,this._byteOffset=n,this._length=i,this._array=new e(t.buffer,n,i)}get array(){return this._array.length!==this._length&&(this._array=new this._array.constructor(this._memory.buffer,this._byteOffset,this._length)),this._array}}const Gi=new WeakMap;async function $i(e,t=navigator.hardwareConcurrency){const n=e.getWasmInstanceInner();{const e=Gi.get(n);if(void 0!==e)return e}let i=null;Gi.set(n,new Promise((e=>i=e)));const o=await n.default();n.init();const r=o.memory;return n.memory=r,r.buffer instanceof ArrayBuffer?n.createTypedArray=function(e,t,n){return new Hi(e,r,t,n)}:n.createTypedArray=function(e,t,n){return new qi(e,r,t,n)},await(n.initThreadPool?.(t)),i(n),n}class Xi{_runtimeBones;_materials;_morphs;_morphIndexMap;_morphWeights;_activeMorphs;morphTargetManagers;constructor(e,t,n,i,o,r){if(this._runtimeBones=e??[],null!==i){const e=this._materials=new Array(t.length);for(let o=0;o<t.length;++o){const r=t[o],a=[];for(let e=0;e<n.length;++e)n[e].material===r&&a.push(n[e]);e[o]=new i(r,a)}}else this._materials=[];const a=this._morphs=this._createRuntimeMorphData(o,null!==e,null!==i),s=this._morphIndexMap=new Map;for(let e=0;e<a.length;++e){const t=a[e];let n=s.get(t.name);void 0===n&&(n=[],s.set(t.name,n)),n.push(e)}this._morphWeights=new Float32Array(a.length),this._activeMorphs=new Set,this.morphTargetManagers=r}getMorphWeight(e){const t=this._morphIndexMap.get(e);return void 0===t?0:this._morphWeights[t[0]]}getMorphIndices(e){return this._morphIndexMap.get(e)}getMorphWeightFromIndex(e){return this._morphWeights[e]}getMorphWeights(){return this._morphWeights}resetMorphWeights(){this._morphWeights.fill(0)}_updatedMaterials=new Set;update(){const e=this._morphs,t=this._morphIndexMap,n=this._morphWeights,i=this._activeMorphs,o=this.morphTargetManagers;for(let e=0;e<o.length;++e)o[e].areUpdatesFrozen=!0;for(const n of i){const i=t.get(n);for(let t=0;t<i.length;++t)this._resetMorph(e[i[t]])}for(const o of i){const r=t.get(o);for(let t=0;t<r.length;++t){const a=r[t],s=n[a];this._applyMorph(e[a],s),0===s&&i.delete(o)}}for(let e=0;e<o.length;++e)o[e].areUpdatesFrozen=!1;const r=this._updatedMaterials;for(const e of r)e.applyChanges();r.clear()}get morphs(){return this._morphs}_createRuntimeMorphData(e,t,n){const i=[];for(let o=0;o<e.length;++o){const r=e[o];let a=null,s=null,l=null,h=null;switch(r.type){case M.Morph.Type.GroupMorph:s=r.indices,l=r.ratios;break;case M.Morph.Type.BoneMorph:t?(s=r.indices,l=r.positions,h=r.rotations):(s=new Int32Array(0),l=new Float32Array(0),h=new Float32Array(0));break;case M.Morph.Type.MaterialMorph:if(n){const e=r.elements,t=new Array(e.length);for(let n=0;n<e.length;++n){const i=e[n];i.type===M.Morph.MaterialMorph.Type.Multiply?t[n]={index:i.index,type:i.type,diffuse:1!==i.diffuse[0]||1!==i.diffuse[1]||1!==i.diffuse[2]||1!==i.diffuse[3]?i.diffuse:null,specular:1!==i.specular[0]||1!==i.specular[1]||1!==i.specular[2]?i.specular:null,shininess:1!==i.shininess?i.shininess:null,ambient:1!==i.ambient[0]||1!==i.ambient[1]||1!==i.ambient[2]?i.ambient:null,edgeColor:1!==i.edgeColor[0]||1!==i.edgeColor[1]||1!==i.edgeColor[2]||1!==i.edgeColor[3]?i.edgeColor:null,edgeSize:1!==i.edgeSize?i.edgeSize:null,textureColor:1!==i.textureColor[0]||1!==i.textureColor[1]||1!==i.textureColor[2]||1!==i.textureColor[3]?i.textureColor:null,sphereTextureColor:1!==i.sphereTextureColor[0]||1!==i.sphereTextureColor[1]||1!==i.sphereTextureColor[2]||1!==i.sphereTextureColor[3]?i.sphereTextureColor:null,toonTextureColor:1!==i.toonTextureColor[0]||1!==i.toonTextureColor[1]||1!==i.toonTextureColor[2]||1!==i.toonTextureColor[3]?i.toonTextureColor:null}:t[n]={index:i.index,type:i.type,diffuse:0!==i.diffuse[0]||0!==i.diffuse[1]||0!==i.diffuse[2]||0!==i.diffuse[3]?i.diffuse:null,specular:0!==i.specular[0]||0!==i.specular[1]||0!==i.specular[2]?i.specular:null,shininess:0!==i.shininess?i.shininess:null,ambient:0!==i.ambient[0]||0!==i.ambient[1]||0!==i.ambient[2]?i.ambient:null,edgeColor:0!==i.edgeColor[0]||0!==i.edgeColor[1]||0!==i.edgeColor[2]||0!==i.edgeColor[3]?i.edgeColor:null,edgeSize:0!==i.edgeSize?i.edgeSize:null,textureColor:0!==i.textureColor[0]||0!==i.textureColor[1]||0!==i.textureColor[2]||0!==i.textureColor[3]?i.textureColor:null,sphereTextureColor:0!==i.sphereTextureColor[0]||0!==i.sphereTextureColor[1]||0!==i.sphereTextureColor[2]||0!==i.sphereTextureColor[3]?i.sphereTextureColor:null,toonTextureColor:0!==i.toonTextureColor[0]||0!==i.toonTextureColor[1]||0!==i.toonTextureColor[2]||0!==i.toonTextureColor[3]?i.toonTextureColor:null}}a=t}else a=[];break;case M.Morph.Type.UvMorph:case M.Morph.Type.AdditionalUvMorph1:case M.Morph.Type.AdditionalUvMorph2:case M.Morph.Type.AdditionalUvMorph3:case M.Morph.Type.AdditionalUvMorph4:case M.Morph.Type.VertexMorph:s=r.morphTargets}const d={name:r.name,type:r.type,materialElements:a,elements:s,elements2:l,elements3:h};i.push(d)}return i}_groupMorphForeach(e,t){const n=this._morphs,i=e.elements,o=e.elements2;for(let e=0;e<i.length;++e){const r=i[e],a=o[e],s=n[r];void 0!==s&&s.type!==M.Morph.Type.GroupMorph&&t(s,a)}}_resetMorph(e){switch(e.type){case M.Morph.Type.GroupMorph:this._groupMorphForeach(e,((e,t)=>this._resetMorph(e)));break;case M.Morph.Type.BoneMorph:this._resetBoneMorph(e);break;case M.Morph.Type.MaterialMorph:{const t=e.materialElements;for(let e=0;e<t.length;++e){const n=t[e],i=this._materials;if(-1===n.index)for(let e=0;e<i.length;++e)i[e]?.reset();else i[n.index]?.reset()}}break;case M.Morph.Type.VertexMorph:case M.Morph.Type.UvMorph:case M.Morph.Type.AdditionalUvMorph1:case M.Morph.Type.AdditionalUvMorph2:case M.Morph.Type.AdditionalUvMorph3:case M.Morph.Type.AdditionalUvMorph4:{const t=e.elements;for(let e=0;e<t.length;++e)t[e].influence=0}}}_applyMorph(e,t){switch(e.type){case M.Morph.Type.GroupMorph:this._groupMorphForeach(e,((e,n)=>this._applyMorph(e,t*n)));break;case M.Morph.Type.BoneMorph:this._applyBoneMorph(e,t);break;case M.Morph.Type.MaterialMorph:{const n=e.materialElements;for(let e=0;e<n.length;++e){const i=n[e],o=this._materials;if(-1===i.index)for(let e=0;e<o.length;++e){const n=o[e];void 0!==n&&this._applyMaterialMorph(i,n,t)}else{const e=o[i.index];void 0!==e&&this._applyMaterialMorph(i,e,t)}}}break;case M.Morph.Type.VertexMorph:case M.Morph.Type.UvMorph:case M.Morph.Type.AdditionalUvMorph1:case M.Morph.Type.AdditionalUvMorph2:case M.Morph.Type.AdditionalUvMorph3:case M.Morph.Type.AdditionalUvMorph4:{const n=e.elements;for(let e=0;e<n.length;++e)n[e].influence+=t}}}_applyMaterialMorph(e,t,n){if(e.type===M.Morph.MaterialMorph.Type.Multiply){if(null!==e.diffuse){const i=t.diffuse;for(let t=0;t<4;++t)i[t]=i[t]+(i[t]*e.diffuse[t]-i[t])*n}if(null!==e.specular){const i=t.specular;for(let t=0;t<3;++t)i[t]=i[t]+(i[t]*e.specular[t]-i[t])*n}if(null!==e.shininess&&(t.shininess=t.shininess+(t.shininess*e.shininess-t.shininess)*n),null!==e.ambient){const i=t.ambient;for(let t=0;t<3;++t)i[t]=i[t]+(i[t]*e.ambient[t]-i[t])*n}if(null!==e.edgeColor){const i=t.edgeColor;for(let t=0;t<4;++t)i[t]=i[t]+(i[t]*e.edgeColor[t]-i[t])*n}if(null!==e.edgeSize&&(t.edgeSize=t.edgeSize+(t.edgeSize*e.edgeSize-t.edgeSize)*n),null!==e.textureColor){const i=t.textureMultiplicativeColor;for(let t=0;t<4;++t)i[t]=i[t]+(i[t]*e.textureColor[t]-i[t])*n}if(null!==e.sphereTextureColor){const i=t.sphereTextureMultiplicativeColor;for(let t=0;t<4;++t)i[t]=i[t]+(i[t]*e.sphereTextureColor[t]-i[t])*n}if(null!==e.toonTextureColor){const i=t.toonTextureMultiplicativeColor;for(let t=0;t<4;++t)i[t]=i[t]+(i[t]*e.toonTextureColor[t]-i[t])*n}}else{if(null!==e.diffuse){const i=t.diffuse;for(let t=0;t<4;++t)i[t]+=e.diffuse[t]*n}if(null!==e.specular){const i=t.specular;for(let t=0;t<3;++t)i[t]+=e.specular[t]*n}if(null!==e.shininess&&(t.shininess+=e.shininess*n),null!==e.ambient){const i=t.ambient;for(let t=0;t<3;++t)i[t]+=e.ambient[t]*n}if(null!==e.edgeColor){const i=t.edgeColor;for(let t=0;t<4;++t)i[t]+=e.edgeColor[t]*n}if(null!==e.edgeSize&&(t.edgeSize+=e.edgeSize*n),null!==e.textureColor){const i=t.textureAdditiveColor;for(let t=0;t<4;++t)i[t]+=e.textureColor[t]*n}if(null!==e.sphereTextureColor){const i=t.sphereTextureAdditiveColor;for(let t=0;t<4;++t)i[t]+=e.sphereTextureColor[t]*n}if(null!==e.toonTextureColor){const i=t.toonTextureAdditiveColor;for(let t=0;t<4;++t)i[t]+=e.toonTextureColor[t]*n}}this._updatedMaterials.add(t)}}class Ji extends Xi{_wasmMorphWeights;_wasmMorphIndexMap;constructor(e,t,n,i,o,r,a){super(null,n,i,o,r,a),this._wasmMorphWeights=e,this._wasmMorphIndexMap=t}setMorphWeight(e,t){const n=this._morphIndexMap.get(e);if(void 0===n)return;const i=this._morphWeights,o=this._wasmMorphWeights.array,r=this._wasmMorphIndexMap;for(let e=0;e<n.length;++e){const a=n[e];i[a]=t,o[r[a]]=t}0!==t&&this._activeMorphs.add(e)}setMorphWeightFromIndex(e,t,n=!0){this._morphWeights[e]=t,n&&(this._wasmMorphWeights.array[this._wasmMorphIndexMap[e]]=t),0!==t&&this._activeMorphs.add(this._morphs[e].name)}resetMorphWeights(){super.resetMorphWeights(),this._wasmMorphWeights.array.fill(0)}syncWasmMorphWeights(){const e=this._morphWeights,t=this._wasmMorphWeights.array,n=this._wasmMorphIndexMap;for(let i=0;i<e.length;++i)t[n[i]]=e[i]}_resetBoneMorph(e){}_applyBoneMorph(e,t){}get wasmMorphIndexMap(){return this._wasmMorphIndexMap}}class Zi{diffuse;specular;shininess;ambient;edgeColor;edgeSize;textureMultiplicativeColor;textureAdditiveColor;sphereTextureMultiplicativeColor;sphereTextureAdditiveColor;toonTextureMultiplicativeColor;toonTextureAdditiveColor;_material;_referencedMeshes;_initialDiffuse;_initialSpecular;_initialShininess;_initialAmbient;_initialEdgeColor;_initialEdgeSize;_initialTextureMultiplicativeColor;_initialTextureAdditiveColor;_initialSphereTextureMultiplicativeColor;_initialSphereTextureAdditiveColor;_initialToonTextureMultiplicativeColor;_initialToonTextureAdditiveColor;_initialTransparencyMode;constructor(e,t){this._material=e,this._referencedMeshes=t;const n=e.diffuseColor;this.diffuse=[n.r,n.g,n.b,e.alpha];const i=e.specularColor;this.specular=[i.r,i.g,i.b],this.shininess=e.specularPower;const o=e.ambientColor;this.ambient=[o.r,o.g,o.b];const r=e.outlineColor;this.edgeColor=[r.r,r.g,r.b,e.outlineAlpha],this.edgeSize=e.outlineWidth,this.textureMultiplicativeColor=[1,1,1,1],this.textureAdditiveColor=[0,0,0,0],this.sphereTextureMultiplicativeColor=[1,1,1,1],this.sphereTextureAdditiveColor=[0,0,0,0],this.toonTextureMultiplicativeColor=[1,1,1,1],this.toonTextureAdditiveColor=[0,0,0,0],this._initialDiffuse=[...this.diffuse],this._initialSpecular=[...this.specular],this._initialShininess=this.shininess,this._initialAmbient=[...this.ambient],this._initialEdgeColor=[...this.edgeColor],this._initialEdgeSize=this.edgeSize,this._initialTextureMultiplicativeColor=[...this.textureMultiplicativeColor],this._initialTextureAdditiveColor=[...this.textureAdditiveColor],this._initialSphereTextureMultiplicativeColor=[...this.sphereTextureMultiplicativeColor],this._initialSphereTextureAdditiveColor=[...this.sphereTextureAdditiveColor],this._initialToonTextureMultiplicativeColor=[...this.toonTextureMultiplicativeColor],this._initialToonTextureAdditiveColor=[...this.toonTextureAdditiveColor],this._initialTransparencyMode=e.transparencyMode}reset(){for(let e=0;e<4;++e)this.diffuse[e]=this._initialDiffuse[e],this.edgeColor[e]=this._initialEdgeColor[e],this.textureMultiplicativeColor[e]=this._initialTextureMultiplicativeColor[e],this.textureAdditiveColor[e]=this._initialTextureAdditiveColor[e],this.sphereTextureMultiplicativeColor[e]=this._initialSphereTextureMultiplicativeColor[e],this.sphereTextureAdditiveColor[e]=this._initialSphereTextureAdditiveColor[e],this.toonTextureMultiplicativeColor[e]=this._initialToonTextureMultiplicativeColor[e],this.toonTextureAdditiveColor[e]=this._initialToonTextureAdditiveColor[e];for(let e=0;e<3;++e)this.specular[e]=this._initialSpecular[e],this.ambient[e]=this._initialAmbient[e];this.shininess=this._initialShininess,this.edgeSize=this._initialEdgeSize}applyChanges(){const e=this._material;e.diffuseColor.set(this.diffuse[0],this.diffuse[1],this.diffuse[2]),e.alpha=this.diffuse[3],1===this.diffuse[3]?e.transparencyMode=this._initialTransparencyMode:e.transparencyMode=D.Material.MATERIAL_ALPHABLEND;const t=this._referencedMeshes;if(this.diffuse[3]<=0)for(let e=0;e<t.length;++e)t[e].isVisible=!1;else for(let e=0;e<t.length;++e)t[e].isVisible=!0;e.specularColor.set(this.specular[0],this.specular[1],this.specular[2]),e.specularPower=this.shininess,e.ambientColor.set(this.ambient[0],this.ambient[1],this.ambient[2]),e.outlineColor.set(this.edgeColor[0],this.edgeColor[1],this.edgeColor[2]),e.outlineAlpha=this.edgeColor[3],e.outlineWidth=this.edgeSize;{const t=this.textureMultiplicativeColor;e.textureMultiplicativeColor.set(t[0],t[1],t[2],t[3])}{const t=this.textureAdditiveColor;e.textureAdditiveColor.set(t[0],t[1],t[2],t[3])}{const t=this.sphereTextureMultiplicativeColor;e.sphereTextureMultiplicativeColor.set(t[0],t[1],t[2],t[3])}{const t=this.sphereTextureAdditiveColor;e.sphereTextureAdditiveColor.set(t[0],t[1],t[2],t[3])}{const t=this.toonTextureMultiplicativeColor;e.toonTextureMultiplicativeColor.set(t[0],t[1],t[2],t[3])}{const t=this.toonTextureAdditiveColor;e.toonTextureAdditiveColor.set(t[0],t[1],t[2],t[3])}}}class eo{encodePhysics;constructor(){this.encodePhysics=!0}computeSize(e){let t=12;const n=e.bones;for(let e=0;e<n.length;++e){t+=88;const i=n[e];if(i.appendTransform&&(t+=8),i.ik){t+=16;const e=i.ik.links;for(let n=0;n<e.length;++n)t+=8,e[n].limitation&&(t+=24)}}t+=4;const i=e.morphs;for(let e=0;e<i.length;++e){const n=i[e];switch(n.type){case M.Morph.Type.BoneMorph:{const e=n.indices;t+=8+4*e.length+12*e.length+16*e.length;break}case M.Morph.Type.GroupMorph:{const e=n.indices;t+=8+4*e.length+4*e.length;break}}}if(this.encodePhysics){t+=4;const n=e.rigidBodies;for(let e=0;e<n.length;++e)t+=68;t+=4;const i=e.joints;for(let e=0;e<i.length;++e)t+=108}else t+=8;return t}encode(e,t,n){const i=new Mt(n.buffer);i.offset=n.byteOffset;const o=new c.Vector3,r=e.bones;i.setUint32(r.length);let a=0,s=0;for(let e=0;e<r.length;++e){const t=r[e];t.appendTransform&&(a+=1),t.ik&&(s+=1)}i.setUint32(a),i.setUint32(s);for(let e=0;e<r.length;++e){const n=r[e],a=t[e];if(i.setFloat32Array(a.getRestMatrix().getTranslationToRef(o).asArray()),i.setFloat32Array(a.getAbsoluteInverseBindMatrix().m),i.setInt32(n.parentBoneIndex),i.setInt32(n.transformOrder),i.setUint16(n.flag),i.offset+=2,n.appendTransform&&(i.setInt32(n.appendTransform.parentIndex),i.setFloat32(n.appendTransform.ratio)),n.ik){i.setInt32(n.ik.target),i.setInt32(n.ik.iteration),i.setFloat32(n.ik.rotationConstraint),i.setUint32(n.ik.links.length);const e=n.ik.links;for(let t=0;t<e.length;++t){const n=e[t];i.setInt32(n.target),i.setUint8(n.limitation?1:0),i.offset+=3,n.limitation&&(i.setFloat32Array(n.limitation.minimumAngle),i.setFloat32Array(n.limitation.maximumAngle))}}}const l=e.morphs;let h=0;for(let e=0;e<l.length;++e)switch(l[e].type){case M.Morph.Type.BoneMorph:case M.Morph.Type.GroupMorph:h+=1}const d=new Int32Array(l.length).fill(-1);for(let e=0,t=0;e<l.length;++e){const n=l[e];n.type!==M.Morph.Type.BoneMorph&&n.type!==M.Morph.Type.GroupMorph||(d[e]=t,t+=1)}i.setUint32(h);for(let e=0;e<l.length;++e){const t=l[e];switch(t.type){case M.Morph.Type.BoneMorph:i.setUint8(t.type),i.offset+=3,i.setUint32(t.indices.length),i.setInt32Array(t.indices),i.setFloat32Array(t.positions),i.setFloat32Array(t.rotations);break;case M.Morph.Type.GroupMorph:{i.setUint8(t.type),i.offset+=3,i.setUint32(t.indices.length);const e=t.indices,n=new Int32Array(e.length);for(let t=0;t<n.length;++t)n[t]=d[e[t]];i.setInt32Array(n),i.setFloat32Array(t.ratios)}}}if(this.encodePhysics){const t=new Map;for(let e=0;e<r.length;++e)t.set(r[e].name,e);const n=e.rigidBodies;i.setUint32(n.length);for(let e=0;e<n.length;++e){const o=n[e],a=o.boneIndex<0||r.length<=o.boneIndex?t.get(o.name)??-1:o.boneIndex;i.setInt32(a),i.setUint8(o.collisionGroup),i.setUint8(o.shapeType),i.setUint16(o.collisionMask),i.setFloat32Array(o.shapeSize),i.setFloat32Array(o.shapePosition),i.setFloat32Array(o.shapeRotation),i.setFloat32(o.mass),i.setFloat32(o.linearDamping),i.setFloat32(o.angularDamping),i.setFloat32(o.repulsion),i.setFloat32(o.friction),i.setUint8(o.physicsMode),i.offset+=3}const o=e.joints;i.setUint32(o.length);for(let e=0;e<o.length;++e){const t=o[e];i.setUint8(t.type),i.offset+=3,i.setInt32(t.rigidbodyIndexA),i.setInt32(t.rigidbodyIndexB),i.setFloat32Array(t.position),i.setFloat32Array(t.rotation),i.setFloat32Array(t.positionMin),i.setFloat32Array(t.positionMax),i.setFloat32Array(t.rotationMin),i.setFloat32Array(t.rotationMax),i.setFloat32Array(t.springPosition),i.setFloat32Array(t.springRotation)}}else i.setUint32(0),i.setUint32(0);return d}}class to{_lock;constructor(e){this._lock=e}wait(){const e=this._lock.array;let t=!1;const n=performance.now();for(;0!==Atomics.load(e,0);)t=!0;if(t){const e=performance.now()-n;console.trace(`Spinlock wait time: ${e}ms`)}}}var no;!function(e){e[e.Immediate=0]="Immediate",e[e.Buffered=1]="Buffered"}(no||(no={}));class io{wasmInstance;wasmInternal;lock;_usingWasmBackBuffer;_lastRequestAnimationFrameTime;_needToSyncEvaluate;_mmdMetadataEncoder;_physics;_models;_camera;_audioPlayer;_loggingEnabled;log;warn;error;_isRegistered;onAnimationDurationChangedObservable;onPlayAnimationObservable;onPauseAnimationObservable;onSeekAnimationObservable;onAnimationTickObservable;_evaluationType;_currentFrameTime;_animationTimeScale;_animationPaused;_animationFrameTimeDuration;_useManualAnimationDuration;_needToInitializePhysicsModels;_needToInitializePhysicsModelsBuffer;_beforePhysicsBinded;_afterPhysicsBinded;_bindedDispose;_disposeObservableObject;constructor(e,t=null,n=null){this.wasmInstance=e,this.wasmInternal=e.createMmdRuntime(),this.lock=new to(e.createTypedArray(Uint8Array,this.wasmInternal.getLockStatePtr(),1)),this._usingWasmBackBuffer=!1,this._lastRequestAnimationFrameTime=null,this._needToSyncEvaluate=!0,this._mmdMetadataEncoder=new eo,this._physics=n,this._models=[],this._camera=null,this._audioPlayer=null,this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._isRegistered=!1,this.onAnimationDurationChangedObservable=new V.Observable,this.onPlayAnimationObservable=new V.Observable,this.onPauseAnimationObservable=new V.Observable,this.onSeekAnimationObservable=new V.Observable,this.onAnimationTickObservable=new V.Observable,this._evaluationType=no.Immediate,this._currentFrameTime=0,this._animationTimeScale=1,this._animationPaused=!0,this._animationFrameTimeDuration=0,this._useManualAnimationDuration=!1,this._needToInitializePhysicsModels=new Set,this._needToInitializePhysicsModelsBuffer=new Set,this._beforePhysicsBinded=null,this._afterPhysicsBinded=this.afterPhysics.bind(this),null!==t?(this._bindedDispose=()=>this.dispose(t),this._disposeObservableObject=t,null!==this._disposeObservableObject&&this._disposeObservableObject.onDisposeObservable.add(this._bindedDispose)):(this._bindedDispose=null,this._disposeObservableObject=null)}dispose(e){this.lock.wait();for(let e=0;e<this._models.length;++e)this._models[e].dispose();this._models.length=0,this.setCamera(null),this.setAudioPlayer(null),this.onAnimationDurationChangedObservable.clear(),this.onPlayAnimationObservable.clear(),this.onPauseAnimationObservable.clear(),this.onSeekAnimationObservable.clear(),this.onAnimationTickObservable.clear(),this._needToInitializePhysicsModels.clear(),this.unregister(e),this.wasmInternal.free(),null!==this._disposeObservableObject&&null!==this._bindedDispose&&this._disposeObservableObject.onDisposeObservable.removeCallback(this._bindedDispose)}createMmdModel(e,t={}){if(!yt.isMmdSkinnedMesh(e))throw new Error("Mesh validation failed.");return this.createMmdModelFromSkeleton(e,e.metadata.skeleton,t)}createMmdModelFromSkeleton(e,t,n={}){void 0===n.materialProxyConstructor&&(n.materialProxyConstructor=Zi),void 0===n.buildPhysics&&(n.buildPhysics=!0),this.lock.wait();const i=this._usingWasmBackBuffer;i&&(this.wasmInternal.swapWorldMatrixBuffer(),this._usingWasmBackBuffer=!1);const o=this._mmdMetadataEncoder;o.encodePhysics=n.buildPhysics;const r=o.computeSize(e.metadata),a=this.wasmInternal,s=a.allocateBuffer(r),l=this.wasmInstance.createTypedArray(Uint8Array,s,r),h=o.encode(e.metadata,t.bones,l.array),d=a.createMmdModel(s,r),c=new so(this,d,e,t,n.materialProxyConstructor,h,n.buildPhysics?this._physics:null);return this._models.push(c),(this._evaluationType===no.Buffered?this._needToInitializePhysicsModelsBuffer:this._needToInitializePhysicsModels).add(c),a.deallocateBuffer(s,r),i&&(this.wasmInternal.swapWorldMatrixBuffer(),this._usingWasmBackBuffer=!0),this._needToSyncEvaluate=!0,c.onCurrentAnimationChangedObservable.add(this._onAnimationChanged),c}destroyMmdModel(e){e.dispose();const t=this._models,n=t.indexOf(e);if(n<0)throw new Error("Model not found.");t.splice(n,1),this.lock.wait(),this.wasmInternal.destroyMmdModel(e.ptr)}setCamera(e){null!==this._camera&&this._camera.onCurrentAnimationChangedObservable.removeCallback(this._onAnimationChanged),null!==e&&e.onCurrentAnimationChangedObservable.add(this._onAnimationChanged),this._camera=e,this._onAnimationChanged(e?.currentAnimation??null)}_setAudioPlayerLastValue=null;async setAudioPlayer(e){if(this._audioPlayer!==e&&(this._setAudioPlayerLastValue=e,null!==this._audioPlayer&&(this._audioPlayer.onDurationChangedObservable.removeCallback(this._onAudioDurationChanged),this._audioPlayer.onPlaybackRateChangedObservable.removeCallback(this._onAudioPlaybackRateChanged),this._audioPlayer.onPlayObservable.removeCallback(this._onAudioPlay),this._audioPlayer.onPauseObservable.removeCallback(this._onAudioPause),this._audioPlayer.onSeekObservable.removeCallback(this._onAudioSeek),this._audioPlayer.pause()),this._audioPlayer=null,null!==e)){if(!this._animationPaused){const t=30*e.duration;if(this._currentFrameTime<t&&(e.currentTime=this._currentFrameTime/30,await e.play(),this._setAudioPlayerLastValue!==e))return void e.pause()}this._audioPlayer=e,this._onAudioDurationChanged(),e.onDurationChangedObservable.add(this._onAudioDurationChanged),e.onPlaybackRateChangedObservable.add(this._onAudioPlaybackRateChanged),e.onPlayObservable.add(this._onAudioPlay),e.onPauseObservable.add(this._onAudioPause),e.onSeekObservable.add(this._onAudioSeek),e._setPlaybackRateWithoutNotify(this._animationTimeScale)}}register(e){this._isRegistered||(this._isRegistered=!0,this._beforePhysicsBinded=()=>this.beforePhysics(e.getEngine().getDeltaTime()),e.onBeforeAnimationsObservable.add(this._beforePhysicsBinded),e.onBeforeRenderObservable.add(this._afterPhysicsBinded))}unregister(e){this._isRegistered&&(this._isRegistered=!1,e.onBeforeAnimationsObservable.removeCallback(this._beforePhysicsBinded),e.onBeforeRenderObservable.removeCallback(this._afterPhysicsBinded),this._beforePhysicsBinded=null)}beforePhysics(e){let t=null;if(!this._animationPaused){if(null===this._audioPlayer||this._audioPlayer.paused)this._currentFrameTime+=e/1e3*30*this._animationTimeScale;else{const t=this._audioPlayer.currentTime,n=t-this._currentFrameTime/30,i=Math.abs(n);if(i<.05)this._currentFrameTime+=e/1e3*30*this._animationTimeScale;else if(i<.5)this._currentFrameTime+=n<0?e/1e3*30*this._animationTimeScale*.9:e/1e3*30*this._animationTimeScale*1.1;else{if(60<Math.abs(t-this._currentFrameTime)){const e=this._needToInitializePhysicsModels;for(let t=0;t<this._models.length;++t){const n=this._models[t];null!==n.currentAnimation&&e.add(n)}}this._currentFrameTime=30*t}}t=this._currentFrameTime,this._animationFrameTimeDuration<=t&&(this._animationPaused=!0,this._currentFrameTime=this._animationFrameTimeDuration,null===this._audioPlayer||this._audioPlayer.paused?this.onPauseAnimationObservable.notifyObservers():this._audioPlayer.pause())}if(this._evaluationType===no.Buffered){const e=this._models;{const n=this._lastRequestAnimationFrameTime??t;for(let t=0;t<e.length;++t){const i=e[t];void 0!==i.currentAnimation?.wasmAnimate&&e[t].beforePhysicsAndWasm(n)}null!==n&&null!==this._camera&&this._camera.animate(n)}if(void 0===this.wasmInstance.MmdRuntime.bufferedUpdate&&(this.wasmInternal.beforePhysics(this._lastRequestAnimationFrameTime??void 0),null===this._physics&&this.wasmInternal.afterPhysics()),this.lock.wait(),!1===this._usingWasmBackBuffer&&(this._usingWasmBackBuffer=!0,this.wasmInternal.swapWorldMatrixBuffer()),null===this._lastRequestAnimationFrameTime)if(null!==t){for(let n=0;n<e.length;++n){const i=e[n];void 0===i.currentAnimation?.wasmAnimate&&e[n].beforePhysicsAndWasm(t)}this.wasmInternal.beforePhysics(t??void 0),null===this._physics&&this.wasmInternal.afterPhysics()}else this._needToSyncEvaluate&&(this._needToSyncEvaluate=!1,this.wasmInternal.beforePhysics(),null===this._physics&&this.wasmInternal.afterPhysics());else if(this._needToSyncEvaluate){this._needToSyncEvaluate=!1;for(let t=0;t<e.length;++t){const n=e[t];void 0===n.currentAnimation?.wasmAnimate&&e[t].beforePhysicsAndWasm(this._lastRequestAnimationFrameTime)}this.wasmInternal.beforePhysics(this._lastRequestAnimationFrameTime),null===this._physics&&this.wasmInternal.afterPhysics()}for(let t=0;t<e.length;++t)e[t].swapWorldTransformMatricesBuffer();this.wasmInternal.swapWorldMatrixBuffer();for(let t=0;t<e.length;++t)e[t].beforePhysics();for(let n=0;n<e.length;++n){const i=e[n];void 0===i.currentAnimation?.wasmAnimate&&e[n].beforePhysicsAndWasm(t)}null===this._physics&&this.wasmInstance.MmdRuntime.bufferedUpdate?.(this.wasmInternal,t??void 0),this._lastRequestAnimationFrameTime=t;const n=this._needToInitializePhysicsModelsBuffer;for(const e of n)e.initializePhysics();n.clear();const i=this._needToInitializePhysicsModels;for(const e of i)n.add(e);i.clear()}else{if(!0===this._usingWasmBackBuffer){const e=this._needToInitializePhysicsModelsBuffer,t=this._needToInitializePhysicsModels;for(const n of e)t.add(n);this.lock.wait(),this._usingWasmBackBuffer=!1,this._lastRequestAnimationFrameTime=null,this.wasmInternal.swapWorldMatrixBuffer()}const e=this._models;for(let n=0;n<e.length;++n)e[n].beforePhysicsAndWasm(t);this.wasmInternal.beforePhysics(t??void 0);for(let t=0;t<e.length;++t)e[t].beforePhysics();this._needToSyncEvaluate=!1;const n=this._needToInitializePhysicsModels;for(const e of n)e.initializePhysics();n.clear(),null!==t&&null!==this._camera&&this._camera.animate(t)}null!==t&&this.onAnimationTickObservable.notifyObservers()}afterPhysics(){const e=this._models;if(this._usingWasmBackBuffer){for(let t=0;t<e.length;++t){const n=e[t];n.afterPhysicsAndWasm(),n.afterPhysics()}null!==this._physics&&(this.wasmInternal.swapWorldMatrixBuffer(),this.wasmInternal.afterPhysics(),this.wasmInternal.swapWorldMatrixBuffer(),this.wasmInstance.MmdRuntime.bufferedBeforePhysics?.(this.wasmInternal,this._lastRequestAnimationFrameTime??void 0))}else{for(let t=0;t<e.length;++t)e[t].afterPhysicsAndWasm();this.wasmInternal.afterPhysics();for(let t=0;t<e.length;++t)e[t].afterPhysics()}}_onAnimationChanged=e=>{if(this._useManualAnimationDuration)return;const t=e?.animation.endFrame??0;this._animationFrameTimeDuration<t?this._animationFrameTimeDuration=t:t<this._animationFrameTimeDuration&&(this._animationFrameTimeDuration=this._computeAnimationDuration()),this.onAnimationDurationChangedObservable.notifyObservers()};_computeAnimationDuration(){let e=0;const t=this._models;for(let n=0;n<t.length;++n){const i=t[n];null!==i.currentAnimation&&(e=Math.max(e,i.currentAnimation.animation.endFrame))}return null!==this._camera&&null!==this._camera.currentAnimation&&(e=Math.max(e,this._camera.currentAnimation.animation.endFrame)),null!==this._audioPlayer&&(e=Math.max(e,30*this._audioPlayer.duration)),e}_onAudioDurationChanged=()=>{if(!this._animationPaused){const e=this._audioPlayer,t=this._currentFrameTime/30;t<e.duration&&(e._setCurrentTimeWithoutNotify(t),e.play().then((()=>{this._setAudioPlayerLastValue===e||e.pause()})))}if(this._useManualAnimationDuration)return;const e=30*this._audioPlayer.duration;this._animationFrameTimeDuration<e?this._animationFrameTimeDuration=e:this._animationFrameTimeDuration=this._computeAnimationDuration(),this.onAnimationDurationChangedObservable.notifyObservers()};_onAudioPlaybackRateChanged=()=>{this._animationTimeScale=this._audioPlayer.playbackRate};_onAudioPlay=()=>{this._playAnimationInternal()};_onAudioPause=()=>{this._audioPlayer.currentTime!==this._audioPlayer.duration&&(this._animationPaused=!0,this.onPauseAnimationObservable.notifyObservers())};_onAudioSeek=()=>{this._seekAnimationInternal(30*this._audioPlayer.currentTime,this._animationPaused)};_playAnimationInternal(){if(this._animationPaused){if(this._animationPaused=!1,0===this._currentFrameTime){const e=this._models,t=this._evaluationType===no.Buffered?this._needToInitializePhysicsModelsBuffer:this._needToInitializePhysicsModels;for(let n=0;n<e.length;++n)t.add(e[n])}this.onPlayAnimationObservable.notifyObservers()}}async playAnimation(){if(null!==this._audioPlayer&&this._currentFrameTime<30*this._audioPlayer.duration)try{const e=this._currentFrameTime/30;.05<Math.abs(this._audioPlayer.currentTime-e)&&this._audioPlayer._setCurrentTimeWithoutNotify(e),await this._audioPlayer.play()}catch(e){if(!(e instanceof DOMException&&"NotSupportedError"===e.name))throw e;this.error("Failed to play audio."),this._playAnimationInternal()}else this._playAnimationInternal()}pauseAnimation(){null===this._audioPlayer||this._audioPlayer.paused?(this._animationPaused=!0,this.onPauseAnimationObservable.notifyObservers()):(this._audioPlayer.pause(),this._animationPaused=!0)}_seekAnimationInternal(e,t){if(60<Math.abs(e-this._currentFrameTime)){const e=this._evaluationType===no.Buffered?this._needToInitializePhysicsModelsBuffer:this._needToInitializePhysicsModels;for(let t=0;t<this._models.length;++t){const n=this._models[t];null!==n.currentAnimation&&e.add(n)}}if(this._currentFrameTime=e,t){const t=this._models;if(this._evaluationType===no.Buffered)this._lastRequestAnimationFrameTime=e,this._needToSyncEvaluate=!0;else{this.lock.wait();for(let n=0;n<t.length;++n){const i=t[n].currentAnimation;null!==i&&(void 0!==i.wasmAnimate?(i.wasmAnimate(e),i.animate(e)):i.animate(e))}}null!==this._camera&&null!==this._camera.currentAnimation&&this._camera.animate(e),this.onAnimationTickObservable.notifyObservers()}this.onSeekAnimationObservable.notifyObservers()}async seekAnimation(e,t=!1){if(e=Math.max(0,Math.min(e,this._animationFrameTimeDuration)),null!==this._audioPlayer)if(this._audioPlayer.paused)if(!this._animationPaused&&30*this._audioPlayer.currentTime<this._animationFrameTimeDuration&&e<30*this._audioPlayer.duration)try{this._audioPlayer._setCurrentTimeWithoutNotify(e/30),await this._audioPlayer.play()}catch(n){if(!(n instanceof DOMException&&"NotSupportedError"===n.name))throw n;this.error("Failed to play audio."),this._seekAnimationInternal(e,t)}else this._seekAnimationInternal(e,t),this._audioPlayer?._setCurrentTimeWithoutNotify(e/30);else this._audioPlayer.currentTime=e/30;else this._seekAnimationInternal(e,t)}get isAnimationPlaying(){return!this._animationPaused}get models(){return this._models}get camera(){return this._camera}get audioPlayer(){return this._audioPlayer}get timeScale(){return this._animationTimeScale}set timeScale(e){this._animationTimeScale=e,null!==this._audioPlayer&&this._audioPlayer._setPlaybackRateWithoutNotify(e)}get currentFrameTime(){return this._currentFrameTime}get currentTime(){return this._currentFrameTime/30}get animationFrameTimeDuration(){return this._animationFrameTimeDuration}get animationDuration(){return this._animationFrameTimeDuration/30}setManualAnimationDuration(e){(null!==e||this._useManualAnimationDuration)&&(null===e?(this._useManualAnimationDuration=!1,this._animationFrameTimeDuration=this._computeAnimationDuration()):(this._useManualAnimationDuration=!0,this._animationFrameTimeDuration=e),this.onAnimationDurationChangedObservable.notifyObservers())}get evaluationType(){return this._evaluationType}set evaluationType(e){if(this._evaluationType===e)return;no.Buffered,this._evaluationType=e;const t=this._models;for(let n=0;n<t.length;++n)t[n].onEvaluationTypeChanged(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){N.Logger.Log(e)}_logDisabled(){}_warnEnabled(e){N.Logger.Warn(e)}_warnDisabled(){}_errorEnabled(e){N.Logger.Error(e)}_errorDisabled(){}}class oo{_frontBuffer;_backBuffer;constructor(e,t){this._frontBuffer=e,this._backBuffer=t??e}setBackBuffer(e){this._backBuffer=e}swap(){const e=this._backBuffer;this._backBuffer=this._frontBuffer,this._frontBuffer=e}get frontBuffer(){return this._frontBuffer.array}get backBuffer(){return this._backBuffer.array}}class ro{_data;_frontBufferPtr;_frontBufferSpan;_backBufferSpan;constructor(e,t,n,i){this._data=t;const o=this._frontBufferPtr=t.frontBuffer.byteOffset;this._frontBufferSpan=e.createTypedArray(t.frontBuffer.constructor,o+n,i);const r=t.backBuffer.byteOffset;this._backBufferSpan=e.createTypedArray(t.backBuffer.constructor,r+n,i)}updateBackBufferReference(e){const t=this._frontBufferSpan.array,n=t.byteOffset-this._frontBufferPtr,i=t.length,o=this._data.backBuffer.byteOffset;this._backBufferSpan=e.createTypedArray(this._data.backBuffer.constructor,o+n,i)}get array(){if(this._frontBufferPtr!==this._data.frontBuffer.byteOffset){this._frontBufferPtr=this._data.frontBuffer.byteOffset;const e=this._backBufferSpan;this._backBufferSpan=this._frontBufferSpan,this._frontBufferSpan=e}return this._frontBufferSpan.array}}class ao{linkedBone;name;parentBone;childBones;transformOrder;flag;transformAfterPhysics;_worldMatrix;get worldMatrix(){return this._worldMatrix.array}ikSolverIndex;constructor(e,t,n,i,o,r){this.linkedBone=e,this.name=t.name,this.parentBone=null,this.childBones=[],this.transformOrder=t.transformOrder,this.flag=t.flag,this.transformAfterPhysics=0!=(t.flag&M.Bone.Flag.TransformAfterPhysics),this._worldMatrix=new ro(r.wasmInstance,n,16*i*4,16),this.ikSolverIndex=o}updateBackBufferReference(e){this._worldMatrix.updateBackBufferReference(e)}getWorldMatrixToRef(e){return c.Matrix.FromArrayToRef(this._worldMatrix.array,0,e)}getWorldTranslationToRef(e){return c.Vector3.FromArrayToRef(this._worldMatrix.array,12,e)}setWorldTranslationFromRef(e){const t=this._worldMatrix.array;t[12]=e.x,t[13]=e.y,t[14]=e.z}}class so{ptr;mesh;skeleton;_worldTransformMatrices;get worldTransformMatrices(){return this._worldTransformMatrices.frontBuffer}_boneAnimationStates;get boneAnimationStates(){return this._runtime.lock.wait(),this._boneAnimationStates.array}_ikSolverStates;get ikSolverStates(){return this._runtime.lock.wait(),this._ikSolverStates.array}runtimeBones;morph;_physicsModel;_runtime;_sortedRuntimeBones;onCurrentAnimationChangedObservable;_animations;_animationIndexMap;_currentAnimation;_needStateReset;constructor(e,t,n,i,o,r,a){const s=e.wasmInstance,l=e.wasmInternal;this._runtime=e;const h=n.metadata,d=n;d.metadata={isRuntimeMmdModel:!0,header:h.header,meshes:h.meshes,materials:h.materials,skeleton:h.skeleton},this.ptr=t,this.mesh=d,this.skeleton=i;const c=l.getBoneWorldMatrixArena(t),m=l.getAnimationArena(t),u=l.getAnimationIkSolverStateArena(t),p=l.getAnimationMorphArena(t),g=s.createTypedArray(Float32Array,c,16*h.bones.length);let f=g;if(e.evaluationType===no.Buffered){const e=l.createBoneWorldMatrixBackBuffer(this.ptr);f=s.createTypedArray(Float32Array,e,16*h.bones.length)}const _=this._worldTransformMatrices=new oo(g,f);this._boneAnimationStates=s.createTypedArray(Float32Array,m,12*h.bones.length);let b=0;for(let e=0;e<h.bones.length;++e)h.bones[e].ik&&(b+=1);this._ikSolverStates=s.createTypedArray(Uint8Array,u,b),i.prepare(),this._disableSkeletonWorldMatrixUpdate(i);const y=this.runtimeBones=this._buildRuntimeSkeleton(i.bones,h.bones,_,e);(this._sortedRuntimeBones=[...y]).sort(((e,t)=>e.transformOrder-t.transformOrder));const A=h.morphs;let T=0;for(let e=0;e<A.length;++e)switch(A[e].type){case M.Morph.Type.BoneMorph:case M.Morph.Type.GroupMorph:T+=1}const w=s.createTypedArray(Float32Array,p,T),x=[];{const e=h.meshes;for(let t=0;t<e.length;++t){const n=e[t].morphTargetManager;null!==n&&x.push(n)}}this.morph=new Ji(w,r,h.materials,h.meshes,o,h.morphs,x),null!==a?(l.setExternalPhysics(t,!0),this._physicsModel=a.buildPhysics(n,y,h.rigidBodies,h.joints,e)):this._physicsModel=null,this.onCurrentAnimationChangedObservable=new V.Observable,this._animations=[],this._animationIndexMap=new Map,this._currentAnimation=null,this._needStateReset=!1}dispose(){this._enableSkeletonWorldMatrixUpdate(),this._physicsModel?.dispose(),this.onCurrentAnimationChangedObservable.clear();const e=this._animations;for(let t=0;t<e.length;++t)e[t].dispose?.();this._animations.length=0,this._animationIndexMap.clear(),this.mesh.metadata=null}get sortedRuntimeBones(){return this._sortedRuntimeBones}addAnimation(e,t){let n;if(void 0!==e.createWasmRuntimeModelAnimation)this._runtime.lock.wait(),n=e.createWasmRuntimeModelAnimation(this,(()=>{this._removeAnimationByReference(n)}),t,this._runtime);else{if(void 0===e.createRuntimeModelAnimation)throw new Error('animation is not MmdWasmAnimation or MmdAnimation or MmdModelAnimationGroup or MmdCompositeAnimation. are you missing import "babylon-mmd/esm/Runtime/Optimized/Animation/mmdWasmRuntimeModelAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimationGroup" or "babylon-mmd/esm/Runtime/Animation/mmdCompositeRuntimeModelAnimation"?');n=e.createRuntimeModelAnimation(this,t,this._runtime),void 0!==e.ptr&&this._runtime.warn('MmdWasmAnimation has better performance in the wasm animation runtime. consider importing "babylon-mmd/esm/Runtime/Optimized/Animation/mmdWasmRuntimeModelAnimation" instead of "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimation"')}const i=this._animationIndexMap.get(e.name);void 0!==i?this._animations[i]=n:(this._animationIndexMap.set(e.name,this._animations.length),this._animations.push(n))}_removeAnimationByReference(e){const t=this._animations.indexOf(e);-1!==t&&this._removeAnimation(t,!0)}removeAnimation(e){this._removeAnimation(e,!1)}_removeAnimation(e,t){const n=this._animations[e];void 0!==n&&(this._currentAnimation===n&&(this._resetPose(),void 0!==this._currentAnimation.wasmAnimate&&(this._runtime.lock.wait(),this._runtime.wasmInternal.setRuntimeAnimation(this.ptr,0)),this._currentAnimation=null,this.onCurrentAnimationChangedObservable.notifyObservers(null)),this._animationIndexMap.delete(n.animation.name),this._animations.splice(e,1),t||n.dispose?.())}setAnimation(e,t=!0){if(null===e)return void(null!==this._currentAnimation&&(this._resetPose(),void 0!==this._currentAnimation.wasmAnimate&&(this._runtime.lock.wait(),this._runtime.wasmInternal.setRuntimeAnimation(this.ptr,0)),this._currentAnimation=null,this.onCurrentAnimationChangedObservable.notifyObservers(null)));const n=this._animationIndexMap.get(e);if(void 0===n)throw new Error(`Animation '${e}' is not found.`);null!==this._currentAnimation&&(this._resetPose(),this._needStateReset=!0);const i=this._currentAnimation=this._animations[n];void 0!==i.wasmAnimate&&(this._runtime.lock.wait(),this._runtime.wasmInternal.setRuntimeAnimation(this.ptr,i.ptr)),i.induceMaterialRecompile(t,this._runtime),this.onCurrentAnimationChangedObservable.notifyObservers(i)}get runtimeAnimations(){return this._animations}get currentAnimation(){return this._currentAnimation}initializePhysics(){this._physicsModel?.initialize()}beforePhysicsAndWasm(e){if(null!==e&&(this._needStateReset&&(this._needStateReset=!1,this.ikSolverStates.fill(1),this.morph.resetMorphWeights()),null!==this._currentAnimation&&this._currentAnimation.animate(e)),this.morph.update(),void 0===this._currentAnimation?.wasmAnimate){const e=this.skeleton.bones,t=this.boneAnimationStates;for(let n=0;n<e.length;++n){const i=e[n],o=12*n;{const{x:e,y:n,z:r}=i.position;t[o+0]=e,t[o+1]=n,t[o+2]=r}{const{x:e,y:n,z:r,w:a}=i.rotationQuaternion;t[o+4]=e,t[o+5]=n,t[o+6]=r,t[o+7]=a}{const{x:e,y:n,z:r}=i.scaling;t[o+8]=e,t[o+9]=n,t[o+10]=r}}}}beforePhysics(){this._physicsModel?.syncBodies()}afterPhysicsAndWasm(){const e=this._physicsModel;null!==e&&e.syncBones()}afterPhysics(){this.mesh.metadata.skeleton._markAsDirty()}_buildRuntimeSkeleton(e,t,n,i){const o=[];let r=0;for(let a=0;a<t.length;++a){const s=t[a];let l=-1;void 0!==s.ik&&(l=r,r+=1),o.push(new ao(e[a],s,n,a,l,i))}for(let e=0;e<t.length;++e){const n=t[e],i=o[e],r=n.parentBoneIndex;if(0<=r&&r<o.length){const e=o[r];i.parentBone=e,e.childBones.push(i)}}return o}_originalComputeTransformMatrices=null;_disableSkeletonWorldMatrixUpdate(e){if(null!==this._originalComputeTransformMatrices)return;this._originalComputeTransformMatrices=e._computeTransformMatrices;const t=this._worldTransformMatrices;e._computeTransformMatrices=function(e,n){this.onBeforeComputeObservable.notifyObservers(this);const i=t.frontBuffer;for(let t=0;t<this.bones.length;t++){const n=this.bones[t];if(n._childUpdateId+=1,-1!==n._index){const o=null===n._index?t:n._index;n.getAbsoluteInverseBindMatrix().multiplyToArray(c.Matrix.FromArrayToRef(i,16*t,n.getFinalMatrix()),e,16*o)}}this._identity.copyToArray(e,16*this.bones.length)}}_enableSkeletonWorldMatrixUpdate(){null!==this._originalComputeTransformMatrices&&(this.skeleton._computeTransformMatrices=this._originalComputeTransformMatrices,this._originalComputeTransformMatrices=null)}_resetPose(){const e=new c.Vector3;if(void 0===this._currentAnimation?.wasmAnimate){const t=this._sortedRuntimeBones,n=c.Quaternion.Identity();for(let i=0;i<t.length;++i){const o=t[i].linkedBone;o.getRestMatrix().getTranslationToRef(e),o.position=e,o.setRotationQuaternion(n,Ye.Space.LOCAL)}}else{this._runtime.lock.wait();const t=this.skeleton.bones,n=this.boneAnimationStates;for(let i=0;i<t.length;++i){const o=t[i],r=12*i,{x:a,y:s,z:l}=o.getRestMatrix().getTranslationToRef(e);n[r+0]=a,n[r+1]=s,n[r+2]=l,n[r+4]=0,n[r+5]=0,n[r+6]=0,n[r+7]=1,n[r+8]=1,n[r+9]=1,n[r+10]=1}}this.mesh.metadata.skeleton._markAsDirty()}onEvaluationTypeChanged(e){if(e===no.Buffered){const e=this._worldTransformMatrices;if(e.frontBuffer===e.backBuffer){const t=this._runtime.wasmInstance,n=this._runtime.wasmInternal.createBoneWorldMatrixBackBuffer(this.ptr),i=t.createTypedArray(Float32Array,n,e.frontBuffer.length);e.setBackBuffer(i);const o=this._sortedRuntimeBones;for(let e=0;e<o.length;++e)o[e].updateBackBufferReference(t)}}}swapWorldTransformMatricesBuffer(){this._worldTransformMatrices.swap()}}var lo=ie(5905),ho=ie(2273);class co extends ho.AmmoJSPlugin{_mmdtmpAmmoVector;_mmdtmpAmmoQuat;_mmdtmpAmmoTransformA;_mmdtmpAmmoTransformB;static _BjsQuaternion=new c.Quaternion;constructor(e=!0,t,n=null){super(e,t,n),this.name="MmdAmmoJSPlugin",this._mmdtmpAmmoVector=new this.bjsAMMO.btVector3,this._mmdtmpAmmoQuat=new this.bjsAMMO.btQuaternion,this._mmdtmpAmmoTransformA=new this.bjsAMMO.btTransform,this._mmdtmpAmmoTransformB=new this.bjsAMMO.btTransform}dispose(){super.dispose(),this.bjsAMMO.destroy(this._mmdtmpAmmoVector),this.bjsAMMO.destroy(this._mmdtmpAmmoQuat),this.bjsAMMO.destroy(this._mmdtmpAmmoTransformA),this.bjsAMMO.destroy(this._mmdtmpAmmoTransformB)}_stepSimulation(e=1/60,t=10,n=1/60){this.world.stepSimulation(e,t,n)}_normalizeAngle(e){const t=Math.PI,n=2*t;return(e%=n)<-t?e+=n:e>t&&(e-=n),e}generateJoint(e){const t=e.mainImpostor.physicsBody,n=e.connectedImpostor.physicsBody;if(t&&n&&!e.joint.physicsJoint)if(20===e.joint.type){const i=e.joint.jointData;i.mainFrame||(i.mainFrame=c.Matrix.Identity()),i.connectedFrame||(i.connectedFrame=c.Matrix.Identity()),i.useLinearReferenceFrameA||(i.useLinearReferenceFrameA=!0),i.linearLowerLimit||(i.linearLowerLimit=new c.Vector3(0,0,0)),i.linearUpperLimit||(i.linearUpperLimit=new c.Vector3(0,0,0)),i.angularLowerLimit||(i.angularLowerLimit=new c.Vector3(0,0,0)),i.angularUpperLimit||(i.angularUpperLimit=new c.Vector3(0,0,0)),i.linearStiffness||(i.linearStiffness=new c.Vector3(0,0,0)),i.angularStiffness||(i.angularStiffness=new c.Vector3(0,0,0));const o=this._mmdtmpAmmoVector,r=this._mmdtmpAmmoQuat;{const e=i.mainFrame;o.setValue(e.m[12],e.m[13],e.m[14]);const t=c.Quaternion.FromRotationMatrixToRef(e,co._BjsQuaternion);r.setValue(t.x,t.y,t.z,t.w)}const a=this._mmdtmpAmmoTransformA;a.setOrigin(o),a.setRotation(r);{const e=i.connectedFrame;o.setValue(e.m[12],e.m[13],e.m[14]);const t=c.Quaternion.FromRotationMatrixToRef(e,co._BjsQuaternion);r.setValue(t.x,t.y,t.z,t.w)}const s=this._mmdtmpAmmoTransformB;s.setOrigin(o),s.setRotation(r);const l=new this.bjsAMMO.btGeneric6DofSpringConstraint(t,n,a,s,i.useLinearReferenceFrameA);0!==i.linearStiffness.x?(l.setStiffness(0,i.linearStiffness.x),l.enableSpring(0,!0)):l.enableSpring(0,!1),0!==i.linearStiffness.y?(l.setStiffness(1,i.linearStiffness.y),l.enableSpring(1,!0)):l.enableSpring(1,!1),0!==i.linearStiffness.z?(l.setStiffness(2,i.linearStiffness.z),l.enableSpring(2,!0)):l.enableSpring(2,!1),l.setStiffness(3,i.angularStiffness.x),l.enableSpring(3,!0),l.setStiffness(4,i.angularStiffness.y),l.enableSpring(4,!0),l.setStiffness(5,i.angularStiffness.z),l.enableSpring(5,!0);const h=this._mmdtmpAmmoVector;h.setValue(i.linearLowerLimit.x,i.linearLowerLimit.y,i.linearLowerLimit.z),l.setLinearLowerLimit(h),h.setValue(i.linearUpperLimit.x,i.linearUpperLimit.y,i.linearUpperLimit.z),l.setLinearUpperLimit(h),h.setValue(this._normalizeAngle(i.angularLowerLimit.x),this._normalizeAngle(i.angularLowerLimit.y),this._normalizeAngle(i.angularLowerLimit.z)),l.setAngularLowerLimit(h),h.setValue(this._normalizeAngle(i.angularUpperLimit.x),this._normalizeAngle(i.angularUpperLimit.y),this._normalizeAngle(i.angularUpperLimit.z)),l.setAngularUpperLimit(h),this.world.addConstraint(l,!e.joint.jointData.collision),e.joint.physicsJoint=l}else super.generateJoint(e)}}class mo extends lo.PhysicsJoint{constructor(e){super(20,e)}}ie(5031),ie(9106);var uo=ie(4439),po=ie(4398);class go extends uo.AbstractMesh{linkedBone;physicsMode;bodyOffsetMatrix;bodyOffsetInverseMatrix;_customBoundingInfo;constructor(e,t,n,i,o){super(e,t),this.linkedBone=n,this.physicsMode=i,this.bodyOffsetMatrix=c.Matrix.Identity(),this.bodyOffsetInverseMatrix=c.Matrix.Identity(),this._customBoundingInfo=o}static _WorldMatrix=new c.Matrix;computeBodyOffsetMatrix(e){c.Matrix.ComposeToRef(this.scaling,this.rotationQuaternion,this.position,go._WorldMatrix).multiplyToRef(e,this.bodyOffsetMatrix),this.bodyOffsetMatrix.invertToRef(this.bodyOffsetInverseMatrix)}getBoundingInfo(){return this._customBoundingInfo??super.getBoundingInfo()}}class fo extends po.PhysicsImpostor{linkedBone;constructor(e,t,n,i,o){super(e,t,n,o),this.linkedBone=i}}class _o{_mmdPhysics;_nodes;_impostors;_rootMesh;_ammoInstance;_tmpBtVector3;_tmpBtQuaternion;_tmpBtTransform;constructor(e,t,n,i,o){this._mmdPhysics=e,this._nodes=t,this._impostors=n,this._rootMesh=i,this._ammoInstance=o,this._tmpBtVector3=new o.btVector3,this._tmpBtQuaternion=new o.btQuaternion,this._tmpBtTransform=new o.btTransform}dispose(){const e=this._impostors;for(let t=0;t<e.length;++t){const n=e[t];null!==n&&(n.dispose(),n.object.physicsImpostor=null)}e.length=0;const t=this._nodes;for(let e=0;e<t.length;++e)t[e]?.dispose(!1,!0);t.length=0,this._ammoInstance.destroy(this._tmpBtVector3),this._ammoInstance.destroy(this._tmpBtQuaternion),this._ammoInstance.destroy(this._tmpBtTransform)}static _NodeWorldMatrix=new c.Matrix;static _ZeroVector=c.Vector3.Zero();static _Position=new c.Vector3;static _Rotation=new c.Quaternion;initialize(){const e=this._rootMesh.computeWorldMatrix(),t=_o._Position,n=_o._Rotation,i=this._tmpBtVector3,o=this._tmpBtQuaternion,r=this._tmpBtTransform,a=this._mmdPhysics,s=this._nodes;for(let l=0;l<s.length;++l){const h=s[l];if(null===h)continue;const d=h.linkedBone.getWorldMatrixToRef(_o._NodeWorldMatrix);if(h.bodyOffsetMatrix.multiplyToRef(d,d),h.physicsMode===M.RigidBody.PhysicsMode.FollowBone)d.decompose(h.scaling,h.rotationQuaternion,h.position);else{d.multiplyToRef(e,d),d.decompose(void 0,n,t);const s=h.physicsImpostor;a._makeKinematicOnce(s),i.setValue(t.x,t.y,t.z),o.setValue(n.x,n.y,n.z,n.w),r.setOrigin(i),r.setRotation(o),s.physicsBody.getMotionState().setWorldTransform(r)}}}syncBodies(){const e=this._nodes;for(let t=0;t<e.length;++t){const n=e[t];if(null!==n)switch(n.physicsMode){case M.RigidBody.PhysicsMode.FollowBone:{const e=n.linkedBone.getWorldMatrixToRef(_o._NodeWorldMatrix);n.bodyOffsetMatrix.multiplyToRef(e,e),e.decompose(n.scaling,n.rotationQuaternion,n.position)}break;case M.RigidBody.PhysicsMode.Physics:case M.RigidBody.PhysicsMode.PhysicsWithBone:break;default:throw new Error(`Unknown physics mode: ${n.physicsMode}`)}}}static _BoneWorldPosition=new c.Vector3;syncBones(){const e=this._nodes;for(let t=0;t<e.length;++t){const n=e[t];if(null!==n)switch(n.physicsMode){case M.RigidBody.PhysicsMode.FollowBone:break;case M.RigidBody.PhysicsMode.Physics:n.bodyOffsetInverseMatrix.multiplyToArray(c.Matrix.ComposeToRef(n.scaling,n.rotationQuaternion,n.position,_o._NodeWorldMatrix),n.linkedBone.worldMatrix,0);break;case M.RigidBody.PhysicsMode.PhysicsWithBone:n.linkedBone.getWorldTranslationToRef(_o._BoneWorldPosition),n.bodyOffsetInverseMatrix.multiplyToArray(c.Matrix.ComposeToRef(n.scaling,n.rotationQuaternion,_o._ZeroVector,_o._NodeWorldMatrix),n.linkedBone.worldMatrix,0),n.linkedBone.setWorldTranslationFromRef(_o._BoneWorldPosition);break;default:throw new Error(`Unknown physics mode: ${n.physicsMode}`)}}}}class bo{_scene;_kinematicOnces=[];constructor(e){this._scene=e}buildPhysics(e,t,n,i,o){const r=this._scene,a=r.getPhysicsEngine()?.getPhysicsPlugin();if(!a)throw new Error("Physics engine is not enabled");if("MmdAmmoJSPlugin"!==a.name)throw new Error("Physics engine is not MMDAmmoJSPlugin");let s;e.computeWorldMatrix(!0);const l=e.getWorldMatrix(),h=new c.Quaternion;{const e=new c.Vector3;l.decompose(e,h),Math.abs(e.x-e.y)<1e-4&&Math.abs(e.y-e.z)<1e-4?Math.abs(e.x-1)<1e-4&&Math.abs(e.y-1)<1e-4&&Math.abs(e.z-1)<1e-4?s=1:(s=e.x,o.warn("Root node scaling is not 1, simulation may differ from the original")):(s=Math.max(e.x,e.y,e.z),o.warn("Root node scaling is not uniform, physics may not work correctly"))}const d=new Array(n.length),m=new Array(n.length),u=new Map;for(let e=0;e<t.length;++e){const n=t[e];u.set(n.name,n)}const p=e=>e.boneIndex<0||t.length<=e.boneIndex?u.get(e.name):t[e.boneIndex];for(let t=0;t<n.length;++t){const i=n[t],u=p(i);if(void 0===u){o.warn(`Bone index out of range failed to create rigid body: ${i.name}`),d[t]=null,m[t]=null;continue}let g;const f=new c.Vector3,_=new c.Vector3;let b=!1;switch(i.shapeType){case M.RigidBody.ShapeType.Sphere:{g=po.PhysicsImpostor.SphereImpostor;const e=i.shapeSize[0]*s;f.copyFromFloats(-e,-e,-e),_.copyFromFloats(e,e,e),0===e&&(b=!0);break}case M.RigidBody.ShapeType.Box:{g=po.PhysicsImpostor.BoxImpostor;const e=i.shapeSize;f.copyFromFloats(-e[0]*s,-e[1]*s,-e[2]*s),_.copyFromFloats(e[0]*s,e[1]*s,e[2]*s),0!==e[0]&&0!==e[1]&&0!==e[2]||(b=!0);break}case M.RigidBody.ShapeType.Capsule:{g=po.PhysicsImpostor.CapsuleImpostor;const e=i.shapeSize,t=e[0]*s,n=e[1]/2*s+t;f.copyFromFloats(-t,-n,-t),_.copyFromFloats(t,n,t),0!==e[0]&&0!==e[1]||(b=!0);break}default:o.warn(`Unknown rigid body shape type: ${i.shapeType}`),d[t]=null,m[t]=null;continue}const y=new go(i.name,r,u,i.physicsMode,new k.BoundingInfo(f,_)),A=i.shapePosition;y.position.copyFromFloats(A[0],A[1],A[2]);const T=i.shapeRotation;y.rotationQuaternion=c.Quaternion.FromEulerAngles(T[0],T[1],T[2]),y.computeBodyOffsetMatrix(u.linkedBone.getAbsoluteInverseBindMatrix()),c.Vector3.TransformCoordinatesToRef(y.position,l,y.position),h.multiplyToRef(y.rotationQuaternion,y.rotationQuaternion);const w=i.physicsMode===M.RigidBody.PhysicsMode.FollowBone?0:i.mass*s,x=y.physicsImpostor=new fo(y,g,{mass:w,friction:i.friction,restitution:i.repulsion,ignoreParent:!0,disableBidirectionalTransformation:i.physicsMode!==M.RigidBody.PhysicsMode.FollowBone,group:1<<i.collisionGroup,mask:i.collisionMask},u,r);x.setDeltaPosition(new c.Vector3(0,0,0)),y.setParent(e);const v=x.physicsBody;(0===i.collisionMask||b)&&v.setCollisionFlags(4|v.getCollisionFlags()),v.setDamping(i.linearDamping,i.angularDamping),v.setSleepingThresholds(0,0);const I=a.bjsAMMO.getPointer(v);a.bjsAMMO.HEAP32[I/4+113]=4294967295,d[t]=y,m[t]=x}const g=c.Vector3.One(),f=new c.Quaternion,_=new c.Vector3,b=new c.Matrix,y=new c.Quaternion,A=new c.Vector3,T=new c.Matrix,w=new c.Matrix,x=new c.Matrix,v=new c.Matrix;for(let e=0;e<i.length;++e){const t=i[e];if(t.rigidbodyIndexA<0||n.length<=t.rigidbodyIndexA){o.warn(`Rigid body index out of range failed to create joint: ${t.name}`);continue}if(t.rigidbodyIndexB<0||n.length<=t.rigidbodyIndexB){o.warn(`Rigid body index out of range failed to create joint: ${t.name}`);continue}const r=m[t.rigidbodyIndexA],a=m[t.rigidbodyIndexB];if(null===r||null===a){o.warn(`Rigid body not found failed to create joint: ${t.name}`);continue}c.Matrix.ComposeToRef(g,c.Quaternion.FromEulerAnglesToRef(t.rotation[0],t.rotation[1],t.rotation[2],f),_.copyFromFloats(t.position[0]*s,t.position[1]*s,t.position[2]*s),b);const l=n[t.rigidbodyIndexA],h=n[t.rigidbodyIndexB];{const e=l.shapeRotation,t=l.shapePosition;c.Matrix.ComposeToRef(g,c.Quaternion.FromEulerAnglesToRef(e[0],e[1],e[2],y),A.copyFromFloats(t[0]*s,t[1]*s,t[2]*s),T).invert()}{const e=h.shapeRotation,t=h.shapePosition;c.Matrix.ComposeToRef(g,c.Quaternion.FromEulerAnglesToRef(e[0],e[1],e[2],y),A.copyFromFloats(t[0]*s,t[1]*s,t[2]*s),w).invert()}b.multiplyToRef(T,x),b.multiplyToRef(w,v);const u=new mo({mainFrame:x,connectedFrame:v,useLinearReferenceFrameA:!0,linearLowerLimit:new c.Vector3(t.positionMin[0],t.positionMin[1],t.positionMin[2]),linearUpperLimit:new c.Vector3(t.positionMax[0],t.positionMax[1],t.positionMax[2]),angularLowerLimit:new c.Vector3(t.rotationMin[0],t.rotationMin[1],t.rotationMin[2]),angularUpperLimit:new c.Vector3(t.rotationMax[0],t.rotationMax[1],t.rotationMax[2]),linearStiffness:new c.Vector3(t.springPosition[0],t.springPosition[1],t.springPosition[2]),angularStiffness:new c.Vector3(t.springRotation[0],t.springRotation[1],t.springRotation[2]),collision:!0});r.addJoint(a,u);const I=d[t.rigidbodyIndexA],B=d[t.rigidbodyIndexB];I.physicsMode!==M.RigidBody.PhysicsMode.FollowBone&&B.physicsMode===M.RigidBody.PhysicsMode.PhysicsWithBone?p(h).parentBone===p(l)&&(B.physicsMode=M.RigidBody.PhysicsMode.Physics):B.physicsMode!==M.RigidBody.PhysicsMode.FollowBone&&I.physicsMode===M.RigidBody.PhysicsMode.PhysicsWithBone&&p(l).parentBone===p(h)&&(I.physicsMode=M.RigidBody.PhysicsMode.Physics)}return new _o(this,d,m,e,a.bjsAMMO)}static _ZeroVector=c.Vector3.Zero();_onAfterPhysics=()=>{const e=this._kinematicOnces;for(let t=0;t<e.length;++t){const n=e[t];n.setLinearVelocity(bo._ZeroVector),n.setAngularVelocity(bo._ZeroVector);const i=n.physicsBody;i.setCollisionFlags(-3&i.getCollisionFlags())}e.length=0};_makeKinematicOnce(e){e._options.disableBidirectionalTransformation&&(0===this._kinematicOnces.length&&this._scene.onAfterPhysicsObservable.addOnce(this._onAfterPhysics),this._kinematicOnces.push(e),e.physicsBody.setCollisionFlags(2|e.physicsBody.getCollisionFlags()))}}ie(6247);var yo,Ao=ie(4044),Mo=ie(6970),To=ie(3466),wo=ie(3301),xo=ie(5755);class vo extends Ao.TransformNode{linkedBone;physicsMode;bodyOffsetMatrix;bodyOffsetInverseMatrix;constructor(e,t,n,i,o){super(e,t,o),this.linkedBone=n,this.physicsMode=i,this.bodyOffsetMatrix=c.Matrix.Identity(),this.bodyOffsetInverseMatrix=c.Matrix.Identity()}static _WorldMatrix=new c.Matrix;computeBodyOffsetMatrix(e){c.Matrix.ComposeToRef(this.scaling,this.rotationQuaternion,this.position,vo._WorldMatrix).multiplyToRef(e,this.bodyOffsetMatrix),this.bodyOffsetMatrix.invertToRef(this.bodyOffsetInverseMatrix)}}class Io extends To.PhysicsBody{linkedBone;constructor(e,t,n,i,o){super(e,t,n,o),this.linkedBone=i}}class Bo{_mmdPhysics;_nodes;_bodies;_constraints;constructor(e,t,n,i){this._mmdPhysics=e,this._nodes=t,this._bodies=n,this._constraints=i}dispose(){const e=this._constraints;for(let t=0;t<e.length;++t)e[t]?.dispose();e.length=0;const t=this._bodies;for(let e=0;e<t.length;++e){const n=t[e];null!==n&&(n.shape?.dispose(),n.dispose())}t.length=0;const n=this._nodes;for(let e=0;e<n.length;++e)n[e]?.dispose();n.length=0}static _NodeWorldMatrix=new c.Matrix;static _ZeroVector=c.Vector3.Zero();initialize(){const e=this._mmdPhysics,t=this._nodes;for(let n=0;n<t.length;++n){const i=t[n];if(null===i)continue;const o=i.linkedBone.getWorldMatrixToRef(Bo._NodeWorldMatrix);i.bodyOffsetMatrix.multiplyToRef(o,o),o.decompose(i.scaling,i.rotationQuaternion,i.position);const r=i.physicsBody;r.setAngularVelocity(Bo._ZeroVector),r.setLinearVelocity(Bo._ZeroVector),e._enablePreStepOnce(r)}}static _NodeWorldPosition=new c.Vector3;static _NodeWorldRotation=new c.Quaternion;syncBodies(){const e=this._nodes;for(let t=0;t<e.length;++t){const n=e[t];if(null!==n)switch(n.physicsMode){case M.RigidBody.PhysicsMode.FollowBone:{const e=n.linkedBone.getWorldMatrixToRef(Bo._NodeWorldMatrix);n.bodyOffsetMatrix.multiplyToRef(e,e),e.decompose(n.scaling,n.rotationQuaternion,n.position),n.computeWorldMatrix(!0),n.getWorldMatrix().decompose(void 0,Bo._NodeWorldRotation,Bo._NodeWorldPosition),n.physicsBody.setTargetTransform(Bo._NodeWorldPosition,Bo._NodeWorldRotation)}break;case M.RigidBody.PhysicsMode.Physics:case M.RigidBody.PhysicsMode.PhysicsWithBone:break;default:throw new Error(`Unknown physics mode: ${n.physicsMode}`)}}}static _BoneWorldPosition=new c.Vector3;syncBones(){const e=this._nodes;for(let t=0;t<e.length;++t){const n=e[t];if(null!==n)switch(n.physicsMode){case M.RigidBody.PhysicsMode.FollowBone:break;case M.RigidBody.PhysicsMode.Physics:n.bodyOffsetInverseMatrix.multiplyToArray(c.Matrix.ComposeToRef(n.scaling,n.rotationQuaternion,n.position,Bo._NodeWorldMatrix),n.linkedBone.worldMatrix,0);break;case M.RigidBody.PhysicsMode.PhysicsWithBone:n.linkedBone.getWorldTranslationToRef(Bo._BoneWorldPosition),n.bodyOffsetInverseMatrix.multiplyToArray(c.Matrix.ComposeToRef(n.scaling,n.rotationQuaternion,Bo._ZeroVector,Bo._NodeWorldMatrix),n.linkedBone.worldMatrix,0),n.linkedBone.setWorldTranslationFromRef(Bo._BoneWorldPosition);break;default:throw new Error(`Unknown physics mode: ${n.physicsMode}`)}}}}class Po{angularLimitClampThreshold;_scene;_enablePreStepOnces=[];constructor(e){this.angularLimitClampThreshold=5*Math.PI/180,this._scene=e}_convertParameter(e){const t=1/60;return(1-(1-e)**t)/t}_clampAngularLimit(e){return Math.abs(e)<this.angularLimitClampThreshold?0:e}buildPhysics(e,t,n,i,o){const r=this._scene,a=r.getPhysicsEngine()?.getPhysicsPlugin();if(!a)throw new Error("Physics engine is not enabled");if("HavokPlugin"!==a.name)throw new Error("Physics plugin is not HavokPlugin");let s;{e.computeWorldMatrix(!0);const t=e.getWorldMatrix(),n=new c.Vector3;t.decompose(n),Math.abs(n.x-n.y)<1e-4&&Math.abs(n.y-n.z)<1e-4?Math.abs(n.x-1)<1e-4&&Math.abs(n.y-1)<1e-4&&Math.abs(n.z-1)<1e-4?s=1:(s=n.x,o.warn("Root node scaling is not 1, simulation may differ from the original")):(s=Math.max(n.x,n.y,n.z),o.warn("Root node scaling is not uniform, physics may not work correctly"))}const l=new Array(n.length),h=new Array(n.length),d=new Array(i.length),m=new Map;for(let e=0;e<t.length;++e){const n=t[e];m.set(n.name,n)}const u=e=>e.boneIndex<0||t.length<=e.boneIndex?m.get(e.name):t[e.boneIndex];for(let t=0;t<n.length;++t){const i=n[t],d=u(i);if(void 0===d){o.warn(`Bone index out of range failed to create rigid body: ${i.name}`),l[t]=null,h[t]=null;continue}let m,p=!1;switch(i.shapeType){case M.RigidBody.ShapeType.Sphere:m=new xo.PhysicsShapeSphere(new c.Vector3,i.shapeSize[0]*s,r),0===i.shapeSize[0]&&(p=!0);break;case M.RigidBody.ShapeType.Box:m=new xo.PhysicsShapeBox(new c.Vector3,new c.Quaternion,new c.Vector3(2*i.shapeSize[0]*s,2*i.shapeSize[1]*s,2*i.shapeSize[2]*s),r),0!==i.shapeSize[0]&&0!==i.shapeSize[1]&&0!==i.shapeSize[2]||(p=!0);break;case M.RigidBody.ShapeType.Capsule:m=new xo.PhysicsShapeCapsule(new c.Vector3(0,i.shapeSize[1]/2*s,0),new c.Vector3(0,-i.shapeSize[1]/2*s,0),i.shapeSize[0]*s,r),0!==i.shapeSize[0]&&0!==i.shapeSize[1]||(p=!0);break;default:o.warn(`Unknown rigid body shape type: ${i.shapeType}`),l[t]=null,h[t]=null;continue}m.material={friction:i.friction,restitution:i.repulsion},m.filterCollideMask=p?0:i.collisionMask,m.filterMembershipMask=1<<i.collisionGroup;const g=new vo(i.name,r,d,i.physicsMode),f=i.shapePosition;g.position.copyFromFloats(f[0],f[1],f[2]);const _=i.shapeRotation;g.rotationQuaternion=c.Quaternion.FromEulerAngles(_[0],_[1],_[2]),g.computeBodyOffsetMatrix(d.linkedBone.getAbsoluteInverseBindMatrix()),g.setParent(e);const b=i.physicsMode===M.RigidBody.PhysicsMode.FollowBone?Mo.PhysicsMotionType.ANIMATED:Mo.PhysicsMotionType.DYNAMIC,y=new Io(g,b,!1,d,r);a.setActivationControl(y,Mo.PhysicsActivationControl.ALWAYS_ACTIVE),y.shape=m,y.setMassProperties({mass:i.mass}),y.setLinearDamping(this._convertParameter(i.linearDamping)),y.setAngularDamping(this._convertParameter(i.angularDamping)),y.computeMassProperties(),l[t]=g,h[t]=y}const p=c.Vector3.One(),g=new c.Quaternion,f=new c.Vector3,_=new c.Matrix,b=new c.Quaternion,y=new c.Vector3,A=new c.Matrix,T=new c.Matrix,w=new c.Matrix,x=new c.Matrix;for(let e=0;e<i.length;++e){const t=i[e];if(t.rigidbodyIndexA<0||n.length<=t.rigidbodyIndexA){o.warn(`Rigid body index out of range failed to create joint: ${t.name}`),d[e]=null;continue}if(t.rigidbodyIndexB<0||n.length<=t.rigidbodyIndexB){o.warn(`Rigid body index out of range failed to create joint: ${t.name}`),d[e]=null;continue}const a=h[t.rigidbodyIndexA],m=h[t.rigidbodyIndexB];if(null===a||null===m){o.warn(`Rigid body not found failed to create joint: ${t.name}`),d[e]=null;continue}c.Matrix.ComposeToRef(p,c.Quaternion.FromEulerAnglesToRef(t.rotation[0],t.rotation[1],t.rotation[2],g),f.copyFromFloats(t.position[0]*s,t.position[1]*s,t.position[2]*s),_);const v=n[t.rigidbodyIndexA],I=n[t.rigidbodyIndexB];{const e=v.shapeRotation,t=v.shapePosition;c.Matrix.ComposeToRef(p,c.Quaternion.FromEulerAnglesToRef(e[0],e[1],e[2],b),y.copyFromFloats(t[0]*s,t[1]*s,t[2]*s),A).invert()}{const e=I.shapeRotation,t=I.shapePosition;c.Matrix.ComposeToRef(p,c.Quaternion.FromEulerAnglesToRef(e[0],e[1],e[2],b),y.copyFromFloats(t[0]*s,t[1]*s,t[2]*s),T).invert()}_.multiplyToRef(A,w),_.multiplyToRef(T,x);const B=this._convertParameter(1),P=[{axis:Mo.PhysicsConstraintAxis.LINEAR_X,minLimit:t.positionMin[0],maxLimit:t.positionMax[0],stiffness:this._convertParameter(t.springPosition[0]),damping:B},{axis:Mo.PhysicsConstraintAxis.LINEAR_Y,minLimit:t.positionMin[1],maxLimit:t.positionMax[1],stiffness:this._convertParameter(t.springPosition[1]),damping:B},{axis:Mo.PhysicsConstraintAxis.LINEAR_Z,minLimit:t.positionMin[2],maxLimit:t.positionMax[2],stiffness:this._convertParameter(t.springPosition[2]),damping:B},{axis:Mo.PhysicsConstraintAxis.ANGULAR_X,minLimit:this._clampAngularLimit(t.rotationMin[0]),maxLimit:this._clampAngularLimit(t.rotationMax[0]),stiffness:this._convertParameter(t.springRotation[0]),damping:B},{axis:Mo.PhysicsConstraintAxis.ANGULAR_Y,minLimit:this._clampAngularLimit(t.rotationMin[1]),maxLimit:this._clampAngularLimit(t.rotationMax[1]),stiffness:this._convertParameter(t.springRotation[1]),damping:B},{axis:Mo.PhysicsConstraintAxis.ANGULAR_Z,minLimit:this._clampAngularLimit(t.rotationMin[2]),maxLimit:this._clampAngularLimit(t.rotationMax[2]),stiffness:this._convertParameter(t.springRotation[2]),damping:B}];for(let e=0;e<3;++e){const t=P[e];0===t.stiffness&&(t.stiffness=void 0,t.damping=void 0)}const R=new wo.Physics6DoFConstraint({pivotA:w.getTranslation(),pivotB:x.getTranslation(),axisA:new c.Vector3(w.m[0],w.m[1],w.m[2]).negateInPlace(),axisB:new c.Vector3(x.m[0],x.m[1],x.m[2]).negateInPlace(),perpAxisA:new c.Vector3(w.m[4],w.m[5],w.m[6]),perpAxisB:new c.Vector3(x.m[4],x.m[5],x.m[6]),collision:!0},P,r);a.addConstraint(m,R),d[e]=R;const C=l[t.rigidbodyIndexA],O=l[t.rigidbodyIndexB];C.physicsMode!==M.RigidBody.PhysicsMode.FollowBone&&O.physicsMode===M.RigidBody.PhysicsMode.PhysicsWithBone?u(I).parentBone===u(v)&&(O.physicsMode=M.RigidBody.PhysicsMode.Physics):O.physicsMode!==M.RigidBody.PhysicsMode.FollowBone&&C.physicsMode===M.RigidBody.PhysicsMode.PhysicsWithBone&&u(v).parentBone===u(I)&&(C.physicsMode=M.RigidBody.PhysicsMode.Physics)}return new Bo(this,l,h,d)}_onAfterPhysics=()=>{const e=this._enablePreStepOnces;for(let t=0;t<e.length;++t)e[t].disablePreStep=!0;e.length=0};_enablePreStepOnce(e){e.disablePreStep&&(0===this._enablePreStepOnces.length&&this._scene.onAfterPhysicsObservable.addOnce(this._onAfterPhysics),this._enablePreStepOnces.push(e),e.disablePreStep=!1)}}class Ro{index;name;get position(){return this._position}set position(e){this._position.copyFrom(e)}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion.copyFrom(e)}get scaling(){return this._scaling}set scaling(e){this._scaling.copyFrom(e)}_position;_rotationQuaternion;_scaling;parent;children;bone;_boneWorldRestRotationMatrix;_boneFinalMatrix;_boneFinalMatrixInverse;_boneParent;_restMatrix;_absoluteInverseBindMatrix;_positionApplyScale;_scalingMatrix;constructor(e,t,n,i,o){this.index=e,this.name=t,this._position=c.Vector3.Zero(),this._rotationQuaternion=c.Quaternion.Identity(),this._scaling=c.Vector3.One(),this.parent=null,this.children=[],this.bone=n,this._boneWorldRestRotationMatrix=null!==n?n.getFinalMatrix().getRotationMatrix():null,this._boneFinalMatrix=null!==n?c.Matrix.Identity():null,this._boneFinalMatrixInverse=null!==n?c.Matrix.Identity():null,this._boneParent=null,this._restMatrix=c.Matrix.Identity(),this._absoluteInverseBindMatrix=c.Matrix.Identity(),this._positionApplyScale=i,this._scalingMatrix=o}getRestMatrix(){return this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}setRotationQuaternion(e){this._rotationQuaternion.copyFrom(e)}updateBoneParent(){let e=this.parent;if(null!==e)for(;null===e.bone&&(e=e.parent,null!==e););this._boneParent=e}computeBoneFinalMatrix(e,t){const n=this._boneFinalMatrix;"センター"===this.name?t.getWorldMatrixToRef(n):e[this.index].getWorldMatrixToRef(n),this._scalingMatrix.multiplyToRef(n,n),n.multiplyToRef(this._scalingMatrix,n);const i=this._positionApplyScale;{const e=n.m;n.setTranslationFromFloats(e[12]*i.x,e[13]*i.y,e[14]*i.z)}this._boneWorldRestRotationMatrix.multiplyToRef(n,n),this._boneFinalMatrixInverse.copyFrom(n).invert()}static _BoneLocalMatrix=new c.Matrix;apply(){const e=this._boneParent,t=Ro._BoneLocalMatrix.copyFrom(this._boneFinalMatrix);null!==e&&t.multiplyToRef(e._boneFinalMatrixInverse,t),this.bone._matrix=t}}class Co{bones;_skeleton;_runtimeBones;_upperBodyBone;constructor(e,t){this.bones=e,this._skeleton=t,this._runtimeBones=null,this._upperBodyBone=null}lateInitialize(e){this._runtimeBones=e;let t=null;for(let n=0;n<e.length;++n){const i=e[n];if("上半身"===i.name){t=i;break}}this._upperBodyBone=t}prepare(){}get _computeTransformMatrices(){return!0}set _computeTransformMatrices(e){if(!0===e){this._skeleton.onBeforeComputeObservable.removeCallback(this._onBeforeCompute);const e=this._skeleton.bones;let t=0;for(let n=0;n<e.length;++n)null!==e[n]._linkedTransformNode&&(t+=1);this._skeleton._numBonesWithLinkedTransformNode=t}else this._skeleton.onBeforeComputeObservable.add(this._onBeforeCompute),this._skeleton._numBonesWithLinkedTransformNode=0}_onBeforeCompute=()=>{const e=this.bones,t=this._runtimeBones,n=this._upperBodyBone;for(let i=0;i<e.length;++i)null!==e[i].bone&&e[i].computeBoneFinalMatrix(t,n);for(let t=0;t<e.length;++t)null!==e[t].bone&&e[t].apply()}}class Oo{static _StandardSkeletonMetaData=[["全ての親",-1,0,31,null,null],["センター",0,0,30,null,null],["グルーブ",1,0,30,null,null],["腰",2,0,26,null,null],["右足IK親",0,0,31,null,null],["右足ＩＫ",4,1,62,null,{target:67,iteration:40,rotationConstraint:2,links:[{target:66,limitation:{minimumAngle:[-3.1415927410125732,0,0],maximumAngle:[-.008726646192371845,0,0]}},{target:65,limitation:void 0}]}],["右つま先ＩＫ",5,2,62,null,{target:72,iteration:3,rotationConstraint:4,links:[{target:67,limitation:void 0}]}],["左足IK親",0,0,31,null,null],["左足ＩＫ",7,1,62,null,{target:71,iteration:40,rotationConstraint:2,links:[{target:70,limitation:{minimumAngle:[-3.1415927410125732,0,0],maximumAngle:[-.008726646192371845,0,0]}},{target:69,limitation:void 0}]}],["左つま先ＩＫ",8,2,62,null,{target:73,iteration:3,rotationConstraint:4,links:[{target:71,limitation:void 0}]}],["上半身",3,0,27,null,null],["上半身2",10,0,27,null,null],["下半身",3,0,26,null,null],["首",11,0,27,null,null],["頭",13,0,26,null,null],["右肩P",11,0,26,null,null],["右肩",15,0,2075,null,null],["右肩C",16,0,274,{parentIndex:15,ratio:-1},null],["右腕",17,0,2075,null,null],["右腕捩",18,0,1050,null,null],["右ひじ",19,0,2075,null,null],["右手捩",20,0,1050,null,null],["右手首",21,0,2075,null,null],["右親指０",22,0,2079,null,null],["右親指１",23,0,2075,null,null],["右親指２",24,0,2075,null,null],["右小指１",22,0,2075,null,null],["右小指２",26,0,2075,null,null],["右小指３",27,0,2075,null,null],["右薬指１",22,0,2075,null,null],["右薬指２",29,0,2075,null,null],["右薬指３",30,0,2075,null,null],["右中指１",22,0,2075,null,null],["右中指２",32,0,2075,null,null],["右中指３",33,0,2075,null,null],["右人指１",22,0,2075,null,null],["右人指２",35,0,2075,null,null],["右人指３",36,0,2075,null,null],["左肩P",11,0,26,null,null],["左肩",38,0,2075,null,null],["左肩C",39,0,274,{parentIndex:38,ratio:-1},null],["左腕",40,0,2075,null,null],["左腕捩",41,0,1050,null,null],["左ひじ",42,0,2075,null,null],["左手捩",43,0,1050,null,null],["左手首",44,0,2075,null,null],["左親指０",45,0,2079,null,null],["左親指１",46,0,2075,null,null],["左親指２",47,0,2075,null,null],["左小指１",45,0,2075,null,null],["左小指２",49,0,2075,null,null],["左小指３",50,0,2075,null,null],["左薬指１",45,0,2075,null,null],["左薬指２",52,0,2075,null,null],["左薬指３",53,0,2075,null,null],["左中指１",45,0,2075,null,null],["左中指２",55,0,2075,null,null],["左中指３",56,0,2075,null,null],["左人指１",45,0,2075,null,null],["左人指２",58,0,2075,null,null],["左人指３",59,0,2075,null,null],["右目",14,2,2330,{parentIndex:63,ratio:1},null],["左目",14,2,2330,{parentIndex:63,ratio:1},null],["両目",14,0,2074,null,null],["腰キャンセル右",12,0,274,{parentIndex:3,ratio:-1},null],["右足",64,0,27,null,null],["右ひざ",65,0,27,null,null],["右足首",66,0,27,null,null],["腰キャンセル左",12,0,274,{parentIndex:3,ratio:-1},null],["左足",68,0,27,null,null],["左ひざ",69,0,27,null,null],["左足首",70,0,27,null,null],["右つま先",67,2,18,null,null],["左つま先",71,2,18,null,null],["右足D",64,1,283,{parentIndex:65,ratio:1},null],["右ひざD",74,1,283,{parentIndex:66,ratio:1},null],["右足首D",75,2,282,{parentIndex:67,ratio:1},null],["左足D",68,1,283,{parentIndex:69,ratio:1},null],["左ひざD",77,1,283,{parentIndex:70,ratio:1},null],["左足首D",78,2,282,{parentIndex:71,ratio:1},null],["右足先EX",76,2,26,null,null],["左足先EX",79,2,26,null,null]];_createMetadata(e,t,n,i){const o={modelName:e,englishModelName:e,comment:"",englishComment:""},r=[],a=Oo._StandardSkeletonMetaData;for(let e=0;e<a.length;++e){const t=a[e],n=t[5],i={name:t[0],englishName:"",parentBoneIndex:t[1],transformOrder:t[2],flag:t[3],appendTransform:null!==t[4]?{...t[4]}:void 0,ik:null!==n?{target:n.target,iteration:n.iteration,rotationConstraint:n.rotationConstraint,links:n.links.map((e=>({target:e.target,limitation:void 0!==e.limitation?{...e.limitation}:void 0})))}:void 0};r.push(i)}const s=[];for(let e=0;e<t.length;++e){const n=t[e];null!==n.morphTargetManager&&s.push(n.morphTargetManager)}const l=new Map;for(let e=0;e<s.length;++e){const t=s[e],n=t.numTargets;for(let e=0;e<n;++e){const n=t.getTarget(e),i=n.name;let o=l.get(i);void 0===o&&(o=[],l.set(i,o)),o.push(n)}}const h=[];for(const[e,t]of l){const i=n[e]??e,o={name:i,englishName:i,category:M.Morph.Category.Eye,type:M.Morph.Type.VertexMorph,morphTargets:t};h.push(o)}return{isMmdModel:!0,header:o,bones:r,morphs:h,rigidBodies:[],joints:[],meshes:t,materials:[],skeleton:i}}_removeScaleFromOffsetMatrix(e){const t=new c.Vector3;e.decompose(t),t.x=Math.abs(t.x),t.y=Math.abs(t.y),t.z=Math.abs(t.z);const n=e.m;return e.setRowFromFloats(0,n[0]/t.x,n[1]/t.x,n[2]/t.x,n[3]),e.setRowFromFloats(1,n[4]/t.y,n[5]/t.y,n[6]/t.y,n[7]),e.setRowFromFloats(2,n[8]/t.z,n[9]/t.z,n[10]/t.z,n[11]),t}_copyBonePosition(e,t,n){const i=n.get(e),o=n.get(t);return void 0===i||void 0===o?null:(o._position.copyFrom(i._position),o)}_getAverageBonePosition(e,t){const n=c.Vector3.Zero();for(let i=0;i<e.length;++i){const o=t.get(e[i]);if(void 0===o)return null;n.addInPlace(o._position)}return n.scaleInPlace(1/e.length)}_buildBoneProxyTree(e,t,n,i,o){const r=i.clone(),a=this._removeScaleFromOffsetMatrix(r),s=new c.Vector3(1/a.x,1/a.y,1/a.z),l=e.bones,h=new Set,d=new Map;for(let e=0;e<l.length;++e){const n=l[e],i=t[n.name];void 0!==i&&d.set(i,n)}e.prepare(!0);const m=[],u=new Map;for(let e=0;e<n.length;++e){const t=n[e],i=d.get(t.name)??null,o=new Ro(e,t.name,i,s,r);null!==i&&(i.getFinalMatrix().getTranslationToRef(o._position),h.add(o.name)),m.push(o),u.set(t.name,o)}for(let e=0;e<n.length;++e){const t=n[e],i=m[e],o=t.parentBoneIndex;if(-1!==o){const e=m[o];i.parent=e,e.children.push(i)}}h.has("全ての親")||(u.get("全ての親")._position.y=.1*s.y,h.add("全ての親"));{const e=h.has("センター"),t=h.has("グルーブ");if(e||t)e?t||null!==this._copyBonePosition("センター","グルーブ",u)&&h.add("グルーブ"):null!==this._copyBonePosition("グルーブ","センター",u)&&h.add("センター");else{const e=this._getAverageBonePosition(["左足","左ひざ","右足","右ひざ"],u);null!==e&&(u.get("センター")._position.copyFrom(e),u.get("グルーブ")._position.copyFrom(e),h.add("センター"),h.add("グルーブ"))}}{const e=h.has("上半身"),t=h.has("下半身"),n=h.has("腰");if(e||t||n)e?t||null!==this._copyBonePosition(e?"上半身":"腰","下半身",u)&&h.add("下半身"):null!==this._copyBonePosition(t?"下半身":"腰","上半身",u)&&h.add("上半身");else{const e=this._getAverageBonePosition(["左足","左足","右足","右足","首"],u);null!==e&&(u.get("上半身")._position.copyFrom(e),u.get("下半身")._position.copyFrom(e),u.get("腰")._position.copyFrom(e),h.add("上半身"),h.add("下半身"),h.add("腰"))}n||null!==this._copyBonePosition(t?"下半身":"上半身","腰",u)&&h.add("腰")}if(!h.has("両目")){const e=this._getAverageBonePosition(["右目","左目"],u);if(null!==e){const t=u.get("両目");t._position.copyFrom(e);const n=u.get("頭")._position.y-t._position.y;t._position.y-=2*n,h.add("両目")}}if(h.has("右肩P")||null!==this._copyBonePosition("右肩","右肩P",u)&&h.add("右肩P"),h.has("右肩C")||null!==this._copyBonePosition("右腕","右肩C",u)&&h.add("右肩C"),h.has("左肩P")||null!==this._copyBonePosition("左肩","左肩P",u)&&h.add("左肩P"),h.has("左肩C")||null!==this._copyBonePosition("左腕","左肩C",u)&&h.add("左肩C"),!h.has("右腕捩")){const e=this._getAverageBonePosition(["右腕","右ひじ"],u);null!==e&&(u.get("右腕捩")._position.copyFrom(e),h.add("右腕捩"))}if(!h.has("右手捩")){const e=this._getAverageBonePosition(["右ひじ","右手首"],u);null!==e&&(u.get("右手捩")._position.copyFrom(e),h.add("右手捩"))}if(!h.has("左腕捩")){const e=this._getAverageBonePosition(["左腕","左ひじ"],u);null!==e&&(u.get("左腕捩")._position.copyFrom(e),h.add("左腕捩"))}if(!h.has("左手捩")){const e=this._getAverageBonePosition(["左ひじ","左手首"],u);null!==e&&(u.get("左手捩")._position.copyFrom(e),h.add("左手捩"))}if(h.has("腰キャンセル右")||null!==this._copyBonePosition("右足","腰キャンセル右",u)&&h.add("腰キャンセル右"),h.has("腰キャンセル左")||null!==this._copyBonePosition("左足","腰キャンセル左",u)&&h.add("腰キャンセル左"),h.has("右足ＩＫ")||null!==this._copyBonePosition("右足首","右足ＩＫ",u)&&h.add("右足ＩＫ"),!h.has("右足IK親")){const e=this._copyBonePosition("右足首","右足IK親",u);null!==e&&(e._position.y=.1*s.y,h.add("右足IK親"))}if(h.has("右つま先ＩＫ")||null!==this._copyBonePosition("右つま先","右つま先ＩＫ",u)&&h.add("右つま先ＩＫ"),h.has("左足ＩＫ")||null!==this._copyBonePosition("左足首","左足ＩＫ",u)&&h.add("左足ＩＫ"),!h.has("左足IK親")){const e=this._copyBonePosition("左足首","左足IK親",u);null!==e&&(e._position.y=.1*s.y,h.add("左足IK親"))}h.has("左つま先ＩＫ")||null!==this._copyBonePosition("左つま先","左つま先ＩＫ",u)&&h.add("左つま先ＩＫ"),h.has("右足D")||null!==this._copyBonePosition("右足","右足D",u)&&h.add("右足D"),h.has("右ひざD")||null!==this._copyBonePosition("右ひざ","右ひざD",u)&&h.add("右ひざD"),h.has("右足首D")||null!==this._copyBonePosition("右足首","右足首D",u)&&h.add("右足首D"),h.has("右足先EX")||null!==this._copyBonePosition("右つま先","右足先EX",u)&&h.add("右足先EX"),h.has("左足D")||null!==this._copyBonePosition("左足","左足D",u)&&h.add("左足D"),h.has("左ひざD")||null!==this._copyBonePosition("左ひざ","左ひざD",u)&&h.add("左ひざD"),h.has("左足首D")||null!==this._copyBonePosition("左足首","左足首D",u)&&h.add("左足首D"),h.has("左足先EX")||null!==this._copyBonePosition("左つま先","左足先EX",u)&&h.add("左足先EX");for(let e=0;e<m.length;++e){const t=m[e];t._position.multiplyInPlace(a),c.Vector3.TransformCoordinatesToRef(t._position,r,t._position)}let p=m.length-h.size;for(;0<p;)for(let e=0;e<m.length;++e){const t=m[e];if(h.has(t.name))continue;const n=t.parent;null!==n&&h.has(n.name)&&(t._position.copyFrom(n._position),h.add(t.name),p-=1,o.warn(`Bone position of ${t.name} is not initialized. Use parent bone position instead. Animation may not work correctly.`))}const g=new Map;for(let e=0;e<m.length;++e)g.set(m[e],m[e]._position.clone());for(let e=0;e<m.length;++e){const t=m[e];c.Matrix.TranslationToRef(-t._position.x,-t._position.y,-t._position.z,t.getAbsoluteInverseBindMatrix());const n=t.parent;if(null!==n){const e=g.get(n);t._position.subtractInPlace(e)}t.getRestMatrix().setTranslation(t._position),t.updateBoneParent()}return m}createMmdModelFromHumanoid(e,t,n,i={}){const{boneMap:o={},morphMap:r={},transformOffset:a=c.Matrix.Identity()}=i;let s=null;for(let e=0;e<n.length;++e){const t=n[e];if(null!==t.skeleton){s=t.skeleton;break}}if(null===s)throw new Error("Skeleton not found.");const l=this._createMetadata(t.name,n.slice(),r,s);if(t.metadata=l,!yt.isMmdSkinnedMesh(t))throw new Error("Mesh validation failed.");let h;h=void 0!==a.getWorldMatrix?a.computeWorldMatrix(!0).clone().setTranslationFromFloats(0,0,0):a.clone().setTranslationFromFloats(0,0,0);const d=this._buildBoneProxyTree(s,o,l.bones,h,e),m=new Co(d,s),u=e.createMmdModelFromSkeleton(t,m,{materialProxyConstructor:null,buildPhysics:!1});return m.lateInitialize(u.runtimeBones),u}}!function(e){e[e.Seconds=0]="Seconds",e[e.Frames=1]="Frames"}(yo||(yo={}));class Fo{autoHidePlayerControl;hidePlayerControlTimeout;displayTimeFormat;_mmdRuntime;_audioPlayer;_newCanvasContainer;_playerContainer;_hidePlayerControlTimeoutId;_playButton;_timeSlider;_soundButton;_volumeSlider;_currentFrameNumberSpan;_endFrameNumberSpan;_speedSlider;_fullscreenButton;_bindedDispose;_scene;constructor(e,t,n){const i=e.getEngine().getInputElement();if(null===i)throw new Error("Failed to get root element.");this.autoHidePlayerControl=!0,this.hidePlayerControlTimeout=3e3,this.displayTimeFormat=yo.Seconds,this._mmdRuntime=t,this._audioPlayer=n??null;const o=this._newCanvasContainer=this._createCanvasContainer(i.parentElement);this._playerContainer=null,this._hidePlayerControlTimeoutId=void 0,this._playButton=null,this._timeSlider=null,this._soundButton=null,this._volumeSlider=null,this._currentFrameNumberSpan=null,this._endFrameNumberSpan=null,this._speedSlider=null,this._fullscreenButton=null,this._createPlayerControl(o,t,n),t.onPlayAnimationObservable.add(this._onAnimationPlay),t.onPauseAnimationObservable.add(this._onAnimationPause),t.onAnimationDurationChangedObservable.add(this._onAnimationDurationChanged),t.onAnimationTickObservable.add(this._onAnimationTick),n?.onMuteStateChangedObservable.add(this._onMuteStateChanged),this._bindedDispose=this.dispose.bind(this),this._scene=e,e.onDisposeObservable.add(this._bindedDispose)}_createCanvasContainer(e){const t=e.ownerDocument.createElement("div");for(t.style.display=e.style.display;e.childElementCount>0;){const n=e.childNodes[0];e.removeChild(n),t.appendChild(n)}return e.appendChild(t),t.style.width="100%",t.style.height="100%",t.style.overflow="hidden",t}_restoreCanvasContainer(e){const t=this._newCanvasContainer;for(;t.childElementCount>0;){const n=t.childNodes[0];t.removeChild(n),e.appendChild(n)}e.removeChild(t)}_createPlayerControl(e,t,n){const i=e.ownerDocument,o=this._playerContainer=i.createElement("div");o.style.position="relative",o.style.bottom="120px",o.style.left="0",o.style.width="100%",o.style.height="120px",o.style.transform="translateY(50%)",o.style.transition="transform 0.5s",e.appendChild(o),o.onmouseenter=this._onPlayerControlMouseEnter,o.onmouseleave=this._onPlayerControlMouseLeave;{const r=i.createElement("div");r.style.position="absolute",r.style.bottom="0",r.style.left="0",r.style.width="100%",r.style.height="50%",r.style.boxSizing="border-box",r.style.background="linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.6))",r.style.display="flex",r.style.flexDirection="column",o.appendChild(r);{const o=i.createElement("div");o.style.width="100%",o.style.boxSizing="border-box",o.style.display="flex",o.style.flexDirection="row",o.style.alignItems="center",r.appendChild(o);{const e=this._timeSlider=i.createElement("input");e.style.width="100%",e.style.height="4px",e.style.border="none",e.style.opacity="0.5",e.type="range",e.min="0",e.max=t.animationFrameTimeDuration.toString(),e.oninput=n=>{n.preventDefault(),t.seekAnimation(Number(e.value),!0)};{let n=!1;e.onmousedown=()=>{t.isAnimationPlaying&&(t.pauseAnimation(),n=!0)},e.onmouseup=()=>{n&&(t.playAnimation(),n=!1)}}o.appendChild(e)}const a=i.createElement("div");a.style.width="100%",a.style.flexGrow="1",a.style.padding="0 5px",a.style.boxSizing="border-box",a.style.display="flex",a.style.flexDirection="row",a.style.alignItems="space-between",r.appendChild(a);{const o=i.createElement("div");o.style.flex="1",o.style.display="flex",o.style.flexDirection="row",o.style.alignItems="center",a.appendChild(o);{const e=this._playButton=i.createElement("button");if(e.style.width="40px",e.style.border="none",e.style.backgroundColor="rgba(0, 0, 0, 0)",e.style.color="white",e.style.fontSize="18px",e.innerText=t.isAnimationPlaying?"❚❚":"▶",e.onclick=()=>{t.isAnimationPlaying?t.pauseAnimation():t.playAnimation()},o.appendChild(e),void 0!==n){const e=this._soundButton=i.createElement("button");e.style.width="35px",e.style.border="none",e.style.backgroundColor="rgba(0, 0, 0, 0)",e.style.color="white",e.style.fontSize="20px",e.innerText=n.muted?"🔇":"🔊",e.onclick=()=>{n.muted?n.unmute():n.mute()},o.appendChild(e);const t=this._volumeSlider=i.createElement("input");t.style.width="80px",t.style.height="4px",t.style.border="none",t.style.opacity="0.5",t.type="range",t.min="0",t.max="1",t.step="0.01",t.value=n.volume.toString(),t.oninput=()=>{n.volume=Number(t.value)},o.appendChild(t)}const r=this._currentFrameNumberSpan=i.createElement("span");r.style.width="40px",r.style.textAlign="right",r.style.color="white",r.innerText=this.displayTimeFormat===yo.Seconds?this._getFormattedTime(t.currentTime):Math.floor(t.currentFrameTime).toString(),o.appendChild(r);const a=this._endFrameNumberSpan=i.createElement("span");a.style.width="50px",a.style.textAlign="left",a.style.color="white",a.innerHTML="&nbsp;/&nbsp;"+(this.displayTimeFormat===yo.Seconds?this._getFormattedTime(t.animationDuration):Math.floor(t.animationFrameTimeDuration).toString()),o.appendChild(a)}const r=i.createElement("div");r.style.flex="1",r.style.display="flex",r.style.flexDirection="row",r.style.alignItems="center",r.style.justifyContent="flex-end",a.appendChild(r);{const n=i.createElement("label");n.style.width="40px",n.style.textAlign="center",n.style.color="white",n.innerText="1.00x",r.appendChild(n);const o=this._speedSlider=i.createElement("input");o.style.width="80px",o.style.height="4px",o.style.border="none",o.style.opacity="0.5",o.type="range",o.min="0.07",o.max="1",o.step="0.01",o.value=t.timeScale.toString(),o.oninput=()=>{t.timeScale=Number(o.value),n.innerText=t.timeScale.toFixed(2)+"x"},r.appendChild(o);const a=this._fullscreenButton=i.createElement("button");a.style.width="40px",a.style.border="none",a.style.color="white",a.style.backgroundColor="rgba(0, 0, 0, 0)",a.style.fontSize="20px",a.innerText="🗖",a.onclick=()=>{i.fullscreenElement?i.exitFullscreen():e.requestFullscreen()},r.appendChild(a)}}}}}_onPlayerControlMouseEnter=()=>{this.autoHidePlayerControl&&(window.clearTimeout(this._hidePlayerControlTimeoutId),this._hidePlayerControlTimeoutId=void 0,this.showPlayerControl())};_onPlayerControlMouseLeave=()=>{this.autoHidePlayerControl&&(this._hidePlayerControlTimeoutId=window.setTimeout(this.hidePlayerControl.bind(this),this.hidePlayerControlTimeout))};_onAnimationPlay=()=>{this._playButton.innerText="❚❚"};_onAnimationPause=()=>{this._playButton.innerText="▶"};_onAnimationDurationChanged=()=>{const e=this._mmdRuntime;this._timeSlider.max=e.animationFrameTimeDuration.toString(),this._endFrameNumberSpan.innerHTML="&nbsp;/&nbsp;"+(this.displayTimeFormat===yo.Seconds?this._getFormattedTime(e.animationDuration):Math.floor(e.animationFrameTimeDuration).toString())};_onAnimationTick=()=>{const e=this._mmdRuntime;if(this._timeSlider.value=e.currentFrameTime.toString(),this.displayTimeFormat===yo.Seconds){const t=this._getFormattedTime(e.currentTime);this._currentFrameNumberSpan.innerText!==t&&(this._currentFrameNumberSpan.innerText=t)}else this._currentFrameNumberSpan.innerText=Math.floor(e.currentFrameTime).toString()};_onMuteStateChanged=()=>{null!==this._soundButton&&(this._soundButton.innerText=this._audioPlayer.muted?"🔇":"🔊")};_formattedTimeCacheKey=NaN;_formatterTimeCacheValue="";_getFormattedTime(e){const t=Math.floor(e);if(t===this._formattedTimeCacheKey)return this._formatterTimeCacheValue;if(!isFinite(e))return this._formattedTimeCacheKey=t,this._formatterTimeCacheValue="-:--","-:--";const n=Math.floor(e/60),i=Math.floor(e%60),o=n.toString()+":"+(i<10?"0":"")+i.toString();return this._formattedTimeCacheKey=t,this._formatterTimeCacheValue=o,o}hidePlayerControl(){this._playerContainer.style.transform="translateY(50%)",this._hidePlayerControlTimeoutId=void 0}showPlayerControl(){this._playerContainer.style.transform="translateY(0)"}dispose(){null!==this._newCanvasContainer&&(this._restoreCanvasContainer(this._newCanvasContainer.parentElement),this._newCanvasContainer=null,this._playButton.onclick=null,this._timeSlider.oninput=null,this._timeSlider.onmousedown=null,this._timeSlider.onmouseup=null,null!==this._audioPlayer&&(this._soundButton.onclick=null,this._volumeSlider.oninput=null),this._speedSlider.oninput=null,this._fullscreenButton.onclick=null,this._playerContainer.onmouseenter=null,this._playerContainer.onmouseleave=null,this._playerContainer.remove(),this._mmdRuntime.onPlayAnimationObservable.removeCallback(this._onAnimationPlay),this._mmdRuntime.onPauseAnimationObservable.removeCallback(this._onAnimationPause),this._mmdRuntime.onAnimationDurationChangedObservable.removeCallback(this._onAnimationDurationChanged),this._mmdRuntime.onAnimationTickObservable.removeCallback(this._onAnimationTick),this._audioPlayer?.onMuteStateChangedObservable.removeCallback(this._onMuteStateChanged),this._scene.onDisposeObservable.removeCallback(this._bindedDispose))}}class So{static OverrideComputeTransformMatrices(e){e._computeTransformMatrices=function(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let n=0;n<this.bones.length;n++){const i=this.bones[n];if(i._childUpdateId+=1,!i.getParent()){const o=[i];for(;o.length>0;){const i=o.pop(),r=i.getParent();if(r?i.getLocalMatrix().multiplyToRef(r.getFinalMatrix(),i.getFinalMatrix()):t?i.getLocalMatrix().multiplyToRef(t,i.getFinalMatrix()):i.getFinalMatrix().copyFrom(i.getLocalMatrix()),-1!==i._index){const t=null===i._index?n:i._index;i.getAbsoluteInverseBindMatrix().multiplyToArray(i.getFinalMatrix(),e,16*t)}const a=i.getChildren();for(const e of a)o.push(e)}}}this._identity.copyToArray(e,16*this.bones.length)}}}var Eo=ie(1068);class ko extends Eo.Camera{ignoreParentScaling=!1;rotation=new c.Vector3;distance=-45;_viewMatrix=c.Matrix.Zero();_tmpUpVector=c.Vector3.Zero();_tmpTargetVector=c.Vector3.Zero();onCurrentAnimationChangedObservable;_animations;_animationIndexMap;_currentAnimation;constructor(e,t=new c.Vector3(0,10,0),n,i=!0){super(e,t,n,i),this.fov=Math.PI/180*30,this.onCurrentAnimationChangedObservable=new V.Observable,this._animations=[],this._animationIndexMap=new Map,this._currentAnimation=null}addAnimation(e){let t;if(!e.createRuntimeCameraAnimation)throw new Error('animation is not MmdAnimation or MmdCameraAnimationGroup or MmdCompositeAnimation. are you missing import "babylon-mmd/esm/Runtime/Animation/mmdRuntimeCameraAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeCameraAnimationGroup" or "babylon-mmd/esm/Runtime/Animation/mmdCompositeRuntimeCameraAnimation"?');t=e.createRuntimeCameraAnimation(this),this._animationIndexMap.set(e.name,this._animations.length),this._animations.push(t)}removeAnimation(e){const t=this._animations[e];this._currentAnimation===t&&(this._currentAnimation=null),this._animationIndexMap.delete(t.animation.name),this._animations.splice(e,1),t.dispose?.()}setAnimation(e){if(null===e)return void(null!==this._currentAnimation&&(this._currentAnimation=null,this.onCurrentAnimationChangedObservable.notifyObservers(null)));const t=this._animationIndexMap.get(e);if(void 0===t)throw new Error(`Animation ${e} is not found`);this._currentAnimation=this._animations[t],this.onCurrentAnimationChangedObservable.notifyObservers(this._currentAnimation)}get runtimeAnimations(){return this._animations}get currentAnimation(){return this._currentAnimation}animate(e){null!==this._currentAnimation&&this._currentAnimation.animate(e)}_storedPosition=null;_storedRotation=null;_storedDistance=0;storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this._storedDistance=this.distance,super.storeState()}_restoreStateValues(){return!!super._restoreStateValues()&&(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.distance=this._storedDistance,!0)}_initCache(){super._initCache(),this._cache.rotation=new c.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.distance=Number.MAX_VALUE}_updateCache(e){e||super._updateCache(),this._cache.rotation.copyFrom(this.rotation),this._cache.distance=this.distance}_isSynchronizedViewMatrix(){return!!super._isSynchronizedViewMatrix()&&this._cache.rotation.equals(this.rotation)&&this._cache.distance===this.distance}static _RotationMatrix=new c.Matrix;static _CameraEyePosition=new c.Vector3;static _UpVector=new c.Vector3;static _TargetVector=new c.Vector3;_getViewMatrix(){const e=c.Matrix.RotationYawPitchRollToRef(-this.rotation.y,-this.rotation.x,-this.rotation.z,ko._RotationMatrix),t=this.position.addToRef(c.Vector3.TransformCoordinatesFromFloatsToRef(0,0,this.distance,e,ko._CameraEyePosition),ko._CameraEyePosition),n=c.Vector3.TransformNormalFromFloatsToRef(0,0,1,e,ko._TargetVector).addInPlace(t),i=c.Vector3.TransformNormalFromFloatsToRef(0,1,0,e,ko._UpVector);if(this.ignoreParentScaling){if(this.parent){const e=this.parent.getWorldMatrix();c.Vector3.TransformCoordinatesToRef(t,e,this._globalPosition),c.Vector3.TransformCoordinatesToRef(n,e,this._tmpTargetVector),c.Vector3.TransformNormalToRef(i,e,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(t),this._tmpTargetVector.copyFrom(n),this._tmpUpVector.copyFrom(i);return this.getScene().useRightHandedSystem?c.Matrix.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):c.Matrix.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix),this._viewMatrix}if(this.getScene().useRightHandedSystem?c.Matrix.LookAtRHToRef(t,n,i,this._viewMatrix):c.Matrix.LookAtLHToRef(t,n,i,this._viewMatrix),this.parent){const e=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(e,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(t);return this._viewMatrix}getClassName(){return"MmdCamera"}}class No{isLocal;affectRotation;affectPosition;ratio;targetBone;appendPosition=c.Vector3.Zero();appendRotation=c.Quaternion.Identity();constructor(e,t,n){this.isLocal=0!=(e&M.Bone.Flag.LocalAppendTransform),this.affectRotation=0!=(e&M.Bone.Flag.HasAppendRotate),this.affectPosition=0!=(e&M.Bone.Flag.HasAppendMove),this.ratio=t.ratio,this.targetBone=n}static _IdentityQuaternion=c.Quaternion.Identity();static _TargetBoneWorldMatrix=c.Matrix.Identity();update(e,t){const n=this.targetBone;if(this.affectRotation){const t=this.appendRotation;if(this.isLocal){const e=n.getWorldMatrixToRef(No._TargetBoneWorldMatrix);c.Quaternion.FromRotationMatrixToRef(e,t)}else null!==n.appendTransformSolver&&n.appendTransformSolver.affectRotation?t.copyFrom(n.appendTransformSolver.appendRotation):n.getAnimatedRotationToRef(t);null===n.ikChainInfo||this.isLocal||n.ikChainInfo.ikRotation.multiplyToRef(t,t),1!==this.ratio&&c.Quaternion.SlerpToRef(No._IdentityQuaternion,t,this.ratio,t),e.multiplyToRef(t,t)}if(this.affectPosition){const e=this.appendPosition;if(this.isLocal){const t=n.getWorldMatrixToRef(No._TargetBoneWorldMatrix);t.multiplyToRef(n.linkedBone.getAbsoluteInverseBindMatrix(),t),t.getTranslationToRef(e)}else null!==n.appendTransformSolver&&n.appendTransformSolver.affectPosition?e.copyFrom(n.appendTransformSolver.appendPosition):n.getAnimationPositionOffsetToRef(e);1!==this.ratio&&e.scaleInPlace(this.ratio),e.addInPlace(t)}}}class Do{localRotation;localPosition;ikRotation;constructor(){this.localRotation=c.Quaternion.Identity(),this.localPosition=c.Vector3.Zero(),this.ikRotation=c.Quaternion.Identity()}}class Lo{bone;minimumAngle;maximumAngle;rotationOrder;solveAxis;constructor(e,t){if(this.bone=e,void 0!==t){{const e=t.minimumAngle,n=t.maximumAngle,i=Math.min(e[0],n[0]),o=Math.min(e[1],n[1]),r=Math.min(e[2],n[2]),a=Math.max(e[0],n[0]),s=Math.max(e[1],n[1]),l=Math.max(e[2],n[2]);this.minimumAngle=new c.Vector3(i,o,r),this.maximumAngle=new c.Vector3(a,s,l)}const e=this.minimumAngle,n=this.maximumAngle,i=.5*Math.PI;-i<e.x&&n.x<i?this.rotationOrder=0:-i<e.y&&n.y<i?this.rotationOrder=1:this.rotationOrder=2,0===e.x&&0===n.x&&0===e.y&&0===n.y&&0===e.z&&0===n.z?this.solveAxis=1:0===e.y&&0===n.y&&0===e.z&&0===n.z?this.solveAxis=2:0===e.x&&0===n.x&&0===e.z&&0===n.z?this.solveAxis=3:0===e.x&&0===n.x&&0===e.y&&0===n.y?this.solveAxis=4:this.solveAxis=0}else this.minimumAngle=null,this.maximumAngle=null,this.rotationOrder=2,this.solveAxis=0}}class Uo{index;get iteration(){return this._iteration}set iteration(e){this._iteration=Math.min(e,256)}limitAngle;ikBone;targetBone;_iteration;_ikChains;_canSkipWhenPhysicsEnabled;constructor(e,t,n){this.index=e,this._iteration=1,this.limitAngle=Math.PI,this.ikBone=t,this.targetBone=n,this._ikChains=[],this._canSkipWhenPhysicsEnabled=!0}addIkChain(e,t,n){e.ikChainInfo=new Do,t||(this._canSkipWhenPhysicsEnabled=!1);const i=new Lo(e,n);this._ikChains.push(i)}get canSkipWhenPhysicsEnabled(){return this._canSkipWhenPhysicsEnabled}static _IkPosition=new c.Vector3;static _TargetPosition=new c.Vector3;solve(e){if(0===this._ikChains.length)return;const t=this.ikBone,n=this.targetBone,i=this._ikChains;for(let e=0;e<i.length;++e)i[e].bone.ikChainInfo.ikRotation.set(0,0,0,1);const o=t.getWorldTranslationToRef(Uo._IkPosition);n.updateWorldMatrix(e,!0);const r=n.getWorldTranslationToRef(Uo._TargetPosition);if(c.Vector3.DistanceSquared(o,r)<1e-8)return;for(let t=i.length-1;t>=0;--t)i[t].bone.updateWorldMatrix(e,!1);if(n.updateWorldMatrix(!1,!1),n.getWorldTranslationToRef(r),c.Vector3.DistanceSquared(o,r)<1e-8)return;const a=this.iteration,s=a>>1;for(let e=0;e<a;++e){for(let t=0;t<i.length;++t){const n=i[t];1!==n.solveAxis&&this._solveChain(n,t,o,r,e<s)}if(c.Vector3.DistanceSquared(o,r)<1e-8)break}}static _ChainPosition=new c.Vector3;static _ChainTargetVector=new c.Vector3;static _ChainIkVector=new c.Vector3;static _ChainRotationAxis=new c.Vector3;static _ChainParentRotationMatrix=new c.Matrix;static _Axis=new c.Vector3;static _Rotation=new c.Quaternion;static _RotationMatrix=new c.Matrix;static _Right=c.Vector3.Right();static _Up=c.Vector3.Up();static _Forward=c.Vector3.Forward();static _Rotation2=new c.Quaternion;static _Rotation3=new c.Quaternion;_solveChain(e,t,n,i,o){const r=this.targetBone,a=e.bone,s=a.getWorldTranslationToRef(Uo._ChainPosition),l=s.subtractToRef(i,Uo._ChainTargetVector).normalize(),h=s.subtractToRef(n,Uo._ChainIkVector).normalize(),d=c.Vector3.CrossToRef(l,h,Uo._ChainRotationAxis);if(d.lengthSquared()<1e-8)return;const m=null!==a.parentBone?a.parentBone.getWorldMatrixToRef(Uo._ChainParentRotationMatrix):c.Matrix.IdentityToRef(Uo._ChainParentRotationMatrix);if(m.setTranslationFromFloats(0,0,0),null!==e.minimumAngle&&o)switch(e.solveAxis){case 0:m.transposeToRef(m),c.Vector3.TransformNormalToRef(d,m,d),d.normalize();break;case 2:{const e=m.m,t=c.Vector3.Dot(d,Uo._Axis.set(e[0],e[1],e[2]));d.x=0<=t?1:-1,d.y=0,d.z=0;break}case 3:{const e=m.m,t=c.Vector3.Dot(d,Uo._Axis.set(e[4],e[5],e[6]));d.x=0,d.y=0<=t?1:-1,d.z=0;break}case 4:{const e=m.m,t=c.Vector3.Dot(d,Uo._Axis.set(e[8],e[9],e[10]));d.x=0,d.y=0,d.z=0<=t?1:-1;break}}else m.transposeToRef(m),c.Vector3.TransformNormalToRef(d,m,d),d.normalize();let u=c.Vector3.Dot(l,h);u=Math.max(-1,Math.min(1,u));const p=Math.min(this.limitAngle*(t+1),Math.acos(u)),g=c.Quaternion.RotationAxisToRef(d,p,Uo._Rotation);if(g.multiplyToRef(a.ikChainInfo.ikRotation,a.ikChainInfo.ikRotation),null!==e.minimumAngle){a.ikChainInfo.ikRotation.multiplyToRef(a.ikChainInfo.localRotation,g);const t=c.Matrix.FromQuaternionToRef(g,Uo._RotationMatrix).m,n=88*Math.PI/180;let i,r,s;switch(e.rotationOrder){case 0:{i=Math.asin(-t[9]),Math.abs(i)>n&&(i=i<0?-n:n);let l=Math.cos(i);0!==l&&(l=1/l),r=Math.atan2(t[8]*l,t[10]*l),s=Math.atan2(t[1]*l,t[5]*l);{const t=e.minimumAngle,n=e.maximumAngle;i=this._limitAngle(i,t.x,n.x,o),r=this._limitAngle(r,t.y,n.y,o),s=this._limitAngle(s,t.z,n.z,o)}c.Quaternion.RotationAxisToRef(Uo._Up,r,a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(c.Quaternion.RotationAxisToRef(Uo._Right,i,Uo._Rotation2),a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(c.Quaternion.RotationAxisToRef(Uo._Forward,s,Uo._Rotation2),a.ikChainInfo.ikRotation);break}case 1:{r=Math.asin(-t[2]),Math.abs(r)>n&&(r=r<0?-n:n);let l=Math.cos(r);0!==l&&(l=1/l),i=Math.atan2(t[6]*l,t[10]*l),s=Math.atan2(t[1]*l,t[0]*l);{const t=e.minimumAngle,n=e.maximumAngle;i=this._limitAngle(i,t.x,n.x,o),r=this._limitAngle(r,t.y,n.y,o),s=this._limitAngle(s,t.z,n.z,o)}c.Quaternion.RotationAxisToRef(Uo._Forward,s,a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(c.Quaternion.RotationAxisToRef(Uo._Up,r,Uo._Rotation2),a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(c.Quaternion.RotationAxisToRef(Uo._Right,i,Uo._Rotation2),a.ikChainInfo.ikRotation);break}case 2:{s=Math.asin(-t[4]),Math.abs(s)>n&&(s=s<0?-n:n);let l=Math.cos(s);0!==l&&(l=1/l),i=Math.atan2(t[6]*l,t[5]*l),r=Math.atan2(t[8]*l,t[0]*l);{const t=e.minimumAngle,n=e.maximumAngle;i=this._limitAngle(i,t.x,n.x,o),r=this._limitAngle(r,t.y,n.y,o),s=this._limitAngle(s,t.z,n.z,o)}c.Quaternion.RotationAxisToRef(Uo._Right,i,a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(c.Quaternion.RotationAxisToRef(Uo._Forward,s,Uo._Rotation2),a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(c.Quaternion.RotationAxisToRef(Uo._Up,r,Uo._Rotation2),a.ikChainInfo.ikRotation);break}}const l=c.Quaternion.InverseToRef(a.ikChainInfo.localRotation,Uo._Rotation3);a.ikChainInfo.ikRotation.multiplyToRef(l,a.ikChainInfo.ikRotation)}const f=this._ikChains;for(let e=t;e>=0;--e)f[e].bone.updateIkChainWorldMatrix();r.updateWorldMatrix(!1,!1),r.getWorldTranslationToRef(i)}_limitAngle(e,t,n,i){if(e<t){const o=2*t-e;return o<=n&&i?o:t}if(e>n){const o=2*n-e;return o>=t&&i?o:n}return e}}class Vo extends Xi{setMorphWeight(e,t){const n=this._morphIndexMap.get(e);if(void 0===n)return;const i=this._morphWeights;for(let e=0;e<n.length;++e)i[n[e]]=t;0!==t&&this._activeMorphs.add(e)}setMorphWeightFromIndex(e,t){this._morphWeights[e]=t,0!==t&&this._activeMorphs.add(this._morphs[e].name)}_resetBoneMorph(e){const t=this._runtimeBones,n=e.elements;for(let e=0;e<n.length;++e){const i=t[n[e]];void 0!==i&&(i.morphPositionOffset.set(0,0,0),i.morphRotationOffset.set(0,0,0,1),i.disableMorph())}}_tempQuaternion=new c.Quaternion;_applyBoneMorph(e,t){const n=this._runtimeBones,i=e.elements,o=e.elements2,r=e.elements3;for(let e=0;e<i.length;++e){const a=n[i[e]];void 0!==a&&(a.morphPositionOffset.addInPlaceFromFloats(o[3*e+0]*t,o[3*e+1]*t,o[3*e+2]*t),c.Quaternion.SlerpToRef(a.morphRotationOffset,this._tempQuaternion.copyFromFloats(r[4*e+0],r[4*e+1],r[4*e+2],r[4*e+3]),t,a.morphRotationOffset),0!==t&&a.enableMorph())}}}class Wo{linkedBone;name;parentBone;childBones;transformOrder;flag;transformAfterPhysics;appendTransformSolver;ikSolver;morphPositionOffset;morphRotationOffset;ikChainInfo;worldMatrix;getAnimatedRotationToRef;getAnimationPositionOffsetToRef;constructor(e,t,n,i){this.linkedBone=e,this.name=t.name,this.parentBone=null,this.childBones=[],this.transformOrder=t.transformOrder,this.flag=t.flag,this.transformAfterPhysics=0!=(t.flag&M.Bone.Flag.TransformAfterPhysics),this.appendTransformSolver=null,this.ikSolver=null,this.morphPositionOffset=c.Vector3.Zero(),this.morphRotationOffset=c.Quaternion.Identity(),this.ikChainInfo=null,this.worldMatrix=new Float32Array(n.buffer,n.byteOffset+16*i*4,16),this.getAnimatedRotationToRef=this._getAnimatedRotationToRef,this.getAnimationPositionOffsetToRef=this._getAnimationPositionOffsetToRef}_getAnimatedRotationToRef(e){return e.copyFrom(this.linkedBone.rotationQuaternion)}_getAnimatedRotationWithMorphToRef(e){return e.copyFrom(this.linkedBone.rotationQuaternion),this.morphRotationOffset.multiplyToRef(e,e)}static _TempVector3=new c.Vector3;_getAnimationPositionOffsetToRef(e){return e.copyFrom(this.linkedBone.position),this.linkedBone.getRestMatrix().getTranslationToRef(Wo._TempVector3),e.subtractInPlace(Wo._TempVector3)}_getAnimationPositionOffsetWithMorphToRef(e){return e.copyFrom(this.linkedBone.position),e.addInPlace(this.morphPositionOffset),this.linkedBone.getRestMatrix().getTranslationToRef(Wo._TempVector3),e.subtractInPlace(Wo._TempVector3)}enableMorph(){this.getAnimatedRotationToRef=this._getAnimatedRotationWithMorphToRef,this.getAnimationPositionOffsetToRef=this._getAnimationPositionOffsetWithMorphToRef}disableMorph(){this.getAnimatedRotationToRef=this._getAnimatedRotationToRef,this.getAnimationPositionOffsetToRef=this._getAnimationPositionOffsetToRef}resetTransformState(){const e=this.worldMatrix;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,null!==this.ikChainInfo&&(this.ikChainInfo.localRotation.set(0,0,0,1),this.ikChainInfo.localPosition.set(0,0,0),this.ikChainInfo.ikRotation.set(0,0,0,1)),null!==this.appendTransformSolver&&(this.appendTransformSolver.appendRotation.set(0,0,0,1),this.appendTransformSolver.appendPosition.set(0,0,0))}static _TempRotation=c.Quaternion.Identity();static _TempPosition=c.Vector3.Zero();static _TempPosition2=c.Vector3.Zero();static _TempMatrix=c.Matrix.Identity();static _TempMatrix2=c.Matrix.Identity();updateWorldMatrix(e,t){const n=this.getAnimatedRotationToRef(Wo._TempRotation),i=this.getAnimationPositionOffsetToRef(Wo._TempPosition);null!==this.appendTransformSolver&&(this.appendTransformSolver.update(n,i),this.appendTransformSolver.affectRotation&&n.copyFrom(this.appendTransformSolver.appendRotation),this.appendTransformSolver.affectPosition&&i.copyFrom(this.appendTransformSolver.appendPosition)),null!==this.ikChainInfo&&(this.ikChainInfo.localRotation.copyFrom(n),this.ikChainInfo.localPosition.copyFrom(i),this.ikChainInfo.ikRotation.multiplyToRef(n,n));const o=Wo._TempMatrix,r=this.linkedBone.getRestMatrix().getTranslationToRef(Wo._TempPosition2).addInPlace(i),a=this.linkedBone.scaling;if(1!==a.x||1!==a.y||1!==a.z?c.Matrix.ComposeToRef(a,n,r,o):(c.Matrix.FromQuaternionToRef(n,o),o.setTranslation(r)),null!==this.parentBone){const e=this.parentBone.getWorldMatrixToRef(Wo._TempMatrix2);o.multiplyToRef(e,o)}o.copyToArray(this.worldMatrix),t&&null!==this.ikSolver&&(e&&this.ikSolver.canSkipWhenPhysicsEnabled||this.ikSolver.solve(e))}updateIkChainWorldMatrix(){const e=this.ikChainInfo,t=e.ikRotation.multiplyToRef(e.localRotation,Wo._TempRotation),n=Wo._TempMatrix,i=this.linkedBone.scaling;if(1!==i.x||1!==i.y||1!==i.z){c.Matrix.ScalingToRef(i.x,i.y,i.z,n);const e=c.Matrix.FromQuaternionToRef(t,Wo._TempMatrix2);n.multiplyToRef(e,n)}else c.Matrix.FromQuaternionToRef(t,n);const o=this.linkedBone.getRestMatrix().getTranslationToRef(Wo._TempPosition);if(o.addInPlace(e.localPosition),n.setTranslation(o),null!==this.parentBone){const e=this.parentBone.getWorldMatrixToRef(Wo._TempMatrix2);n.multiplyToRef(e,n)}n.copyToArray(this.worldMatrix);const r=this.childBones;for(let e=0;e<r.length;++e)r[e]._updateWorldMatrixRecursive()}static _WorldMatrixUpdateStack=[];_updateWorldMatrixRecursive(){const e=Wo._WorldMatrixUpdateStack;for(e.length=0,e.push(this);e.length>0;){const t=e.pop();t.updateWorldMatrix(!1,!1);for(let n=0,i=t.childBones.length;n<i;++n)e.push(t.childBones[n])}}getWorldMatrixToRef(e){return c.Matrix.FromArrayToRef(this.worldMatrix,0,e)}getWorldTranslationToRef(e){return c.Vector3.FromArrayToRef(this.worldMatrix,12,e)}setWorldTranslationFromRef(e){e.toArray(this.worldMatrix,12)}get ikSolverIndex(){return null!==this.ikSolver?this.ikSolver.index:-1}}class zo{mesh;skeleton;worldTransformMatrices;ikSolverStates;runtimeBones;morph;_physicsModel;_logger;_sortedRuntimeBones;onCurrentAnimationChangedObservable;_animations;_animationIndexMap;_currentAnimation;_needStateReset;constructor(e,t,n,i,o){this._logger=o;const r=e.metadata,a=e;a.metadata={isRuntimeMmdModel:!0,header:r.header,meshes:r.meshes,materials:r.materials,skeleton:r.skeleton},this.mesh=a,this.skeleton=t;const s=this.worldTransformMatrices=new Float32Array(16*t.bones.length);{let e=0;const t=r.bones;for(let n=0;n<t.length;++n)void 0!==t[n].ik&&(e+=1);this.ikSolverStates=new Uint8Array(e).fill(1)}t.prepare(),this._disableSkeletonWorldMatrixUpdate(t);const l=this.runtimeBones=this._buildRuntimeSkeleton(t.bones,r.bones,r.rigidBodies,s);(this._sortedRuntimeBones=[...l]).sort(((e,t)=>e.transformOrder-t.transformOrder));const h=[];{const e=r.meshes;for(let t=0;t<e.length;++t){const n=e[t].morphTargetManager;null!==n&&h.push(n)}}this.morph=new Vo(l,r.materials,r.meshes,n,r.morphs,h),this._physicsModel=null!==i?i.buildPhysics(e,l,r.rigidBodies,r.joints,o):null,this.onCurrentAnimationChangedObservable=new V.Observable,this._animations=[],this._animationIndexMap=new Map,this._currentAnimation=null,this._needStateReset=!1}dispose(){this._enableSkeletonWorldMatrixUpdate(),this._physicsModel?.dispose(),this.onCurrentAnimationChangedObservable.clear();const e=this._animations;for(let t=0;t<e.length;++t)e[t].dispose?.();this._animations.length=0,this._animationIndexMap.clear(),this.mesh.metadata=null}get sortedRuntimeBones(){return this._sortedRuntimeBones}addAnimation(e,t){let n;if(void 0===e.createRuntimeModelAnimation)throw new Error('animation is not MmdAnimation or MmdModelAnimationGroup or MmdCompositeAnimation. are you missing import "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimationGroup" or "babylon-mmd/esm/Runtime/Animation/mmdCompositeRuntimeModelAnimation"?');n=e.createRuntimeModelAnimation(this,t,this._logger);const i=this._animationIndexMap.get(e.name);void 0!==i?this._animations[i]=n:(this._animationIndexMap.set(e.name,this._animations.length),this._animations.push(n))}removeAnimation(e){const t=this._animations[e];void 0!==t&&(this._currentAnimation===t&&(this._currentAnimation=null,this._resetPose(),this.onCurrentAnimationChangedObservable.notifyObservers(null)),this._animationIndexMap.delete(t.animation.name),this._animations.splice(e,1),t.dispose?.())}setAnimation(e,t=!0){if(null===e)return void(null!==this._currentAnimation&&(this._currentAnimation=null,this._resetPose(),this.onCurrentAnimationChangedObservable.notifyObservers(null)));const n=this._animationIndexMap.get(e);if(void 0===n)throw new Error(`Animation '${e}' is not found.`);null!==this._currentAnimation&&(this._resetPose(),this._needStateReset=!0);const i=this._currentAnimation=this._animations[n];i.induceMaterialRecompile(t,this._logger),this.onCurrentAnimationChangedObservable.notifyObservers(i)}get runtimeAnimations(){return this._animations}get currentAnimation(){return this._currentAnimation}initializePhysics(){this._physicsModel?.initialize()}beforePhysics(e){null!==e&&(this._needStateReset&&(this._needStateReset=!1,this.morph.resetMorphWeights(),this.ikSolverStates.fill(1)),null!==this._currentAnimation&&this._currentAnimation.animate(e)),this.morph.update();for(let e=0;e<this._sortedRuntimeBones.length;++e)this._sortedRuntimeBones[e].resetTransformState();this._update(!1),this._physicsModel?.syncBodies()}afterPhysics(){const e=this._physicsModel;null!==e&&e.syncBones(),this._update(!0),this.mesh.metadata.skeleton._markAsDirty()}_update(e){const t=null!==this._physicsModel,n=this._sortedRuntimeBones;for(let i=0;i<n.length;++i){const o=n[i];o.transformAfterPhysics===e&&o.updateWorldMatrix(t,0!==this.ikSolverStates[o.ikSolverIndex])}}_buildRuntimeSkeleton(e,t,n,i){const o=[];for(let n=0;n<t.length;++n){const r=t[n];o.push(new Wo(e[n],r,i,n))}const r=new Set;{const e=new Map;for(let t=0;t<o.length;++t){const n=o[t];e.set(n.name,n)}for(let t=0;t<n.length;++t){const i=n[t];if(i.physicsMode===M.RigidBody.PhysicsMode.FollowBone)continue;let a=o[i.boneIndex];void 0===a&&(a=e.get(n[t].name)),void 0!==a&&r.add(a)}}let a=0;for(let e=0;e<t.length;++e){const n=t[e],i=o[e],s=n.parentBoneIndex;if(0<=s&&s<o.length){const e=o[s];i.parentBone=e,e.childBones.push(i)}if(void 0!==n.appendTransform){const e=n.appendTransform.parentIndex;0<=e&&e<o.length?i.appendTransformSolver=new No(n.flag,n.appendTransform,o[e]):this._logger.error(`Invalid append transform target bone index: ${e}`)}if(void 0!==n.ik){const e=n.ik,t=e.target;if(0<=t&&t<o.length){const n=i.ikSolver=new Uo(a,i,o[t]);a+=1,n.iteration=e.iteration,n.limitAngle=e.rotationConstraint;for(let t=0;t<e.links.length;++t){const i=e.links[t],a=i.target;if(0<=a&&a<o.length){const e=o[a];n.addIkChain(e,r.has(e),i.limitation)}else this._logger.error(`Invalid IK link bone index: ${a}`)}}else this._logger.error(`Invalid IK target bone index: ${t}`)}}return o}_originalComputeTransformMatrices=null;_disableSkeletonWorldMatrixUpdate(e){if(null!==this._originalComputeTransformMatrices)return;this._originalComputeTransformMatrices=e._computeTransformMatrices;const t=this.worldTransformMatrices;e._computeTransformMatrices=function(e,n){this.onBeforeComputeObservable.notifyObservers(this);for(let n=0;n<this.bones.length;n++){const i=this.bones[n];if(i._childUpdateId+=1,-1!==i._index){const o=null===i._index?n:i._index;i.getAbsoluteInverseBindMatrix().multiplyToArray(c.Matrix.FromArrayToRef(t,16*n,i.getFinalMatrix()),e,16*o)}}this._identity.copyToArray(e,16*this.bones.length)}}_enableSkeletonWorldMatrixUpdate(){null!==this._originalComputeTransformMatrices&&(this.skeleton._computeTransformMatrices=this._originalComputeTransformMatrices,this._originalComputeTransformMatrices=null)}_resetPose(){const e=this._sortedRuntimeBones,t=new c.Vector3,n=c.Quaternion.Identity();for(let i=0;i<e.length;++i){const o=e[i].linkedBone;o.getRestMatrix().getTranslationToRef(t),o.position=t,o.setRotationQuaternion(n,Ye.Space.LOCAL)}this.mesh.metadata.skeleton._markAsDirty()}}class Ko{_physics;_models;_camera;_audioPlayer;_loggingEnabled;log;warn;error;_isRegistered;onAnimationDurationChangedObservable;onPlayAnimationObservable;onPauseAnimationObservable;onSeekAnimationObservable;onAnimationTickObservable;_currentFrameTime;_animationTimeScale;_animationPaused;_animationFrameTimeDuration;_useManualAnimationDuration;_needToInitializePhysicsModels;_beforePhysicsBinded;_afterPhysicsBinded;_bindedDispose;_disposeObservableObject;constructor(e=null,t=null){this._physics=t,this._models=[],this._camera=null,this._audioPlayer=null,this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._isRegistered=!1,this.onAnimationDurationChangedObservable=new V.Observable,this.onPlayAnimationObservable=new V.Observable,this.onPauseAnimationObservable=new V.Observable,this.onSeekAnimationObservable=new V.Observable,this.onAnimationTickObservable=new V.Observable,this._currentFrameTime=0,this._animationTimeScale=1,this._animationPaused=!0,this._animationFrameTimeDuration=0,this._useManualAnimationDuration=!1,this._needToInitializePhysicsModels=new Set,this._beforePhysicsBinded=null,this._afterPhysicsBinded=this.afterPhysics.bind(this),null!==e?(this._bindedDispose=()=>this.dispose(e),this._disposeObservableObject=e,null!==this._disposeObservableObject&&this._disposeObservableObject.onDisposeObservable.add(this._bindedDispose)):(this._bindedDispose=null,this._disposeObservableObject=null)}dispose(e){for(let e=0;e<this._models.length;++e)this._models[e].dispose();this._models.length=0,this.setCamera(null),this.setAudioPlayer(null),this.onAnimationDurationChangedObservable.clear(),this.onPlayAnimationObservable.clear(),this.onPauseAnimationObservable.clear(),this.onSeekAnimationObservable.clear(),this.onAnimationTickObservable.clear(),this._needToInitializePhysicsModels.clear(),this.unregister(e),null!==this._disposeObservableObject&&null!==this._bindedDispose&&this._disposeObservableObject.onDisposeObservable.removeCallback(this._bindedDispose)}createMmdModel(e,t={}){if(!yt.isMmdSkinnedMesh(e))throw new Error("Mesh validation failed.");return this.createMmdModelFromSkeleton(e,e.metadata.skeleton,t)}createMmdModelFromSkeleton(e,t,n={}){void 0===n.materialProxyConstructor&&(n.materialProxyConstructor=Zi),void 0===n.buildPhysics&&(n.buildPhysics=!0);const i=new zo(e,t,n.materialProxyConstructor,n.buildPhysics?this._physics:null,this);return this._models.push(i),this._needToInitializePhysicsModels.add(i),i.onCurrentAnimationChangedObservable.add(this._onAnimationChanged),i}destroyMmdModel(e){e.dispose();const t=this._models,n=t.indexOf(e);if(n<0)throw new Error("Model not found.");t.splice(n,1)}setCamera(e){null!==this._camera&&this._camera.onCurrentAnimationChangedObservable.removeCallback(this._onAnimationChanged),null!==e&&e.onCurrentAnimationChangedObservable.add(this._onAnimationChanged),this._camera=e,this._onAnimationChanged(e?.currentAnimation??null)}_setAudioPlayerLastValue=null;async setAudioPlayer(e){if(this._audioPlayer!==e&&(this._setAudioPlayerLastValue=e,null!==this._audioPlayer&&(this._audioPlayer.onDurationChangedObservable.removeCallback(this._onAudioDurationChanged),this._audioPlayer.onPlaybackRateChangedObservable.removeCallback(this._onAudioPlaybackRateChanged),this._audioPlayer.onPlayObservable.removeCallback(this._onAudioPlay),this._audioPlayer.onPauseObservable.removeCallback(this._onAudioPause),this._audioPlayer.onSeekObservable.removeCallback(this._onAudioSeek),this._audioPlayer.pause()),this._audioPlayer=null,null!==e)){if(!this._animationPaused){const t=30*e.duration;if(this._currentFrameTime<t&&(e.currentTime=this._currentFrameTime/30,await e.play(),this._setAudioPlayerLastValue!==e))return void e.pause()}this._audioPlayer=e,this._onAudioDurationChanged(),e.onDurationChangedObservable.add(this._onAudioDurationChanged),e.onPlaybackRateChangedObservable.add(this._onAudioPlaybackRateChanged),e.onPlayObservable.add(this._onAudioPlay),e.onPauseObservable.add(this._onAudioPause),e.onSeekObservable.add(this._onAudioSeek),e._setPlaybackRateWithoutNotify(this._animationTimeScale)}}register(e){this._isRegistered||(this._isRegistered=!0,this._beforePhysicsBinded=()=>this.beforePhysics(e.getEngine().getDeltaTime()),e.onBeforeAnimationsObservable.add(this._beforePhysicsBinded),e.onBeforeRenderObservable.add(this._afterPhysicsBinded))}unregister(e){this._isRegistered&&(this._isRegistered=!1,e.onBeforeAnimationsObservable.removeCallback(this._beforePhysicsBinded),e.onBeforeRenderObservable.removeCallback(this._afterPhysicsBinded),this._beforePhysicsBinded=null)}beforePhysics(e){if(this._animationPaused){const e=this._models;for(let t=0;t<e.length;++t)e[t].beforePhysics(null)}else{if(null===this._audioPlayer||this._audioPlayer.paused)this._currentFrameTime+=e/1e3*30*this._animationTimeScale;else{const t=this._audioPlayer.currentTime,n=t-this._currentFrameTime/30,i=Math.abs(n);if(i<.05)this._currentFrameTime+=e/1e3*30*this._animationTimeScale;else if(i<.5)this._currentFrameTime+=n<0?e/1e3*30*this._animationTimeScale*.9:e/1e3*30*this._animationTimeScale*1.1;else{if(60<Math.abs(t-this._currentFrameTime)){const e=this._needToInitializePhysicsModels;for(let t=0;t<this._models.length;++t){const n=this._models[t];null!==n.currentAnimation&&e.add(n)}}this._currentFrameTime=30*t}}const t=this._currentFrameTime;this._animationFrameTimeDuration<=t&&(this._animationPaused=!0,this._currentFrameTime=this._animationFrameTimeDuration,null===this._audioPlayer||this._audioPlayer.paused?this.onPauseAnimationObservable.notifyObservers():this._audioPlayer.pause());const n=this._models;for(let e=0;e<n.length;++e)n[e].beforePhysics(t);null!==this._camera&&this._camera.animate(t),this.onAnimationTickObservable.notifyObservers()}const t=this._needToInitializePhysicsModels;for(const e of t)e.initializePhysics();t.clear()}afterPhysics(){const e=this._models;for(let t=0;t<e.length;++t)e[t].afterPhysics()}_onAnimationChanged=e=>{if(this._useManualAnimationDuration)return;const t=e?.animation.endFrame??0;this._animationFrameTimeDuration<t?this._animationFrameTimeDuration=t:t<this._animationFrameTimeDuration&&(this._animationFrameTimeDuration=this._computeAnimationDuration()),this.onAnimationDurationChangedObservable.notifyObservers()};_computeAnimationDuration(){let e=0;const t=this._models;for(let n=0;n<t.length;++n){const i=t[n];null!==i.currentAnimation&&(e=Math.max(e,i.currentAnimation.animation.endFrame))}return null!==this._camera&&null!==this._camera.currentAnimation&&(e=Math.max(e,this._camera.currentAnimation.animation.endFrame)),null!==this._audioPlayer&&(e=Math.max(e,30*this._audioPlayer.duration)),e}_onAudioDurationChanged=()=>{if(!this._animationPaused){const e=this._audioPlayer,t=this._currentFrameTime/30;t<e.duration&&(e._setCurrentTimeWithoutNotify(t),e.play().then((()=>{this._setAudioPlayerLastValue===e||e.pause()})))}if(this._useManualAnimationDuration)return;const e=30*this._audioPlayer.duration;this._animationFrameTimeDuration<e?this._animationFrameTimeDuration=e:this._animationFrameTimeDuration=this._computeAnimationDuration(),this.onAnimationDurationChangedObservable.notifyObservers()};_onAudioPlaybackRateChanged=()=>{this._animationTimeScale=this._audioPlayer.playbackRate};_onAudioPlay=()=>{this._playAnimationInternal()};_onAudioPause=()=>{this._audioPlayer.currentTime!==this._audioPlayer.duration&&(this._animationPaused=!0,this.onPauseAnimationObservable.notifyObservers())};_onAudioSeek=()=>{this._seekAnimationInternal(30*this._audioPlayer.currentTime,this._animationPaused)};_playAnimationInternal(){if(this._animationPaused){if(this._animationPaused=!1,0===this._currentFrameTime){const e=this._models,t=this._needToInitializePhysicsModels;for(let n=0;n<e.length;++n)t.add(e[n])}this.onPlayAnimationObservable.notifyObservers()}}async playAnimation(){if(null!==this._audioPlayer&&this._currentFrameTime<30*this._audioPlayer.duration)try{const e=this._currentFrameTime/30;.05<Math.abs(this._audioPlayer.currentTime-e)&&this._audioPlayer._setCurrentTimeWithoutNotify(e),await this._audioPlayer.play()}catch(e){if(!(e instanceof DOMException&&"NotSupportedError"===e.name))throw e;this.error("Failed to play audio."),this._playAnimationInternal()}else this._playAnimationInternal()}pauseAnimation(){null===this._audioPlayer||this._audioPlayer.paused?(this._animationPaused=!0,this.onPauseAnimationObservable.notifyObservers()):(this._audioPlayer.pause(),this._animationPaused=!0)}_seekAnimationInternal(e,t){if(60<Math.abs(e-this._currentFrameTime)){const e=this._needToInitializePhysicsModels;for(let t=0;t<this._models.length;++t){const n=this._models[t];null!==n.currentAnimation&&e.add(n)}}if(this._currentFrameTime=e,t){const t=this._models;for(let n=0;n<t.length;++n){const i=t[n];null!==i.currentAnimation&&i.currentAnimation.animate(e)}null!==this._camera&&null!==this._camera.currentAnimation&&this._camera.animate(e),this.onAnimationTickObservable.notifyObservers()}this.onSeekAnimationObservable.notifyObservers()}async seekAnimation(e,t=!1){if(e=Math.max(0,Math.min(e,this._animationFrameTimeDuration)),null!==this._audioPlayer)if(this._audioPlayer.paused)if(!this._animationPaused&&30*this._audioPlayer.currentTime<this._animationFrameTimeDuration&&e<30*this._audioPlayer.duration)try{this._audioPlayer._setCurrentTimeWithoutNotify(e/30),await this._audioPlayer.play()}catch(n){if(!(n instanceof DOMException&&"NotSupportedError"===n.name))throw n;this.error("Failed to play audio."),this._seekAnimationInternal(e,t)}else this._seekAnimationInternal(e,t),this._audioPlayer?._setCurrentTimeWithoutNotify(e/30);else this._audioPlayer.currentTime=e/30;else this._seekAnimationInternal(e,t)}get isAnimationPlaying(){return!this._animationPaused}get models(){return this._models}get camera(){return this._camera}get audioPlayer(){return this._audioPlayer}get timeScale(){return this._animationTimeScale}set timeScale(e){this._animationTimeScale=e,null!==this._audioPlayer&&this._audioPlayer._setPlaybackRateWithoutNotify(e)}get currentFrameTime(){return this._currentFrameTime}get currentTime(){return this._currentFrameTime/30}get animationFrameTimeDuration(){return this._animationFrameTimeDuration}get animationDuration(){return this._animationFrameTimeDuration/30}setManualAnimationDuration(e){(null!==e||this._useManualAnimationDuration)&&(null===e?(this._useManualAnimationDuration=!1,this._animationFrameTimeDuration=this._computeAnimationDuration()):(this._useManualAnimationDuration=!0,this._animationFrameTimeDuration=e),this.onAnimationDurationChangedObservable.notifyObservers())}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){N.Logger.Log(e)}_logDisabled(){}_warnEnabled(e){N.Logger.Warn(e)}_warnDisabled(){}_errorEnabled(e){N.Logger.Error(e)}_errorDisabled(){}}})(),oe})()));
//# sourceMappingURL=babylon.mmd.min.js.map